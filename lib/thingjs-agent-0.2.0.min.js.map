{"version":3,"file":"thingjs-agent-0.2.0.min.js","sources":["thingjs-agent-0.2.0/bootstrap.js","thingjs-agent-0.2.0/core.js","thingjs-agent-0.2.0/Object.js","thingjs-agent-0.2.0/Base.js","thingjs-agent-0.2.0/Definition.js","thingjs-agent-0.2.0/Delegate.js","thingjs-agent-0.2.0/Pattern.js","thingjs-agent-0.2.0/Agent.js","thingjs-agent-0.2.0/Behaviour.js","thingjs-agent-0.2.0/Selector.js","thingjs-agent-0.2.0/Container.js","thingjs-agent-0.2.0/Heartbeat.js","thingjs-agent-0.2.0/Flow.js","thingjs-agent-0.2.0/Series.js","thingjs-agent-0.2.0/Parallel.js","thingjs-agent-0.2.0/Queue.js","thingjs-agent-0.2.0/Waker.js","thingjs-agent-0.2.0/Util.js"],"names":["$thing","bootstrap","usePaho","async","getMicroTime","Date","now","getBacktrace","first","e","trace","stack","match","slice","createBuffer","byteArray","buf","toString","String","fromCharCode","apply","Uint16Array","heap","Mash","n","mash","data","i","length","charCodeAt","h","create64BitId","h1","h2","arguments","split","merge","args","Array","prototype","call","obj","undefined","k","attach","def","_id","_refCount","pop","push","search","searchMeta","predicate","type","cb","meta","getMeta","_meta","forEach","item","isNaN","parseInt","toLowerCase","cbBuilder","self","cbDone","this","agent","cbObj","Container","setImmediate","source","selector","filter","pattern","selects","callChain","refCount","wakeTask","enqueueActionTask","Pattern","Selector","getInterfaces","Definition","Agent","refObject","cbRelease","name","filters","callArgs","dispatch","method","release","Filter","ALL","all","FIRST","last","LAST","switchContext","functString","parentOrdinal","superOrdinal","ordinal","superName","methodName","$vtable","indexOf","ret","$parent","$super","switchParentContext","Object","getName","$inherit","inherit","parent","init","replace","j","v","signature","signatures","constructor","substring","$owner","$signatures","Base","property","prop","cbGetter","cbSetter","get","set","defineProperty","bind","funct","State","EXPR_AND","EXPR_NOT","EXPR_OR","DEF_DESC","DEF_NAME","DEF_SOURCE","DEF_EXTENDS","DEF_IMPLEMENTS","DEF_USES","DEF_META","DEF_NOP","DEF_END","LIFE_INITIATED","LIFE_ACTIVE","LIFE_WAITING","LIFE_SUSPENDED","LIFE_DELETED","LIFE_TRANSIT","LIFE_BLOCKED","_metaHandlers","mobile","_isMobile","passive","_isPassive","singleton","_singleton","_source","catchall","_substitute","$__catchall__","_super","_state","_parent","_children","_interfaces","_uses","_isAgent","_isAbstract","$id","$source","parseStack","_extends","_name","Error","_class","unshift","_instance","_childrenWrapper","_pushChild","_forEachChild","_countChildren","_factory","interfaces","concat","getHeapId","id","splice","child","getRefCount","shift","charAt","Boolean","RegExp","patchObject","getSource","getChildren","getState","setState","states","state","unsetState","isAbstract","unpatchObject","constructed","setup","takedown","Delegate","matchInterface","_pattern","toArray","doActivate","doDelete","doSuspend","doWait","doWake","addBehaviour","reset","Behaviour","instance","removeBehaviour","objs","children","done","action","$cb","block","restart","includePassive","include","_exprs","_selection","_callbacks","expr","and","not","isPassive","matchObject","m","cbItem","interface","each","cbNext","WAKE_MIN_PERIOD","nextWakeTime","isActionTaskQueued","keepAlive","intervalId","setInterval","destroy","clearInterval","getFlow","methods","names","cbYield","yield","series","parallel","getQueue","concurrency","limit","functs","active","paused","value","queue","flow","applyEach","err","next","pause","resume","items","errs","getWakeTime","time","period","wake","stop","catchAll"],"mappings":"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","sourcesContent":["/*\nCopyright (c) 2015 Simon Cullen, http://github.com/cullens\n\nPermission is hereby granted, free of charge, to any person\nobtaining a copy of this software and associated documentation\nfiles (the \"Software\"), to deal in the Software without\nrestriction, including without limitation the rights to use,\ncopy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the\nSoftware is furnished to do so, subject to the following\nconditions:\n\nThe above copyright notice and this permission notice shall be\nincluded in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\nEXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES\nOF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\nNONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\nHOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,\nWHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING\nFROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR\nOTHER DEALINGS IN THE SOFTWARE.\n*/\n'use strict';\n\nvar $thing = $thing || {};\n\n$thing.bootstrap = 'browser.js';\n$thing.usePaho = true;\n\n$thing.async = async;\n\n$thing.getMicroTime = function() {\n    return Date.now() * 1000;\n};\n\n$thing.getBacktrace = function(first) {\n    first = first || 0;\n\n    try {\n        0(); \n    }\n    catch(e) {\n        var trace;\n\n        if ((trace = e.stack.match(/\\S+\\:\\d+/g)) !== null)\n            return trace.slice(1 + first);\n        else if ((trace = e.stack.match(/\\s+at /g)) !== null)\n            return trace.slice(1 + first);\n        return [];\n    }\n};\n\n$thing.createBuffer = function(byteArray) {\n    return {\n        buf: byteArray,\n        toString: function() {\n            return String.fromCharCode.apply(\n                null, \n                new Uint16Array(byteArray)\n            );\n        }\n    };\n};","/*\nCopyright (c) 2015 Simon Cullen, http://github.com/cullens\n\nPermission is hereby granted, free of charge, to any person\nobtaining a copy of this software and associated documentation\nfiles (the \"Software\"), to deal in the Software without\nrestriction, including without limitation the rights to use,\ncopy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the\nSoftware is furnished to do so, subject to the following\nconditions:\n\nThe above copyright notice and this permission notice shall be\nincluded in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\nEXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES\nOF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\nNONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\nHOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,\nWHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING\nFROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR\nOTHER DEALINGS IN THE SOFTWARE.\n*/\n'use strict';\n\n/** @namespace $thing */\n\n$thing.heap = [];\n\n$thing.Mash = function() {\n    // Mash by Johannes Baagoe <baagoe@baagoe.com>\n    var n = 0xefc8249d;\n    var mash = function(data) {\n        data = data.toString();\n        for (var i = 0; i < data.length; i++) {\n            n += data.charCodeAt(i);\n            var h = 0.02519603282416938 * n;\n            n = h >>> 0;\n            h -= n;\n            h *= n;\n            n = h >>> 0;\n            h -= n;\n            n += h * 0x100000000; \n        }\n        return (n >>> 0) * 2.3283064365386963e-10; \n    };\n    return mash;\n};\n\n/**\n * @memberOf $thing\n * @method create64BitId\n */\n$thing.create64BitId = function() {\n    var h1 = new $thing.Mash(),\n        h2 = new $thing.Mash()\n        ;\n\n    for (var i = 0; i < arguments.length; i++) \n        h1(arguments[i] || '');\n\n    return  h1('').toString(16).split('.')[1] +\n            h2($thing.getMicroTime()).toString(16).split('.')[1]\n            ;\n};\n\n/**\n * @memberOf $thing\n * @method merge\n */\n$thing.merge = function() {\n    var args = Array.prototype.slice.call(arguments, 0),\n        obj = args[0],\n        i = 1\n        ;\n        \n    for(; i < args.length; i++)\n        if (args[i] !== undefined)\n            for(var k in args[i])\n                (obj[k] === undefined)\n                    ? obj[k] = args[i][k]\n                    : undefined\n                    ;\n\n    return obj;\n};\n\n/**\n * @memberOf $thing\n * @method attach\n */\n$thing.attach = function(def) {\n    if (def._id !== undefined) \n        return def._id;\n    else {\n        var length = $thing.heap.length;\n        \n        while($thing.heap.length !== 0 &&\n            $thing.heap[$thing.heap.length - 1]._refCount === 0\n        ) \n            ($thing.heap.pop())._id = undefined;\n        \n        if (!$thing.heap.length || $thing.heap.length !== length)\n            def._id = $thing.heap.push(def) - 1;\n        else {\n            def._id = undefined;\n            \n            for(var i = $thing.heap.length - 1;\n                i > -1 && def._id === undefined;\n                i--\n            )\n                if ($thing.heap[i]._refCount === 0) {\n                    $thing.heap[i]._id = undefined;\n                    $thing.heap[def._id = i] = def;\n                }\n            \n            if (def._id === undefined)\n                def._id = $thing.heap.push(def) - 1;\n        }\n        \n        return def._id;\n    }\n};\n\n/**\n * @memberOf $thing\n * @method search\n */\n$thing.search = function(obj) {\n    var match;\n    \n    for(var i = $thing.heap.length - 1; i > -1; i--) {\n        if ($thing.heap[i]._refCount > 0) {\n            for(var k in obj)\n                if (!(match = obj[k] === $thing.heap[i][k]))\n                    break;\n                \n                if (match)\n                    return $thing.heap[i];\n            }\n        }\n    \n    return undefined;\n};\n\n/**\n * @memberOf $thing\n * @method searchMeta\n */\n$thing.searchMeta = function(obj, predicate) {\n    var type = 'string',\n        cb = arguments[2],\n        meta = (obj.getMeta !== undefined)\n            ? obj.getMeta()\n            : obj._meta\n        ;\n    \n    switch(arguments[2]) {\n        case 'int':\n        case 'boolean':\n        case 'string':\n            type = arguments[2];\n            cb = arguments[3];\n    }\n    \n    meta.forEach(function(item) {\n        if ((item = item.match(/\\S+/g))[0] === predicate) {\n            item = item.slice(1);\n            \n            switch(type) {\n                case 'int':\n                    if (!isNaN(item[0] = parseInt(item[0])))\n                        cb.apply(obj, item);\n                    break;\n                \n                case 'boolean':\n                    switch(item[0].toLowerCase()) {\n                        case 'true':\n                            item[0] = true;\n                            cb.apply(obj, item);\n                            break;\n                        \n                        case 'false':\n                            item[0] = false;\n                            cb.apply(obj, item);\n                            break;\n                    }\n                    break;\n                \n                default:\n                    cb.apply(obj, item);\n            }\n        }\n    });\n};\n\n$thing.cbBuilder = function(self, args, cbDone) {\n    cbDone = cbDone || function(){};\n    \n    return function() {\n        var self = this,\n            args = arguments\n            ;\n        \n        $thing.agent();\n        \n        return (!args.length)\n            ? cbDone()\n            : function() {\n                var cbObj = (arguments.length)\n                    ? arguments\n                    : [$thing.Container]\n                    ;\n                \n                $thing.async.setImmediate(function() {\n                    $thing.agent(self)\n                        .apply($thing, args)\n                        .apply($thing, cbObj)\n                        ;\n                    \n                    cbDone();\n                });\n            }\n            ;\n\n    }.apply(self, args);\n};\n\n/**\n * @method agent\n * @param {*}\n */\nvar agent = $thing.agent = function() {\n    var def,\n        source,\n        selector,\n        filter,\n        pattern,\n        selects,\n        callChain,\n        refCount = 0\n        ;\n\n    switch(arguments.length) {\n        case 0:\n            $thing.wakeTask();\n            return $thing.enqueueActionTask();\n        \n        case 1:\n            if (arguments[0] instanceof $thing.Pattern) {\n                selector = new $thing.Selector(pattern = arguments[0]);\n                break;\n            }\n            else if (   typeof arguments[0] === 'object' &&\n                        arguments[0].getInterfaces !== undefined\n            ) {\n                selector = arguments[0];\n                break;\n            }\n\n            /* falls through */\n        default:\n            var args = Array.prototype.slice.call(arguments, 0);\n            \n            def = new $thing.Definition(\n                $thing.Container,\n                $thing.Agent,\n                (source = $thing.getBacktrace(1)[0]),\n                args\n            );\n\n            if (def.class !== undefined)\n                return def.refObject(function(obj, cbRelease) {\n                    cbRelease();\n                });\n            else {\n                selects = [];\n                \n                $thing.searchMeta(def, 'select', function() {\n                    selects.push(Array.prototype.slice.call(arguments, 0));\n                });\n                \n                selector = new $thing.Selector(\n                    pattern = (selects.length)\n                        ? selects\n                        : def.name,\n                    source\n                );\n            }\n    }\n\n    filter = function(filters, callArgs) {          \n        return function() {\n            var obj,\n                args = Array.prototype.slice.call(arguments, 0)\n                ;\n                \n            switch(arguments.length) {\n                case 0:\n                    obj = $thing.Container;\n                    break;\n                \n                case 1:\n                    if (typeof arguments[0] === 'object' &&\n                        arguments[0].getInterfaces !== undefined\n                    ) {\n                        obj = arguments[0];\n                        break;\n                    }\n                    \n                    /* falls through */ \n                default:\n                    var source = $thing.getBacktrace(1)[0],\n                        def = new $thing.Definition(\n                            $thing.Container,\n                            $thing.Agent,\n                            source,\n                            args\n                        )\n                        ;\n                    \n                    if (def.class !== undefined) \n                        obj = def;\n                    else {\n                        selects = [];\n                        \n                        $thing.searchMeta(def, 'select', function() {\n                            selects.push(Array.prototype.slice.call(arguments, 0));\n                        });\n                        \n                        obj = new $thing.Pattern(\n                            (selects.length)\n                                ? selects\n                                : def.name,\n                                source\n                        );\n                    }\n                    \n                    break;\n            }\n\n            obj.refObject(function(obj, cbRelease) {\n\n                refCount++;\n\n                (pattern !== undefined)\n                    ? selector.dispatch(\n                        {   filters: filters,\n                            method: callArgs[0],\n                            args: callArgs.slice(1)\n                        },\n                        function() {\n                            return $thing.cbBuilder(\n                                obj,\n                                Array.prototype.slice.call(\n                                    arguments,\n                                    0,\n                                    arguments.length - 1\n                                ),\n                                arguments[arguments.length - 1]\n                            );\n                        },\n                        function() {\n                            if (--refCount === 0) {\n                                cbRelease();\n                                selector.release();\n                            }\n                        }\n                    )\n                    : selector.dispatch(\n                        {   filters: filters,\n                            method: callArgs[0],\n                            args: callArgs.slice(1)\n                        },\n                        function() {\n                            return $thing.cbBuilder(\n                                obj,\n                                arguments,\n                                function() {\n                                    if (--refCount === 0) {\n                                        cbRelease();\n                                    }\n                                }\n                            );\n                        }\n                    )\n                    ;\n            });\n\n            return callChain;\n        };\n    };\n\n    callChain = function() {\n        return filter(\n            $thing.Filter.ALL, \n            Array.prototype.slice.call(arguments, 0)\n        );\n    };\n\n    callChain.all = callChain;\n\n    callChain.first = function() {\n        return filter(\n            $thing.Filter.FIRST, \n            Array.prototype.slice.call(arguments, 0)\n        );\n    };\n\n    callChain.last = function() {\n        return filter(\n            $thing.Filter.LAST, \n            Array.prototype.slice.call(arguments, 0)\n        );\n    };\n\n    return callChain;\n};","/*\nCopyright (c) 2015 Simon Cullen, http://github.com/cullens\n\nPermission is hereby granted, free of charge, to any person\nobtaining a copy of this software and associated documentation\nfiles (the \"Software\"), to deal in the Software without\nrestriction, including without limitation the rights to use,\ncopy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the\nSoftware is furnished to do so, subject to the following\nconditions:\n\nThe above copyright notice and this permission notice shall be\nincluded in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\nEXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES\nOF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\nNONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\nHOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,\nWHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING\nFROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR\nOTHER DEALINGS IN THE SOFTWARE.\n*/\n'use strict';\n\n/**\n * @memberOf $thing\n * @method switchContext\n */\n$thing.switchContext = function(\n    functString,\n    parentOrdinal,\n    superOrdinal,\n    ordinal,\n    superName,\n    methodName\n) {\n    functString = functString || this.$vtable[ordinal][methodName].toString();\n\n    return (\n        functString.indexOf('$parent') > -1 ||\n        functString.indexOf('$super') > -1\n    )\n        ? function() {\n            var ret,\n                $parent = this.$parent,\n                $super = this.$super\n                ;\n            \n            this.$parent = this.$vtable[parentOrdinal] || $parent;\n            this.$super = this.$vtable[superOrdinal][superName];\n\n            ret = this.$vtable[ordinal][methodName].apply(this, arguments);\n\n            this.$parent = $parent;\n            this.$super = $super;\n            \n            return ret;\n        }\n        : this.$vtable[ordinal][methodName]\n        ;\n};\n\n/**\n * @memberOf $thing\n * @method switchParentContext\n */\n$thing.switchParentContext = function(\n    functString,\n    parentOrdinal,\n    ordinal,\n    methodName\n) {\n    functString = functString || this.$vtable[ordinal][methodName].toString();\n\n    return (\n        functString.indexOf('$parent') > -1\n    )\n        ? function() {\n            var ret,\n                $parent = this.$parent\n                ;\n            \n            this.$parent = this.$vtable[parentOrdinal] || this.$parent;\n\n            ret = this.$vtable[ordinal][methodName].apply(this, arguments);\n\n            this.$parent = $parent;\n            \n            return ret;\n        }\n        : this.$vtable[ordinal][methodName]\n        ;\n};\n\n/**\n * @class Object\n * @memberOf $thing\n */\n$thing.Object = function(){};\n\n/**\n * Return object name\n * @memberOf $thing\n * @method Object#getName\n * @returns {string}\n */\n$thing.Object.prototype.getName = function(){\n    return 'Object';\n};\n\n/**\n * @memberOf $thing\n * @method Object.inherit\n * @param {object} obj\n * @param {object} parent\n * @returns {object}\n */\nvar $inherit = $thing.Object.inherit = function(obj, parent) {\n    var i,\n        j,\n        k,\n        v,\n        functString,\n        signature,\n        signatures = {},\n        inherit = this.prototype\n        ;\n        \n    function ret() {\n        /*jshint validthis:true */\n        (this.init !== undefined)\n            ? this.init.apply(this, arguments)\n            : undefined\n            ;\n    }\n\n    function replace() {\n        return (obj['$' + arguments[1]] !== undefined)\n            ? obj['$' + arguments[1]]\n            : arguments[0]\n            ;\n    }\n    \n    ret.prototype = new this();\n    ret.prototype.constructor = ret;\n    ret.prototype.$vtable = (ret.prototype.$vtable !== undefined)\n        ? ret.prototype.$vtable.slice()\n        : []\n        ;\n    \n    var ordinal = ret.prototype.$vtable.push(obj) - 1,\n        parentOrdinal = ret.prototype.$vtable.push(parent) - 1,\n        superOrdinal = ret.prototype.$vtable.push(inherit) - 1\n        ;\n    \n    ret.inherit = $inherit;\n    \n    for (i in obj) {\n        switch(i) {\n            case '$vtable':\n                /* falls through */\n            case '$signatures':\n                /* falls through */\n            case '$owner':\n                /* falls through */\n            case '$parent':\n                 /* falls through */\n            case '$super':\n                continue;\n        }\n        \n        v = obj[i];\n        k = i.replace(/\\$\\((.+?)\\)/g, replace);\n        j = k.substring(k.indexOf('.') + 1);\n        \n        if (typeof v !== 'function')\n            ret.prototype[k] = v;\n        else {\n            functString = v.toString();\n            signature = functString.match(/function[^(]*\\(([^)]*)\\)/);\n            \n            (typeof inherit[k] !== 'function')\n                ? (typeof inherit[j] !== 'function')\n                    ? ret.prototype[k] = $thing.switchParentContext.apply(\n                        ret.prototype,\n                        [   functString,\n                            parentOrdinal,\n                            ordinal,\n                            i\n                        ]\n                    )\n                    : ret.prototype[k] = $thing.switchContext.apply(\n                        ret.prototype,\n                        [   functString,\n                            parentOrdinal,\n                            superOrdinal,\n                            ordinal,\n                            j,\n                            i\n                        ]\n                    )\n                : ret.prototype[k] = $thing.switchContext.apply(\n                    ret.prototype,\n                    [   functString,\n                        parentOrdinal,\n                        superOrdinal,\n                        ordinal,\n                        k,\n                        i\n                    ]\n                )\n                ;\n            \n            if (signature !== null)\n                signatures[k] = (signature[1].length)\n                    ? signature[1].split(/,\\s*/)\n                    : []\n                    ;\n        }\n    }\n    \n    ret.prototype.$owner = parent || ret.prototype.$owner;\n    ret.prototype.$signatures = $thing.merge(\n        signatures,\n        ret.prototype.$signatures\n    );\n    \n    return ret;\n};","/*\nCopyright (c) 2015 Simon Cullen, http://github.com/cullens\n\nPermission is hereby granted, free of charge, to any person\nobtaining a copy of this software and associated documentation\nfiles (the \"Software\"), to deal in the Software without\nrestriction, including without limitation the rights to use,\ncopy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the\nSoftware is furnished to do so, subject to the following\nconditions:\n\nThe above copyright notice and this permission notice shall be\nincluded in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\nEXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES\nOF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\nNONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\nHOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,\nWHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING\nFROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR\nOTHER DEALINGS IN THE SOFTWARE.\n*/\n'use strict';\n\n$thing.Base = $thing.Object.inherit({\n\n    /**\n     * @constructs Base\n     * @mixes $thing.Object\n     * @memberOf $thing\n     */\n    init: function() {},\n\n    getName: function() {\n        return 'Base';\n    },\n\n    /**\n     * Define an object property\n     * @memberOf $thing\n     * @method Base#property\n     * @param {string} prop property name\n     * @param {function} [cbGetter]\n     * @param {function} [cbSetter]\n     */\n    property: function(prop, cbGetter, cbSetter) {\n        var obj = {};\n\n        (cbGetter)\n            ? obj.get = cbGetter\n            : undefined\n            ;\n        \n        (cbSetter)\n            ? obj.set = cbSetter\n            : undefined\n            ;\n    \n        Object.defineProperty(this, prop, obj);\n    },\n\n    bind: function(funct) {\n        var self = this;\n        \n        return function() {\n            return funct.apply(self, arguments);\n        };\n    }\n\n});","/*\nCopyright (c) 2015 Simon Cullen, http://github.com/cullens\n\nPermission is hereby granted, free of charge, to any person\nobtaining a copy of this software and associated documentation\nfiles (the \"Software\"), to deal in the Software without\nrestriction, including without limitation the rights to use,\ncopy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the\nSoftware is furnished to do so, subject to the following\nconditions:\n\nThe above copyright notice and this permission notice shall be\nincluded in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\nEXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES\nOF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\nNONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\nHOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,\nWHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING\nFROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR\nOTHER DEALINGS IN THE SOFTWARE.\n*/\n'use strict';\n\n$thing.State = {\n    EXPR_AND:       1,\n    EXPR_NOT:       2,\n    EXPR_OR:        3,\n    DEF_DESC:       1,\n    DEF_NAME:       2,\n    DEF_SOURCE:     4,\n    DEF_EXTENDS:    16,\n    DEF_IMPLEMENTS: 64,\n    DEF_USES:       128,\n    DEF_META:       256,\n    DEF_NOP:        512,\n    DEF_END:        1024,\n    LIFE_INITIATED: 2048,\n    LIFE_ACTIVE:    4096,\n    LIFE_WAITING:   8192,\n    LIFE_SUSPENDED: 16384,\n    LIFE_DELETED:   32768,\n    LIFE_TRANSIT:   65536,\n    LIFE_BLOCKED:   131072\n};\n\n$thing.Definition = $thing.Base.inherit({\n\n    _metaHandlers: {\n\n        mobile: function() {\n            this._isMobile = true;\n        },\n\n        passive: function() {\n            this._isPassive = true;\n        },\n\n        singleton: function() {\n            this._singleton = this._singleton || this._source;\n        },\n\n        catchall: function(catchall, methodName) {\n            this._substitute.$__catchall__ = methodName;\n        }\n\n    },\n\n    getName: function() {\n        return 'Definition';\n    },\n\n    /**\n     * @constructs Definition\n     * @mixes $thing.Base\n     * @memberOf $thing\n     * @param {object} parent\n     * @param {object} super\n     * @param {string} source\n     * @param {string[]} stack\n     */\n    init: function(parent, _super, source, stack) {\n        var k,\n            item,\n            search,\n            self = this\n            ;\n        \n        this.$super();\n        \n        this._state = $thing.State.DEF_DESC;\n        this._parent = parent;\n        this._children = [];\n        this._meta = [];\n        this._interfaces = [];\n        this._uses = [];\n        this._super = _super;\n        this._source = source;\n        this._refCount = 0;\n        this._isAgent = this._super === $thing.Agent;\n        this._isAbstract = false;\n        this._isPassive = false;\n        this._isMobile = false;\n\n        this._interfaces = [\n            $thing.create64BitId(source, $thing.heap.length),\n            source\n        ];\n\n        this._substitute = {\n            $id: this._interfaces[0],\n            $source: source\n        };\n        \n        this.parseStack(stack);\n        \n        if (this._extends !== undefined) {\n            item = $thing.search({_name: this._extends});\n            \n            if (item === undefined) throw new Error(\n                'DefinitionError: Super Class \\'' +\n                this._extends + '\\' is not defined'\n            );\n            else {\n                this._super = item._class;\n                this._singleton = item._singleton;\n                for(k = item._meta.length - 1; k > -1; k--)\n                    this._meta.unshift(item._meta[k]);\n            }\n            \n            (this._class === undefined)\n                ? this._class = {}\n                : undefined\n                ;\n        }\n        \n        this._meta.forEach(function(item) {\n            var args = item.split(/ (.+)?/);\n            \n            (self._metaHandlers[args[0]] !== undefined)\n                ? self._metaHandlers[args[0]].apply(self, args)\n                : undefined\n                ;\n        });\n        \n        if (this._isAbstract)\n            search = {\n                _name: this._name,\n                _source: this._source\n            };\n        else if (this._singleton !== undefined)\n            search = {\n                _name: this._name,\n                _singleton: this._singleton\n            };\n        \n        if (search !== undefined && (item = $thing.search(search))) {\n            this.refObject = item.bind(item.refObject);\n            \n            this.property('class', function() {\n                return item._class;\n            });\n            \n            this.property('refCount', function() {\n                return item._refCount;\n            });\n            \n            this.property('isAbstract', function() {\n                return item._isAbstract;\n            });\n            \n            this.property('isPassive', function() {\n                return item._isPassive;\n            });\n                \n            this.property('instance', function() {\n                return item._instance;\n            });\n                \n            this.property('state', function() {\n                return item._state;\n            });\n                \n            this.property('name', function() {\n                return item._name;\n            });\n            \n            this.property('parent', function() {\n                return item._parent;\n            });\n        \n        }\n        else {\n            \n            this._childrenWrapper = {\n                push: this.bind(this._pushChild),\n                forEach: this.bind(this._forEachChild)\n            };\n            \n            Object.defineProperty(this._childrenWrapper, 'length', {\n                get: this.bind(this._countChildren)\n            });\n            \n            (this._factory !== undefined)\n                ? this._class = this._factory.apply($thing, this._uses)\n                : undefined\n                ;\n            \n            if (this._class !== undefined) {\n                for(k in this._substitute)\n                    this._class[k] = this._substitute[k]\n                    ;\n                \n                var interfaces = (this._name !== undefined)\n                    ? this._interfaces.concat(this._name)\n                    : this._interfaces\n                    ;\n                \n                this._class.getInterfaces = function() {\n                    return this.$super().concat(interfaces);\n                };\n                \n                this._class = this._super.inherit(\n                    this._class,\n                    parent,\n                    this._isMobile\n                );\n                \n                $thing.attach(this);\n            }\n            \n            this.property('class', function() {\n                return this._class;\n            });\n            \n            this.property('refCount', function() {\n                return this._refCount;\n            });\n            \n            this.property('isAbstract', function() {\n                return this._isAbstract;\n            });\n            \n            this.property('isPassive', function() {\n                return this._isPassive;\n            });\n            \n            this.property('instance', function() {\n                return this._instance;\n            });\n            \n            this.property('state', function() {\n                return this._state;\n            });\n            \n            this.property('name', function() {\n                return this._name;\n            });\n            \n            this.property('parent', function() {\n                return this._parent;\n            });\n        }\n\n    },\n\n    _forEachChild: function(cb) {\n        this._children.forEach(function(args) {\n            (args[0].getHeapId !== undefined)\n                ? cb.apply(undefined, args)\n                : undefined\n                ;\n        });\n    },\n\n    _pushChild: function(obj) {\n        var id = obj.getHeapId();\n    \n        for(var i = 0; i < this._children.length; i++) {\n\n            if (this._children[i][0].getHeapId === undefined)\n                this._children.splice(i, 1);\n\n            else if (this._children[i][0].getHeapId() === id)\n                return this._children.length;\n\n        }\n    \n        return this._children.push(arguments);\n    },\n\n    _countChildren: function() {\n        var length = 0;\n        \n        this._forEachChild(function(child) {\n            if (child.getRefCount())\n                length++;\n        });\n        \n        return length;\n    },\n\n    parseStack: function(stack) {\n        var item,\n            match,\n            self = this\n            ;\n        \n        function replace() {\n            return (arguments[1] === undefined)\n                ? stack.shift()\n                : self._substitute['$' + arguments[1]] = stack.shift()\n                ;\n        }\n        \n        while(  this._state !== $thing.State.DEF_END &&\n                (item = stack.shift()) !== undefined\n        ) {\n        \n            switch(typeof item) {\n                case 'function':\n                    this._state = $thing.State.DEF_END;\n                    this._factory = item;\n                    continue;\n\n                case 'object':\n                    this._state = $thing.State.DEF_END;\n                    this._class = item;\n                    continue;\n            }\n            \n            switch(item) {\n                case 'abstract':\n                    this._isPassive = this._isAbstract = true;\n                    continue;\n\n                case 'source':\n                    this._state = $thing.State.DEF_SOURCE;\n                    continue;\n\n                case 'extends':\n                    this._state = $thing.State.DEF_EXTENDS;\n                    continue;\n\n                case 'implements':\n                    this._state = $thing.State.DEF_IMPLEMENTS;\n                    continue;\n\n                case 'uses':\n                    this._state = $thing.State.DEF_USES;\n                    continue;\n\n                default:\n                    (this._state === $thing.State.DEF_META || item.charAt(0) === '@')\n                        ? this._state = $thing.State.DEF_META\n                        : (item.match(/ /))\n                            ? this._state = $thing.State.DEF_DESC\n                            : undefined\n                            ;\n            }\n            \n            switch(this._state) {\n\n                case $thing.State.DEF_DESC:\n                    item = item.replace(/\\$\\((.+?)\\)|\\$/g, replace);\n                    \n                    item = item.split(' @');\n\n                    stack = item[0].split(/ +/).filter(Boolean).concat(\n                        (item[1] !== undefined)\n                            ? ['@' + item[1]].concat(stack)\n                            : stack\n                    );\n\n                    (this._name === undefined)\n                        ? this._state = $thing.State.DEF_NAME\n                        : this._state = $thing.State.DEF_NOP\n                        ;\n                    break;\n                    \n                case $thing.State.DEF_META:\n                    item = item.replace(/\\$\\((.+?)\\)|\\$/g, replace);\n                    \n                    if (item.charAt(item.length - 1) === '+') {\n                        stack = [\n                            item.slice(0, -1) + stack.shift()\n                        ].concat(stack);\n                    }\n                    else {\n                        this._state = $thing.State.DEF_DESC;\n                        this._meta.push(item.slice(1));\n                    }\n                    \n                    break;\n                \n                case $thing.State.DEF_NAME:\n                    this._name = item || this._name;\n                    break;\n                \n                case $thing.State.DEF_SOURCE:\n                    this._source = item || this._source;\n                    break;\n                \n                case $thing.State.DEF_EXTENDS:\n                    this._extends = item || this._extends;\n                    break;\n                \n                case $thing.State.DEF_IMPLEMENTS:\n                    ((match = item.match(/^\\/(.*?)\\/([gimy]*)$/)) !== null)\n                        ? this._interfaces.push(\n                            new RegExp(match[1], match[2])\n                        )\n                        : this._interfaces.push(item)\n                        ;\n                    break;\n                \n                case $thing.State.DEF_USES:\n                    this._uses.push($thing.agent(item));\n                    break;\n            }\n        }\n    },\n\n    patchObject: function(obj) {\n        var self = this;\n        \n        obj.refObject = this.bind(this.refObject);\n        \n        obj.getRefCount = function() {\n            return self._refCount;\n        };\n        \n        obj.getHeapId = function() {\n            return self._id;\n        };\n        \n        obj.getName = function() {\n            return self._name;\n        };\n        \n        obj.getSource = function() {\n            return self._source;\n        };\n        \n        obj.getChildren = function() {\n            return self._childrenWrapper;\n        };\n        \n        obj.getState = function() {\n            return self._state;\n        };\n        \n        obj.setState = function() {\n            var states = Array.prototype.slice.call(arguments, 0);\n            \n            states.forEach(function(state) {\n                self._state |= state;\n            });\n            \n            this.getChildren().forEach(function(child) {\n                child.setState(states);\n            });\n        };\n        \n        obj.unsetState = function() {\n            var states = Array.prototype.slice.call(arguments, 0);\n            \n            states.forEach(function(state) {\n                self._state &= ~state;\n            });\n            \n            this.getChildren().forEach(function(child) {\n                child.unsetState(states);\n            });\n        };\n        \n        obj.getMeta = function() {\n            return self._meta;\n        };\n        \n        obj.isAbstract = function() {\n            return self._isAbstract;\n        };\n        \n        return obj;\n    },\n\n    unpatchObject: function(obj) {\n        delete obj.refObject;\n        delete obj.getRefCount;\n        delete obj.getHeapId;\n        delete obj.getName;\n        delete obj.getSource;\n        delete obj.getChildren;\n        delete obj.getState;\n        delete obj.setState;\n        delete obj.unsetState;\n        delete obj.getMeta;\n        delete obj.isAbstract;\n        \n        return obj;\n    },\n\n    refObject: function(cb) {\n        var self = this;\n        \n        this.parent.refObject(function(parent, cbRelease) {\n            var constructed;\n            \n            if (self._refCount)\n                self._refCount++;\n            else {\n                self._refCount = constructed = 1;\n                self._instance = self.patchObject(new self._class());\n                self._instance.setState($thing.State.LIFE_INITIATED);\n            }\n            \n            if (constructed && self._isAgent && !self._isAbstract)\n                self._instance.setup();\n            cb(\n                self._instance,\n                function() {\n                    if (self._isAgent && self._isPassive) return;\n                    else if (--self._refCount !== 0) cbRelease();\n                    else {\n                        if (self._isAgent)\n                            self._instance.takedown(\n                                function() {\n                                    self._children = [];\n                                    self.unpatchObject(self._instance);\n                                    \n                                    delete self._instance;\n                                    \n                                    cbRelease();\n                                }\n                            );\n                        else {\n                            self._children = [];\n                            self.unpatchObject(self._instance);\n                            \n                            delete self._instance;\n                            \n                            cbRelease();\n                        }\n                    }\n                }\n            );\n        });\n    }\n\n});","/*\nCopyright (c) 2015 Simon Cullen, http://github.com/cullens\n\nPermission is hereby granted, free of charge, to any person\nobtaining a copy of this software and associated documentation\nfiles (the \"Software\"), to deal in the Software without\nrestriction, including without limitation the rights to use,\ncopy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the\nSoftware is furnished to do so, subject to the following\nconditions:\n\nThe above copyright notice and this permission notice shall be\nincluded in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\nEXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES\nOF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\nNONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\nHOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,\nWHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING\nFROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR\nOTHER DEALINGS IN THE SOFTWARE.\n*/\n'use strict';  \n\n/**\n * @class Delegate\n * @mixes $thing.Base\n * @memberOf $thing\n */\n$thing.Delegate = $thing.Base.inherit({\n\n    getName: function() {\n        return 'Delegate';\n    },\n\n    /**\n     * @memberOf $thing\n     * @method Delegate#getInterfaces\n     * @returns {string[]}\n     */\n    getInterfaces: function() {\n        return [];\n    },\n\n    /**\n     * @memberOf $thing\n     * @method Delegate#matchInterface\n     * @param {string} pattern\n     * @param {string} source\n     * @returns {string}\n     */\n    matchInterface: function(pattern) {\n        var interfaces = this.getInterfaces();\n\n        for(var i = 0; i < interfaces.length; i++)\n            if ((interfaces[i] instanceof RegExp)\n                    ? pattern.match(interfaces[i]) !== null\n                    : interfaces[i] === pattern\n            ) break;\n            \n        return interfaces[i];\n    },\n\n    /**\n     * @memberOf $thing\n     * @method Delegate#refObject\n     */\n    refObject: function(cb) {\n        cb(this, function(){});\n    },\n\n    /**\n     * @memberOf $thing\n     * @method Delegate#dispatch\n     * @param {object} call\n     */\n    dispatch: function(call, cb) {\n        var method,\n            signature\n            ;\n\n        cb = cb || function() {};\n            \n        // Don't dispatch to unpatched delegates\n        //if (this.getRefCount === undefined) return cb();\n\n        // Don't dispatch to methods with $ prefix \n        if (call.method.charAt(0) === '$') return cb(); \n\n        // Check for method name prefixed with interface\n        (this[method = call.interface + '.' + call.method] === undefined)\n            ? (this[method = call.method] === undefined)\n                ? method = undefined\n                : undefined\n            : undefined\n            ;\n\n            // Check method has a name\n        (   method === undefined ||\n            // Does the signature for the method exist\n            (signature = this.$signatures[method]) === undefined ||\n            // Last argument of signature must be prefixed with $ \n            signature[signature.length - 1].charAt(0) !== '$' ||\n            // Number of signature arguments must match the number of\n            // call arguments plus callback object\n            signature.length !== call.args.length + 1\n        )\n            // Didn't match, check for catch all\n            ? ( this[method = this.$__catchall__] === undefined ||\n            // Catch all signature must exist\n                (signature = this.$signatures[method]) === undefined ||\n                // Last argument is prefix with $\n                signature[1].charAt(0) !== '$' ||\n                // 2 arguments\n                signature.length !== 2\n            )\n                // Didn't match, skip call\n                ? cb()\n                // Matched, call catch all\n                : this[this.$__catchall__].apply(\n                    this,\n                    [call.args, cb]\n                )\n            // Matched, make call\n            : this[method].apply(\n                this,\n                call.args.concat(cb)\n            )\n            ;\n    }\n\n});","/*\nCopyright (c) 2015 Simon Cullen, http://github.com/cullens\n\nPermission is hereby granted, free of charge, to any person\nobtaining a copy of this software and associated documentation\nfiles (the \"Software\"), to deal in the Software without\nrestriction, including without limitation the rights to use,\ncopy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the\nSoftware is furnished to do so, subject to the following\nconditions:\n\nThe above copyright notice and this permission notice shall be\nincluded in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\nEXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES\nOF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\nNONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\nHOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,\nWHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING\nFROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR\nOTHER DEALINGS IN THE SOFTWARE.\n*/\n'use strict';\n    \n$thing.Pattern = $thing.Delegate.inherit({\n\n    getName: function() {\n        return 'Pattern';\n    },\n\n    /**\n     * @constructs Pattern\n     * @mixes $thing.Delegate\n     * @memberOf $thing\n     * @param {(string|string[])} pattern\n     * @param {string} source\n     */\n    init: function(pattern, source) {\n        this.$super();\n        this._pattern = pattern;\n        this.property('source', function() {\n            return source;\n        });\n    },\n\n    /**\n     * @memberOf $thing\n     * @method Pattern#toArray\n     * @returns {string[]}\n     */\n    toArray: function() {\n        return (this._pattern instanceof Array)\n            ? this._pattern\n            : [[this._pattern]]\n            ;\n    }\n\n});","/*\nCopyright (c) 2015 Simon Cullen, http://github.com/cullens\n\nPermission is hereby granted, free of charge, to any person\nobtaining a copy of this software and associated documentation\nfiles (the \"Software\"), to deal in the Software without\nrestriction, including without limitation the rights to use,\ncopy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the\nSoftware is furnished to do so, subject to the following\nconditions:\n\nThe above copyright notice and this permission notice shall be\nincluded in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\nEXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES\nOF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\nNONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\nHOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,\nWHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING\nFROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR\nOTHER DEALINGS IN THE SOFTWARE.\n*/\n'use strict';\n\n/**\n * @class Agent\n * @mixes $thing.Delegate\n * @memberOf $thing\n */\n$thing.Agent = $thing.Delegate.inherit({\n\n    getName: function() {\n        return 'Agent';\n    },\n\n    getInterfaces: function() {\n        return ['Agent'];\n    },\n\n    /**\n     * @memberOf $thing\n     * @method Agent#setup\n     */\n    setup: function(cb) {\n        this.setState($thing.State.LIFE_ACTIVE);\n        this.doActivate(cb);\n    },\n\n    /**\n     * @memberOf $thing\n     * @method Agent#takedown\n     */\n    takedown: function(cb) {\n        this.doDelete(cb);\n    },\n\n    /**\n     * @memberOf $thing\n     * @method Agent#doActivate\n     */\n    doActivate: function(cb) {\n        this.unsetState($thing.State.LIFE_SUSPENDED);\n        if (cb) cb();\n        $thing.agent();\n    },\n\n    /**\n     * @memberOf $thing\n     * @method Agent#doDelete\n     */\n    doDelete: function(cb) {\n        this.setState($thing.State.LIFE_DELETED);\n        if (cb) cb();\n        $thing.agent();\n    },\n\n    /**\n     * @memberOf $thing\n     * @method Agent#doSuspend\n     */\n    doSuspend: function(cb) {\n        this.setState($thing.State.LIFE_SUSPENDED);\n        if (cb) cb();\n        $thing.agent();\n    },\n\n    /**\n     * @memberOf $thing\n     * @method Agent#doWait\n     */\n    doWait: function(cb) {\n        this.setState($thing.State.LIFE_WAITING);\n        if (cb) cb();\n        $thing.agent();\n    },\n\n    /**\n     * @memberOf $thing\n     * @method Agent#doWake\n     */\n    doWake: function(cb) {\n        this.unsetState($thing.State.LIFE_WAITING);\n        if (cb) cb();\n        $thing.agent();\n    },\n\n    /**\n     * @memberOf $thing\n     * @method Agent#addBehaviour\n     * @param {*}\n     * @returns {$thing.Behaviour}\n     */\n    addBehaviour: function() {\n        var obj,\n            reset,\n            self = this,\n            args = Array.prototype.slice.call(arguments, 0),\n            def = new $thing.Definition(\n                this,\n                $thing.Behaviour,\n                $thing.getBacktrace(1)[0],\n                args\n            )\n            ;\n\n        if (def.class !== undefined) {\n            var funct = function() {\n\n                (!def.refCount)\n                    ? def.refObject(function(instance, cbRelease) {\n                        $thing.attach(def);\n                        obj = instance;\n                        self.getChildren().push(obj, cbRelease);\n                    })\n                    : obj = def.instance\n                    ;\n                    \n                obj.unsetState(\n                    $thing.State.LIFE_WAITING |\n                    $thing.State.LIFE_SUSPENDED |\n                    $thing.State.LIFE_DELETED |\n                    $thing.State.LIFE_TRANSIT |\n                    $thing.State.LIFE_BLOCKED\n                );\n                \n                obj.setState(self.getState() | $thing.State.LIFE_ACTIVE);\n                \n                $thing.agent();\n            };\n            \n            funct();\n            \n            reset = obj.reset;\n            \n            obj.reset = function() {\n                funct();\n                reset.apply(obj, arguments);\n            };\n        }\n        \n        return obj;\n    },\n\n    /**\n     * @memberOf $thing\n     * @method Agent#removeBehaviour\n     * @param {string|$thing.Behaviour}\n     */\n    removeBehaviour: function() {\n        var objs = [],\n            children = this.getChildren()\n            ;\n            \n        if (typeof arguments[0] === 'object' &&\n            arguments[0].getHeapId !== undefined\n        ) {\n            var id = arguments[0].getHeapId();\n            \n            children.forEach(function(obj, cbRelease) {\n                if (obj.getHeapId() === id) {\n                    obj.setState($thing.State.LIFE_DELETED);\n                    cbRelease();\n                    objs.push(obj);\n                }\n            });\n        }\n        else {\n            var args = Array.prototype.slice.call(arguments, 0),\n                def = new $thing.Definition(\n                    this,\n                    $thing.Behaviour,\n                    $thing.getBacktrace(1)[0],\n                    args\n                )\n                ;\n                \n            children.forEach(function(obj, cbRelease) {\n                if (obj.getName() === def.name) {\n                    obj.setState($thing.State.LIFE_DELETED);\n                    cbRelease();\n                    objs.push(obj);\n                }\n            });\n        }\n\n        return objs;\n    }\n\n});\n","/*\nCopyright (c) 2015 Simon Cullen, http://github.com/cullens\n\nPermission is hereby granted, free of charge, to any person\nobtaining a copy of this software and associated documentation\nfiles (the \"Software\"), to deal in the Software without\nrestriction, including without limitation the rights to use,\ncopy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the\nSoftware is furnished to do so, subject to the following\nconditions:\n\nThe above copyright notice and this permission notice shall be\nincluded in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\nEXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES\nOF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\nNONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\nHOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,\nWHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING\nFROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR\nOTHER DEALINGS IN THE SOFTWARE.\n*/\n'use strict';    \n\n/**\n * @class Behaviour\n * @mixes $thing.Delegate\n * @memberOf $thing\n */\n$thing.Behaviour = $thing.Delegate.inherit({\n\n    getName: function() {\n        return 'Behaviour';\n    },\n\n    getInterfaces: function() {\n        return [\n            'Behaviour', \n            'parent:' + this.$parent.$id,\n            'owner:' + this.$owner.$id\n        ];\n    },\n\n    done: function() {\n        return false;\n    },\n\n    action: function($cb) {\n        if (this.done()) \n            this.$owner.removeBehaviour(this);\n            \n        if ($cb) $cb();\n    },\n\n    block: function(cb) {\n        this.setState($thing.State.LIFE_BLOCKED);\n        if (cb) cb();\n    },\n\n    restart: function(cb) {\n        this.unsetState($thing.State.LIFE_BLOCKED);\n        if (cb) cb();\n    },\n\n    reset: function(cb) {\n        if (cb) cb();\n    }\n\n});","/*\nCopyright (c) 2015 Simon Cullen, http://github.com/cullens\n\nPermission is hereby granted, free of charge, to any person\nobtaining a copy of this software and associated documentation\nfiles (the \"Software\"), to deal in the Software without\nrestriction, including without limitation the rights to use,\ncopy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the\nSoftware is furnished to do so, subject to the following\nconditions:\n\nThe above copyright notice and this permission notice shall be\nincluded in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\nEXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES\nOF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\nNONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\nHOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,\nWHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING\nFROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR\nOTHER DEALINGS IN THE SOFTWARE.\n*/\n'use strict';\n\n$thing.Filter = {\n    ALL:            1,\n    FIRST:          2,\n    LAST:           4\n};\n\n$thing.Selector = $thing.Base.inherit({\n\n    getName: function() {\n        return 'Selector';\n    },\n\n    /**\n     * @constructs Selector\n     * @mixes $thing.Base\n     * @memberOf $thing\n     * @param {(string|string[]|$thing.Pattern)} pattern\n     * @param {string} source\n     * @param {boolean} [includePassive=true]\n     */\n    init: function(pattern, source, includePassive) {\n        var i,\n            include,\n            def\n            ;\n        \n        this.$super();\n\n        this._source = source;\n        this._exprs = [];\n        this._selection = [];\n        this._callbacks = [];\n        \n        if (pattern instanceof $thing.Pattern) {\n            this._source = pattern.source;\n            pattern = pattern.toArray();\n        }\n        else if (typeof pattern === 'string') {\n            var expr = {\n                and: {},\n                not: {}\n            };\n            \n            expr.and[pattern] = true;\n            \n            this._exprs.push(expr);\n        }\n        \n        if (pattern instanceof Array) {\n            for(i = 0; i < pattern.length; i++) {\n                this.parseStack(pattern[i]);\n            }\n        }\n        \n        includePassive =\n            (includePassive === undefined)\n                ? true\n                : includePassive\n                ;\n\n        for(i = 0; i < $thing.heap.length; i++) {\n            def = $thing.heap[i];\n            \n            include = (def.isPassive)\n                ? (def.isPassive & includePassive) &&\n                    def.state < $thing.State.LIFE_SUSPENDED\n                : (includePassive)\n                    ? def.state < $thing.State.LIFE_SUSPENDED\n                    : def.state < $thing.State.LIFE_WAITING\n                    ;\n\n            if (!def.isAbstract &&\n                def.refCount > 0 &&\n                def.state & $thing.State.LIFE_ACTIVE &&\n                include\n            )\n                def.refObject(this.bind(this.matchObject));\n\n        }\n        \n        this.property('length', function() {\n            return this._selection.length;\n        });\n    },\n\n    parseStack: function(stack) {\n        var k,\n            item,\n            state = $thing.State.EXPR_AND,\n            expr = {\n                and: {},\n                not: {}\n            }\n            ;\n        \n        while((item = stack.shift()) !== undefined) {\n            \n            switch(item) {\n                case 'and':\n                    state = $thing.State.EXPR_AND;\n                    continue;\n                \n                case 'not':\n                    state = $thing.State.EXPR_NOT;\n                    continue;\n                \n                case 'or':\n                    state = $thing.State.EXPR_OR;\n                    continue;\n            }\n\n            switch(state) {\n                case $thing.State.EXPR_AND:\n                    expr.and[item] = true;\n                    break;\n                \n                case $thing.State.EXPR_NOT:\n                    expr.not[item] = true;\n                    break;\n                \n                case $thing.State.EXPR_OR:\n                    for (k in expr.and) {\n                        this._exprs.push(expr);\n                        break;\n                    }\n                    \n                    expr = {\n                        and: {},\n                        not: {}\n                    };\n                    \n                    expr.and[item] = true;\n                    break;\n            }\n        }\n        \n        for (k in expr.and) {\n            this._exprs.push(expr);\n            break;\n        }\n    },\n\n    matchObject: function(obj, cbRelease) {\n        var k,\n            match\n            ;\n        \n        for (var i = 0; i < this._exprs.length; i++) {\n            var m,\n                expr = this._exprs[i]\n                ;\n            \n            for(k in expr.and)\n                if ((m = obj.matchInterface(k, this._source)) !== undefined)\n                    match = match || m;\n                else {\n                    match = undefined;\n                    break;\n                }\n                \n            if (match === undefined)\n                continue;\n                \n            for(k in expr.not)\n                if (obj.matchInterface(k, this._source)) {\n                    match = undefined;\n                    cbRelease();\n                    return;\n                }\n\n            if (match !== undefined)\n                break;\n        }\n            \n        if (match === undefined)\n            cbRelease();\n        else {\n            this._callbacks.push(cbRelease);\n            this._selection.push({match: match, obj: obj});\n        }\n    \n    },\n\n    dispatch: function(call, cbItem, cbDone) {\n        $thing.async.setImmediate(this.bind(function() {\n\n            if (call.filters & $thing.Filter.FIRST &&\n                this._selection.length > 0\n            ) {\n\n                this._selection[0].obj.dispatch(\n                    {   interface: this._selection[0].match,\n                        method: call.method,\n                        args: call.args\n                    },\n                    this.bind(function() {\n                        return cbItem.apply(\n                            this._selection[0].obj,\n                            Array.prototype.slice.call(\n                                arguments,\n                                0\n                            ).concat(cbDone)\n                        );\n                    })\n                );\n\n            }\n            else if (   call.filters & $thing.Filter.LAST &&\n                        this._selection.length > 0\n            ) {\n                var i = this._selection.length - 1;\n\n                this._selection[i].obj.dispatch(\n                    {   interface: this._selection[i].match,\n                        method: call.method,\n                        args: call.args\n                    },\n                    this.bind(function() {\n                        return cbItem.apply(\n                            this._selection[i].obj,\n                            Array.prototype.slice.call(\n                                arguments,\n                                0\n                            ).concat(cbDone)\n                        );\n                    })\n                );\n            }\n            else if (   call.filters & $thing.Filter.ALL &&\n                        this._selection.length > 0\n            ) {\n\n                $thing.async.each(\n                    this._selection,\n                    function(item, cbNext) {\n                        item.obj.dispatch(\n                            {   interface: item.match,\n                                method: call.method,\n                                args: call.args\n                            },\n                            function() {\n                                return cbItem.apply(\n                                    item.obj,\n                                    Array.prototype.slice.call(\n                                        arguments,\n                                        0\n                                    ).concat(cbNext)\n                                );\n                            }\n                        );\n                    },\n                    cbDone\n                );\n            \n            }\n            else {\n\n                cbDone();\n\n            }\n\n        }));\n    },\n\n    release: function() {\n        for(var i = 0; i < this._callbacks.length; i++)\n            this._callbacks[i]();\n        this._callbacks = [];\n        this._selection = [];\n    }\n\n});","/*\nCopyright (c) 2015 Simon Cullen, http://github.com/cullens\n\nPermission is hereby granted, free of charge, to any person\nobtaining a copy of this software and associated documentation\nfiles (the \"Software\"), to deal in the Software without\nrestriction, including without limitation the rights to use,\ncopy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the\nSoftware is furnished to do so, subject to the following\nconditions:\n\nThe above copyright notice and this permission notice shall be\nincluded in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\nEXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES\nOF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\nNONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\nHOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,\nWHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING\nFROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR\nOTHER DEALINGS IN THE SOFTWARE.\n*/\n'use strict';\n\n/**\n * @class Container\n * @mixes $thing.Agent\n * @memberOf $thing\n */\n$thing.Container = new ($thing.Agent.inherit({\n    \n    getName: function() {\n        return 'Container';\n    },\n    \n    getInterfaces: function() {\n        return ['Container'];\n    },\n    \n    setup: undefined,\n    takedown: undefined,\n    addBehaviour: undefined,\n    removeBehaviour: undefined\n\n}))();\n","/*\nCopyright (c) 2015 Simon Cullen, http://github.com/cullens\n\nPermission is hereby granted, free of charge, to any person\nobtaining a copy of this software and associated documentation\nfiles (the \"Software\"), to deal in the Software without\nrestriction, including without limitation the rights to use,\ncopy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the\nSoftware is furnished to do so, subject to the following\nconditions:\n\nThe above copyright notice and this permission notice shall be\nincluded in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\nEXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES\nOF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\nNONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\nHOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,\nWHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING\nFROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR\nOTHER DEALINGS IN THE SOFTWARE.\n*/\n'use strict';\n\n$thing.WAKE_MIN_PERIOD = 50000;\n$thing.nextWakeTime = $thing.getMicroTime();\n$thing.isActionTaskQueued = false;\n\n$thing.wakeTask = function() {\n    var now = $thing.getMicroTime();\n\n    if (now >= $thing.nextWakeTime) {\n\n        var selector = new $thing.Selector(\n                [['Behaviour', 'and', 'Waker']], \n                '$thing', \n                false\n            )\n            ;\n\n        if (selector.length === 0) {\n            selector.release();\n            selector = undefined;\n        }\n        else {\n            selector.dispatch(\n                {   filters: $thing.Filter.ALL,\n                    method: 'action',\n                    args: []\n                },\n                function(cbNext) {\n                    cbNext();\n                },\n                function() {\n                    selector.release();\n                    selector = undefined;\n                }\n            );\n        }\n\n        $thing.nextWakeTime =   \n            now + $thing.WAKE_MIN_PERIOD - (now % $thing.WAKE_MIN_PERIOD);\n    }\n};\n\n$thing.enqueueActionTask = function() {\n    if ($thing.isActionTaskQueued) return;\n    $thing.isActionTaskQueued = true;\n\n    $thing.async.setImmediate(function() {\n        var selector = new $thing.Selector(\n                [['Behaviour', 'not', 'Waker']], \n                '$thing', \n                false\n            )\n            ;\n        \n        if (selector.length === 0) {\n            selector.release();\n            selector = undefined;\n            $thing.isActionTaskQueued = false;\n        }\n        else {\n            selector.dispatch(\n                {   filters: $thing.Filter.ALL,\n                    method: 'action',\n                    args: []\n                },\n                function(cbNext) {\n                    cbNext();\n                },\n                function() {\n                    selector.release();\n                    selector = undefined;\n                    $thing.isActionTaskQueued = false;\n                    $thing.enqueueActionTask();\n                }\n            );\n        }\n\n    });\n\n};\n\n/**\n * @class Heartbeat\n * @mixes $thing.Agent\n * @abstract\n * @singleton\n */\n$thing.agent(\n    '@singleton', \n    'abstract Heartbeat implements Container', {\n\n        setup: function(cb) {\n            this.$super(cb);\n            \n            this.keepAlive = this.addBehaviour('@passive', {});\n\n            this.intervalId = setInterval(\n                $thing.agent, \n                $thing.WAKE_MIN_PERIOD / 1000\n            );\n        },\n            \n        /**\n         * @method Heartbeat#destroy\n         */\n        destroy: function($cb) {\n                \n            clearInterval(this.intervalId);\n\n            this.removeBehaviour(this.keepAlive);\n\n            $cb();\n        }\n    }\n);","/*\nCopyright (c) 2015 Simon Cullen, http://github.com/cullens\n\nPermission is hereby granted, free of charge, to any person\nobtaining a copy of this software and associated documentation\nfiles (the \"Software\"), to deal in the Software without\nrestriction, including without limitation the rights to use,\ncopy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the\nSoftware is furnished to do so, subject to the following\nconditions:\n\nThe above copyright notice and this permission notice shall be\nincluded in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\nEXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES\nOF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\nNONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\nHOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,\nWHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING\nFROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR\nOTHER DEALINGS IN THE SOFTWARE.\n*/\n'use strict';\n\n$thing.agent('@singleton', {\n    \n    setup: function(cb) {\n        this.$super(cb);\n\n        /**\n         * @class Flow\n         * @abstract\n         * @mixes $thing.Behaviour\n         */\n        this.addBehaviour('abstract Flow', {\n\n            /**\n             * @method Flow#getFlow\n             * @returns {function[]}\n             */\n            getFlow: function() {\n                var self = this,\n                    reset = this.reset,\n                    getFlow = this.getFlow,\n                    methods = [],\n                    names = [],\n                    args = Array.prototype.slice.call(arguments, 0)\n                    ;\n                    \n                args.forEach(function(item) {\n                    if (names.indexOf(item) === -1)\n                        names.push(item);\n                });\n                    \n                $thing.searchMeta(this, 'flow', function() {\n                    Array.prototype.slice.call(arguments, 0).forEach(\n                        function(item) {\n                            if (names.indexOf(item) === -1)\n                                names.push(item);\n                        }\n                    );\n                });\n\n                names.forEach(function(item) {\n                    if (self.$signatures[item] !== undefined &&\n                        self.$signatures[item]\n                        [self.$signatures[item].length - 1].charAt(0) === '$'\n                    )\n                        methods.push(function() {\n                            var cbYield = arguments[arguments.length - 1],\n                                args = Array.prototype.slice.call(\n                                    arguments,\n                                    0,\n                                    arguments.length - 1\n                                )\n                                ;\n                                \n                            args.push(function() {\n                                var args = arguments;\n                                    \n                                return (args.length === 0)\n                                    ? cbYield()\n                                    : function() {\n                                        // This needs improvement                                  \n                                        $thing.agent(new ($thing.Agent.inherit({\n\n                                            done: function($cb) {\n                                                var i = names.indexOf(item);\n                                                    \n                                                names.splice(i, 1);\n                                                methods.splice(i, 1);\n                                                \n                                                $cb();\n                                                cbYield();\n                                            },\n                                                    \n                                            yield: function($cb) {\n                                                $cb();\n                                                cbYield();\n                                            }\n\n                                        }))())\n                                        .apply($thing, args)\n                                        .apply($thing, [])\n                                        ;\n                                    }\n                                    ;\n                            });\n                            \n                            self[item].apply(self, args);\n                        \n                        });\n                               \n                });\n                    \n                this.reset = function(cb) {\n                    this.getFlow = getFlow;\n                    return reset.apply(this, [cb]);\n                };\n                    \n                this.getFlow = function() {\n                    return methods;\n                };\n                    \n                return methods;\n            },\n\n            action: function($cb) {\n                if (!this.getFlow().length)\n                    this.done = function() {\n                        return true;\n                    };\n                            \n                this.$super($cb);\n            },\n                \n            done: function() {\n                return false;\n            }\n\n        });\n    }\n\n});","/*\nCopyright (c) 2015 Simon Cullen, http://github.com/cullens\n\nPermission is hereby granted, free of charge, to any person\nobtaining a copy of this software and associated documentation\nfiles (the \"Software\"), to deal in the Software without\nrestriction, including without limitation the rights to use,\ncopy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the\nSoftware is furnished to do so, subject to the following\nconditions:\n\nThe above copyright notice and this permission notice shall be\nincluded in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\nEXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES\nOF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\nNONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\nHOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,\nWHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING\nFROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR\nOTHER DEALINGS IN THE SOFTWARE.\n*/\n'use strict';\n\n$thing.agent('@singleton', {\n    \n    setup: function(cb) {\n        this.$super(cb);\n    \n        /**\n         * @class Series\n         * @mixes Flow\n         * @abstract\n         */\n        this.addBehaviour('abstract Series extends Flow', {\n    \n            action: function($cb) {\n                $thing.async.series(\n                    this.getFlow(),\n                    this.bind(function() {\n                        this.$super($cb);\n                    })\n                );\n            }\n    \n        });\n    }\n\n});","/*\nCopyright (c) 2015 Simon Cullen, http://github.com/cullens\n\nPermission is hereby granted, free of charge, to any person\nobtaining a copy of this software and associated documentation\nfiles (the \"Software\"), to deal in the Software without\nrestriction, including without limitation the rights to use,\ncopy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the\nSoftware is furnished to do so, subject to the following\nconditions:\n\nThe above copyright notice and this permission notice shall be\nincluded in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\nEXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES\nOF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\nNONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\nHOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,\nWHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING\nFROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR\nOTHER DEALINGS IN THE SOFTWARE.\n*/\n'use strict';\n\n$thing.agent('@singleton', {\n    \n    setup: function(cb) {\n        this.$super(cb);\n    \n        /**\n         * @class Parallel\n         * @mixes Flow\n         * @abstract\n         */\n        this.addBehaviour('abstract Parallel extends Flow', {\n    \n            action: function($cb) {\n                $thing.async.parallel(\n                    this.getFlow(),\n                    this.bind(function() {\n                        this.$super($cb);\n                    })\n                );\n            }\n    \n        });\n    }\n\n});","/*\nCopyright (c) 2015 Simon Cullen, http://github.com/cullens\n\nPermission is hereby granted, free of charge, to any person\nobtaining a copy of this software and associated documentation\nfiles (the \"Software\"), to deal in the Software without\nrestriction, including without limitation the rights to use,\ncopy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the\nSoftware is furnished to do so, subject to the following\nconditions:\n\nThe above copyright notice and this permission notice shall be\nincluded in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\nEXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES\nOF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\nNONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\nHOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,\nWHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING\nFROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR\nOTHER DEALINGS IN THE SOFTWARE.\n*/\n'use strict';\n\n$thing.agent('@singleton', {\n    \n    setup: function(cb) {\n        this.$super(cb);\n    \n        /**\n         * @class Queue\n         * @mixes Flow\n         * @abstract\n         */\n        this.addBehaviour('abstract Queue extends Flow', {\n        \n            /**\n            * @method Queue#getQueue\n            */\n            getQueue: function() {\n                var self = this,\n                    concurrency = 1,\n                    limit = 0,\n                    functs = [],\n                    active = 0,\n                    paused = false\n                    ;\n\n                $thing.searchMeta(this, 'concurrency', 'int', function(value) {\n                    concurrency = value;\n                });\n            \n                $thing.searchMeta(this, 'limit', 'int', function(value) {\n                    limit = value;\n                });\n            \n                var queue = {\n                \n                    push: function(item, cbItem) {\n                    \n                        if (limit && functs.length > limit - 1) {\n                            cbItem(-1);\n                            return;\n                        }\n                    \n                        if (!paused)\n                            self.unsetState($thing.State.LIFE_WAITING);\n                    \n                        functs.push(function(cbDone) {\n                            var flow = self.getFlow();\n                        \n                            if (!flow.length) {\n                                cbDone();\n                                cbItem(-1);\n                            }\n                            else {\n                                $thing.async.applyEach(\n                                    flow,\n                                    item,\n                                    function(err) {\n                                        cbDone();\n                                        cbItem(err);\n                                    }\n                                );\n                            }\n                    \n                        });\n                \n                    },\n                \n                    action: function(next, cb) {\n                        var call = [],\n                            length = (functs.length < concurrency)\n                                ? functs.length\n                                : concurrency\n                                ;\n                    \n                        while(length--)\n                            call.push(functs.shift());\n                        \n                        if (call.length > 0) {\n                            active = call.length;\n                            \n                            $thing.async.parallel(call, function() {\n                                active = 0; \n                                next(cb);\n                            });\n                        }\n                        else {\n                            self.setState($thing.State.LIFE_WAITING);\n                            next(cb);\n                        }\n                    },\n                \n                    pause: function() {\n                        if (!paused) {\n                            paused = true;\n                            self.setState($thing.State.LIFE_WAITING);\n                        }\n                    },\n                \n                    resume: function() {\n                        if (paused) {\n                            paused = false;\n                            self.unsetState($thing.State.LIFE_WAITING);\n                            $thing.agent();\n                        }\n                    }   \n        \n                };\n        \n                Object.defineProperty(queue, 'length', {\n                    get: function() {\n                        return active + functs.length;\n                    }\n                });\n        \n                this.getQueue = function() {\n                    return queue;\n                };\n        \n                return queue;\n            },\n    \n            action: function($cb) {\n                this.getQueue().action(this.bind(this.$super), $cb);\n            },\n    \n            /**\n             * @method Queue#push\n             */\n            push: function(items, $cb) {\n                if (items instanceof Array) {\n                    var self = this,\n                        length = items.length,\n                        errs = [],\n                        ret\n                        ;\n            \n                    items.forEach(function(item, i) {\n                        self.getQueue().push(item, function(err) {\n                            ret = (errs[i] = err) || ret;\n                    \n                            if (!--length)\n                                (ret)\n                                    ? $cb('doneWithError', errs)()\n                                    : $cb('done')()\n                                    ;            \n                            });\n                    });\n                }\n                else {\n                    this.getQueue().push(items, function(err) {\n                        (err)\n                            ? $cb('doneWithError', err)()\n                            : $cb('done')()\n                            ;\n                    });\n                }\n        \n                $thing.agent();\n            },\n    \n            pause: function($cb) {\n                this.getQueue().pause();\n                $cb();\n            },\n    \n            resume: function($cb) {\n                this.getQueue().resume();\n                $cb();\n            }\n\n        });\n    }\n\n});","/*\nCopyright (c) 2015 Simon Cullen, http://github.com/cullens\n\nPermission is hereby granted, free of charge, to any person\nobtaining a copy of this software and associated documentation\nfiles (the \"Software\"), to deal in the Software without\nrestriction, including without limitation the rights to use,\ncopy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the\nSoftware is furnished to do so, subject to the following\nconditions:\n\nThe above copyright notice and this permission notice shall be\nincluded in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\nEXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES\nOF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\nNONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\nHOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,\nWHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING\nFROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR\nOTHER DEALINGS IN THE SOFTWARE.\n*/\n'use strict';\n\n$thing.agent('@singleton', {\n    \n    setup: function(cb) {\n        this.$super(cb);\n    \n        /**\n         * @class Waker\n         * @mixes Behaviour\n         * @abstract\n         */\n        this.addBehaviour('abstract Waker', {\n\n            /**\n             * @method Waker#getWakeTime\n             */\n            getWakeTime: function() {\n                var time,\n                    period = 1000000,\n                    now = $thing.getMicroTime()\n                    ;\n\n                $thing.searchMeta(this, 'period', 'int', function(value) {\n                    period = value * 1000;\n                });\n\n                time = now + period - (now % period);\n\n                this.getWakeTime = function() {\n                    return time;\n                };\n                        \n                return this.getWakeTime();\n            },\n\n            /**\n             * @method Waker#wake\n             */\n            wake: function(cb) {\n                cb();\n            },\n\n            action: function($cb) {\n                var time = this.getWakeTime();\n\n                if (time === undefined) \n                    return this.$super($cb);\n                else if ($thing.getMicroTime() >= time) {\n                    this.getWakeTime = function() {\n                        return undefined;\n                    };\n                    \n                    return this.wake(\n                        this.bind(function() {\n                            this.$super($cb);\n                        })\n                    );\n                }\n\n                this.$super($cb);\n            },\n\n            done: function() {\n                if (this.getWakeTime() !== undefined)\n                    return false;\n                else {\n                    delete this.getWakeTime;\n                    return true;\n                }\n            },\n\n            reset: function($cb) {\n                delete this.getWakeTime;\n                this.$super($cb);\n            },\n\n            /**\n             * @method Waker#stop\n             */\n            stop: function($cb) {\n                this.$owner.removeBehaviour(this);\n                delete this.getWakeTime;\n                if ($cb) $cb();\n            }\n \n        });\n    }\n\n});","/*\nCopyright (c) 2015 Simon Cullen, http://github.com/cullens\n\nPermission is hereby granted, free of charge, to any person\nobtaining a copy of this software and associated documentation\nfiles (the \"Software\"), to deal in the Software without\nrestriction, including without limitation the rights to use,\ncopy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the\nSoftware is furnished to do so, subject to the following\nconditions:\n\nThe above copyright notice and this permission notice shall be\nincluded in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\nEXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES\nOF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\nNONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\nHOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,\nWHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING\nFROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR\nOTHER DEALINGS IN THE SOFTWARE.\n*/\n'use strict';\n\n$thing.agent('@singleton', 'Util', {\n\n    setup: function(cb) {\n        this.$super(cb);\n\n        /**\n         * @class Done\n         * @mixes $thing.Behaviour\n         */\n        this.addBehaviour(\n            '@passive',\n            '@catchall catchAll',\n            'Done', {\n                catchAll: function(args, $cb) {\n                    $cb('done')();\n                }\n            }\n        );\n\n        /**\n         * @class Error\n         * @mixes $thing.Behaviour\n         */\n        this.addBehaviour(\n            '@passive',\n            '@catchall catchAll',\n            'Error', {\n                catchAll: function(args, $cb) {\n                    $cb('doneWithError', -1)();\n                }\n            }\n        );\n\n        /**\n         * @class Sensor\n         * @mixes Queue\n         * @abstract\n         */\n        this.addBehaviour('abstract Sensor extends Queue');\n\n        /**\n         * @class Actuator\n         * @mixes Queue\n         * @abstract\n         */\n        this.addBehaviour('abstract Actuator extends Queue');\n\n        /**\n         * @class Bridge\n         * @mixes Queue\n         * @abstract\n         */\n        this.addBehaviour(\n            'abstract Bridge extends Queue implements Actuator Sensor'\n        );\n    }\n    \n});"]}