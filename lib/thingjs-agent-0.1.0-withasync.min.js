!function(){function only_once(fn){var called=!1;return function(){if(called)throw new Error("Callback was already called.");called=!0,fn.apply(root,arguments)}}var root,previous_async,async={};root=this,null!=root&&(previous_async=root.async),async.noConflict=function(){return root.async=previous_async,async};var _toString=Object.prototype.toString,_isArray=Array.isArray||function(obj){return"[object Array]"===_toString.call(obj)},_each=function(arr,iterator){if(arr.forEach)return arr.forEach(iterator);for(var i=0;i<arr.length;i+=1)iterator(arr[i],i,arr)},_map=function(arr,iterator){if(arr.map)return arr.map(iterator);var results=[];return _each(arr,function(x,i,a){results.push(iterator(x,i,a))}),results},_reduce=function(arr,iterator,memo){return arr.reduce?arr.reduce(iterator,memo):(_each(arr,function(x,i,a){memo=iterator(memo,x,i,a)}),memo)},_keys=function(obj){if(Object.keys)return Object.keys(obj);var keys=[];for(var k in obj)obj.hasOwnProperty(k)&&keys.push(k);return keys};"undefined"!=typeof process&&process.nextTick?(async.nextTick=process.nextTick,async.setImmediate="undefined"!=typeof setImmediate?function(fn){setImmediate(fn)}:async.nextTick):"function"==typeof setImmediate?(async.nextTick=function(fn){setImmediate(fn)},async.setImmediate=async.nextTick):(async.nextTick=function(fn){setTimeout(fn,0)},async.setImmediate=async.nextTick),async.each=function(arr,iterator,callback){function done(err){err?(callback(err),callback=function(){}):(completed+=1,completed>=arr.length&&callback())}if(callback=callback||function(){},!arr.length)return callback();var completed=0;_each(arr,function(x){iterator(x,only_once(done))})},async.forEach=async.each,async.eachSeries=function(arr,iterator,callback){if(callback=callback||function(){},!arr.length)return callback();var completed=0,iterate=function(){iterator(arr[completed],function(err){err?(callback(err),callback=function(){}):(completed+=1,completed>=arr.length?callback():iterate())})};iterate()},async.forEachSeries=async.eachSeries,async.eachLimit=function(arr,limit,iterator,callback){var fn=_eachLimit(limit);fn.apply(null,[arr,iterator,callback])},async.forEachLimit=async.eachLimit;var _eachLimit=function(limit){return function(arr,iterator,callback){if(callback=callback||function(){},!arr.length||0>=limit)return callback();var completed=0,started=0,running=0;!function replenish(){if(completed>=arr.length)return callback();for(;limit>running&&started<arr.length;)started+=1,running+=1,iterator(arr[started-1],function(err){err?(callback(err),callback=function(){}):(completed+=1,running-=1,completed>=arr.length?callback():replenish())})}()}},doParallel=function(fn){return function(){var args=Array.prototype.slice.call(arguments);return fn.apply(null,[async.each].concat(args))}},doParallelLimit=function(limit,fn){return function(){var args=Array.prototype.slice.call(arguments);return fn.apply(null,[_eachLimit(limit)].concat(args))}},doSeries=function(fn){return function(){var args=Array.prototype.slice.call(arguments);return fn.apply(null,[async.eachSeries].concat(args))}},_asyncMap=function(eachfn,arr,iterator,callback){if(arr=_map(arr,function(x,i){return{index:i,value:x}}),callback){var results=[];eachfn(arr,function(x,callback){iterator(x.value,function(err,v){results[x.index]=v,callback(err)})},function(err){callback(err,results)})}else eachfn(arr,function(x,callback){iterator(x.value,function(err){callback(err)})})};async.map=doParallel(_asyncMap),async.mapSeries=doSeries(_asyncMap),async.mapLimit=function(arr,limit,iterator,callback){return _mapLimit(limit)(arr,iterator,callback)};var _mapLimit=function(limit){return doParallelLimit(limit,_asyncMap)};async.reduce=function(arr,memo,iterator,callback){async.eachSeries(arr,function(x,callback){iterator(memo,x,function(err,v){memo=v,callback(err)})},function(err){callback(err,memo)})},async.inject=async.reduce,async.foldl=async.reduce,async.reduceRight=function(arr,memo,iterator,callback){var reversed=_map(arr,function(x){return x}).reverse();async.reduce(reversed,memo,iterator,callback)},async.foldr=async.reduceRight;var _filter=function(eachfn,arr,iterator,callback){var results=[];arr=_map(arr,function(x,i){return{index:i,value:x}}),eachfn(arr,function(x,callback){iterator(x.value,function(v){v&&results.push(x),callback()})},function(){callback(_map(results.sort(function(a,b){return a.index-b.index}),function(x){return x.value}))})};async.filter=doParallel(_filter),async.filterSeries=doSeries(_filter),async.select=async.filter,async.selectSeries=async.filterSeries;var _reject=function(eachfn,arr,iterator,callback){var results=[];arr=_map(arr,function(x,i){return{index:i,value:x}}),eachfn(arr,function(x,callback){iterator(x.value,function(v){v||results.push(x),callback()})},function(){callback(_map(results.sort(function(a,b){return a.index-b.index}),function(x){return x.value}))})};async.reject=doParallel(_reject),async.rejectSeries=doSeries(_reject);var _detect=function(eachfn,arr,iterator,main_callback){eachfn(arr,function(x,callback){iterator(x,function(result){result?(main_callback(x),main_callback=function(){}):callback()})},function(){main_callback()})};async.detect=doParallel(_detect),async.detectSeries=doSeries(_detect),async.some=function(arr,iterator,main_callback){async.each(arr,function(x,callback){iterator(x,function(v){v&&(main_callback(!0),main_callback=function(){}),callback()})},function(){main_callback(!1)})},async.any=async.some,async.every=function(arr,iterator,main_callback){async.each(arr,function(x,callback){iterator(x,function(v){v||(main_callback(!1),main_callback=function(){}),callback()})},function(){main_callback(!0)})},async.all=async.every,async.sortBy=function(arr,iterator,callback){async.map(arr,function(x,callback){iterator(x,function(err,criteria){err?callback(err):callback(null,{value:x,criteria:criteria})})},function(err,results){if(err)return callback(err);var fn=function(left,right){var a=left.criteria,b=right.criteria;return b>a?-1:a>b?1:0};callback(null,_map(results.sort(fn),function(x){return x.value}))})},async.auto=function(tasks,callback){callback=callback||function(){};var keys=_keys(tasks),remainingTasks=keys.length;if(!remainingTasks)return callback();var results={},listeners=[],addListener=function(fn){listeners.unshift(fn)},removeListener=function(fn){for(var i=0;i<listeners.length;i+=1)if(listeners[i]===fn)return void listeners.splice(i,1)},taskComplete=function(){remainingTasks--,_each(listeners.slice(0),function(fn){fn()})};addListener(function(){if(!remainingTasks){var theCallback=callback;callback=function(){},theCallback(null,results)}}),_each(keys,function(k){var task=_isArray(tasks[k])?tasks[k]:[tasks[k]],taskCallback=function(err){var args=Array.prototype.slice.call(arguments,1);if(args.length<=1&&(args=args[0]),err){var safeResults={};_each(_keys(results),function(rkey){safeResults[rkey]=results[rkey]}),safeResults[k]=args,callback(err,safeResults),callback=function(){}}else results[k]=args,async.setImmediate(taskComplete)},requires=task.slice(0,Math.abs(task.length-1))||[],ready=function(){return _reduce(requires,function(a,x){return a&&results.hasOwnProperty(x)},!0)&&!results.hasOwnProperty(k)};if(ready())task[task.length-1](taskCallback,results);else{var listener=function(){ready()&&(removeListener(listener),task[task.length-1](taskCallback,results))};addListener(listener)}})},async.retry=function(times,task,callback){var DEFAULT_TIMES=5,attempts=[];"function"==typeof times&&(callback=task,task=times,times=DEFAULT_TIMES),times=parseInt(times,10)||DEFAULT_TIMES;var wrappedTask=function(wrappedCallback,wrappedResults){for(var retryAttempt=function(task,finalAttempt){return function(seriesCallback){task(function(err,result){seriesCallback(!err||finalAttempt,{err:err,result:result})},wrappedResults)}};times;)attempts.push(retryAttempt(task,!(times-=1)));async.series(attempts,function(done,data){data=data[data.length-1],(wrappedCallback||callback)(data.err,data.result)})};return callback?wrappedTask():wrappedTask},async.waterfall=function(tasks,callback){if(callback=callback||function(){},!_isArray(tasks)){var err=new Error("First argument to waterfall must be an array of functions");return callback(err)}if(!tasks.length)return callback();var wrapIterator=function(iterator){return function(err){if(err)callback.apply(null,arguments),callback=function(){};else{var args=Array.prototype.slice.call(arguments,1),next=iterator.next();args.push(next?wrapIterator(next):callback),async.setImmediate(function(){iterator.apply(null,args)})}}};wrapIterator(async.iterator(tasks))()};var _parallel=function(eachfn,tasks,callback){if(callback=callback||function(){},_isArray(tasks))eachfn.map(tasks,function(fn,callback){fn&&fn(function(err){var args=Array.prototype.slice.call(arguments,1);args.length<=1&&(args=args[0]),callback.call(null,err,args)})},callback);else{var results={};eachfn.each(_keys(tasks),function(k,callback){tasks[k](function(err){var args=Array.prototype.slice.call(arguments,1);args.length<=1&&(args=args[0]),results[k]=args,callback(err)})},function(err){callback(err,results)})}};async.parallel=function(tasks,callback){_parallel({map:async.map,each:async.each},tasks,callback)},async.parallelLimit=function(tasks,limit,callback){_parallel({map:_mapLimit(limit),each:_eachLimit(limit)},tasks,callback)},async.series=function(tasks,callback){if(callback=callback||function(){},_isArray(tasks))async.mapSeries(tasks,function(fn,callback){fn&&fn(function(err){var args=Array.prototype.slice.call(arguments,1);args.length<=1&&(args=args[0]),callback.call(null,err,args)})},callback);else{var results={};async.eachSeries(_keys(tasks),function(k,callback){tasks[k](function(err){var args=Array.prototype.slice.call(arguments,1);args.length<=1&&(args=args[0]),results[k]=args,callback(err)})},function(err){callback(err,results)})}},async.iterator=function(tasks){var makeCallback=function(index){var fn=function(){return tasks.length&&tasks[index].apply(null,arguments),fn.next()};return fn.next=function(){return index<tasks.length-1?makeCallback(index+1):null},fn};return makeCallback(0)},async.apply=function(fn){var args=Array.prototype.slice.call(arguments,1);return function(){return fn.apply(null,args.concat(Array.prototype.slice.call(arguments)))}};var _concat=function(eachfn,arr,fn,callback){var r=[];eachfn(arr,function(x,cb){fn(x,function(err,y){r=r.concat(y||[]),cb(err)})},function(err){callback(err,r)})};async.concat=doParallel(_concat),async.concatSeries=doSeries(_concat),async.whilst=function(test,iterator,callback){test()?iterator(function(err){return err?callback(err):void async.whilst(test,iterator,callback)}):callback()},async.doWhilst=function(iterator,test,callback){iterator(function(err){if(err)return callback(err);var args=Array.prototype.slice.call(arguments,1);test.apply(null,args)?async.doWhilst(iterator,test,callback):callback()})},async.until=function(test,iterator,callback){test()?callback():iterator(function(err){return err?callback(err):void async.until(test,iterator,callback)})},async.doUntil=function(iterator,test,callback){iterator(function(err){if(err)return callback(err);var args=Array.prototype.slice.call(arguments,1);test.apply(null,args)?callback():async.doUntil(iterator,test,callback)})},async.queue=function(worker,concurrency){function _insert(q,data,pos,callback){return q.started||(q.started=!0),_isArray(data)||(data=[data]),0==data.length?async.setImmediate(function(){q.drain&&q.drain()}):void _each(data,function(task){var item={data:task,callback:"function"==typeof callback?callback:null};pos?q.tasks.unshift(item):q.tasks.push(item),q.saturated&&q.tasks.length===q.concurrency&&q.saturated(),async.setImmediate(q.process)})}void 0===concurrency&&(concurrency=1);var workers=0,q={tasks:[],concurrency:concurrency,saturated:null,empty:null,drain:null,started:!1,paused:!1,push:function(data,callback){_insert(q,data,!1,callback)},kill:function(){q.drain=null,q.tasks=[]},unshift:function(data,callback){_insert(q,data,!0,callback)},process:function(){if(!q.paused&&workers<q.concurrency&&q.tasks.length){var task=q.tasks.shift();q.empty&&0===q.tasks.length&&q.empty(),workers+=1;var next=function(){workers-=1,task.callback&&task.callback.apply(task,arguments),q.drain&&q.tasks.length+workers===0&&q.drain(),q.process()},cb=only_once(next);worker(task.data,cb)}},length:function(){return q.tasks.length},running:function(){return workers},idle:function(){return q.tasks.length+workers===0},pause:function(){q.paused!==!0&&(q.paused=!0,q.process())},resume:function(){q.paused!==!1&&(q.paused=!1,q.process())}};return q},async.priorityQueue=function(worker,concurrency){function _compareTasks(a,b){return a.priority-b.priority}function _binarySearch(sequence,item,compare){for(var beg=-1,end=sequence.length-1;end>beg;){var mid=beg+(end-beg+1>>>1);compare(item,sequence[mid])>=0?beg=mid:end=mid-1}return beg}function _insert(q,data,priority,callback){return q.started||(q.started=!0),_isArray(data)||(data=[data]),0==data.length?async.setImmediate(function(){q.drain&&q.drain()}):void _each(data,function(task){var item={data:task,priority:priority,callback:"function"==typeof callback?callback:null};q.tasks.splice(_binarySearch(q.tasks,item,_compareTasks)+1,0,item),q.saturated&&q.tasks.length===q.concurrency&&q.saturated(),async.setImmediate(q.process)})}var q=async.queue(worker,concurrency);return q.push=function(data,priority,callback){_insert(q,data,priority,callback)},delete q.unshift,q},async.cargo=function(worker,payload){var working=!1,tasks=[],cargo={tasks:tasks,payload:payload,saturated:null,empty:null,drain:null,drained:!0,push:function(data,callback){_isArray(data)||(data=[data]),_each(data,function(task){tasks.push({data:task,callback:"function"==typeof callback?callback:null}),cargo.drained=!1,cargo.saturated&&tasks.length===payload&&cargo.saturated()}),async.setImmediate(cargo.process)},process:function process(){if(!working){if(0===tasks.length)return cargo.drain&&!cargo.drained&&cargo.drain(),void(cargo.drained=!0);var ts="number"==typeof payload?tasks.splice(0,payload):tasks.splice(0,tasks.length),ds=_map(ts,function(task){return task.data});cargo.empty&&cargo.empty(),working=!0,worker(ds,function(){working=!1;var args=arguments;_each(ts,function(data){data.callback&&data.callback.apply(null,args)}),process()})}},length:function(){return tasks.length},running:function(){return working}};return cargo};var _console_fn=function(name){return function(fn){var args=Array.prototype.slice.call(arguments,1);fn.apply(null,args.concat([function(err){var args=Array.prototype.slice.call(arguments,1);"undefined"!=typeof console&&(err?console.error&&console.error(err):console[name]&&_each(args,function(x){console[name](x)}))}]))}};async.log=_console_fn("log"),async.dir=_console_fn("dir"),async.memoize=function(fn,hasher){var memo={},queues={};hasher=hasher||function(x){return x};var memoized=function(){var args=Array.prototype.slice.call(arguments),callback=args.pop(),key=hasher.apply(null,args);key in memo?async.nextTick(function(){callback.apply(null,memo[key])}):key in queues?queues[key].push(callback):(queues[key]=[callback],fn.apply(null,args.concat([function(){memo[key]=arguments;var q=queues[key];delete queues[key];for(var i=0,l=q.length;l>i;i++)q[i].apply(null,arguments)}])))};return memoized.memo=memo,memoized.unmemoized=fn,memoized},async.unmemoize=function(fn){return function(){return(fn.unmemoized||fn).apply(null,arguments)}},async.times=function(count,iterator,callback){for(var counter=[],i=0;count>i;i++)counter.push(i);return async.map(counter,iterator,callback)},async.timesSeries=function(count,iterator,callback){for(var counter=[],i=0;count>i;i++)counter.push(i);return async.mapSeries(counter,iterator,callback)},async.seq=function(){var fns=arguments;return function(){var that=this,args=Array.prototype.slice.call(arguments),callback=args.pop();async.reduce(fns,args,function(newargs,fn,cb){fn.apply(that,newargs.concat([function(){var err=arguments[0],nextargs=Array.prototype.slice.call(arguments,1);cb(err,nextargs)}]))},function(err,results){callback.apply(that,[err].concat(results))})}},async.compose=function(){return async.seq.apply(null,Array.prototype.reverse.call(arguments))};var _applyEach=function(eachfn,fns){var go=function(){var that=this,args=Array.prototype.slice.call(arguments),callback=args.pop();return eachfn(fns,function(fn,cb){fn.apply(that,args.concat([cb]))},callback)};if(arguments.length>2){var args=Array.prototype.slice.call(arguments,2);return go.apply(this,args)}return go};async.applyEach=doParallel(_applyEach),async.applyEachSeries=doSeries(_applyEach),async.forever=function(fn,callback){function next(err){if(err){if(callback)return callback(err);throw err}fn(next)}next()},"undefined"!=typeof module&&module.exports?module.exports=async:"undefined"!=typeof define&&define.amd?define([],function(){return async}):root.async=async}(),function(_global){"use strict";function Mash(){var n=4022871197,mash=function(data){data=data.toString();for(var i=0;i<data.length;i++){n+=data.charCodeAt(i);var h=.02519603282416938*n;n=h>>>0,h-=n,h*=n,n=h>>>0,h-=n,n+=4294967296*h}return 2.3283064365386963e-10*(n>>>0)};return mash}function cbBuilder(self,args,cbDone){return cbDone=cbDone||function(){},function(){var self=this,args=arguments;return agent(),args.length?function(){var cbObj=arguments.length?arguments:[$thing.Container];async.setImmediate(function(){agent(self).apply(_global,args).apply(_global,cbObj),cbDone()})}:cbDone()}.apply(self,args)}var _getMicroTime,_module,async;if("undefined"!=typeof module&&module.exports?(async=void 0!==module.exports.setImmediate?module.exports:require("async"),_global=GLOBAL,_module=module,_getMicroTime=function(){var hrTime=process.hrtime();return Math.floor(1e6*hrTime[0]+hrTime[1]/1e3)}):(async=_global.async,_getMicroTime=function(){return 1e3*Date.now()}),void 0!==_global.$thing)return void(void 0!==_module?_module.exports=_global.$thing.agent:void 0);var $thing=_global.$thing={};$thing.heap=[],$thing.create64BitId=function(){for(var h1=new Mash,h2=new Mash,i=0;i<arguments.length;i++)h1(arguments[i]||"");return h1("").toString(16).split(".")[1]+h2(_getMicroTime()).toString(16).split(".")[1]},$thing.getBacktrace=function(first){first=first||0;try{0()}catch(e){var trace;return null!==(trace=e.stack.match(/\S+\:\d+/g))?trace.slice(1+first):null!==(trace=e.stack.match(/\s+at /g))?trace.slice(1+first):[]}},$thing.merge=function(){for(var args=Array.prototype.slice.call(arguments,0),obj=args[0],i=1;i<args.length;i++)if(void 0!==args[i])for(var k in args[i])void 0===obj[k]?obj[k]=args[i][k]:void 0;return obj},$thing.attach=function(def){if(void 0!==def._id)return def._id;for(var length=$thing.heap.length;0!==$thing.heap.length&&0===$thing.heap[$thing.heap.length-1]._refCount;)$thing.heap.pop()._id=void 0;if($thing.heap.length&&$thing.heap.length===length){def._id=void 0;for(var i=$thing.heap.length-1;i>-1&&void 0===def._id;i--)0===$thing.heap[i]._refCount&&($thing.heap[i]._id=void 0,$thing.heap[def._id=i]=def);void 0===def._id?def._id=$thing.heap.push(def)-1:void 0}else def._id=$thing.heap.push(def)-1;return def._id},$thing.search=function(obj){for(var match,i=$thing.heap.length-1;i>-1;i--)if($thing.heap[i]._refCount>0){for(var k in obj)if(!(match=obj[k]===$thing.heap[i][k]))break;if(match)return $thing.heap[i]}return void 0},$thing.searchMeta=function(obj,predicate){var type="string",cb=arguments[2],meta=void 0!==obj.getMeta?obj.getMeta():obj._meta;switch(arguments[2]){case"int":case"boolean":case"string":type=arguments[2],cb=arguments[3]}meta.forEach(function(item){if((item=item.match(/\S+/g))[0]===predicate)switch(item=item.slice(1),type){case"int":isNaN(item[0]=parseInt(item[0]))?void 0:cb.apply(obj,item);break;case"boolean":switch(item[0].toLowerCase()){case"true":item[0]=!0,cb.apply(obj,item);break;case"false":item[0]=!1,cb.apply(obj,item)}break;default:cb.apply(obj,item)}})},$thing.switchContext=function(functString,parentOrdinal,superOrdinal,ordinal,superName,methodName){return functString=functString||this.$vtable[ordinal][methodName].toString(),functString.indexOf("$parent")>-1||functString.indexOf("$super")>-1?function(){var ret,$parent=this.$parent,$super=this.$super;return this.$parent=this.$vtable[parentOrdinal]||$parent,this.$super=this.$vtable[superOrdinal][superName],ret=this.$vtable[ordinal][methodName].apply(this,arguments),this.$parent=$parent,this.$super=$super,ret}:this.$vtable[ordinal][methodName]},$thing.switchParentContext=function(functString,parentOrdinal,ordinal,methodName){return functString=functString||this.$vtable[ordinal][methodName].toString(),functString.indexOf("$parent")>-1?function(){var ret,$parent=this.$parent;return this.$parent=this.$vtable[parentOrdinal]||this.$parent,ret=this.$vtable[ordinal][methodName].apply(this,arguments),this.$parent=$parent,ret}:this.$vtable[ordinal][methodName]},$thing.Object=function(){},$thing.Object.prototype.getName=function(){return"Object"};var $inherit=$thing.Object.inherit=function(obj,parent){function ret(){void 0!==this.init?this.init.apply(this,arguments):void 0}function replace(){return void 0!==obj["$"+arguments[1]]?obj["$"+arguments[1]]:arguments[0]}var i,j,k,v,functString,signature,signatures={},inherit=this.prototype;ret.prototype=new this,ret.prototype.constructor=ret,ret.prototype.$vtable=void 0!==ret.prototype.$vtable?ret.prototype.$vtable.slice():[];var ordinal=ret.prototype.$vtable.push(obj)-1,parentOrdinal=ret.prototype.$vtable.push(parent)-1,superOrdinal=ret.prototype.$vtable.push(inherit)-1;ret.inherit=$inherit;for(i in obj){switch(i){case"$vtable":case"$signatures":case"$owner":case"$parent":case"$super":continue}v=obj[i],k=i.replace(/\$\((.+?)\)/g,replace),j=k.substring(k.indexOf(".")+1),"function"!=typeof v?ret.prototype[k]=v:(functString=v.toString(),signature=functString.match(/function[^(]*\(([^)]*)\)/),ret.prototype[k]="function"!=typeof inherit[k]?"function"!=typeof inherit[j]?$thing.switchParentContext.apply(ret.prototype,[functString,parentOrdinal,ordinal,i]):$thing.switchContext.apply(ret.prototype,[functString,parentOrdinal,superOrdinal,ordinal,j,i]):$thing.switchContext.apply(ret.prototype,[functString,parentOrdinal,superOrdinal,ordinal,k,i]),null!==signature?signatures[k]=signature[1].length?signature[1].split(/,\s*/):[]:void 0)}return ret.prototype.$owner=parent||ret.prototype.$owner,ret.prototype.$signatures=$thing.merge(signatures,ret.prototype.$signatures),ret};$thing.Base=$thing.Object.inherit({init:function(){},getName:function(){return"Base"},property:function(prop,cbGetter,cbSetter){var obj={};cbGetter?obj.get=cbGetter:void 0,cbSetter?obj.set=cbSetter:void 0,Object.defineProperty(this,prop,obj)},bind:function(funct){var self=this;return function(){return funct.apply(self,arguments)}}}),$thing.State={EXPR_AND:1,EXPR_NOT:2,EXPR_OR:3,DEF_DESC:1,DEF_NAME:2,DEF_SOURCE:4,DEF_EXTENDS:16,DEF_IMPLEMENTS:64,DEF_USES:128,DEF_META:256,DEF_NOP:512,DEF_END:1024,LIFE_INITIATED:2048,LIFE_ACTIVE:4096,LIFE_WAITING:8192,LIFE_SUSPENDED:16384,LIFE_DELETED:32768,LIFE_TRANSIT:65536,LIFE_BLOCKED:131072},$thing.Filter={ALL:1,FIRST:2,LAST:4},$thing.Definition=$thing.Base.inherit({_metaHandlers:{mobile:function(){this._isMobile=!0},passive:function(){this._isPassive=!0},singleton:function(){this._singleton=this._singleton||this._source},catchall:function(catchall,methodName){this._substitute.$__catchall__=methodName}},getName:function(){return"Definition"},init:function(parent,_super,source,stack){var k,item,search,self=this;if(this.$super(),this._state=$thing.State.DEF_DESC,this._parent=parent,this._children=[],this._meta=[],this._interfaces=[],this._uses=[],this._super=_super,this._source=source,this._refCount=0,this._isAgent=this._super===$thing.Agent,this._isAbstract=!1,this._isPassive=!1,this._isMobile=!1,this._interfaces=[$thing.create64BitId(source,$thing.heap.length),source],this._substitute={$id:this._interfaces[0],$source:source},this.parseStack(stack),void 0!==this._extends){if(item=$thing.search({_name:this._extends}),void 0===item)throw"DefinitionError: Super Class '"+this._extends+"' is not defined";for(this._super=item._class,this._singleton=item._singleton,k=item._meta.length-1;k>-1;k--)this._meta.unshift(item._meta[k]);void 0===this._class?this._class={}:void 0}if(this._meta.forEach(function(item){var args=item.split(/ (.+)?/);void 0!==self._metaHandlers[args[0]]?self._metaHandlers[args[0]].apply(self,args):void 0}),this._isAbstract?search={_name:this._name,_source:this._source}:void 0!==this._singleton&&(search={_name:this._name,_singleton:this._singleton}),void 0!==search&&(item=$thing.search(search)))this.refObject=item.bind(item.refObject),this.property("class",function(){return item._class}),this.property("refCount",function(){return item._refCount}),this.property("isAbstract",function(){return item._isAbstract}),this.property("isPassive",function(){return item._isPassive}),this.property("instance",function(){return item._instance}),this.property("state",function(){return item._state}),this.property("name",function(){return item._name}),this.property("parent",function(){return item._parent});else{if(this._childrenWrapper={push:this.bind(this._pushChild),forEach:this.bind(this._forEachChild)},Object.defineProperty(this._childrenWrapper,"length",{get:this.bind(this._countChildren)}),void 0!==this._factory?this._class=this._factory.apply(_global,this._uses):void 0,void 0!==this._class){for(k in this._substitute)this._class[k]=this._substitute[k];var interfaces=void 0!==this._name?this._interfaces.concat(this._name):this._interfaces;this._class.getInterfaces=function(){return this.$super().concat(interfaces)},this._class=this._super.inherit(this._class,parent,this._isMobile),$thing.attach(this)}this.property("class",function(){return this._class}),this.property("refCount",function(){return this._refCount}),this.property("isAbstract",function(){return this._isAbstract}),this.property("isPassive",function(){return this._isPassive}),this.property("instance",function(){return this._instance}),this.property("state",function(){return this._state}),this.property("name",function(){return this._name}),this.property("parent",function(){return this._parent})}},_forEachChild:function(cb){this._children.forEach(function(args){void 0!==args[0].getHeapId?cb.apply(void 0,args):void 0})},_pushChild:function(obj){for(var id=obj.getHeapId(),i=0;i<this._children.length;i++)if(void 0===this._children[i][0].getHeapId)this._children.splice(i,1);else if(this._children[i][0].getHeapId()===id)return this._children.length;return this._children.push(arguments)},_countChildren:function(){var length=0;return this._forEachChild(function(child){child.getRefCount()?length++:void 0}),length},parseStack:function(stack){function replace(){return void 0===arguments[1]?stack.shift():self._substitute["$"+arguments[1]]=stack.shift()}for(var item,match,self=this;this._state!==$thing.State.DEF_END&&void 0!==(item=stack.shift());){switch(typeof item){case"function":this._state=$thing.State.DEF_END,this._factory=item;continue;case"object":this._state=$thing.State.DEF_END,this._class=item;continue}switch(item){case"abstract":this._isPassive=this._isAbstract=!0;continue;case"source":this._state=$thing.State.DEF_SOURCE;continue;case"extends":this._state=$thing.State.DEF_EXTENDS;continue;case"implements":this._state=$thing.State.DEF_IMPLEMENTS;continue;case"uses":this._state=$thing.State.DEF_USES;continue;default:this._state===$thing.State.DEF_META||"@"===item.charAt(0)?this._state=$thing.State.DEF_META:item.match(/ /)?this._state=$thing.State.DEF_DESC:void 0}switch(this._state){case $thing.State.DEF_DESC:item=item.replace(/\$\((.+?)\)|\$/g,replace),item=item.split(" @"),stack=item[0].split(/ +/).filter(Boolean).concat(void 0!==item[1]?["@"+item[1]].concat(stack):stack),this._state=void 0===this._name?$thing.State.DEF_NAME:$thing.State.DEF_NOP;break;case $thing.State.DEF_META:item=item.replace(/\$\((.+?)\)|\$/g,replace),"+"===item.charAt(item.length-1)?stack=[item.slice(0,-1)+stack.shift()].concat(stack):(this._state=$thing.State.DEF_DESC,this._meta.push(item.slice(1)));break;case $thing.State.DEF_NAME:this._name=item||this._name;break;case $thing.State.DEF_SOURCE:this._source=item||this._source;break;case $thing.State.DEF_EXTENDS:this._extends=item||this._extends;break;case $thing.State.DEF_IMPLEMENTS:this._interfaces.push(null!==(match=item.match(/^\/(.*?)\/([gimy]*)$/))?new RegExp(match[1],match[2]):item);break;case $thing.State.DEF_USES:this._uses.push(agent(item))}}},patchObject:function(obj){var self=this;return obj.refObject=this.bind(this.refObject),obj.getRefCount=function(){return self._refCount},obj.getHeapId=function(){return self._id},obj.getName=function(){return self._name},obj.getSource=function(){return self._source},obj.getChildren=function(){return self._childrenWrapper},obj.getState=function(){return self._state},obj.setState=function(){var states=Array.prototype.slice.call(arguments,0);states.forEach(function(state){self._state|=state}),this.getChildren().forEach(function(child){child.setState(states)})},obj.unsetState=function(){var states=Array.prototype.slice.call(arguments,0);states.forEach(function(state){self._state&=~state}),this.getChildren().forEach(function(child){child.unsetState(states)})},obj.getMeta=function(){return self._meta},obj.isAbstract=function(){return self._isAbstract},obj},unpatchObject:function(obj){return delete obj.refObject,delete obj.getRefCount,delete obj.getHeapId,delete obj.getName,delete obj.getSource,delete obj.getChildren,delete obj.getState,delete obj.setState,delete obj.unsetState,delete obj.getMeta,delete obj.isAbstract,obj},refObject:function(cb){var self=this;this.parent.refObject(function(parent,cbRelease){var constructed;self._refCount?self._refCount++:(self._refCount=constructed=1,self._instance=self.patchObject(new self._class),self._instance.setState($thing.State.LIFE_INITIATED)),constructed&&self._isAgent&&!self._isAbstract&&self._instance.setup(),cb(self._instance,function(){self._isAgent&&self._isPassive||(0!==--self._refCount?cbRelease():self._isAgent?self._instance.takedown(function(){self._children=[],self.unpatchObject(self._instance),delete self._instance,cbRelease()}):(self._children=[],self.unpatchObject(self._instance),delete self._instance,cbRelease()))})})}}),$thing.Delegate=$thing.Base.inherit({getName:function(){return"Delegate"},getInterfaces:function(){return[]},matchInterface:function(pattern){for(var interfaces=this.getInterfaces(),i=0;i<interfaces.length&&(interfaces[i]instanceof RegExp?null===pattern.match(interfaces[i]):interfaces[i]!==pattern);i++);return interfaces[i]},refObject:function(cb){cb(this,function(){})},dispatch:function(call,cb){var method,signature;return cb=cb||function(){},"$"===call.method.charAt(0)?cb():(void 0===this[method=call["interface"]+"."+call.method]&&void 0===this[method=call.method]?method=void 0:void 0,void(void 0===method||void 0===(signature=this.$signatures[method])||"$"!==signature[signature.length-1].charAt(0)||signature.length!==call.args.length+1?void 0===this[method=this.$__catchall__]||void 0===(signature=this.$signatures[method])||"$"!==signature[1].charAt(0)||2!==signature.length?cb():this[this.$__catchall__].apply(this,[call.args,cb]):this[method].apply(this,call.args.concat(cb))))}}),$thing.Pattern=$thing.Delegate.inherit({getName:function(){return"Pattern"},init:function(pattern,source){this.$super(),this._pattern=pattern,this.property("source",function(){return source})},toArray:function(){return this._pattern instanceof Array?this._pattern:[[this._pattern]]}}),$thing.Agent=$thing.Delegate.inherit({getName:function(){return"Agent"},getInterfaces:function(){return["Agent"]},setup:function(cb){this.setState($thing.State.LIFE_ACTIVE),this.doActivate(cb)},takedown:function(cb){this.doDelete(cb)},doActivate:function(cb){this.unsetState($thing.State.LIFE_SUSPENDED),cb&&cb(),agent()},doDelete:function(cb){this.setState($thing.State.LIFE_DELETED),cb&&cb(),agent()
},doSuspend:function(cb){this.setState($thing.State.LIFE_SUSPENDED),cb&&cb(),agent()},doWait:function(cb){this.setState($thing.State.LIFE_WAITING),cb&&cb(),agent()},doWake:function(cb){this.unsetState($thing.State.LIFE_WAITING),cb&&cb(),agent()},addBehaviour:function(){var obj,reset,self=this,args=Array.prototype.slice.call(arguments,0),def=new $thing.Definition(this,$thing.Behaviour,$thing.getBacktrace(1)[0],args);if(void 0!==def["class"]){var funct=function(){def.refCount?obj=def.instance:def.refObject(function(instance,cbRelease){$thing.attach(def),obj=instance,self.getChildren().push(obj,cbRelease)}),obj.unsetState($thing.State.LIFE_WAITING|$thing.State.LIFE_SUSPENDED|$thing.State.LIFE_DELETED|$thing.State.LIFE_TRANSIT|$thing.State.LIFE_BLOCKED),obj.setState(self.getState()|$thing.State.LIFE_ACTIVE),agent()};funct(),reset=obj.reset,obj.reset=function(){funct(),reset.apply(obj,arguments)}}return obj},removeBehaviour:function(){var objs=[],children=this.getChildren();if("object"==typeof arguments[0]&&void 0!==arguments[0].getHeapId){var id=arguments[0].getHeapId();children.forEach(function(obj,cbRelease){obj.getHeapId()===id&&(obj.setState($thing.State.LIFE_DELETED),cbRelease(),objs.push(obj))})}else{var args=Array.prototype.slice.call(arguments,0),def=new $thing.Definition(this,$thing.Behaviour,$thing.getBacktrace(1)[0],args);children.forEach(function(obj,cbRelease){obj.getName()===def.name&&(obj.setState($thing.State.LIFE_DELETED),cbRelease(),objs.push(obj))})}return objs}}),$thing.Behaviour=$thing.Delegate.inherit({getName:function(){return"Behaviour"},getInterfaces:function(){return["Behaviour"]},done:function(){return!1},action:function($cb){this.done()?this.$owner.removeBehaviour(this):void 0,$cb&&$cb()},block:function(cb){this.setState($thing.State.LIFE_BLOCKED),cb&&cb()},restart:function(cb){this.unsetState($thing.State.LIFE_BLOCKED),cb&&cb()},reset:function(cb){cb&&cb()}}),$thing.Selector=$thing.Base.inherit({getName:function(){return"Selector"},init:function(pattern,source,includePassive){var i,include,def;if(this.$super(),this._source=source,this._exprs=[],this._selection=[],this._callbacks=[],pattern instanceof $thing.Pattern)this._source=pattern.source,pattern=pattern.toArray();else if("string"==typeof pattern){var expr={and:{},not:{}};expr.and[pattern]=!0,this._exprs.push(expr)}if(pattern instanceof Array)for(i=0;i<pattern.length;i++)this.parseStack(pattern[i]);for(includePassive=void 0===includePassive?!0:includePassive,i=0;i<$thing.heap.length;i++)def=$thing.heap[i],include=def.isPassive?def.isPassive&includePassive&&def.state<$thing.State.LIFE_SUSPENDED:includePassive?def.state<$thing.State.LIFE_SUSPENDED:def.state<$thing.State.LIFE_WAITING,!def.isAbstract&&def.refCount>0&&def.state&$thing.State.LIFE_ACTIVE&&include?def.refObject(this.bind(this.matchObject)):void 0;this.property("length",function(){return this._selection.length})},parseStack:function(stack){for(var k,item,state=$thing.State.EXPR_AND,expr={and:{},not:{}};void 0!==(item=stack.shift());){switch(item){case"and":state=$thing.State.EXPR_AND;continue;case"not":state=$thing.State.EXPR_NOT;continue;case"or":state=$thing.State.EXPR_OR;continue}switch(state){case $thing.State.EXPR_AND:expr.and[item]=!0;break;case $thing.State.EXPR_NOT:expr.not[item]=!0;break;case $thing.State.EXPR_OR:for(k in expr.and){this._exprs.push(expr);break}expr={and:{},not:{}},expr.and[item]=!0}}for(k in expr.and){this._exprs.push(expr);break}},matchObject:function(obj,cbRelease){for(var k,match,i=0;i<this._exprs.length;i++){var m,expr=this._exprs[i];for(k in expr.and){if(void 0===(m=obj.matchInterface(k,this._source))){match=void 0;break}match=match||m}if(void 0!==match){for(k in expr.not)if(obj.matchInterface(k,this._source))return void(match=void 0);if(void 0!==match)break}}void 0===match?cbRelease():(this._callbacks.push(cbRelease),this._selection.push({match:match,obj:obj}))},dispatch:function(call,cbItem,cbDone){async.setImmediate(this.bind(function(){if(call.filters&$thing.Filter.FIRST&&this._selection.length>0)this._selection[0].obj.dispatch({"interface":this._selection[0].match,method:call.method,args:call.args},this.bind(function(){return cbItem.apply(this._selection[0].obj,Array.prototype.slice.call(arguments,0).concat(cbDone))}));else if(call.filters&$thing.Filter.LAST&&this._selection.length>0){var i=this._selection.length-1;this._selection[i].obj.dispatch({"interface":this._selection[i].match,method:call.method,args:call.args},this.bind(function(){return cbItem.apply(this._selection[i].obj,Array.prototype.slice.call(arguments,0).concat(cbDone))}))}else call.filters&$thing.Filter.ALL&&this._selection.length>0?async.each(this._selection,function(item,cbNext){item.obj.dispatch({"interface":item.match,method:call.method,args:call.args},function(){return cbItem.apply(item.obj,Array.prototype.slice.call(arguments,0).concat(cbNext))})},cbDone):cbDone()}))},release:function(){for(var i=0;i<this._callbacks.length;i++)this._callbacks[i]();this._callbacks=[],this._selection=[]}}),$thing.WAKE_MIN_PERIOD=5e4,$thing.nextWakeTime=_getMicroTime(),$thing.isActionTaskQueued=!1,$thing.wakeTask=function(){var now=_getMicroTime();if(now>=$thing.nextWakeTime){var selector=new $thing.Selector([["Behaviour","and","Waker"]],"$thing",!1);0===selector.length?(selector.release(),selector=void 0):selector.dispatch({filters:$thing.Filter.ALL,method:"action",args:[]},function(cbNext){cbNext()},function(){selector.release(),selector=void 0}),$thing.nextWakeTime=now+$thing.WAKE_MIN_PERIOD-now%$thing.WAKE_MIN_PERIOD}},$thing.enqueueActionTask=function(){$thing.isActionTaskQueued||($thing.isActionTaskQueued=!0,async.setImmediate(function(){var selector=new $thing.Selector([["Behaviour","not","Waker"]],"$thing",!1);0===selector.length?(selector.release(),selector=void 0,$thing.isActionTaskQueued=!1):selector.dispatch({filters:$thing.Filter.ALL,method:"action",args:[]},function(cbNext){cbNext()},function(){selector.release(),selector=void 0,$thing.isActionTaskQueued=!1,$thing.enqueueActionTask()})}))};var agent=$thing.agent=function(){var def,source,selector,filter,pattern,selects,callChain,refCount=0;switch(arguments.length){case 0:return $thing.wakeTask(),$thing.enqueueActionTask();case 1:if(arguments[0]instanceof $thing.Pattern){selector=new $thing.Selector(pattern=arguments[0]);break}if("object"==typeof arguments[0]&&void 0!==arguments[0].getInterfaces){selector=arguments[0];break}default:var args=Array.prototype.slice.call(arguments,0);if(def=new $thing.Definition($thing.Container,$thing.Agent,source=$thing.getBacktrace(1)[0],args),void 0!==def["class"])return def.refObject(function(obj,cbRelease){cbRelease()});selects=[],$thing.searchMeta(def,"select",function(){selects.push(Array.prototype.slice.call(arguments,0))}),selector=new $thing.Selector(pattern=selects.length?selects:def.name,source)}return filter=function(filters,callArgs){return function(){var obj,args=Array.prototype.slice.call(arguments,0);switch(arguments.length){case 0:obj=$thing.Container;break;case 1:if("object"==typeof arguments[0]&&void 0!==arguments[0].getInterfaces){obj=arguments[0];break}default:var source=$thing.getBacktrace(1)[0],def=new $thing.Definition($thing.Container,$thing.Agent,source,args);void 0!==def["class"]?obj=def:(selects=[],$thing.searchMeta(def,"select",function(){selects.push(Array.prototype.slice.call(arguments,0))}),obj=new $thing.Pattern(selects.length?selects:def.name,source))}return obj.refObject(function(obj,cbRelease){refCount++,void 0!==pattern?selector.dispatch({filters:filters,method:callArgs[0],args:callArgs.slice(1)},function(){return cbBuilder(obj,Array.prototype.slice.call(arguments,0,arguments.length-1),arguments[arguments.length-1])},function(){0===--refCount&&(cbRelease(),selector.release())}):selector.dispatch({filters:filters,method:callArgs[0],args:callArgs.slice(1)},function(){return cbBuilder(obj,arguments,function(){0===--refCount&&cbRelease()})})}),callChain}},callChain=function(){return filter($thing.Filter.ALL,Array.prototype.slice.call(arguments,0))},callChain.all=callChain,callChain.first=function(){return filter($thing.Filter.FIRST,Array.prototype.slice.call(arguments,0))},callChain.last=function(){return filter($thing.Filter.LAST,Array.prototype.slice.call(arguments,0))},callChain};void 0!==_module?_module.exports=agent:_global.agent=agent,$thing.Container=new($thing.Agent.inherit({getName:function(){return"Container"},getInterfaces:function(){return["Container"]},setup:void 0,takedown:void 0,addBehaviour:void 0,removeBehaviour:void 0})),agent("@singleton","abstract Heartbeat implements Container",{setup:function(cb){this.$super(cb),this.keepAlive=this.addBehaviour("@passive",{}),this.intervalId=setInterval(agent,$thing.WAKE_MIN_PERIOD/1e3)},destroy:function($cb){clearInterval(this.intervalId),this.removeBehaviour(this.keepAlive),$cb()}}),agent({setup:function(cb){this.$super(cb),this.addBehaviour("@passive","@catchall catchAll","Done",{catchAll:function(args,$cb){$cb("done")()}}),this.addBehaviour("@passive","@catchall catchAll","Error",{catchAll:function(args,$cb){$cb("doneWithError",-1)()}}),this.addBehaviour("abstract Flow",{getFlow:function(){var self=this,reset=this.reset,getFlow=this.getFlow,methods=[],names=[],args=Array.prototype.slice.call(arguments,0);return args.forEach(function(item){-1===names.indexOf(item)?names.push(item):void 0}),$thing.searchMeta(this,"flow",function(){Array.prototype.slice.call(arguments,0).forEach(function(item){-1===names.indexOf(item)?names.push(item):void 0})}),names.forEach(function(item){void 0!==self.$signatures[item]&&"$"===self.$signatures[item][self.$signatures[item].length-1].charAt(0)?methods.push(function(){var cbYield=arguments[arguments.length-1],args=Array.prototype.slice.call(arguments,0,arguments.length-1);args.push(function(){var args=arguments;return 0===args.length?cbYield():function(){agent(new($thing.Agent.inherit({done:function($cb){var i=names.indexOf(item);names.splice(i,1),methods.splice(i,1),$cb(),cbYield()},"yield":function($cb){$cb(),cbYield()}}))).apply(_global,args).apply(_global,[])}}),self[item].apply(self,args)}):void 0}),this.reset=function(cb){return this.getFlow=getFlow,reset.apply(this,[cb])},this.getFlow=function(){return methods},methods},action:function($cb){this.getFlow().length?void 0:this.done=function(){return!0},this.$super($cb)},done:function(){return!1}}),this.addBehaviour("abstract Series extends Flow",{action:function($cb){async.series(this.getFlow(),this.bind(function(){this.$super($cb)}))}}),this.addBehaviour("abstract Parallel extends Flow",{action:function($cb){async.parallel(this.getFlow(),this.bind(function(){this.$super($cb)}))}}),this.addBehaviour("abstract Queue extends Flow",{getQueue:function(){var self=this,concurrency=1,limit=0,functs=[],active=0,paused=!1;$thing.searchMeta(this,"concurrency","int",function(value){concurrency=value}),$thing.searchMeta(this,"limit","int",function(value){limit=value});var queue={push:function(item,cbItem){return limit&&functs.length>limit-1?void cbItem(-1):(paused||self.unsetState($thing.State.LIFE_WAITING),void functs.push(function(cbDone){var flow=self.getFlow();flow.length?async.applyEach(flow,item,function(err){cbDone(),cbItem(err)}):(cbDone(),cbItem(-1))}))},action:function(next,cb){for(var call=[],length=functs.length<concurrency?functs.length:concurrency;length--;)call.push(functs.shift());call.length>0?(active=call.length,async.parallel(call,function(){active=0,next(cb)})):(self.setState($thing.State.LIFE_WAITING),next(cb))},pause:function(){paused||(paused=!0,self.setState($thing.State.LIFE_WAITING))},resume:function(){paused&&(paused=!1,self.unsetState($thing.State.LIFE_WAITING),agent())}};return Object.defineProperty(queue,"length",{get:function(){return active+functs.length}}),this.getQueue=function(){return queue},queue},action:function($cb){this.getQueue().action(this.bind(this.$super),$cb)},push:function(items,$cb){if(items instanceof Array){var ret,self=this,length=items.length,errs=[];items.forEach(function(item,i){self.getQueue().push(item,function(err){ret=(errs[i]=err)||ret,--length?void 0:ret?$cb("doneWithError",errs)():$cb("done")()})})}else this.getQueue().push(items,function(err){err?$cb("doneWithError",err)():$cb("done")()});agent()},pause:function($cb){this.getQueue().pause(),$cb()},resume:function($cb){this.getQueue().resume(),$cb()}}),this.addBehaviour("abstract Waker",{getWakeTime:function(){var time,period=1e6,now=_getMicroTime();return $thing.searchMeta(this,"period","int",function(value){period=1e3*value}),time=now+period-now%period,this.getWakeTime=function(){return time},this.getWakeTime()},wake:function(cb){cb()},action:function($cb){var time=this.getWakeTime();return void 0===time?this.$super($cb):_getMicroTime()>=time?(this.getWakeTime=function(){return void 0},this.wake(this.bind(function(){this.$super($cb)}))):void this.$super($cb)},done:function(){return void 0!==this.getWakeTime()?!1:(delete this.getWakeTime,!0)},reset:function($cb){delete this.getWakeTime,this.$super($cb)},stop:function($cb){this.$owner.removeBehaviour(this),delete this.getWakeTime,$cb&&$cb()}}),this.addBehaviour("abstract Sensor extends Queue"),this.addBehaviour("abstract Actuator extends Queue")}})}(this);
//# sourceMappingURL=thingjs-agent-0.1.0-withasync.min.js.map