!function(){function a(a){var c=!1;return function(){if(c)throw new Error("Callback was already called.");c=!0,a.apply(b,arguments)}}var b,c,d={};b=this,null!=b&&(c=b.async),d.noConflict=function(){return b.async=c,d};var e=Object.prototype.toString,f=Array.isArray||function(a){return"[object Array]"===e.call(a)},g=function(a,b){if(a.forEach)return a.forEach(b);for(var c=0;c<a.length;c+=1)b(a[c],c,a)},h=function(a,b){if(a.map)return a.map(b);var c=[];return g(a,function(a,d,e){c.push(b(a,d,e))}),c},i=function(a,b,c){return a.reduce?a.reduce(b,c):(g(a,function(a,d,e){c=b(c,a,d,e)}),c)},j=function(a){if(Object.keys)return Object.keys(a);var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b};"undefined"!=typeof process&&process.nextTick?(d.nextTick=process.nextTick,d.setImmediate="undefined"!=typeof setImmediate?function(a){setImmediate(a)}:d.nextTick):"function"==typeof setImmediate?(d.nextTick=function(a){setImmediate(a)},d.setImmediate=d.nextTick):(d.nextTick=function(a){setTimeout(a,0)},d.setImmediate=d.nextTick),d.each=function(b,c,d){function e(a){a?(d(a),d=function(){}):(f+=1,f>=b.length&&d())}if(d=d||function(){},!b.length)return d();var f=0;g(b,function(b){c(b,a(e))})},d.forEach=d.each,d.eachSeries=function(a,b,c){if(c=c||function(){},!a.length)return c();var d=0,e=function(){b(a[d],function(b){b?(c(b),c=function(){}):(d+=1,d>=a.length?c():e())})};e()},d.forEachSeries=d.eachSeries,d.eachLimit=function(a,b,c,d){var e=k(b);e.apply(null,[a,c,d])},d.forEachLimit=d.eachLimit;var k=function(a){return function(b,c,d){if(d=d||function(){},!b.length||0>=a)return d();var e=0,f=0,g=0;!function h(){if(e>=b.length)return d();for(;a>g&&f<b.length;)f+=1,g+=1,c(b[f-1],function(a){a?(d(a),d=function(){}):(e+=1,g-=1,e>=b.length?d():h())})}()}},l=function(a){return function(){var b=Array.prototype.slice.call(arguments);return a.apply(null,[d.each].concat(b))}},m=function(a,b){return function(){var c=Array.prototype.slice.call(arguments);return b.apply(null,[k(a)].concat(c))}},n=function(a){return function(){var b=Array.prototype.slice.call(arguments);return a.apply(null,[d.eachSeries].concat(b))}},o=function(a,b,c,d){if(b=h(b,function(a,b){return{index:b,value:a}}),d){var e=[];a(b,function(a,b){c(a.value,function(c,d){e[a.index]=d,b(c)})},function(a){d(a,e)})}else a(b,function(a,b){c(a.value,function(a){b(a)})})};d.map=l(o),d.mapSeries=n(o),d.mapLimit=function(a,b,c,d){return p(b)(a,c,d)};var p=function(a){return m(a,o)};d.reduce=function(a,b,c,e){d.eachSeries(a,function(a,d){c(b,a,function(a,c){b=c,d(a)})},function(a){e(a,b)})},d.inject=d.reduce,d.foldl=d.reduce,d.reduceRight=function(a,b,c,e){var f=h(a,function(a){return a}).reverse();d.reduce(f,b,c,e)},d.foldr=d.reduceRight;var q=function(a,b,c,d){var e=[];b=h(b,function(a,b){return{index:b,value:a}}),a(b,function(a,b){c(a.value,function(c){c&&e.push(a),b()})},function(){d(h(e.sort(function(a,b){return a.index-b.index}),function(a){return a.value}))})};d.filter=l(q),d.filterSeries=n(q),d.select=d.filter,d.selectSeries=d.filterSeries;var r=function(a,b,c,d){var e=[];b=h(b,function(a,b){return{index:b,value:a}}),a(b,function(a,b){c(a.value,function(c){c||e.push(a),b()})},function(){d(h(e.sort(function(a,b){return a.index-b.index}),function(a){return a.value}))})};d.reject=l(r),d.rejectSeries=n(r);var s=function(a,b,c,d){a(b,function(a,b){c(a,function(c){c?(d(a),d=function(){}):b()})},function(){d()})};d.detect=l(s),d.detectSeries=n(s),d.some=function(a,b,c){d.each(a,function(a,d){b(a,function(a){a&&(c(!0),c=function(){}),d()})},function(){c(!1)})},d.any=d.some,d.every=function(a,b,c){d.each(a,function(a,d){b(a,function(a){a||(c(!1),c=function(){}),d()})},function(){c(!0)})},d.all=d.every,d.sortBy=function(a,b,c){d.map(a,function(a,c){b(a,function(b,d){b?c(b):c(null,{value:a,criteria:d})})},function(a,b){if(a)return c(a);var d=function(a,b){var c=a.criteria,d=b.criteria;return d>c?-1:c>d?1:0};c(null,h(b.sort(d),function(a){return a.value}))})},d.auto=function(a,b){b=b||function(){};var c=j(a),e=c.length;if(!e)return b();var h={},k=[],l=function(a){k.unshift(a)},m=function(a){for(var b=0;b<k.length;b+=1)if(k[b]===a)return void k.splice(b,1)},n=function(){e--,g(k.slice(0),function(a){a()})};l(function(){if(!e){var a=b;b=function(){},a(null,h)}}),g(c,function(c){var e=f(a[c])?a[c]:[a[c]],k=function(a){var e=Array.prototype.slice.call(arguments,1);if(e.length<=1&&(e=e[0]),a){var f={};g(j(h),function(a){f[a]=h[a]}),f[c]=e,b(a,f),b=function(){}}else h[c]=e,d.setImmediate(n)},o=e.slice(0,Math.abs(e.length-1))||[],p=function(){return i(o,function(a,b){return a&&h.hasOwnProperty(b)},!0)&&!h.hasOwnProperty(c)};if(p())e[e.length-1](k,h);else{var q=function(){p()&&(m(q),e[e.length-1](k,h))};l(q)}})},d.retry=function(a,b,c){var e=5,f=[];"function"==typeof a&&(c=b,b=a,a=e),a=parseInt(a,10)||e;var g=function(e,g){for(var h=function(a,b){return function(c){a(function(a,d){c(!a||b,{err:a,result:d})},g)}};a;)f.push(h(b,!(a-=1)));d.series(f,function(a,b){b=b[b.length-1],(e||c)(b.err,b.result)})};return c?g():g},d.waterfall=function(a,b){if(b=b||function(){},!f(a)){var c=new Error("First argument to waterfall must be an array of functions");return b(c)}if(!a.length)return b();var e=function(a){return function(c){if(c)b.apply(null,arguments),b=function(){};else{var f=Array.prototype.slice.call(arguments,1),g=a.next();f.push(g?e(g):b),d.setImmediate(function(){a.apply(null,f)})}}};e(d.iterator(a))()};var t=function(a,b,c){if(c=c||function(){},f(b))a.map(b,function(a,b){a&&a(function(a){var c=Array.prototype.slice.call(arguments,1);c.length<=1&&(c=c[0]),b.call(null,a,c)})},c);else{var d={};a.each(j(b),function(a,c){b[a](function(b){var e=Array.prototype.slice.call(arguments,1);e.length<=1&&(e=e[0]),d[a]=e,c(b)})},function(a){c(a,d)})}};d.parallel=function(a,b){t({map:d.map,each:d.each},a,b)},d.parallelLimit=function(a,b,c){t({map:p(b),each:k(b)},a,c)},d.series=function(a,b){if(b=b||function(){},f(a))d.mapSeries(a,function(a,b){a&&a(function(a){var c=Array.prototype.slice.call(arguments,1);c.length<=1&&(c=c[0]),b.call(null,a,c)})},b);else{var c={};d.eachSeries(j(a),function(b,d){a[b](function(a){var e=Array.prototype.slice.call(arguments,1);e.length<=1&&(e=e[0]),c[b]=e,d(a)})},function(a){b(a,c)})}},d.iterator=function(a){var b=function(c){var d=function(){return a.length&&a[c].apply(null,arguments),d.next()};return d.next=function(){return c<a.length-1?b(c+1):null},d};return b(0)},d.apply=function(a){var b=Array.prototype.slice.call(arguments,1);return function(){return a.apply(null,b.concat(Array.prototype.slice.call(arguments)))}};var u=function(a,b,c,d){var e=[];a(b,function(a,b){c(a,function(a,c){e=e.concat(c||[]),b(a)})},function(a){d(a,e)})};d.concat=l(u),d.concatSeries=n(u),d.whilst=function(a,b,c){a()?b(function(e){return e?c(e):void d.whilst(a,b,c)}):c()},d.doWhilst=function(a,b,c){a(function(e){if(e)return c(e);var f=Array.prototype.slice.call(arguments,1);b.apply(null,f)?d.doWhilst(a,b,c):c()})},d.until=function(a,b,c){a()?c():b(function(e){return e?c(e):void d.until(a,b,c)})},d.doUntil=function(a,b,c){a(function(e){if(e)return c(e);var f=Array.prototype.slice.call(arguments,1);b.apply(null,f)?c():d.doUntil(a,b,c)})},d.queue=function(b,c){function e(a,b,c,e){return a.started||(a.started=!0),f(b)||(b=[b]),0==b.length?d.setImmediate(function(){a.drain&&a.drain()}):void g(b,function(b){var f={data:b,callback:"function"==typeof e?e:null};c?a.tasks.unshift(f):a.tasks.push(f),a.saturated&&a.tasks.length===a.concurrency&&a.saturated(),d.setImmediate(a.process)})}void 0===c&&(c=1);var h=0,i={tasks:[],concurrency:c,saturated:null,empty:null,drain:null,started:!1,paused:!1,push:function(a,b){e(i,a,!1,b)},kill:function(){i.drain=null,i.tasks=[]},unshift:function(a,b){e(i,a,!0,b)},process:function(){if(!i.paused&&h<i.concurrency&&i.tasks.length){var c=i.tasks.shift();i.empty&&0===i.tasks.length&&i.empty(),h+=1;var d=function(){h-=1,c.callback&&c.callback.apply(c,arguments),i.drain&&i.tasks.length+h===0&&i.drain(),i.process()},e=a(d);b(c.data,e)}},length:function(){return i.tasks.length},running:function(){return h},idle:function(){return i.tasks.length+h===0},pause:function(){i.paused!==!0&&(i.paused=!0,i.process())},resume:function(){i.paused!==!1&&(i.paused=!1,i.process())}};return i},d.priorityQueue=function(a,b){function c(a,b){return a.priority-b.priority}function e(a,b,c){for(var d=-1,e=a.length-1;e>d;){var f=d+(e-d+1>>>1);c(b,a[f])>=0?d=f:e=f-1}return d}function h(a,b,h,i){return a.started||(a.started=!0),f(b)||(b=[b]),0==b.length?d.setImmediate(function(){a.drain&&a.drain()}):void g(b,function(b){var f={data:b,priority:h,callback:"function"==typeof i?i:null};a.tasks.splice(e(a.tasks,f,c)+1,0,f),a.saturated&&a.tasks.length===a.concurrency&&a.saturated(),d.setImmediate(a.process)})}var i=d.queue(a,b);return i.push=function(a,b,c){h(i,a,b,c)},delete i.unshift,i},d.cargo=function(a,b){var c=!1,e=[],i={tasks:e,payload:b,saturated:null,empty:null,drain:null,drained:!0,push:function(a,c){f(a)||(a=[a]),g(a,function(a){e.push({data:a,callback:"function"==typeof c?c:null}),i.drained=!1,i.saturated&&e.length===b&&i.saturated()}),d.setImmediate(i.process)},process:function j(){if(!c){if(0===e.length)return i.drain&&!i.drained&&i.drain(),void(i.drained=!0);var d="number"==typeof b?e.splice(0,b):e.splice(0,e.length),f=h(d,function(a){return a.data});i.empty&&i.empty(),c=!0,a(f,function(){c=!1;var a=arguments;g(d,function(b){b.callback&&b.callback.apply(null,a)}),j()})}},length:function(){return e.length},running:function(){return c}};return i};var v=function(a){return function(b){var c=Array.prototype.slice.call(arguments,1);b.apply(null,c.concat([function(b){var c=Array.prototype.slice.call(arguments,1);"undefined"!=typeof console&&(b?console.error&&console.error(b):console[a]&&g(c,function(b){console[a](b)}))}]))}};d.log=v("log"),d.dir=v("dir"),d.memoize=function(a,b){var c={},e={};b=b||function(a){return a};var f=function(){var f=Array.prototype.slice.call(arguments),g=f.pop(),h=b.apply(null,f);h in c?d.nextTick(function(){g.apply(null,c[h])}):h in e?e[h].push(g):(e[h]=[g],a.apply(null,f.concat([function(){c[h]=arguments;var a=e[h];delete e[h];for(var b=0,d=a.length;d>b;b++)a[b].apply(null,arguments)}])))};return f.memo=c,f.unmemoized=a,f},d.unmemoize=function(a){return function(){return(a.unmemoized||a).apply(null,arguments)}},d.times=function(a,b,c){for(var e=[],f=0;a>f;f++)e.push(f);return d.map(e,b,c)},d.timesSeries=function(a,b,c){for(var e=[],f=0;a>f;f++)e.push(f);return d.mapSeries(e,b,c)},d.seq=function(){var a=arguments;return function(){var b=this,c=Array.prototype.slice.call(arguments),e=c.pop();d.reduce(a,c,function(a,c,d){c.apply(b,a.concat([function(){var a=arguments[0],b=Array.prototype.slice.call(arguments,1);d(a,b)}]))},function(a,c){e.apply(b,[a].concat(c))})}},d.compose=function(){return d.seq.apply(null,Array.prototype.reverse.call(arguments))};var w=function(a,b){var c=function(){var c=this,d=Array.prototype.slice.call(arguments),e=d.pop();return a(b,function(a,b){a.apply(c,d.concat([b]))},e)};if(arguments.length>2){var d=Array.prototype.slice.call(arguments,2);return c.apply(this,d)}return c};d.applyEach=l(w),d.applyEachSeries=n(w),d.forever=function(a,b){function c(d){if(d){if(b)return b(d);throw d}a(c)}c()},"undefined"!=typeof module&&module.exports?module.exports=d:"undefined"!=typeof define&&define.amd?define([],function(){return d}):b.async=d}(),function(a){"use strict";function b(){var a=4022871197,b=function(b){b=b.toString();for(var c=0;c<b.length;c++){a+=b.charCodeAt(c);var d=.02519603282416938*a;a=d>>>0,d-=a,d*=a,a=d>>>0,d-=a,a+=4294967296*d}return 2.3283064365386963e-10*(a>>>0)};return b}function c(b,c,d){return d=d||function(){},function(){var b=this,c=arguments;return i(),c.length?function(){var e=arguments.length?arguments:[g.Container];f.setImmediate(function(){i(b).apply(a,c).apply(a,e),d()})}:d()}.apply(b,c)}var d,e,f;if("undefined"!=typeof module&&module.exports?(f=require("async"),a=GLOBAL,d=module,e=function(){var a=process.hrtime();return 1e6*a[0]+a[1]}):(f=a.async,e=Date.now),void 0!==a.$thing)return void(void 0!==d?d.exports=i:void 0);var g=a.$thing={};g.heap=[],g.create64BitId=function(){for(var a=new b,c=new b,d=0;d<arguments.length;d++)a(arguments[d]||"");return a("").toString(16).split(".")[1]+c(e()).toString(16).split(".")[1]},g.getBacktrace=function(a){a=a||0;try{0()}catch(b){var c;return null!==(c=b.stack.match(/\S+\:\d+/g))?c.slice(1+a):null!==(c=b.stack.match(/\s+at /g))?c.slice(1+a):[]}},g.merge=function(){for(var a=Array.prototype.slice.call(arguments,0),b=a[0],c=1;c<a.length;c++)if(void 0!==a[c])for(var d in a[c])void 0===b[d]?b[d]=a[c][d]:void 0;return b},g.attach=function(a){if(void 0!==a._id)return a._id;for(var b=g.heap.length;0!==g.heap.length&&0===g.heap[g.heap.length-1]._refCount;)g.heap.pop()._id=void 0;if(g.heap.length&&g.heap.length===b){a._id=void 0;for(var c=g.heap.length-1;c>-1&&void 0===a._id;c--)0===g.heap[c]._refCount&&(g.heap[c]._id=void 0,g.heap[a._id=c]=a);void 0===a._id?a._id=g.heap.push(a)-1:void 0}else a._id=g.heap.push(a)-1;return a._id},g.search=function(a){for(var b,c=g.heap.length-1;c>-1;c--)if(g.heap[c]._refCount>0){for(var d in a)if(!(b=a[d]===g.heap[c][d]))break;if(b)return g.heap[c]}return void 0},g.searchMeta=function(a,b){var c="string",d=arguments[2],e=void 0!==a.getMeta?a.getMeta():a._meta;switch(arguments[2]){case"int":case"boolean":case"string":c=arguments[2],d=arguments[3]}e.forEach(function(e){if((e=e.match(/\S+/g))[0]===b)switch(e=e.slice(1),c){case"int":isNaN(e[0]=parseInt(e[0]))?void 0:d.apply(a,e);break;case"boolean":switch(e[0].toLowerCase()){case"true":e[0]=!0,d.apply(a,e);break;case"false":e[0]=!1,d.apply(a,e)}break;default:d.apply(a,e)}})},g.switchContext=function(a,b,c,d,e,f){return a=a||this.$vtable[d][f].toString(),a.indexOf("$parent")>-1||a.indexOf("$super")>-1?function(){var a,g=this.$parent,h=this.$super;return this.$parent=this.$vtable[b]||g,this.$super=this.$vtable[c][e],a=this.$vtable[d][f].apply(this,arguments),this.$parent=g,this.$super=h,a}:this.$vtable[d][f]},g.switchParentContext=function(a,b,c,d){return a=a||this.$vtable[c][d].toString(),a.indexOf("$parent")>-1?function(){var a,e=this.$parent;return this.$parent=this.$vtable[b]||this.$parent,a=this.$vtable[c][d].apply(this,arguments),this.$parent=e,a}:this.$vtable[c][d]},g.Object=function(){},g.Object.prototype.getName=function(){return"Object"};var h=g.Object.inherit=function(a,b){function c(){void 0!==this.init?this.init.apply(this,arguments):void 0}function d(){return void 0!==a["$"+arguments[1]]?a["$"+arguments[1]]:arguments[0]}var e,f,i,j,k,l,m={},n=this.prototype;c.prototype=new this,c.prototype.constructor=c,c.prototype.$vtable=void 0!==c.prototype.$vtable?c.prototype.$vtable.slice():[];var o=c.prototype.$vtable.push(a)-1,p=c.prototype.$vtable.push(b)-1,q=c.prototype.$vtable.push(n)-1;c.inherit=h;for(e in a){switch(e){case"$vtable":case"$signatures":case"$owner":case"$parent":case"$super":continue}j=a[e],i=e.replace(/\$\((.+?)\)/g,d),f=i.substring(i.indexOf(".")+1),"function"!=typeof j?c.prototype[i]=j:(k=j.toString(),l=k.match(/function[^(]*\(([^)]*)\)/),c.prototype[i]="function"!=typeof n[i]?"function"!=typeof n[f]?g.switchParentContext.apply(c.prototype,[k,p,o,e]):g.switchContext.apply(c.prototype,[k,p,q,o,f,e]):g.switchContext.apply(c.prototype,[k,p,q,o,i,e]),null!==l?m[i]=l[1].length?l[1].split(/,\s*/):[]:void 0)}return c.prototype.$owner=b||c.prototype.$owner,c.prototype.$signatures=g.merge(m,c.prototype.$signatures),c};g.Base=g.Object.inherit({init:function(){},getName:function(){return"Base"},property:function(a,b,c){var d={};b?d.get=b:void 0,c?d.set=c:void 0,Object.defineProperty(this,a,d)},bind:function(a){var b=this;return function(){return a.apply(b,arguments)}}}),g.State={EXPR_AND:1,EXPR_NOT:2,EXPR_OR:3,DEF_DESC:1,DEF_NAME:2,DEF_SOURCE:4,DEF_EXTENDS:16,DEF_IMPLEMENTS:64,DEF_USES:128,DEF_META:256,DEF_NOP:512,DEF_END:1024,LIFE_INITIATED:2048,LIFE_ACTIVE:4096,LIFE_WAITING:8192,LIFE_SUSPENDED:16384,LIFE_DELETED:32768,LIFE_TRANSIT:65536,LIFE_BLOCKED:131072},g.Filter={ALL:1,FIRST:2,LAST:4},g.Definition=g.Base.inherit({_metaHandlers:{mobile:function(){this._isMobile=!0},passive:function(){this._isPassive=!0},singleton:function(){this._singleton=this._singleton||this._source},catchall:function(a,b){this._substitute.$__catchall__=b}},getName:function(){return"Definition"},init:function(b,c,d,e){var f,h,i,j=this;if(this.$super(),this._state=g.State.DEF_DESC,this._parent=b,this._children=[],this._meta=[],this._interfaces=[],this._uses=[],this._super=c,this._source=d,this._refCount=0,this._isAgent=this._super===g.Agent,this._isAbstract=!1,this._isPassive=!1,this._isMobile=!1,this._interfaces=[g.create64BitId(d,g.heap.length),d],this._substitute={$id:this._interfaces[0],$source:d},this.parseStack(e),void 0!==this._extends){if(h=g.search({_name:this._extends}),void 0===h)throw"DefinitionError: Super Class '"+this._extends+"' is not defined";for(this._super=h._class,this._singleton=h._singleton,f=h._meta.length-1;f>-1;f--)this._meta.unshift(h._meta[f]);void 0===this._class?this._class={}:void 0}if(this._meta.forEach(function(a){var b=a.split(/ (.+)?/);void 0!==j._metaHandlers[b[0]]?j._metaHandlers[b[0]].apply(j,b):void 0}),this._isAbstract?i={_name:this._name,_source:this._source}:void 0!==this._singleton&&(i={_name:this._name,_singleton:this._singleton}),void 0!==i&&(h=g.search(i)))this.refObject=h.bind(h.refObject),this.property("class",function(){return h._class}),this.property("refCount",function(){return h._refCount}),this.property("isAbstract",function(){return h._isAbstract}),this.property("isPassive",function(){return h._isPassive}),this.property("instance",function(){return h._instance}),this.property("state",function(){return h._state}),this.property("name",function(){return h._name}),this.property("parent",function(){return h._parent});else{if(this._childrenWrapper={push:this.bind(this._pushChild),forEach:this.bind(this._forEachChild)},Object.defineProperty(this._childrenWrapper,"length",{get:this.bind(this._countChildren)}),void 0!==this._factory?this._class=this._factory.apply(a,this._uses):void 0,void 0!==this._class){for(f in this._substitute)this._class[f]=this._substitute[f];var k=void 0!==this._name?this._interfaces.concat(this._name):this._interfaces;this._class.getInterfaces=function(){return this.$super().concat(k)},this._class=this._super.inherit(this._class,b,this._isMobile),g.attach(this)}this.property("class",function(){return this._class}),this.property("refCount",function(){return this._refCount}),this.property("isAbstract",function(){return this._isAbstract}),this.property("isPassive",function(){return this._isPassive}),this.property("instance",function(){return this._instance}),this.property("state",function(){return this._state}),this.property("name",function(){return this._name}),this.property("parent",function(){return this._parent})}},_forEachChild:function(a){this._children.forEach(function(b){void 0!==b[0].getHeapId?a.apply(void 0,b):void 0})},_pushChild:function(a){for(var b=a.getHeapId(),c=0;c<this._children.length;c++)if(void 0===this._children[c][0].getHeapId)this._children.splice(c,1);else if(this._children[c][0].getHeapId()===b)return this._children.length;return this._children.push(arguments)},_countChildren:function(){var a=0;return this._forEachChild(function(b){b.getRefCount()?a++:void 0}),a},parseStack:function(a){function b(){return void 0===arguments[1]?a.shift():e._substitute["$"+arguments[1]]=a.shift()}for(var c,d,e=this;this._state!==g.State.DEF_END&&void 0!==(c=a.shift());){switch(typeof c){case"function":this._state=g.State.DEF_END,this._factory=c;continue;case"object":this._state=g.State.DEF_END,this._class=c;continue}switch(c){case"abstract":this._isPassive=this._isAbstract=!0;continue;case"source":this._state=g.State.DEF_SOURCE;continue;case"extends":this._state=g.State.DEF_EXTENDS;continue;case"implements":this._state=g.State.DEF_IMPLEMENTS;continue;case"uses":this._state=g.State.DEF_USES;continue;default:this._state===g.State.DEF_META||"@"===c.charAt(0)?this._state=g.State.DEF_META:c.match(/ /)?this._state=g.State.DEF_DESC:void 0}switch(this._state){case g.State.DEF_DESC:c=c.replace(/\$\((.+?)\)|\$/g,b),c=c.split(" @"),a=c[0].split(/ +/).filter(Boolean).concat(void 0!==c[1]?["@"+c[1]].concat(a):a),this._state=void 0===this._name?g.State.DEF_NAME:g.State.DEF_NOP;break;case g.State.DEF_META:c=c.replace(/\$\((.+?)\)|\$/g,b),"+"===c.charAt(c.length-1)?a=[c.slice(0,-1)+a.shift()].concat(a):(this._state=g.State.DEF_DESC,this._meta.push(c.slice(1)));break;case g.State.DEF_NAME:this._name=c||this._name;break;case g.State.DEF_SOURCE:this._source=c||this._source;break;case g.State.DEF_EXTENDS:this._extends=c||this._extends;break;case g.State.DEF_IMPLEMENTS:this._interfaces.push(null!==(d=c.match(/^\/(.*?)\/([gimy]*)$/))?new RegExp(d[1],d[2]):c);break;case g.State.DEF_USES:this._uses.push(i(c))}}},patchObject:function(a){var b=this;return a.refObject=this.bind(this.refObject),a.getRefCount=function(){return b._refCount},a.getHeapId=function(){return b._id},a.getName=function(){return b._name},a.getSource=function(){return b._source},a.getChildren=function(){return b._childrenWrapper},a.getState=function(){return b._state},a.setState=function(){var a=Array.prototype.slice.call(arguments,0);a.forEach(function(a){b._state|=a}),this.getChildren().forEach(function(b){b.setState(a)})},a.unsetState=function(){var a=Array.prototype.slice.call(arguments,0);a.forEach(function(a){b._state&=~a}),this.getChildren().forEach(function(b){b.unsetState(a)})},a.getMeta=function(){return b._meta},a.isAbstract=function(){return b._isAbstract},a},unpatchObject:function(a){return delete a.refObject,delete a.getRefCount,delete a.getHeapId,delete a.getName,delete a.getSource,delete a.getChildren,delete a.getState,delete a.setState,delete a.unsetState,delete a.getMeta,delete a.isAbstract,a},refObject:function(a){var b=this;this.parent.refObject(function(c,d){var e;b._refCount?b._refCount++:(b._refCount=e=1,b._instance=b.patchObject(new b._class),b._instance.setState(g.State.LIFE_INITIATED)),e&&b._isAgent&&!b._isAbstract&&b._instance.setup(),a(b._instance,function(){b._isAgent&&b._isPassive||(0!==--b._refCount?d():b._isAgent?b._instance.takedown(function(){b._children=[],b.unpatchObject(b._instance),delete b._instance,d()}):(b._children=[],b.unpatchObject(b._instance),delete b._instance,d()))})})}}),g.Delegate=g.Base.inherit({getName:function(){return"Delegate"},getInterfaces:function(){return[]},matchInterface:function(a){for(var b=this.getInterfaces(),c=0;c<b.length&&(b[c]instanceof RegExp?null===a.match(b[c]):b[c]!==a);c++);return b[c]},refObject:function(a){a(this,function(){})},dispatch:function(a,b){var c,d;return b=b||function(){},"$"===a.method.charAt(0)?b():(void 0===this[c=a["interface"]+"."+a.method]&&void 0===this[c=a.method]?c=void 0:void 0,void(void 0===c||void 0===(d=this.$signatures[c])||"$"!==d[d.length-1].charAt(0)||d.length!==a.args.length+1?void 0===this[c=this.$__catchall__]||void 0===(d=this.$signatures[c])||"$"!==d[1].charAt(0)||2!==d.length?b():this[this.$__catchall__].apply(this,[a.args,b]):this[c].apply(this,a.args.concat(b))))}}),g.Pattern=g.Delegate.inherit({getName:function(){return"Pattern"},init:function(a,b){this.$super(),this._pattern=a,this.property("source",function(){return b})},toArray:function(){return this._pattern instanceof Array?this._pattern:[[this._pattern]]}}),g.Agent=g.Delegate.inherit({getName:function(){return"Agent"},getInterfaces:function(){return["Agent"]},setup:function(a){this.setState(g.State.LIFE_ACTIVE),this.doActivate(a)},takedown:function(a){this.doDelete(a)},doActivate:function(a){this.unsetState(g.State.LIFE_SUSPENDED),a&&a(),i()},doDelete:function(a){this.setState(g.State.LIFE_DELETED),a&&a(),i()},doSuspend:function(a){this.setState(g.State.LIFE_SUSPENDED),a&&a(),i()},doWait:function(a){this.setState(g.State.LIFE_WAITING),a&&a(),i()},doWake:function(a){this.unsetState(g.State.LIFE_WAITING),a&&a(),i()},addBehaviour:function(){var a,b,c=this,d=Array.prototype.slice.call(arguments,0),e=new g.Definition(this,g.Behaviour,g.getBacktrace(1)[0],d);if(void 0!==e["class"]){var f=function(){e.refCount?a=e.instance:e.refObject(function(b,d){g.attach(e),a=b,c.getChildren().push(a,d)}),a.unsetState(g.State.LIFE_WAITING|g.State.LIFE_SUSPENDED|g.State.LIFE_DELETED|g.State.LIFE_TRANSIT|g.State.LIFE_BLOCKED),a.setState(c.getState()|g.State.LIFE_ACTIVE),i()};f(),b=a.reset,a.reset=function(){f(),b.apply(a,arguments)}}return a},removeBehaviour:function(){var a=[],b=this.getChildren();if("object"==typeof arguments[0]&&void 0!==arguments[0].getHeapId){var c=arguments[0].getHeapId();b.forEach(function(b,d){b.getHeapId()===c&&(b.setState(g.State.LIFE_DELETED),d(),a.push(b))})}else{var d=Array.prototype.slice.call(arguments,0),e=new g.Definition(this,g.Behaviour,g.getBacktrace(1)[0],d);b.forEach(function(b,c){b.getName()===e.name&&(b.setState(g.State.LIFE_DELETED),c(),a.push(b))})}return a}}),g.Behaviour=g.Delegate.inherit({getName:function(){return"Behaviour"},getInterfaces:function(){return["Behaviour"]},done:function(){return!1},action:function(a){this.done()?this.$owner.removeBehaviour(this):void 0,a&&a()},block:function(a){this.setState(g.State.LIFE_BLOCKED),a&&a()},restart:function(a){this.unsetState(g.State.LIFE_BLOCKED),a&&a()},reset:function(a){a&&a()}}),g.Selector=g.Base.inherit({getName:function(){return"Selector"},init:function(a,b,c){var d,e,f;if(this.$super(),this._source=b,this._exprs=[],this._selection=[],this._callbacks=[],a instanceof g.Pattern)this._source=a.source,a=a.toArray();else if("string"==typeof a){var h={and:{},not:{}};h.and[a]=!0,this._exprs.push(h)}if(a instanceof Array)for(d=0;d<a.length;d++)this.parseStack(a[d]);for(c=void 0===c?!0:c,d=0;d<g.heap.length;d++)f=g.heap[d],e=f.isPassive?f.isPassive&c&&f.state<g.State.LIFE_SUSPENDED:c?f.state<g.State.LIFE_SUSPENDED:f.state<g.State.LIFE_WAITING,!f.isAbstract&&f.refCount>0&&f.state&g.State.LIFE_ACTIVE&&e?f.refObject(this.bind(this.matchObject)):void 0;this.property("length",function(){return this._selection.length})},parseStack:function(a){for(var b,c,d=g.State.EXPR_AND,e={and:{},not:{}};void 0!==(c=a.shift());){switch(c){case"and":d=g.State.EXPR_AND;continue;case"not":d=g.State.EXPR_NOT;continue;case"or":d=g.State.EXPR_OR;continue}switch(d){case g.State.EXPR_AND:e.and[c]=!0;break;case g.State.EXPR_NOT:e.not[c]=!0;break;case g.State.EXPR_OR:for(b in e.and){this._exprs.push(e);break}e={and:{},not:{}},e.and[c]=!0}}for(b in e.and){this._exprs.push(e);break}},matchObject:function(a,b){for(var c,d,e=0;e<this._exprs.length;e++){var f,g=this._exprs[e];for(c in g.and){if(void 0===(f=a.matchInterface(c,this._source))){d=void 0;break}d=d||f}if(void 0!==d){for(c in g.not)if(a.matchInterface(c,this._source))return void(d=void 0);if(void 0!==d)break}}void 0===d?b():(this._callbacks.push(b),this._selection.push({match:d,obj:a}))},dispatch:function(a,b,c){f.setImmediate(this.bind(function(){if(a.filters&g.Filter.FIRST&&this._selection.length>0)this._selection[0].obj.dispatch({"interface":this._selection[0].match,method:a.method,args:a.args},this.bind(function(){return b.apply(this._selection[0].obj,Array.prototype.slice.call(arguments,0).concat(c))}));else if(a.filters&g.Filter.LAST&&this._selection.length>0){var d=this._selection.length-1;this._selection[d].obj.dispatch({"interface":this._selection[d].match,method:a.method,args:a.args},this.bind(function(){return b.apply(this._selection[d].obj,Array.prototype.slice.call(arguments,0).concat(c))}))}else a.filters&g.Filter.ALL&&this._selection.length>0?f.each(this._selection,function(c,d){c.obj.dispatch({"interface":c.match,method:a.method,args:a.args},function(){return b.apply(c.obj,Array.prototype.slice.call(arguments,0).concat(d))})},c):c()}))},release:function(){for(var a=0;a<this._callbacks.length;a++)this._callbacks[a]();this._callbacks=[],this._selection=[]}}),g.WAKE_MIN_PERIOD=500,g.nextWakeTime=Date.now(),g.isActionTaskQueued=!1,g.wakeTask=function(){var a=Date.now();if(a>=g.nextWakeTime){var b=new g.Selector([["Behaviour","and","Waker"]],"$thing",!1);0===b.length?(b.release(),b=void 0):b.dispatch({filters:g.Filter.ALL,method:"action",args:[]},function(a){a()},function(){b.release(),b=void 0}),g.nextWakeTime=a%g.WAKE_MIN_PERIOD+a}},g.enqueueActionTask=function(){g.isActionTaskQueued||(g.isActionTaskQueued=!0,f.setImmediate(function(){var a=new g.Selector([["Behaviour","not","Waker"]],"$thing",!1);0===a.length?(a.release(),a=void 0,g.isActionTaskQueued=!1):a.dispatch({filters:g.Filter.ALL,method:"action",args:[]},function(a){a()},function(){a.release(),a=void 0,g.isActionTaskQueued=!1,g.enqueueActionTask()})}))};var i=a.agent=function(){var a,b,d,e,f,h,i,j=0;switch(arguments.length){case 0:return g.wakeTask(),g.enqueueActionTask();case 1:if(arguments[0]instanceof g.Pattern){d=new g.Selector(f=arguments[0]);break}if("object"==typeof arguments[0]&&void 0!==arguments[0].getInterfaces){d=arguments[0];break}default:var k=Array.prototype.slice.call(arguments,0);if(a=new g.Definition(g.Container,g.Agent,b=g.getBacktrace(1)[0],k),void 0!==a["class"])return a.refObject(function(a,b){b()});h=[],g.searchMeta(a,"select",function(){h.push(Array.prototype.slice.call(arguments,0))}),d=new g.Selector(f=h.length?h:a.name,b)}return e=function(a,b){return function(){var e,k=Array.prototype.slice.call(arguments,0);switch(arguments.length){case 0:e=g.Container;break;case 1:if("object"==typeof arguments[0]&&void 0!==arguments[0].getInterfaces){e=arguments[0];break}default:var l=g.getBacktrace(1)[0],m=new g.Definition(g.Container,g.Agent,l,k);void 0!==m["class"]?e=m:(h=[],g.searchMeta(m,"select",function(){h.push(Array.prototype.slice.call(arguments,0))}),e=new g.Pattern(h.length?h:m.name,l))}return e.refObject(function(e,g){j++,void 0!==f?d.dispatch({filters:a,method:b[0],args:b.slice(1)},function(){return c(e,Array.prototype.slice.call(arguments,0,arguments.length-1),arguments[arguments.length-1])},function(){0===--j&&(g(),d.release())}):d.dispatch({filters:a,method:b[0],args:b.slice(1)},function(){return c(e,arguments,function(){0===--j&&g()})})}),i}},i=function(){return e(g.Filter.ALL,Array.prototype.slice.call(arguments,0))},i.all=i,i.first=function(){return e(g.Filter.FIRST,Array.prototype.slice.call(arguments,0))},i.last=function(){return e(g.Filter.LAST,Array.prototype.slice.call(arguments,0))},i};void 0!==d?d.exports=i:a.agent=i,g.Container=new(g.Agent.inherit({getName:function(){return"Container"},getInterfaces:function(){return["Container"]},setup:void 0,takedown:void 0,addBehaviour:void 0,removeBehaviour:void 0})),i({setup:function(b){this.$super(b),this.addBehaviour("@passive","@catchall catchAll","Done",{catchAll:function(a,b){b("done")()}}),this.addBehaviour("@passive","@catchall catchAll","Error",{catchAll:function(a,b){b("doneWithError",-1)()}}),this.addBehaviour("abstract Flow",{getFlow:function(){var b=this,c=this.reset,d=this.getFlow,e=[],f=[],h=Array.prototype.slice.call(arguments,0);return h.forEach(function(a){-1===f.indexOf(a)?f.push(a):void 0}),g.searchMeta(this,"flow",function(){Array.prototype.slice.call(arguments,0).forEach(function(a){-1===f.indexOf(a)?f.push(a):void 0})}),f.forEach(function(c){void 0!==b.$signatures[c]&&"$"===b.$signatures[c][b.$signatures[c].length-1].charAt(0)?e.push(function(){var d=arguments[arguments.length-1],h=Array.prototype.slice.call(arguments,0,arguments.length-1);h.push(function(){var b=arguments;return 0===b.length?d():function(){i(new(g.Agent.inherit({done:function(a){var b=f.indexOf(c);f.splice(b,1),e.splice(b,1),a(),d()},"yield":function(a){a(),d()}}))).apply(a,b).apply(a,[])}}),b[c].apply(b,h)}):void 0}),this.reset=function(a){return this.getFlow=d,c.apply(this,[a])},this.getFlow=function(){return e},e},action:function(a){this.getFlow().length?void 0:this.done=function(){return!0},this.$super(a)},done:function(){return!1}}),this.addBehaviour("abstract Series extends Flow",{action:function(a){f.series(this.getFlow(),this.bind(function(){this.$super(a)
}))}}),this.addBehaviour("abstract Parallel extends Flow",{action:function(a){f.parallel(this.getFlow(),this.bind(function(){this.$super(a)}))}}),this.addBehaviour("abstract Queue extends Flow",{getQueue:function(){var a=this,b=1,c=0,d=[],e=0,h=!1;g.searchMeta(this,"concurrency","int",function(a){b=a}),g.searchMeta(this,"limit","int",function(a){c=a});var j={push:function(b,e){return c&&d.length>c-1?void e(-1):(h||a.unsetState(g.State.LIFE_WAITING),void d.push(function(c){var d=a.getFlow();d.length?f.applyEach(d,b,function(a){c(),e(a)}):(c(),e(-1))}))},action:function(c,h){for(var i=[],j=d.length<b?d.length:b;j--;)i.push(d.shift());i.length>0?(e=i.length,f.parallel(i,function(){e=0,c(h)})):(a.setState(g.State.LIFE_WAITING),c(h))},pause:function(){h||(h=!0,a.setState(g.State.LIFE_WAITING))},resume:function(){h&&(h=!1,a.unsetState(g.State.LIFE_WAITING),i())}};return Object.defineProperty(j,"length",{get:function(){return e+d.length}}),this.getQueue=function(){return j},j},action:function(a){this.getQueue().action(this.bind(this.$super),a)},push:function(a,b){if(a instanceof Array){var c,d=this,e=a.length,f=[];a.forEach(function(a,g){d.getQueue().push(a,function(a){c=(f[g]=a)||c,--e?void 0:c?b("doneWithError",f)():b("done")()})})}else this.getQueue().push(a,function(a){a?b("doneWithError",a)():b("done")()});i()},pause:function(a){this.getQueue().pause(),a()},resume:function(a){this.getQueue().resume(),a()}}),this.addBehaviour("abstract Waker",{getWakeTime:function(){var a,b=1e3,c=Date.now();return g.searchMeta(this,"period","int",function(a){b=a}),a=c%b+c,this.getWakeTime=function(){return a},this.getWakeTime()},wake:function(a){var b=this.getWakeTime();void 0===b&&this.$owner.removeBehaviour(this),void 0!==a&&a()},action:function(a){var b=Date.now(),c=this.getWakeTime();void 0!==c&&0>=c-b&&(this.getWakeTime=function(){return void 0},i(this)("wake")()),this.$super(a)},done:function(){var a=Date.now(),b=this.getWakeTime();return void 0===b?!1:0>=b-a?!0:!1},reset:function(a){delete this.getWakeTime,this.$super(a)},stop:function(a){this.$owner.removeBehaviour(this),void 0!==a&&a()}}),this.addBehaviour("abstract Sensor extends Queue"),this.addBehaviour("abstract Actuator extends Queue")}})}(this);
//# sourceMappingURL=thingjs-agent-0.1.0-withasync.min.js.map