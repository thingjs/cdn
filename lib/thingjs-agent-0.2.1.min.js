"use strict";var $thing=$thing||{};$thing.bootstrap="browser.js",$thing.usePaho=!0,$thing.async=async,$thing.getMicroTime=function(){return 1e3*Date.now()},$thing.getBacktrace=function(first){first=first||0;try{0()}catch(e){var trace=e.stack.replace(/Object\.\$thing\.\$container [^\r\n\t\f ]+/g,"$container:0:0").replace(/\$thing\.\$container@[^\r\n\t\f ]+/g,"$container:0:0").replace(/\$container@[^\r\n\t\f ]+/g,"$container:0:0");return null!==(trace=trace.match(/[^\r\n\t\f\( ]+\d\:\d+/g))?trace.slice(1+first):null!==(trace=trace.match(/\s+at /g))?trace.slice(1+first):[]}},$thing.createBuffer=function(byteArray){return{buf:byteArray,toString:function(){return String.fromCharCode.apply(null,new Uint16Array(byteArray))}}},$thing.Mash=function(){var n=4022871197,mash=function(data){data=data.toString();for(var i=0;i<data.length;i++){n+=data.charCodeAt(i);var h=.02519603282416938*n;n=h>>>0,h-=n,h*=n,n=h>>>0,h-=n,n+=4294967296*h}return 2.3283064365386963e-10*(n>>>0)};return mash},$thing.create64BitId=function(){for(var h1=new $thing.Mash,h2=new $thing.Mash,i=0;i<arguments.length;i++)h1(arguments[i]||"");return h1("").toString(16).split(".")[1]+h2($thing.getMicroTime()).toString(16).split(".")[1]},$thing.merge=function(){for(var args=Array.prototype.slice.call(arguments,0),obj=args[0],i=1;i<args.length;i++)if(void 0!==args[i])for(var k in args[i])void 0===obj[k]?obj[k]=args[i][k]:void 0;return obj},$thing.containers={$thing:{source:"$thing",heap:[]}},$thing.$container=function(cb){cb()},$thing.getContainer=function(backtrace){var i=backtrace.indexOf("$container:0:0");return-1===i?$thing.containers.$thing:$thing.containers[backtrace[++i]]?$thing.containers[backtrace[i]]:$thing.containers[backtrace[i]]={source:backtrace[i],heap:[]}},$thing.attach=function(def,heap){if(void 0!==def._id)return def._id;for(var length=heap.length;0!==heap.length&&0===heap[heap.length-1]._refCount;)heap.pop()._id=void 0;if(heap.length&&heap.length===length){def._id=void 0;for(var i=heap.length-1;i>-1&&void 0===def._id;i--)0===heap[i]._refCount&&(heap[i]._id=void 0,heap[def._id=i]=def);void 0===def._id&&(def._id=heap.push(def)-1)}else def._id=heap.push(def)-1;return def._id},$thing.search=function(obj,heap){for(var match,i=heap.length-1;i>-1;i--)if(heap[i]._refCount>0){for(var k in obj)if(!(match=obj[k]===heap[i][k]))break;if(match)return heap[i]}return void 0},$thing.searchMeta=function(obj,predicate){var type="string",cb=arguments[2],meta=void 0!==obj.getMeta?obj.getMeta():obj._meta;switch(arguments[2]){case"int":case"boolean":case"string":type=arguments[2],cb=arguments[3]}meta.forEach(function(item){if(item=item.match(/\S+/g),null!==item&&item[0]===predicate)switch(item=item.slice(1),type){case"int":isNaN(item[0]=parseInt(item[0]))||cb.apply(obj,item);break;case"boolean":switch(item[0].toLowerCase()){case"true":item[0]=!0,cb.apply(obj,item);break;case"false":item[0]=!1,cb.apply(obj,item)}break;default:cb.apply(obj,item)}})},$thing.cbBuilder=function(self,args,cbDone){return cbDone=cbDone||function(){},function(){var self=this,args=arguments;return $thing.agent(),args.length?function(){var cbObj=arguments.length?arguments:[$thing.Container];$thing.async.setImmediate(function(){$thing.agent(self).apply($thing,args).apply($thing,cbObj),cbDone()})}:cbDone()}.apply(self,args)};var agent=$thing.agent=function(){var def,backtrace,selector,filter,pattern,selects,callChain,refCount=0;switch(arguments.length){case 0:return $thing.Tasker.thread();case 1:if(arguments[0]instanceof $thing.Pattern){selector=new $thing.Selector(void 0,pattern=arguments[0]);break}if("object"==typeof arguments[0]&&void 0!==arguments[0].getInterfaces){selector=arguments[0];break}default:var args=Array.prototype.slice.call(arguments,0);if(def=new $thing.Definition(void 0,$thing.Container,$thing.Agent,backtrace=$thing.getBacktrace(1),args),void 0!==def["class"])return def.refObject(function(obj,cbRelease){cbRelease()});selects=[],$thing.searchMeta(def,"select",function(){selects.push(Array.prototype.slice.call(arguments,0))}),selector=new $thing.Selector(void 0,pattern=selects.length?selects:def.name,backtrace)}return filter=function(filters,callArgs){return function(){var obj,args=Array.prototype.slice.call(arguments,0);switch(arguments.length){case 0:obj=$thing.Container;break;case 1:if("object"==typeof arguments[0]&&void 0!==arguments[0].getInterfaces){obj=arguments[0];break}default:var backtrace=$thing.getBacktrace(1),def=new $thing.Definition(void 0,$thing.Container,$thing.Agent,backtrace,args);void 0!==def["class"]?obj=def:(selects=[],$thing.searchMeta(def,"select",function(){selects.push(Array.prototype.slice.call(arguments,0))}),obj=new $thing.Pattern(selects.length?selects:def.name,backtrace))}return obj.refObject(function(obj,cbRelease){refCount++,void 0!==pattern?selector.dispatch({filters:filters,method:callArgs[0],args:callArgs.slice(1)},function(){return $thing.cbBuilder(obj,Array.prototype.slice.call(arguments,0,arguments.length-1),arguments[arguments.length-1])},function(){0===--refCount&&(cbRelease(),selector.release())}):selector.dispatch({filters:filters,method:callArgs[0],args:callArgs.slice(1)},function(){return $thing.cbBuilder(obj,arguments,function(){0===--refCount&&cbRelease()})})}),callChain}},callChain=function(){return filter($thing.Filter.ALL,Array.prototype.slice.call(arguments,0))},callChain.all=callChain,callChain.first=function(){return filter($thing.Filter.FIRST,Array.prototype.slice.call(arguments,0))},callChain.last=function(){return filter($thing.Filter.LAST,Array.prototype.slice.call(arguments,0))},callChain};$thing.switchContext=function(functString,parentOrdinal,superOrdinal,ordinal,superName,methodName){return functString=functString||this.$vtable[ordinal][methodName].toString(),functString.indexOf("$parent")>-1||functString.indexOf("$super")>-1?function(){var ret,$parent=this.$parent,$super=this.$super;return this.$parent=this.$vtable[parentOrdinal]||$parent,this.$super=this.$vtable[superOrdinal][superName],ret=this.$vtable[ordinal][methodName].apply(this,arguments),this.$parent=$parent,this.$super=$super,ret}:this.$vtable[ordinal][methodName]},$thing.switchParentContext=function(functString,parentOrdinal,ordinal,methodName){return functString=functString||this.$vtable[ordinal][methodName].toString(),functString.indexOf("$parent")>-1?function(){var ret,$parent=this.$parent;return this.$parent=this.$vtable[parentOrdinal]||this.$parent,ret=this.$vtable[ordinal][methodName].apply(this,arguments),this.$parent=$parent,ret}:this.$vtable[ordinal][methodName]},$thing.Object=function(){},$thing.Object.prototype.getName=function(){return"Object"};var $inherit=$thing.Object.inherit=function(obj,parent){function ret(){void 0!==this.init?this.init.apply(this,arguments):void 0}function replace(){return void 0!==obj["$"+arguments[1]]?obj["$"+arguments[1]]:arguments[0]}var i,j,k,v,functString,signature,signatures={},inherit=this.prototype;ret.prototype=new this,ret.prototype.constructor=ret,ret.prototype.$vtable=void 0!==ret.prototype.$vtable?ret.prototype.$vtable.slice():[];var ordinal=ret.prototype.$vtable.push(obj)-1,parentOrdinal=ret.prototype.$vtable.push(parent)-1,superOrdinal=ret.prototype.$vtable.push(inherit)-1;ret.inherit=$inherit;for(i in obj){switch(i){case"$vtable":case"$signatures":case"$owner":case"$parent":case"$super":continue}v=obj[i],k=i.replace(/\$\((.+?)\)/g,replace),j=k.substring(k.indexOf(".")+1),"function"!=typeof v?ret.prototype[k]=v:(functString=v.toString(),signature=functString.match(/function[^(]*\(([^)]*)\)/),ret.prototype[k]="function"!=typeof inherit[k]?"function"!=typeof inherit[j]?$thing.switchParentContext.apply(ret.prototype,[functString,parentOrdinal,ordinal,i]):$thing.switchContext.apply(ret.prototype,[functString,parentOrdinal,superOrdinal,ordinal,j,i]):$thing.switchContext.apply(ret.prototype,[functString,parentOrdinal,superOrdinal,ordinal,k,i]),null!==signature&&(signatures[k]=signature[1].length?signature[1].split(/,\s*/):[]))}return ret.prototype.$owner=parent||ret.prototype.$owner,ret.prototype.$signatures=$thing.merge(signatures,ret.prototype.$signatures),ret};$thing.Base=$thing.Object.inherit({init:function(){},getName:function(){return"Base"},property:function(prop,cbGetter,cbSetter){var obj={};cbGetter?obj.get=cbGetter:void 0,cbSetter?obj.set=cbSetter:void 0,Object.defineProperty(this,prop,obj)},bind:function(funct){var self=this;return function(){return funct.apply(self,arguments)}}}),$thing.State={EXPR_AND:1,EXPR_NOT:2,EXPR_OR:3,DEF_DESC:1,DEF_NAME:2,DEF_SOURCE:4,DEF_EXTENDS:16,DEF_IMPLEMENTS:64,DEF_USES:128,DEF_META:256,DEF_NOP:512,DEF_END:1024,LIFE_INITIATED:2048,LIFE_ACTIVE:4096,LIFE_WAITING:8192,LIFE_SUSPENDED:16384,LIFE_DELETED:32768,LIFE_TRANSIT:65536,LIFE_BLOCKED:131072},$thing.Definition=$thing.Base.inherit({_metaHandlers:{mobile:function(){this._isMobile=!0},passive:function(){this._isPassive=!0},singleton:function(){this._singleton=this._singleton||this._source},catchall:function(catchall,methodName){this._substitute.$__catchall__=methodName}},getName:function(){return"Definition"},init:function(container,parent,_super,backtrace,stack){var k,item,search,self=this,heap=container?container.heap:$thing.getContainer(backtrace).heap;if(this.$super(),this._state=$thing.State.DEF_DESC,this._parent=parent,this._children=[],this._meta=[],this._interfaces=[],this._uses=[],this._super=_super,this._source=backtrace[0],this._refCount=0,this._isAgent=this._super===$thing.Agent,this._isAbstract=!1,this._isPassive=!1,this._isMobile=!1,this._interfaces=[$thing.create64BitId(this._source,heap.length),this._source],this._substitute={$id:this._interfaces[0],$source:this._source},this.parseStack(stack),void 0!==this._extends){if(item=$thing.search({_name:this._extends},heap),void 0===item)throw new Error("DefinitionError: Super Class '"+this._extends+"' is not defined");for(this._super=item._class,this._singleton=item._singleton,k=item._meta.length-1;k>-1;k--)this._meta.unshift(item._meta[k]);void 0===this._class?this._class={}:void 0}if(this._meta.forEach(function(item){var args=item.split(/ (.+)?/);void 0!==self._metaHandlers[args[0]]?self._metaHandlers[args[0]].apply(self,args):void 0}),this._isAbstract?search={_name:this._name,_source:this._source}:void 0!==this._singleton&&(search={_name:this._name,_singleton:this._singleton}),void 0!==search&&(item=$thing.search(search,heap)))this.refObject=item.bind(item.refObject),this.property("class",function(){return item._class}),this.property("refCount",function(){return item._refCount}),this.property("isAbstract",function(){return item._isAbstract}),this.property("isPassive",function(){return item._isPassive}),this.property("instance",function(){return item._instance}),this.property("state",function(){return item._state}),this.property("name",function(){return item._name}),this.property("parent",function(){return item._parent});else{if(this._childrenWrapper={push:this.bind(this._pushChild),forEach:this.bind(this._forEachChild)},Object.defineProperty(this._childrenWrapper,"length",{get:this.bind(this._countChildren)}),void 0!==this._factory?this._class=this._factory.apply($thing,this._uses):void 0,void 0!==this._class){for(k in this._substitute)this._class[k]=this._substitute[k];var interfaces=void 0!==this._name?this._interfaces.concat(this._name):this._interfaces;this._class.getInterfaces=function(){return this.$super().concat(interfaces)},this._class=this._super.inherit(this._class,parent,this._isMobile),$thing.attach(this,heap)}this.property("class",function(){return this._class}),this.property("refCount",function(){return this._refCount}),this.property("isAbstract",function(){return this._isAbstract}),this.property("isPassive",function(){return this._isPassive}),this.property("instance",function(){return this._instance}),this.property("state",function(){return this._state}),this.property("name",function(){return this._name}),this.property("parent",function(){return this._parent})}},_forEachChild:function(cb){this._children.forEach(function(args){void 0!==args[0].getHeapId?cb.apply(void 0,args):void 0})},_pushChild:function(obj){for(var id=obj.getHeapId(),i=0;i<this._children.length;i++)if(void 0===this._children[i][0].getHeapId)this._children.splice(i,1);else if(this._children[i][0].getHeapId()===id)return this._children.length;return this._children.push(arguments)},_countChildren:function(){var length=0;return this._forEachChild(function(child){child.getRefCount()&&length++}),length},parseStack:function(stack){function replace(){return void 0===arguments[1]?stack.shift():self._substitute["$"+arguments[1]]=stack.shift()}for(var item,match,self=this;this._state!==$thing.State.DEF_END&&void 0!==(item=stack.shift());){switch(typeof item){case"function":this._state=$thing.State.DEF_END,this._factory=item;continue;case"object":this._state=$thing.State.DEF_END,this._class=item;continue}switch(item){case"abstract":this._isPassive=this._isAbstract=!0;continue;case"source":this._state=$thing.State.DEF_SOURCE;continue;case"extends":this._state=$thing.State.DEF_EXTENDS;continue;case"implements":this._state=$thing.State.DEF_IMPLEMENTS;continue;case"uses":this._state=$thing.State.DEF_USES;continue;default:this._state===$thing.State.DEF_META||"@"===item.charAt(0)?this._state=$thing.State.DEF_META:item.match(/ /)?this._state=$thing.State.DEF_DESC:void 0}switch(this._state){case $thing.State.DEF_DESC:item=item.replace(/\$\((.+?)\)|\$/g,replace),item=item.split(" @"),stack=item[0].split(/ +/).filter(Boolean).concat(void 0!==item[1]?["@"+item[1]].concat(stack):stack),this._state=void 0===this._name?$thing.State.DEF_NAME:$thing.State.DEF_NOP;break;case $thing.State.DEF_META:item=item.replace(/\$\((.+?)\)|\$/g,replace),"+"===item.charAt(item.length-1)?stack=[item.slice(0,-1)+stack.shift()].concat(stack):(this._state=$thing.State.DEF_DESC,this._meta.push(item.slice(1)));break;case $thing.State.DEF_NAME:this._name=item||this._name;break;case $thing.State.DEF_SOURCE:this._source=item||this._source;break;case $thing.State.DEF_EXTENDS:this._extends=item||this._extends;break;case $thing.State.DEF_IMPLEMENTS:this._interfaces.push(null!==(match=item.match(/^\/(.*?)\/([gimy]*)$/))?new RegExp(match[1],match[2]):item);break;case $thing.State.DEF_USES:this._uses.push($thing.agent(item))}}},patchObject:function(obj){var self=this;return obj.refObject=this.bind(this.refObject),obj.getRefCount=function(){return self._refCount},obj.getHeapId=function(){return self._id},obj.getName=function(){return self._name},obj.getSource=function(){return self._source},obj.getChildren=function(){return self._childrenWrapper},obj.getState=function(){return self._state},obj.setState=function(){var states=Array.prototype.slice.call(arguments,0);states.forEach(function(state){self._state|=state}),this.getChildren().forEach(function(child){child.setState(states)})},obj.unsetState=function(){var states=Array.prototype.slice.call(arguments,0);states.forEach(function(state){self._state&=~state}),this.getChildren().forEach(function(child){child.unsetState(states)})},obj.getMeta=function(){return self._meta},obj.isAbstract=function(){return self._isAbstract},obj},unpatchObject:function(obj){return delete obj.refObject,delete obj.getRefCount,delete obj.getHeapId,delete obj.getName,delete obj.getSource,delete obj.getChildren,delete obj.getState,delete obj.setState,delete obj.unsetState,delete obj.getMeta,delete obj.isAbstract,obj},refObject:function(cb){var self=this;this.parent.refObject(function(parent,cbRelease){var constructed;self._refCount?self._refCount++:(self._refCount=constructed=1,self._instance=self.patchObject(new self._class),self._instance.setState($thing.State.LIFE_INITIATED)),constructed&&self._isAgent&&!self._isAbstract&&self._instance.setup(),cb(self._instance,function(){self._isAgent&&self._isPassive||(0!==--self._refCount?cbRelease():self._isAgent?self._instance.takedown(function(){self._children=[],self.unpatchObject(self._instance),delete self._instance,cbRelease()}):(self._children=[],self.unpatchObject(self._instance),delete self._instance,cbRelease()))})})}}),$thing.Delegate=$thing.Base.inherit({getName:function(){return"Delegate"},getInterfaces:function(){return[]},matchInterface:function(pattern){for(var interfaces=this.getInterfaces(),i=0;i<interfaces.length&&(interfaces[i]instanceof RegExp?null===pattern.match(interfaces[i]):interfaces[i]!==pattern);i++);return interfaces[i]},refObject:function(cb){cb(this,function(){})},dispatch:function(call,cb){var method,signature;return cb=cb||function(){},"$"===call.method.charAt(0)?cb():(void 0===this[method=call["interface"]+"."+call.method]&&void 0===this[method=call.method]?method=void 0:void 0,void(void 0===method||void 0===(signature=this.$signatures[method])||"$"!==signature[signature.length-1].charAt(0)||signature.length!==call.args.length+1?void 0===this[method=this.$__catchall__]||void 0===(signature=this.$signatures[method])||"$"!==signature[1].charAt(0)||2!==signature.length?cb():this[this.$__catchall__].apply(this,[call.args,cb]):this[method].apply(this,call.args.concat(cb))))}}),$thing.Pattern=$thing.Delegate.inherit({getName:function(){return"Pattern"},init:function(pattern,backtrace){this.$super(),this._pattern=pattern,this.property("backtrace",function(){return backtrace})},toArray:function(){return this._pattern instanceof Array?this._pattern:[[this._pattern]]}}),$thing.Agent=$thing.Delegate.inherit({getName:function(){return"Agent"},getInterfaces:function(){return["Agent"]},setup:function(cb){this.setState($thing.State.LIFE_ACTIVE),this.doActivate(cb)},takedown:function(cb){this.doDelete(cb)},doActivate:function(cb){this.unsetState($thing.State.LIFE_SUSPENDED),cb&&cb(),$thing.agent()},doDelete:function(cb){this.setState($thing.State.LIFE_DELETED),cb&&cb(),$thing.agent()},doSuspend:function(cb){this.setState($thing.State.LIFE_SUSPENDED),cb&&cb(),$thing.agent()},doWait:function(cb){this.setState($thing.State.LIFE_WAITING),cb&&cb(),$thing.agent()},doWake:function(cb){this.unsetState($thing.State.LIFE_WAITING),cb&&cb(),$thing.agent()},addBehaviour:function(){var obj,reset,self=this,args=Array.prototype.slice.call(arguments,0),def=new $thing.Definition(void 0,this,$thing.Behaviour,$thing.getBacktrace(1),args);if(void 0!==def["class"]){var funct=function(){def.refCount?obj=def.instance:def.refObject(function(instance,cbRelease){$thing.attach(def),obj=instance,self.getChildren().push(obj,cbRelease)}),obj.unsetState($thing.State.LIFE_WAITING|$thing.State.LIFE_SUSPENDED|$thing.State.LIFE_DELETED|$thing.State.LIFE_TRANSIT|$thing.State.LIFE_BLOCKED),obj.setState(self.getState()|$thing.State.LIFE_ACTIVE),$thing.agent()};funct(),reset=obj.reset,obj.reset=function(){funct(),reset.apply(obj,arguments)}}return obj},removeBehaviour:function(){var objs=[],children=this.getChildren();if("object"==typeof arguments[0]&&void 0!==arguments[0].getHeapId){var id=arguments[0].getHeapId();children.forEach(function(obj,cbRelease){obj.getHeapId()===id&&(obj.setState($thing.State.LIFE_DELETED),cbRelease(),objs.push(obj))})}else{var args=Array.prototype.slice.call(arguments,0),def=new $thing.Definition(void 0,this,$thing.Behaviour,$thing.getBacktrace(1),args);children.forEach(function(obj,cbRelease){obj.getName()===def.name&&(obj.setState($thing.State.LIFE_DELETED),cbRelease(),objs.push(obj))})}return objs}}),$thing.Behaviour=$thing.Delegate.inherit({getName:function(){return"Behaviour"},getInterfaces:function(){return["Behaviour","parent:"+this.$parent.$id,"owner:"+this.$owner.$id]},done:function(){return!1},action:function($cb){this.done()&&this.$owner.removeBehaviour(this),$cb&&$cb()},block:function(cb){this.setState($thing.State.LIFE_BLOCKED),cb&&cb()},restart:function(cb){this.unsetState($thing.State.LIFE_BLOCKED),cb&&cb()},reset:function(cb){cb&&cb()}}),$thing.Filter={ALL:1,FIRST:2,LAST:4},$thing.Selector=$thing.Base.inherit({getName:function(){return"Selector"},init:function(container,pattern,backtrace,includePassive){var i,include,def,heap;if(this.$super(),this._exprs=[],this._selection=[],this._callbacks=[],this._backtrace=backtrace,this._source=void 0!==this._backtrace?this._backtrace[0]:void 0,pattern instanceof $thing.Pattern)this._backtrace=pattern.backtrace,this._source=this._backtrace[0],pattern=pattern.toArray();else if("string"==typeof pattern){var expr={and:{},not:{}};expr.and[pattern]=!0,this._exprs.push(expr)}if(pattern instanceof Array)for(i=0;i<pattern.length;i++)this.parseStack(pattern[i]);for(includePassive=void 0===includePassive?!0:includePassive,heap=container?container.heap:$thing.getContainer(this._backtrace).heap,i=0;i<heap.length;i++)def=heap[i],include=def.isPassive?def.isPassive&includePassive&&def.state<$thing.State.LIFE_SUSPENDED:includePassive?def.state<$thing.State.LIFE_SUSPENDED:def.state<$thing.State.LIFE_WAITING,!def.isAbstract&&def.refCount>0&&def.state&$thing.State.LIFE_ACTIVE&&include&&def.refObject(this.bind(this.matchObject));this.property("length",function(){return this._selection.length})},parseStack:function(stack){for(var k,item,state=$thing.State.EXPR_AND,expr={and:{},not:{}};void 0!==(item=stack.shift());){switch(item){case"and":state=$thing.State.EXPR_AND;continue;case"not":state=$thing.State.EXPR_NOT;continue;case"or":state=$thing.State.EXPR_OR;continue}switch(state){case $thing.State.EXPR_AND:expr.and[item]=!0;break;case $thing.State.EXPR_NOT:expr.not[item]=!0;break;case $thing.State.EXPR_OR:for(k in expr.and){this._exprs.push(expr);break}expr={and:{},not:{}},expr.and[item]=!0}}for(k in expr.and){this._exprs.push(expr);break}},matchObject:function(obj,cbRelease){for(var k,match,i=0;i<this._exprs.length;i++){var m,expr=this._exprs[i];for(k in expr.and){if(void 0===(m=obj.matchInterface(k,this._source))){match=void 0;break}match=match||m}if(void 0!==match){for(k in expr.not)if(obj.matchInterface(k,this._source))return match=void 0,void cbRelease();if(void 0!==match)break}}void 0===match?cbRelease():(this._callbacks.push(cbRelease),this._selection.push({match:match,obj:obj}))},dispatch:function(call,cbItem,cbDone){$thing.async.setImmediate(this.bind(function(){if(call.filters&$thing.Filter.FIRST&&this._selection.length>0)this._selection[0].obj.dispatch({"interface":this._selection[0].match,method:call.method,args:call.args},this.bind(function(){return cbItem.apply(this._selection[0].obj,Array.prototype.slice.call(arguments,0).concat(cbDone))}));else if(call.filters&$thing.Filter.LAST&&this._selection.length>0){var i=this._selection.length-1;this._selection[i].obj.dispatch({"interface":this._selection[i].match,method:call.method,args:call.args},this.bind(function(){return cbItem.apply(this._selection[i].obj,Array.prototype.slice.call(arguments,0).concat(cbDone))}))}else call.filters&$thing.Filter.ALL&&this._selection.length>0?$thing.async.each(this._selection,function(item,cbNext){item.obj.dispatch({"interface":item.match,method:call.method,args:call.args},function(){return cbItem.apply(item.obj,Array.prototype.slice.call(arguments,0).concat(cbNext))})},cbDone):cbDone()}))},release:function(){for(var i=0;i<this._callbacks.length;i++)this._callbacks[i]();this._callbacks=[],this._selection=[]}}),$thing.Container=new($thing.Agent.inherit({getName:function(){return"Container"},getInterfaces:function(){return["Container"]},setup:void 0,takedown:void 0,addBehaviour:void 0,removeBehaviour:void 0})),$thing.Tasker=new($thing.Base.inherit({doWake:function(container){var now=$thing.getMicroTime();if(!container.nextWakeTime||now>=container.nextWakeTime){var selector=new $thing.Selector(container,[["Behaviour","and","Waker"]],["$container:0:0","$thing"],!1);0===selector.length?(selector.release(),selector=void 0):selector.dispatch({filters:$thing.Filter.ALL,method:"action",args:[]},function(cbNext){cbNext()},function(){selector.release(),selector=void 0}),container.nextWakeTime=now+$thing.WAKE_MIN_PERIOD-now%$thing.WAKE_MIN_PERIOD}},doAction:function(container){var self=this;container.isActionTaskQueued||(container.isActionTaskQueued=!0,$thing.async.setImmediate(function(){var selector=new $thing.Selector(container,[["Behaviour","not","Waker"]],["$container:0:0","$thing"],!1);0===selector.length?(selector.release(),selector=void 0,container.isActionTaskQueued=!1):selector.dispatch({filters:$thing.Filter.ALL,method:"action",args:[]},function(cbNext){cbNext()},function(){selector.release(),selector=void 0,container.isActionTaskQueued=!1,self.doAction(container)})}))},thread:function(){var container=$thing.getContainer($thing.getBacktrace());this.doWake(container),this.doAction(container)}})),$thing.agent("@singleton","abstract Heartbeat implements Container",{setup:function(cb){this.$super(cb),this.keepAlive=this.addBehaviour("@passive",{}),this.intervalId=setInterval($thing.agent,$thing.WAKE_MIN_PERIOD/1e3)},destroy:function($cb){clearInterval(this.intervalId),this.removeBehaviour(this.keepAlive),$cb()}}),$thing.agent("@singleton",{setup:function(cb){this.$super(cb),this.addBehaviour("abstract Flow",{getFlow:function(){var self=this,reset=this.reset,getFlow=this.getFlow,methods=[],names=[],args=Array.prototype.slice.call(arguments,0);return args.forEach(function(item){-1===names.indexOf(item)&&names.push(item)}),$thing.searchMeta(this,"flow",function(){Array.prototype.slice.call(arguments,0).forEach(function(item){-1===names.indexOf(item)&&names.push(item)})}),names.forEach(function(item){void 0!==self.$signatures[item]&&"$"===self.$signatures[item][self.$signatures[item].length-1].charAt(0)&&methods.push(function(){var cbYield=arguments[arguments.length-1],args=Array.prototype.slice.call(arguments,0,arguments.length-1);args.push(function(){var args=arguments;return 0===args.length?cbYield():function(){$thing.agent(new($thing.Agent.inherit({done:function($cb){var i=names.indexOf(item);names.splice(i,1),methods.splice(i,1),$cb(),cbYield()},"yield":function($cb){$cb(),cbYield()}}))).apply($thing,args).apply($thing,[])}}),self[item].apply(self,args)})}),this.reset=function(cb){return this.getFlow=getFlow,reset.apply(this,[cb])},this.getFlow=function(){return methods},methods},action:function($cb){this.getFlow().length||(this.done=function(){return!0}),this.$super($cb)},done:function(){return!1}})}}),$thing.agent("@singleton",{setup:function(cb){this.$super(cb),this.addBehaviour("abstract Series extends Flow",{action:function($cb){$thing.async.series(this.getFlow(),this.bind(function(){this.$super($cb)}))}})}}),$thing.agent("@singleton",{setup:function(cb){this.$super(cb),this.addBehaviour("abstract Parallel extends Flow",{action:function($cb){$thing.async.parallel(this.getFlow(),this.bind(function(){this.$super($cb)}))}})}}),$thing.agent("@singleton",{setup:function(cb){this.$super(cb),this.addBehaviour("abstract Queue extends Flow",{getQueue:function(){var self=this,concurrency=1,limit=0,functs=[],active=0,paused=!1;$thing.searchMeta(this,"concurrency","int",function(value){concurrency=value}),$thing.searchMeta(this,"limit","int",function(value){limit=value});var queue={push:function(item,cbItem){return limit&&functs.length>limit-1?void cbItem(-1):(paused||self.unsetState($thing.State.LIFE_WAITING),void functs.push(function(cbDone){var flow=self.getFlow();flow.length?$thing.async.applyEach(flow,item,function(err){cbDone(),cbItem(err)}):(cbDone(),cbItem(-1))}))},action:function(next,cb){for(var call=[],length=functs.length<concurrency?functs.length:concurrency;length--;)call.push(functs.shift());call.length>0?(active=call.length,$thing.async.parallel(call,function(){active=0,next(cb)})):(self.setState($thing.State.LIFE_WAITING),next(cb))},pause:function(){paused||(paused=!0,self.setState($thing.State.LIFE_WAITING))},resume:function(){paused&&(paused=!1,self.unsetState($thing.State.LIFE_WAITING),$thing.agent())}};return Object.defineProperty(queue,"length",{get:function(){return active+functs.length}}),this.getQueue=function(){return queue},queue},action:function($cb){this.getQueue().action(this.bind(this.$super),$cb)},push:function(items,$cb){if(items instanceof Array){var ret,self=this,length=items.length,errs=[];items.forEach(function(item,i){self.getQueue().push(item,function(err){ret=(errs[i]=err)||ret,--length||(ret?$cb("doneWithError",errs)():$cb("done")())})})}else this.getQueue().push(items,function(err){err?$cb("doneWithError",err)():$cb("done")()});$thing.agent()},pause:function($cb){this.getQueue().pause(),$cb()},resume:function($cb){this.getQueue().resume(),$cb()}})}}),$thing.WAKE_MIN_PERIOD=5e4,$thing.agent("@singleton",{setup:function(cb){this.$super(cb),this.addBehaviour("abstract Waker",{getWakeTime:function(){var time,period=1e6,now=$thing.getMicroTime();return $thing.searchMeta(this,"period","int",function(value){period=1e3*value}),time=now+period-now%period,this.getWakeTime=function(){return time},this.getWakeTime()},wake:function(cb){cb()},action:function($cb){var time=this.getWakeTime();return void 0===time?this.$super($cb):$thing.getMicroTime()>=time?(this.getWakeTime=function(){return void 0},this.wake(this.bind(function(){this.$super($cb)}))):void this.$super($cb)},done:function(){return void 0!==this.getWakeTime()?!1:(delete this.getWakeTime,!0)},reset:function($cb){delete this.getWakeTime,this.$super($cb)},stop:function($cb){this.$owner.removeBehaviour(this),delete this.getWakeTime,$cb&&$cb()}})}}),$thing.agent("@singleton","Util",{setup:function(cb){this.$super(cb),this.addBehaviour("@passive","@catchall catchAll","Done",{catchAll:function(args,$cb){$cb("done")()}}),this.addBehaviour("@passive","@catchall catchAll","Error",{catchAll:function(args,$cb){$cb("doneWithError",-1)()}}),this.addBehaviour("abstract Sensor extends Queue"),this.addBehaviour("abstract Actuator extends Queue"),this.addBehaviour("abstract Bridge extends Queue implements Actuator Sensor")}});
//# sourceMappingURL=thingjs-agent-0.2.1.min.js.map