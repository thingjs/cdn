/*! ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  
        /\____                                          THING.JS               
      // ~ / _\_____                            Internet of Wild Things        
     /     \   .. \/                                 version 0.2.2             
    //     /~_____/                                                            
    /// \/  /                                      http://thingjs.org          
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ */
"use strict";if("undefined"==typeof async||"undefined"==typeof async.setImmediate)throw new Error("async missing: https://github.com/caolan/async");if("undefined"==typeof jsonld||"undefined"==typeof jsonld.compact)throw new Error("jsonld missing: https://github.com/digitalbazaar/jsonld.js");var $thing=$thing||{};$thing.bootstrap="browser.js",$thing.usePaho=!0,$thing.async=async,$thing.jsonld=jsonld,$thing.getMicroTime=function(){return 1e3*Date.now()},window.chrome?$thing.getThreadId=function(first){first=first||0;var j=0,threadId=[void 0,"main","main"],prepareStackTrace=Error.prepareStackTrace;return first++,Error.prepareStackTrace=function(err,frame){if(frame.length>first){threadId[0]=frame[first].getFileName()+":"+frame[first].getLineNumber()+":"+frame[first].getColumnNumber();for(var i=1;i<frame.length&&!("$thing.$container"===frame[i-1].getFunctionName()&&(threadId[++j]=frame[i].getFileName()+":"+frame[i].getLineNumber()+":"+frame[i].getColumnNumber(),j>threadId.length));i++);}},(new Error).stack,Error.prepareStackTrace=prepareStackTrace,threadId}:($thing.getBacktrace=function(first){first=first||0;try{0()}catch(e){var trace=e.stack.replace(/Object\.\$thing\.\$container [^\r\n\t\f ]+/g,"$container:0:0").replace(/\$thing\.\$container@[^\r\n\t\f ]+/g,"$container:0:0").replace(/\$container@[^\r\n\t\f ]+/g,"$container:0:0");return null!==(trace=trace.match(/[^\r\n\t\f\( ]+\d\:\d+/g))?trace.slice(1+first):null!==(trace=trace.match(/\s+at /g))?trace.slice(1+first):[]}},$thing.getThreadId=function(first){var j=0,threadId=[void 0,"main","main"],frame=$thing.getBacktrace(first+1);threadId[0]=frame[0];for(var i=1;i<frame.length&&!(frame[i-1].indexOf("$container:0:0")>-1&&(threadId[++j]=frame[i],j>threadId.length));i++);return threadId}),$thing.createBuffer=function(byteArray){return{buf:byteArray,toString:function(){return String.fromCharCode.apply(null,new Uint16Array(byteArray))}}},$thing.Mash=function(){var n=4022871197,mash=function(data){data=data.toString();for(var i=0;i<data.length;i++){n+=data.charCodeAt(i);var h=.02519603282416938*n;n=h>>>0,h-=n,h*=n,n=h>>>0,h-=n,n+=4294967296*h}return 2.3283064365386963e-10*(n>>>0)};return mash},$thing.create64BitId=function(){for(var h1=new $thing.Mash,h2=new $thing.Mash,i=0;i<arguments.length;i++)h1(arguments[i]||"");return h1("").toString(16).split(".")[1]+h2($thing.getMicroTime()).toString(16).split(".")[1]},$thing.merge=function(){for(var args=$thing.arrayDup(arguments),obj=args[0],i=1;i<args.length;i++)if(void 0!==args[i])for(var k in args[i])void 0===obj[k]?obj[k]=args[i][k]:void 0;return obj},$thing.arrayDup=function(src,length,destroySrc,retainLength){var i,l=length||src.length,dest=new Array(length||src.length);if(void 0===destroySrc||destroySrc===!1)for(i=0;l>i;i++)dest[i]=src[i];else{for(i=0;l>i;i++)dest[i]=src[i],src[i]=void 0;void 0===retainLength?src.length=0:src.length>retainLength&&(src.length=retainLength)}return dest},$thing.arrayAppend=function(src,value){for(var l=src.length,dest=new Array(l+1),i=0;l>i;i++)dest[i]=src[i];return dest[l]=value,dest},$thing.arrayToObject=function(values,predicates,cbTestFunc){var obj={};predicates=predicates||[];for(var i in values)(!cbTestFunc||cbTestFunc(values[i]))&&(obj[predicates[i]||i]=values[i]);return obj},$thing.containers={main:{source:"$thing",heap:[]}},$thing.$container=function(cb){$thing.getContainer($thing.getThreadId(1)),cb()},$thing.getContainer=function(threadId){var container=$thing.containers[threadId[1]],parent=$thing.containers[threadId[2]];if(void 0===container&&(container=$thing.containers[threadId[1]]={heap:[]},threadId[1]!==threadId[2]&&void 0!==parent))for(var k in parent.heap)parent.heap[k].isAbstract&&container.heap.push(parent.heap[k]);return container},$thing.attach=function(def,heap){if(void 0!==def._id)return def._id;for(var length=heap.length;0!==heap.length&&0===heap[heap.length-1]._refCount;)heap.pop()._id=void 0;if(heap.length&&heap.length===length){def._id=void 0;for(var i=heap.length-1;i>-1&&void 0===def._id;i--)0===heap[i]._refCount&&(heap[i]._id=void 0,heap[def._id=i]=def);void 0===def._id&&(def._id=heap.push(def)-1)}else def._id=heap.push(def)-1;return def._id},$thing.search=function(obj,heap){for(var match,i=heap.length-1;i>-1;i--)if(heap[i]._refCount>0){for(var k in obj)if(!(match=obj[k]===heap[i][k]))break;if(match)return heap[i]}return void 0},$thing.searchMeta=function(obj,predicate){var type="string",cb=arguments[2],meta=void 0!==obj.getMeta?obj.getMeta():obj._meta;switch(arguments[2]){case"int":case"boolean":case"string":type=arguments[2],cb=arguments[3]}meta.forEach(function(item){if(item=item.match(/\S+/g),null!==item&&item[0]===predicate)switch(item=item.slice(1),type){case"int":isNaN(item[0]=parseInt(item[0]))||cb.apply(obj,item);break;case"boolean":switch(item[0].toLowerCase()){case"true":item[0]=!0,cb.apply(obj,item);break;case"false":item[0]=!1,cb.apply(obj,item)}break;default:cb.apply(obj,item)}})},$thing.cbBuilder=function(threadId,self,args,cbDone){return cbDone=cbDone||function(){},$thing.Tasker.thread(threadId),0!==args.length?function(){$thing.agent(self).apply($thing,args).apply($thing,arguments.length?arguments:[$thing.Container]),cbDone()}:void cbDone()};var agent=$thing.agent=function(){var cb,threadId,selector,filter,pattern,selects,callChain,inlineDef,inlineThreadId,inlineObj=$thing.Container,refCount=0;switch(arguments.length){case 0:return $thing.Tasker.thread($thing.getThreadId(1));case 2:"function"==typeof arguments[1]&&(cb=arguments[1]);case 1:if(arguments[0]instanceof $thing.Pattern){pattern=arguments[0],threadId=pattern.getThreadId(),selector=new $thing.Selector(threadId,pattern,!0);break}if("object"==typeof arguments[0]&&void 0!==arguments[0].getInterfaces){selector=arguments[0],threadId=selector.getThreadId();break}default:var def=new $thing.Definition($thing.Container,$thing.Agent,threadId=$thing.getThreadId(1),$thing.arrayDup(arguments));if(void 0!==def["class"])return def.refObject(function(obj,cbRelease){cbRelease()});selects=[],$thing.searchMeta(def,"select",function(){selects.push($thing.arrayDup(arguments))}),selector=new $thing.Selector(threadId,pattern=selects.length?selects:def.name,!0)}return filter=function(filters,callArgs){return 2===arguments.length&&"string"==typeof callArgs[0]&&"^"===callArgs[0].charAt(0)?(void 0===inlineDef&&(inlineDef={},inlineThreadId=$thing.getThreadId(2)),inlineDef[callArgs[0].substring(1)]=callArgs[1],callChain):function(){var obj;switch(arguments.length){case 0:void 0===inlineDef?obj=inlineObj:(obj=inlineObj=new $thing.Definition($thing.Container,$thing.Agent,inlineThreadId,[inlineDef]),inlineDef=void 0);break;case 1:if("object"==typeof arguments[0]&&void 0!==arguments[0].getInterfaces){obj=arguments[0];break}default:var def=new $thing.Definition($thing.Container,$thing.Agent,$thing.getThreadId(1),$thing.arrayDup(arguments));void 0!==def["class"]?obj=def:(selects=[],$thing.searchMeta(def,"select",function(){selects.push($thing.arrayDup(arguments))}),obj=new $thing.Pattern(threadId,selects.length?selects:def.name))}return obj.refObject(function(obj,cbRelease){refCount++,void 0===pattern?selector.dispatch({filters:filters,method:callArgs[0],args:callArgs.slice(1)},function(){return $thing.cbBuilder(threadId,obj,arguments,function(){0===--refCount&&(void 0!==cb&&cb(),cbRelease())})}):(selector.select(),selector.schedule(),selector.dispatch({filters:filters,method:callArgs[0],args:callArgs.slice(1)},function(){return $thing.cbBuilder(threadId,obj,Array.prototype.slice.call(arguments,0,arguments.length-1),arguments[arguments.length-1])},function(){refCount>1?refCount--:$thing.async.setImmediate(function(){0===--refCount&&(void 0!==cb&&cb(),cbRelease(),selector.release())})}))}),callChain}},callChain=function(){return filter($thing.Filter.ALL,$thing.arrayDup(arguments))},callChain.all=callChain,callChain.first=function(){return filter($thing.Filter.FIRST,$thing.arrayDup(arguments))},callChain.last=function(){return filter($thing.Filter.LAST,$thing.arrayDup(arguments))},callChain};$thing.switchContext=function(functString,parentOrdinal,superOrdinal,ordinal,superName,methodName){return functString=functString||this.$vtable[ordinal][methodName].toString(),functString.indexOf("$parent")>-1||functString.indexOf("$super")>-1?function(){var ret,$parent=this.$parent,$super=this.$super;return this.$parent=this.$vtable[parentOrdinal]||$parent,this.$super=this.$vtable[superOrdinal][superName],ret=this.$vtable[ordinal][methodName].apply(this,arguments),this.$parent=$parent,this.$super=$super,ret}:this.$vtable[ordinal][methodName]},$thing.switchParentContext=function(functString,parentOrdinal,ordinal,methodName){return functString=functString||this.$vtable[ordinal][methodName].toString(),functString.indexOf("$parent")>-1?function(){var ret,$parent=this.$parent;return this.$parent=this.$vtable[parentOrdinal]||this.$parent,ret=this.$vtable[ordinal][methodName].apply(this,arguments),this.$parent=$parent,ret}:this.$vtable[ordinal][methodName]},$thing.Object=function(){},$thing.Object.prototype.getName=function(){return"Object"};var $inherit=$thing.Object.inherit=function(obj,parent){function $obj(){void 0!==this.init?this.init.apply(this,arguments):void 0}function replace(){return void 0!==obj["$"+arguments[1]]?obj["$"+arguments[1]]:arguments[0]}var i,j,k,v,functString,signature,signatures={},ontology={},inherit=this.prototype;$obj.prototype=new this,$obj.prototype.constructor=$obj,$obj.prototype.$vtable=void 0!==$obj.prototype.$vtable?$obj.prototype.$vtable.slice():[];var ordinal=$obj.prototype.$vtable.push(obj)-1,parentOrdinal=$obj.prototype.$vtable.push(parent)-1,superOrdinal=$obj.prototype.$vtable.push(inherit)-1;$obj.inherit=$inherit;for(i in obj){switch(i){case"$vtable":case"$signatures":case"$ontology":case"$owner":case"$parent":case"$super":continue}v=obj[i],k=i.replace(/\$\((.+?)\)/g,replace),j=k.substring(k.indexOf(".")+1),"function"!=typeof v?"$"===k.charAt(0)?$obj.prototype[k]=v:ontology[k]=v:(functString=v.toString(),signature=functString.match(/function[^(]*\(([^)]*)\)/),$obj.prototype[k]="function"!=typeof inherit[k]?"function"!=typeof inherit[j]?$thing.switchParentContext.apply($obj.prototype,[functString,parentOrdinal,ordinal,i]):$thing.switchContext.apply($obj.prototype,[functString,parentOrdinal,superOrdinal,ordinal,j,i]):$thing.switchContext.apply($obj.prototype,[functString,parentOrdinal,superOrdinal,ordinal,k,i]),null!==signature&&(signatures[k]=signature[1].length?signature[1].split(/,\s*/):[]))}return $obj.prototype.$owner=parent||$obj.prototype.$owner,$obj.prototype.$signatures=$thing.merge(signatures,$obj.prototype.$signatures),$obj.prototype.$ontology=$thing.merge(ontology,$obj.prototype.$ontology),$obj};if($thing.Base=$thing.Object.inherit({init:function(){},getName:function(){return"Base"},property:function(prop,cbGetter,cbSetter){var obj={};cbGetter?obj.get=cbGetter:void 0,cbSetter?obj.set=cbSetter:void 0,Object.defineProperty(this,prop,obj)},bind:function(funct){var self=this;return function(){return funct.apply(self,arguments)}}}),$thing.BURST_DECAY=3e8,$thing.State={EXPR_AND:1,EXPR_NOT:2,EXPR_OR:3,DEF_DESC:1,DEF_NAME:2,DEF_SOURCE:4,DEF_EXTENDS:16,DEF_IMPLEMENTS:64,DEF_USES:128,DEF_META:256,DEF_NOP:512,DEF_END:1024,LIFE_INITIATED:2048,LIFE_ACTIVE:4096,LIFE_WAITING:8192,LIFE_SUSPENDED:16384,LIFE_DELETED:32768,LIFE_TRANSIT:65536,LIFE_BLOCKED:131072},$thing.Definition=$thing.Base.inherit({$metaHandlers:{mobile:function(){this._isMobile=!0},passive:function(){this._isPassive=!0},singleton:function(){this._singleton=this._singleton||this._source},catchall:function(catchall,methodName){this._substitute.$__catchall__=methodName}},getName:function(){return"Definition"},init:function(parent,_super,threadId,stack){var k,item,search,self=this,heap=$thing.getContainer(threadId).heap;if(this.$super(),this._state=$thing.State.DEF_DESC,this._threadId=threadId,this._parent=parent,this._children=[],this._meta=[],this._interfaces=[],this._uses=[],this._super=_super,this._source=threadId[0],this._refCount=0,this._isAgent=this._super===$thing.Agent,this._isAbstract=!1,this._isPassive=!1,this._isMobile=!1,this._lastBurstTime=0,this._burstAverage=1,this._waitTime=$thing.getMicroTime(),this._interfaces=[$thing.create64BitId(this._source,heap.length),this._source],this._substitute={$id:this._interfaces[0],$source:this._source},this.parseStack(stack),void 0!==this._extends){if(item=$thing.search({_name:this._extends},heap),void 0===item)throw new Error("DefinitionError: Super Class '"+this._extends+"' is not defined");for(this._super=item._class,this._singleton=item._singleton,k=item._meta.length-1;k>-1;k--)this._meta.unshift(item._meta[k]);void 0===this._class?this._class={}:void 0}if(this._meta.forEach(function(item){var args=item.split(/ (.+)?/);void 0!==self.$metaHandlers[args[0]]?self.$metaHandlers[args[0]].apply(self,args):void 0}),this._isAbstract?search={_name:this._name,_source:this._source}:void 0!==this._singleton&&(search={_name:this._name,_singleton:this._singleton}),void 0!==search&&(item=$thing.search(search,heap)))this.refObject=item.bind(item.refObject),this.property("class",function(){return item._class}),this.property("refCount",function(){return item._refCount}),this.property("isAbstract",function(){return item._isAbstract}),this.property("isPassive",function(){return item._isPassive}),this.property("instance",function(){return item._instance}),this.property("state",function(){return item._state}),this.property("name",function(){return item._name}),this.property("parent",function(){return item._parent}),this.property("threadId",function(){return item._threadId});else{if(this._childrenWrapper={push:this.bind(this._pushChild),forEach:this.bind(this._forEachChild)},Object.defineProperty(this._childrenWrapper,"length",{get:this.bind(this._countChildren)}),void 0!==this._factory?this._class=this._factory.apply($thing,this._uses):void 0,void 0!==this._class){for(k in this._substitute)this._class[k]=this._substitute[k];var interfaces=void 0!==this._name?this._interfaces.concat(this._name):this._interfaces;this._class.getInterfaces=function(){return this.$super().concat(interfaces)},this._class=this._super.inherit(this._class,parent,this._isMobile),$thing.attach(this,heap)}this.property("class",function(){return this._class}),this.property("refCount",function(){return this._refCount}),this.property("isAbstract",function(){return this._isAbstract}),this.property("isPassive",function(){return this._isPassive}),this.property("instance",function(){return this._instance}),this.property("state",function(){return this._state}),this.property("name",function(){return this._name}),this.property("parent",function(){return this._parent}),this.property("threadId",function(){return this._threadId})}},_forEachChild:function(cb){this._children.forEach(function(args){void 0!==args[0].getHeapId?cb.apply(void 0,args):void 0})},_pushChild:function(obj){for(var id=obj.getHeapId(),i=0;i<this._children.length;i++)if(void 0===this._children[i][0].getHeapId)this._children.splice(i,1);else if(this._children[i][0].getHeapId()===id)return this._children.length;return this._children.push(arguments)},_countChildren:function(){var length=0;return this._forEachChild(function(child){child.getRefCount()&&length++}),length},parseStack:function(stack){function replace(){return void 0===arguments[1]?stack.shift():self._substitute["$"+arguments[1]]=stack.shift()}for(var item,match,self=this;this._state!==$thing.State.DEF_END&&void 0!==(item=stack.shift());){switch(typeof item){case"function":this._state=$thing.State.DEF_END,this._factory=item;continue;case"object":this._state=$thing.State.DEF_END,this._class=item;continue}switch(item){case"abstract":this._isPassive=this._isAbstract=!0;continue;case"source":this._state=$thing.State.DEF_SOURCE;continue;case"extends":this._state=$thing.State.DEF_EXTENDS;continue;case"implements":this._state=$thing.State.DEF_IMPLEMENTS;continue;case"uses":this._state=$thing.State.DEF_USES;continue;default:this._state===$thing.State.DEF_META||"@"===item.charAt(0)?this._state=$thing.State.DEF_META:item.match(/ /)?this._state=$thing.State.DEF_DESC:void 0}switch(this._state){case $thing.State.DEF_DESC:item=item.replace(/\$\((.+?)\)|\$/g,replace),item=item.split(" @"),stack=item[0].split(/ +/).filter(Boolean).concat(void 0!==item[1]?["@"+item[1]].concat(stack):stack),this._state=void 0===this._name?$thing.State.DEF_NAME:$thing.State.DEF_NOP;break;case $thing.State.DEF_META:item=item.replace(/\$\((.+?)\)|\$/g,replace),"+"===item.charAt(item.length-1)?stack=[item.slice(0,-1)+stack.shift()].concat(stack):(this._state=$thing.State.DEF_DESC,this._meta.push(item.slice(1)));break;case $thing.State.DEF_NAME:this._name=item||this._name;break;case $thing.State.DEF_SOURCE:this._source=item||this._source;break;case $thing.State.DEF_EXTENDS:this._extends=item||this._extends;break;case $thing.State.DEF_IMPLEMENTS:this._interfaces.push(null!==(match=item.match(/^\/(.*?)\/([gimy]*)$/))?new RegExp(match[1],match[2]):item);break;case $thing.State.DEF_USES:this._uses.push($thing.agent(item))}}},patchObject:function(obj){var self=this;return obj.refObject=this.bind(this.refObject),obj.getRefCount=function(){return self._refCount},obj.getHeapId=function(){return self._id},obj.getName=function(){return self._name},obj.getSource=function(){return self._source},obj.getChildren=function(){return self._childrenWrapper},obj.getState=function(){return self._state},obj.setState=function(){for(var k in arguments)self._state|=arguments[k];var states=$thing.arrayDup(arguments);this.getChildren().forEach(function(child){child.setState(states)})},obj.unsetState=function(){for(var k in arguments)self._state&=~arguments[k];var states=$thing.arrayDup(arguments);this.getChildren().forEach(function(child){child.unsetState(states)})},obj.getThreadId=function(){return $thing.arrayDup(self._threadId)},obj.getMeta=function(){return self._meta},obj.isAbstract=function(){return self._isAbstract},obj.waitTime=function(){self._waitTime=$thing.getMicroTime()},obj.burstTime=function(ticks){var now=$thing.getMicroTime();if(self._lastBurstTime){var a=1-Math.exp(-(now-self._lastBurstTime)/$thing.BURST_DECAY*60);self._burstAverage=a*ticks+(1-a)*self._burstAverage}else self._burstAverage=ticks;return self._lastBurstTime=now,self._burstAverage},obj.getResponseRatio=function(){var now=$thing.getMicroTime();return(now-self._waitTime+self._burstAverage)/self._burstAverage},obj},unpatchObject:function(obj){return delete obj.refObject,delete obj.getRefCount,delete obj.getHeapId,delete obj.getName,delete obj.getSource,delete obj.getChildren,delete obj.getState,delete obj.setState,delete obj.unsetState,delete obj.getThreadId,delete obj.getMeta,delete obj.isAbstract,delete obj.waitTime,delete obj.burstTime,delete obj.getResponseRatio,obj},refObject:function(cb){var self=this;this.parent.refObject(function(parent,cbRelease){var constructed;self._refCount?self._refCount++:(self._refCount=constructed=1,self._instance=self.patchObject(new self._class),self._instance.setState($thing.State.LIFE_INITIATED)),constructed&&self._isAgent&&!self._isAbstract&&self._instance.setup(),cb(self._instance,function(){self._isAgent&&self._isPassive||(0!==--self._refCount?cbRelease():self._isAgent?self._instance.takedown(function(){self._children=[],self.unpatchObject(self._instance),delete self._instance,cbRelease()}):(self._children=[],self.unpatchObject(self._instance),delete self._instance,cbRelease()))})})}}),$thing.Delegate=$thing.Base.inherit({init:function(){this.$super()},getName:function(){return"Delegate"},getInterfaces:function(){return[]},matchInterface:function(pattern){for(var interfaces=this.getInterfaces(),i=0;i<interfaces.length&&(interfaces[i]instanceof RegExp?null===pattern.match(interfaces[i]):interfaces[i]!==pattern);i++);return interfaces[i]},refObject:function(cb){cb(this,function(){})},dispatch:function(call,cb){var method,signature,predicates,args,thisHasOntology=!1,argHasContext=!1,self=this;if(cb=cb||function(){},"undefined"==typeof this.getRefCount)return cb();if("$"===call.method.charAt(0))return cb();void 0===this[method=call["interface"]+"."+call.method]&&void 0===this[method=call.method]?method=void 0:void 0;for(thisHasOntology in this.$ontology)break;if(thisHasOntology)for(var k in call.args)if(call.args[k].constructor===Object&&"undefined"!=typeof call.args[k]["@context"]){argHasContext=!0;break}void 0===method||void 0===(signature=this.$signatures[method])||signature.length<1||"$"!==signature[signature.length-1].charAt(0)||signature.length!==call.args.length+1?void 0===this[method=this.$__catchall__]||void 0===(signature=this.$signatures[method])||"$"!==signature[1].charAt(0)||2!==signature.length?cb():this[this.$__catchall__].apply(this,[call.args,cb]):thisHasOntology&&argHasContext&&1!==this.$signatures[method].length?$thing.jsonld.compact({"@graph":(predicates=Object.keys(args=$thing.arrayToObject(call.args,this.$signatures[method],function(value){return value&&value.constructor===Object&&"undefined"!=typeof value["@context"]}))).map(function(k){return args[k]})},this.$ontology,{graph:!0},function(err,graph){if(err)return cb();if(graph=graph["@graph"],graph.length!==predicates.length)cb();else{graph=$thing.merge($thing.arrayToObject(graph,predicates),$thing.arrayToObject(call.args,self.$signatures[method])),args=new Array(self.$signatures[method].length);for(var i=0;i<self.$signatures[method].length-1;i++)args[i]=graph[self.$signatures[method][i]];args[args.length-1]=cb,self[method].apply(self,args)}}):this[method].apply(this,$thing.arrayAppend(call.args,cb))}}),$thing.Pattern=$thing.Delegate.inherit({getName:function(){return"Pattern"},init:function(threadId,pattern){this.$super(),this._threadId=threadId,this._pattern=pattern},getThreadId:function(){return this._threadId},toArray:function(){return this._pattern instanceof Array?this._pattern:[[this._pattern]]}}),$thing.Agent=$thing.Delegate.inherit({getName:function(){return"Agent"},getInterfaces:function(){return["Agent"]},setup:function(cb){this.setState($thing.State.LIFE_ACTIVE),this.doActivate(cb)},takedown:function(cb){this.doDelete(cb)},doActivate:function(cb){this.unsetState($thing.State.LIFE_SUSPENDED),cb&&cb()},doDelete:function(cb){this.setState($thing.State.LIFE_DELETED),cb&&cb()},doSuspend:function(cb){this.setState($thing.State.LIFE_SUSPENDED),cb&&cb()},doWait:function(cb){this.setState($thing.State.LIFE_WAITING),cb&&cb()},doWake:function(cb){this.unsetState($thing.State.LIFE_WAITING),cb&&cb()},addBehaviour:function(){var obj,reset,self=this,threadId=$thing.getThreadId(1),args=$thing.arrayDup(arguments),def=new $thing.Definition(this,$thing.Behaviour,threadId,args);if(void 0!==def["class"]){var funct=function(){def.refCount?obj=def.instance:def.refObject(function(instance,cbRelease){$thing.attach(def),obj=instance,self.getChildren().push(obj,cbRelease)}),obj.unsetState($thing.State.LIFE_WAITING|$thing.State.LIFE_SUSPENDED|$thing.State.LIFE_DELETED|$thing.State.LIFE_TRANSIT|$thing.State.LIFE_BLOCKED),obj.setState(self.getState()|$thing.State.LIFE_ACTIVE)};funct(),reset=obj.reset,obj.reset=function(){funct(),reset.apply(obj,arguments)},$thing.async.setImmediate(function(){$thing.Tasker.thread(threadId)})}return obj},removeBehaviour:function(){var objs=[],children=this.getChildren();if("object"==typeof arguments[0]&&void 0!==arguments[0].getHeapId){var id=arguments[0].getHeapId();children.forEach(function(obj,cbRelease){obj.getHeapId()===id&&(obj.setState($thing.State.LIFE_DELETED),cbRelease(),objs.push(obj))})}else{var args=$thing.arrayDup(arguments),def=new $thing.Definition(this,$thing.Behaviour,$thing.getThreadId(1),args);children.forEach(function(obj,cbRelease){obj.getName()===def.name&&(obj.setState($thing.State.LIFE_DELETED),cbRelease(),objs.push(obj))})}return objs}}),$thing.Behaviour=$thing.Delegate.inherit({getName:function(){return"Behaviour"},getInterfaces:function(){return["Behaviour","parent:"+this.$parent.$id,"owner:"+this.$owner.$id]},done:function(){return!1},action:function($cb){this.done()&&this.$owner.removeBehaviour(this),$cb&&$cb()},block:function($cb){this.setState($thing.State.LIFE_BLOCKED),$cb&&$cb()},restart:function($cb){this.unsetState($thing.State.LIFE_BLOCKED),$cb&&$cb()},reset:function($cb){this.unsetState($thing.State.LIFE_WAITING|$thing.State.LIFE_SUSPENDED),this.setState($thing.State.LIFE_ACTIVE),$cb&&$cb()}}),$thing.Filter={ALL:1,FIRST:2,LAST:4},$thing.Selector=$thing.Base.inherit({getName:function(){return"Selector"},init:function(threadId,pattern,includePassive){if(this.$super(),this._threadId=threadId,this._includePassive=void 0===includePassive?!0:includePassive,this._exprs=[],this._schedule=[],this._selection=[],this._callbacks=[],this._filterStates=this._includePassive?$thing.State.LIFE_SUSPENDED:$thing.State.LIFE_WAITING,pattern instanceof $thing.Pattern)void 0===this._threadId&&(this._threadId=pattern.getThreadId()),pattern=pattern.toArray();else if("string"==typeof pattern){var expr={and:{},not:{}};expr.and[pattern]=!0,this._exprs.push(expr)}if(pattern instanceof Array)for(var i=0;i<pattern.length;i++)this.parseStack(pattern[i]);this.property("length",function(){return this._schedule.length})},parseStack:function(stack){for(var k,item,state=$thing.State.EXPR_AND,expr={and:{},not:{}};void 0!==(item=stack.shift());){switch(item){case"and":state=$thing.State.EXPR_AND;continue;case"not":state=$thing.State.EXPR_NOT;continue;case"or":state=$thing.State.EXPR_OR;continue}switch(state){case $thing.State.EXPR_AND:expr.and[item]=!0;break;case $thing.State.EXPR_NOT:expr.not[item]=!0;break;case $thing.State.EXPR_OR:for(k in expr.and){this._exprs.push(expr);break}expr={and:{},not:{}},expr.and[item]=!0}}for(k in expr.and){this._exprs.push(expr);break}},matchObject:function(obj,cbRelease){for(var k,match,i=0;i<this._exprs.length;i++){var m,expr=this._exprs[i];for(k in expr.and){if(void 0===(m=obj.matchInterface(k,this._source))){match=void 0;break}match=match||m}if(void 0!==match){for(k in expr.not)if(obj.matchInterface(k,this._source))return match=void 0,void cbRelease();if(void 0!==match)break}}void 0===match?cbRelease():(this._callbacks.push(cbRelease),this._selection.push({match:match,obj:obj}))},select:function(){var i,j,include,def,heap;for(this.release(),heap=$thing.getContainer(this._threadId).heap,i=0;i<heap.length;i++)def=heap[i],include=def.isPassive?def.isPassive&this._includePassive&&def.state<this._filterStates:def.state<this._filterStates,!def.isAbstract&&def.refCount>0&&def.state&$thing.State.LIFE_ACTIVE&&include&&def.refObject(this.bind(this.matchObject));if(this._schedule.length!==this._selection.length)for(this._schedule=new Array(this._selection.length),j=0;j<this._schedule.length;j++)this._schedule[j]=j},schedule:function(){if(1===this._schedule.length){var s=this._selection[this._schedule[0]].obj.getState()<this._filterStates;s||(this._schedule.length=0)}else{var shrink=!1,self=this;if(this._schedule.sort(function(x,y){x=self._selection[x].obj,y=self._selection[y].obj;var xr=x.getResponseRatio(),yr=y.getResponseRatio(),xs=x.getState()<self._filterStates,ys=y.getState()<self._filterStates;return ys?xs?xr>yr?-1:yr>xr?1:0:(shrink=!0,1):(shrink=!0,xs?-1:0)}),shrink)for(var i=0;i<this._schedule.length;i++){var s=this._selection[this._schedule[i]].obj.getState()<this.filterStates;if(!s){this._schedule.length=i;break}}}},dispatch:function(call,cbItem,cbDone){var self=this;if(call.filters&$thing.Filter.ALL&&1===this._schedule.length||call.filters&$thing.Filter.FIRST&&this._schedule.length>0){var item=this._selection[this._schedule[0]],match=item.match,obj=item.obj,start=$thing.getMicroTime();obj.dispatch({"interface":match,method:call.method,args:call.args},function(){return"undefined"==typeof obj.getRefCount?obj=$thing.Container:(obj.burstTime($thing.getMicroTime()-start),obj.waitTime()),cbItem.apply(obj,$thing.arrayAppend(arguments,cbDone))})}else if(call.filters&$thing.Filter.LAST&&this._schedule.length>0){var item=this._selection[this._schedule[this._schedule.length-1]],match=item.match,obj=item.obj,start=$thing.getMicroTime();obj.dispatch({"interface":match,method:call.method,args:call.args},function(){return"undefined"==typeof obj.getRefCount?obj=$thing.Container:(obj.burstTime($thing.getMicroTime()-start),obj.waitTime()),cbItem.apply(obj,$thing.arrayAppend(arguments,cbDone))})}else call.filters&$thing.Filter.ALL&&this._schedule.length>0?$thing.async.each(this._schedule,function(item,cbNext){item=self._selection[item];var match=item.match,obj=item.obj,start=$thing.getMicroTime();obj.dispatch({"interface":match,method:call.method,args:call.args},function(){return"undefined"==typeof obj.getRefCount?obj=$thing.Container:(obj.burstTime($thing.getMicroTime()-start),obj.waitTime()),cbItem.apply(obj,$thing.arrayAppend(arguments,cbNext))})},cbDone):cbDone()},release:function(){var i,callbacks=this._callbacks;for(this._schedule=[],this._callbacks=[],this._selection=[],i=0;i<callbacks.length;i++)callbacks[i]()}}),$thing.Container=new($thing.Agent.inherit({getName:function(){return"Container"},getInterfaces:function(){return["Container"]},getThreadId:function(){return["$thing","main","main"]},setup:void 0,takedown:void 0,addBehaviour:void 0,removeBehaviour:void 0})),$thing.Tasker=new($thing.Base.inherit({doAction:function(container,selector,iteration){var self=this;container.isTaskerQueued=!0,iteration>selector.length&&(selector.select(),iteration=0),0===selector.length?(selector.release(),container.isTaskerQueued=!1):(selector.schedule(),selector.dispatch({filters:$thing.Filter.FIRST,method:"action",args:[]},function(cbNext){cbNext()},function(){$thing.async.setImmediate(function(){self.doAction(container,selector,++iteration)})}))},thread:function(threadId){void 0===threadId&&(threadId=$thing.getThreadId(1));var container=$thing.getContainer(threadId);if(!container.isTaskerQueued){var selector=new $thing.Selector(threadId,[["Behaviour"]],!1);selector.select(),this.doAction(container,selector,0)}}})),$thing.agent("@singleton","abstract Heartbeat implements Container",{setup:function(cb){this.$super(cb);var self=this;this.keepAlive=this.addBehaviour("@passive",{}),this.intervalId=setInterval(function(){$thing.Tasker.thread(self.getThreadId())},$thing.WAKE_MIN_PERIOD/1e3)},destroy:function($cb){clearInterval(this.intervalId),this.removeBehaviour(this.keepAlive),$cb()}}),$thing.agent("@singleton",{setup:function(cb){this.$super(cb),this.addBehaviour("abstract Flow",{getFlow:function(){for(var flow,names,namesDict={},self=this,i=0;i<arguments.length;i++)namesDict[arguments[i]]=i;return $thing.searchMeta(this,"flow",function(){for(var j=0;j<arguments.length;j++)namesDict[arguments[j]]=j+i;i+=j}),names=Object.keys(namesDict),flow=new Array(names.length),names.forEach(function(name,index){flow[index]=function(){var args=new Array(arguments.length);args[0]=name;for(var i=0;i<arguments.length-1;i++)args[i+1]=arguments[i];$thing.agent(self,arguments[arguments.length-1]).apply(self,args).apply(self,[self])}}),flow.remove=function(name){var k,l=0,index=namesDict[name];-1!==index&&(namesDict[name]=-1,flow[index]=function(){arguments[arguments.length-1]()});for(k in namesDict){if(-1!==namesDict[k])break;l++}flow.length===l&&this.removeAll()},flow.removeAll=function(){namesDict={},flow.length=0},this.getFlow=function(){return flow},flow},end:function(methodName,$cb){var flow=this.getFlow();if(methodName instanceof Array)for(var k in methodName)flow.remove(methodName[k]);else flow.remove(methodName);$cb&&$cb()},endAll:function($cb){this.getFlow().removeAll(),$cb&&$cb()},action:function($cb){0===this.getFlow().length&&(this.done=function(){return!0}),this.$super($cb)},done:function(){return!1}})}}),$thing.agent("@singleton",{setup:function(cb){this.$super(cb),this.addBehaviour("abstract Series extends Flow",{action:function($cb){this.$super($cb);var self=this,start=$thing.getMicroTime();$thing.async.series(this.getFlow(),function(){self.burstTime($thing.getMicroTime()-start)
})}})}}),$thing.agent("@singleton",{setup:function(cb){this.$super(cb),this.addBehaviour("abstract Parallel extends Flow",{action:function($cb){this.$super($cb);var self=this,start=$thing.getMicroTime();$thing.async.parallel(this.getFlow(),function(){self.burstTime($thing.getMicroTime()-start)})}})}}),$thing.agent("@singleton",{setup:function(cb){this.$super(cb),this.addBehaviour("abstract Queue extends Flow",{getQueue:function(){var chunks,callbacks,cbCompletion,i=0,x=0,y=0,last=0,queueLength=0,limit=0,concurrency=1,active=0,paused=0,self=this,getQueue=this.getQueue,queue={action:function(){if(!paused){if(0===queueLength&&0===limit){var l=Math.max(chunks.length/2,1);chunks.length>l&&(chunks.length=l,callbacks.length=l)}if(0===queueLength&&limit>0)return void self.setState($thing.State.LIFE_WAITING);if(0===queueLength&&1===chunks.length)return void self.setState($thing.State.LIFE_WAITING);for(var j=0,flow=self.getFlow();flow.length>0&&concurrency+1>j+active&&queueLength>i;j++){var v,$cb,start=$thing.getMicroTime();i++,active++,chunks[y]instanceof Array?(v=chunks[y][x],x<chunks[y].length-1?x++:($cb=callbacks[y],chunks[y]=void 0,callbacks[y]=void 0,x=0,y++)):(v=chunks[y],$cb=callbacks[y],chunks[y]=void 0,callbacks[y]=void 0,x=0,y++),$thing.async.applyEachSeries(flow,v,cbCompletion.bind({start:start,$cb:$cb}))}}},push:function(items,$cb){var length=items instanceof Array?queueLength+items.length:queueLength+1;return 0===self.getFlow()?$cb?$cb("onError",-1)():void 0:limit>0&&length>limit?$cb?$cb("onError",-1)():void 0:(queueLength=length,last===chunks.length&&(chunks=$thing.arrayDup(chunks,2*chunks.length,!0),callbacks=$thing.arrayDup(callbacks,2*callbacks.length,!0)),chunks[last]=items,callbacks[last]=$cb,last++,paused||self.unsetState($thing.State.LIFE_WAITING),void $thing.Tasker.thread(self.getThreadId()))},clear:function(){i=queueLength,$thing.async.each(callbacks.slice(y),function(cbItem,cbNext){cbItem&&cbItem("onError",-1)(),cbNext()})},pause:function($cb){paused=!0,self.setState($thing.State.LIFE_WAITING),$cb&&$cb()},resume:function($cb){queueLength>0&&self.unsetState($thing.State.LIFE_WAITING),paused=!1,$cb&&$cb()},reset:function(){this.clear(),chunks.length=0,callbacks.length=0,queue=void 0,self.getQueue=getQueue}};return $thing.searchMeta(this,"concurrency","int",function(value){concurrency=value}),$thing.searchMeta(this,"limit","int",function(value){limit=value}),chunks=new Array(limit||1),callbacks=new Array(limit||1),cbCompletion=function(){var $cb=this.$cb,start=this.start,callDrain=!1;0===--active&&i===queueLength&&(queueLength=last=i=x=y=0,callDrain=!0),callDrain?self.drain(function(){self.burstTime($thing.getMicroTime()-start)}):self.burstTime($thing.getMicroTime()-start),$cb&&$cb("onComplete")()},Object.defineProperty(queue,"length",{get:function(){return queueLength}}),this.getQueue=function(){return queue},queue},action:function($cb){this.$super($cb),this.getQueue().action()},push:function(items,$cb){this.getQueue().push(items,$cb)},pause:function($cb){this.getQueue().pause($cb)},resume:function($cb){this.getQueue().resume($cb)},end:function(method,$cb){var ret=this.$super(method,$cb);return 0===this.getFlow().length&&this.getQueue().clear(),ret},endAll:function($cb){var ret=this.$super($cb);return this.getQueue().clear(),ret},reset:function($cb){this.getQueue().reset(),this.$super($cb)},drain:function(cb){cb()}})}}),$thing.agent("@singleton",{setup:function(cb){this.$super(cb),this.addBehaviour("abstract MapReduce extends Queue",{getMapReduce:function(){var keys={},values=[],lengths=[],last=0,shape=1,total=0,reduceIndex=0,drainRefs=0,pushes=[],self=this,getMapReduce=this.getMapReduce,mapReduce={write:function(key,value){var index;if(last===values.length){values=$thing.arrayDup(values,2*(1+values.length),!0),lengths=$thing.arrayDup(lengths,2*(1+lengths.length),!0);for(var i=last;i<lengths.length;i++)lengths[i]=0,values[i]=new Array(shape)}void 0===(index=keys[key])&&(index=keys[key]=last,last++),lengths[index]===values[index].length&&(values[index]=$thing.arrayDup(values[index],Math.max(2*(1+values[index].length),shape),!0)),values[index][lengths[index]]=value,lengths[index]++,shape=Math.ceil(++total/last)},drain:function(){1===++drainRefs&&(self.pause(),self.unsetState($thing.State.LIFE_WAITING))},action:function($cb){var start=$thing.getMicroTime(),valuesCopy=$thing.arrayDup(values[reduceIndex],lengths[reduceIndex],!0,shape);lengths[reduceIndex]=0,self.reduce(valuesCopy,function(reduced){if(++reduceIndex===last){var l=2*(1+last);values.length>l&&(values.length=l,lengths.length=l),keys={},drainRefs=last=reduceIndex=0,self.resume()}if(void 0!==reduced)for(var k in pushes)pushes[k]("push",reduced)(self);self.burstTime($thing.getMicroTime()-start),$cb()})},reset:function(){keys={},values.length=0,lengths.length=0,mapReduce=void 0,self.getMapReduce=getMapReduce}};return $thing.searchMeta(this,"push","string",function(){pushes.push($thing.agent("@select "+$thing.arrayDup(arguments).join(" ")))}),Object.defineProperty(mapReduce,"length",{get:function(){return total}}),Object.defineProperty(mapReduce,"isReducing",{get:function(){return drainRefs>0&&last>0}}),this.getMapReduce=function(){return mapReduce},mapReduce},action:function($cb){var mapReduce=this.getMapReduce();mapReduce.isReducing?mapReduce.action($cb):this.$super($cb)},reset:function($cb){this.getMapReduce().reset(),this.$super($cb)},write:function(key,value){this.getMapReduce().write(key,value)},reduce:function(values,cb){cb(values)},drain:function(cb){this.getMapReduce().drain(),this.$super(cb)}})}}),$thing.WAKE_MIN_PERIOD=5e5,$thing.agent("@singleton",{setup:function(cb){this.$super(cb),this.addBehaviour("abstract Waker",{getWakeTime:function(){var time,period=1e6,now=$thing.getMicroTime();return $thing.searchMeta(this,"period","int",function(value){period=1e3*value}),time=now+period-now%period,this.getWakeTime=function(){return time},this.getWakeTime()},wake:function(cb){cb()},action:function($cb){var time=this.getWakeTime();return void 0===time?this.$super($cb):$thing.getMicroTime()>=time?(this.getWakeTime=function(){return void 0},this.wake(this.bind(function(){this.$super($cb)}))):void this.$super($cb)},done:function(){return void 0!==this.getWakeTime()?!1:(delete this.getWakeTime,!0)},reset:function($cb){delete this.getWakeTime,this.$super($cb)},stop:function($cb){this.$owner.removeBehaviour(this),delete this.getWakeTime,$cb&&$cb()}})}}),$thing.agent("@singleton","Util",{setup:function(cb){this.$super(cb),this.addBehaviour("@passive","@catchall catchAll","Complete",{catchAll:function(args,$cb){$cb("onComplete")()}}),this.addBehaviour("@passive","@catchall catchAll","Error",{catchAll:function(args,$cb){$cb("onError",-1)()}}),this.addBehaviour("abstract Sensor extends Queue"),this.addBehaviour("abstract Actuator extends Queue"),this.addBehaviour("abstract Bridge extends Queue implements Actuator Sensor")}}),!$thing.usePaho)var mqtt=require("mqtt");(mqtt||$thing.usePaho&&Paho)&&$thing.agent("abstract Mqtt implements Container",{setup:function(cb){this.$super(cb),this.port=$thing.usePaho?80:1883,this.reconnectPeriod=1e3,this.isConnecting=!1,this.isConnected=!1,this.actuatorsTotal=0,this.topicRefs={},this.pendingSubs={},this.pendingUnsubs={};var z=-1,self=this;if($thing.searchMeta(this,"host","string",function(value){self.host=value}),$thing.searchMeta(this,"port","int",function(value){self.port=value}),$thing.searchMeta(this,"clientId","string",function(value){self.clientId=value}),$thing.searchMeta(this,"reconnectPeriod","int",function(value){self.reconnectPeriod=value}),void 0===this.host)throw new Error("Mqtt: Missing @host");void 0===this.clientId&&(this.clientId="xxxxxxxx-xxxx-4xxz-yzzz-zzzzzzzzzzzz".replace(/[xyz4-]/g,function(c){switch(c){case"x":return(Math.floor(100*Math.random())%16).toString(16);case"y":return"8";case"z":return self.$id.charAt(++z);case"-":case"4":return c}}))},destroy:function($cb){this.getChildren().forEach(function(child){child.isAbstract()||(void 0!==child.matchInterface("Sensor")||void 0!==child.matchInterface("Actuator"))&&child.$owner.removeBehaviour(child)}),$cb()},addBehaviour:function(){var doConnect=!1,obj=this.$super.apply(this,arguments);if(void 0!==obj&&!obj.isAbstract()){if(void 0!==obj.matchInterface("Sensor")&&(obj.$subTopic=obj.getName(),void 0!==this.topicRefs[obj.$subTopic]?this.topicRefs[obj.$subTopic]++:(this.topicRefs[obj.$subTopic]=1,this.isConnected?this.doSubscribe(obj.$subTopic):(this.pendingSubs[obj.$subTopic]=!0,void 0!==this.pendingUnsubs[obj.$subTopic]&&delete this.pendingUnsubs[obj.$subTopic],doConnect=!0))),void 0!==obj.matchInterface("Actuator")){var flow=obj.getFlow();obj.$pubTopic=obj.getName(),obj.getFlow=function(){return $thing.arrayAppend(flow,function(message,cb){obj.$owner.doSendMessage(obj.$pubTopic,message),cb()})},this.isConnected||(doConnect=!0,$thing.agent(obj)("pause")()),this.actuatorsTotal++}doConnect&&this.doConnect()}return obj},removeBehaviour:function(){var self=this,objs=this.$super.apply(this,arguments);return objs.forEach(function(obj){void 0!==obj.$subTopic&&--self.topicRefs[obj.$subTopic]<=0&&(delete self.topicRefs[obj.$subTopic],void 0!==self.pendingSubs[obj.$subTopic]&&delete self.pendingSubs[obj.$subTopic],self.isConnected?self.doUnsubscribe(obj.$subTopic):self.pendingUnsubs[obj.$subTopic]=!0),void 0!==obj.$pubTopic&&self.actuatorsTotal--}),this.isActive()||this.doDisconnect(),objs},doConnectWithMqtt:function(){var self=this;this.client=mqtt.connect({host:this.host,port:this.port,clientId:this.clientId,reconnectPeriod:this.reconnectPeriod}),this.client.on("error",function(err){self.onError(err)()}),this.client.on("close",function(){self.onDisconnect(),self.removeBehaviour(self.broker),delete self.broker}),this.client.on("connect",function(){self.broker=self.addBehaviour("@passive",{}),self.onConnect()}),this.client.on("message",function(topic,message){self.onMessageArrived(topic,$thing.createBuffer(message))})},doConnectWithPaho:function(){var self=this;this.client=new Paho.MQTT.Client(this.host,this.port,this.clientId),this.client.onConnectionLost=function(){self.onDisconnect()},this.client.onMessageArrived=function(msg){self.onMessageArrived(msg.destinationName,$thing.createBuffer(msg.payloadBytes))},this.client.onMessageDelivered=function(msg){self.onMessageDelivered(msg.destinationName,$thing.createBuffer(msg.payloadBytes))},this.client.connect({onSuccess:function(){self.onConnect()},onFailure:function(err){self.onError(err)}})},isActive:function(){for(var i in this.pendingSubs)break;for(var j in this.pendingUnsubs)break;for(var k in this.topicRefs)break;return void 0!==i||void 0!==j||void 0!==k||this.actuatorsTotal>0?!0:!1},doConnect:function(){this.isConnecting||(this.isConnecting=!0,this.isConnected=!1,$thing.usePaho?this.doConnectWithPaho():this.doConnectWithMqtt())},doDisconnect:function(){void 0!==this.client&&(this.isConnecting=!1,this.isConnected=!1,$thing.usePaho?this.client.disconnect():this.client.end(),delete this.client)},doReconnect:function(){$thing.usePaho&&this.addBehaviour("@singleton","@period $",this.reconnectPeriod,"extends Waker",{wake:function(cb){this.$super(cb),this.$owner.isConnected?this.$owner.doDisconnect():this.$owner.doConnect()}})},doSubscribe:function(topic){this.client.subscribe(topic)},doUnsubscribe:function(topic){this.client.unsubscribe(topic)},doSendMessage:function(topic,message){var self=this;$thing.usePaho?this.client.send(topic,message,0,!1):this.client.publish(topic,message,{},function(err){err?self.onError(err):self.onMessageDelivered(topic,$thing.createBuffer(message))})},onError:function(err){this.isConnecting=!1,$thing.usePaho&&8===err.errorCode&&this.onDisconnect()},onConnect:function(){this.isConnecting=!1,this.isConnected=!0;for(var i in this.pendingSubs)this.doSubscribe(i);for(var j in this.pendingUnsubs)this.doUnsubscribe(j);this.pendingSubs={},this.pendingUnsubs={};for(var k in this.topicRefs)break;void 0===k&&this.actuatorsTotal<=0?this.doDisconnect():this.getChildren().forEach(function(obj){obj.isAbstract()||void 0===obj.matchInterface("Actuator")||$thing.agent(obj)("resume")()})},onDisconnect:function(){this.isConnecting=!1,this.isConnected=!1,this.actuatorsTotal>0&&this.getChildren().forEach(function(obj){void 0!==obj.matchInterface("Actuator")&&$thing.agent(obj)("pause")()}),this.isActive()&&this.doReconnect()},onMessageArrived:function(topic,message){this.getChildren().forEach(function(obj){obj.isAbstract()||void 0===obj.matchInterface(topic)||(void 0!==obj.matchInterface("Bridge")?$thing.agent("@select $ not owner:$",topic,obj.$owner.$id)("push",message)():void 0!==obj.matchInterface("Sensor")&&$thing.agent(obj)("push",message)())})},onMessageDelivered:function(){}});