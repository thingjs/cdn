/*! ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  
        /\____                                          THING.JS               
      // ~ / _\_____                            Internet of Wild Things        
     /     \   .. \/                                 version 0.2.2             
    //     /~_____/                                                            
    /// \/  /                                      http://thingjs.org          
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ */
if(function(){function only_once(fn){var called=!1;return function(){if(called)throw new Error("Callback was already called.");called=!0,fn.apply(root,arguments)}}var root,previous_async,async={};root=this,null!=root&&(previous_async=root.async),async.noConflict=function(){return root.async=previous_async,async};var _toString=Object.prototype.toString,_isArray=Array.isArray||function(obj){return"[object Array]"===_toString.call(obj)},_each=function(arr,iterator){if(arr.forEach)return arr.forEach(iterator);for(var i=0;i<arr.length;i+=1)iterator(arr[i],i,arr)},_map=function(arr,iterator){if(arr.map)return arr.map(iterator);var results=[];return _each(arr,function(x,i,a){results.push(iterator(x,i,a))}),results},_reduce=function(arr,iterator,memo){return arr.reduce?arr.reduce(iterator,memo):(_each(arr,function(x,i,a){memo=iterator(memo,x,i,a)}),memo)},_keys=function(obj){if(Object.keys)return Object.keys(obj);var keys=[];for(var k in obj)obj.hasOwnProperty(k)&&keys.push(k);return keys};"undefined"!=typeof process&&process.nextTick?(async.nextTick=process.nextTick,async.setImmediate="undefined"!=typeof setImmediate?function(fn){setImmediate(fn)}:async.nextTick):"function"==typeof setImmediate?(async.nextTick=function(fn){setImmediate(fn)},async.setImmediate=async.nextTick):(async.nextTick=function(fn){setTimeout(fn,0)},async.setImmediate=async.nextTick),async.each=function(arr,iterator,callback){function done(err){err?(callback(err),callback=function(){}):(completed+=1,completed>=arr.length&&callback())}if(callback=callback||function(){},!arr.length)return callback();var completed=0;_each(arr,function(x){iterator(x,only_once(done))})},async.forEach=async.each,async.eachSeries=function(arr,iterator,callback){if(callback=callback||function(){},!arr.length)return callback();var completed=0,iterate=function(){iterator(arr[completed],function(err){err?(callback(err),callback=function(){}):(completed+=1,completed>=arr.length?callback():iterate())})};iterate()},async.forEachSeries=async.eachSeries,async.eachLimit=function(arr,limit,iterator,callback){var fn=_eachLimit(limit);fn.apply(null,[arr,iterator,callback])},async.forEachLimit=async.eachLimit;var _eachLimit=function(limit){return function(arr,iterator,callback){if(callback=callback||function(){},!arr.length||0>=limit)return callback();var completed=0,started=0,running=0;!function replenish(){if(completed>=arr.length)return callback();for(;limit>running&&started<arr.length;)started+=1,running+=1,iterator(arr[started-1],function(err){err?(callback(err),callback=function(){}):(completed+=1,running-=1,completed>=arr.length?callback():replenish())})}()}},doParallel=function(fn){return function(){var args=Array.prototype.slice.call(arguments);return fn.apply(null,[async.each].concat(args))}},doParallelLimit=function(limit,fn){return function(){var args=Array.prototype.slice.call(arguments);return fn.apply(null,[_eachLimit(limit)].concat(args))}},doSeries=function(fn){return function(){var args=Array.prototype.slice.call(arguments);return fn.apply(null,[async.eachSeries].concat(args))}},_asyncMap=function(eachfn,arr,iterator,callback){if(arr=_map(arr,function(x,i){return{index:i,value:x}}),callback){var results=[];eachfn(arr,function(x,callback){iterator(x.value,function(err,v){results[x.index]=v,callback(err)})},function(err){callback(err,results)})}else eachfn(arr,function(x,callback){iterator(x.value,function(err){callback(err)})})};async.map=doParallel(_asyncMap),async.mapSeries=doSeries(_asyncMap),async.mapLimit=function(arr,limit,iterator,callback){return _mapLimit(limit)(arr,iterator,callback)};var _mapLimit=function(limit){return doParallelLimit(limit,_asyncMap)};async.reduce=function(arr,memo,iterator,callback){async.eachSeries(arr,function(x,callback){iterator(memo,x,function(err,v){memo=v,callback(err)})},function(err){callback(err,memo)})},async.inject=async.reduce,async.foldl=async.reduce,async.reduceRight=function(arr,memo,iterator,callback){var reversed=_map(arr,function(x){return x}).reverse();async.reduce(reversed,memo,iterator,callback)},async.foldr=async.reduceRight;var _filter=function(eachfn,arr,iterator,callback){var results=[];arr=_map(arr,function(x,i){return{index:i,value:x}}),eachfn(arr,function(x,callback){iterator(x.value,function(v){v&&results.push(x),callback()})},function(){callback(_map(results.sort(function(a,b){return a.index-b.index}),function(x){return x.value}))})};async.filter=doParallel(_filter),async.filterSeries=doSeries(_filter),async.select=async.filter,async.selectSeries=async.filterSeries;var _reject=function(eachfn,arr,iterator,callback){var results=[];arr=_map(arr,function(x,i){return{index:i,value:x}}),eachfn(arr,function(x,callback){iterator(x.value,function(v){v||results.push(x),callback()})},function(){callback(_map(results.sort(function(a,b){return a.index-b.index}),function(x){return x.value}))})};async.reject=doParallel(_reject),async.rejectSeries=doSeries(_reject);var _detect=function(eachfn,arr,iterator,main_callback){eachfn(arr,function(x,callback){iterator(x,function(result){result?(main_callback(x),main_callback=function(){}):callback()})},function(){main_callback()})};async.detect=doParallel(_detect),async.detectSeries=doSeries(_detect),async.some=function(arr,iterator,main_callback){async.each(arr,function(x,callback){iterator(x,function(v){v&&(main_callback(!0),main_callback=function(){}),callback()})},function(){main_callback(!1)})},async.any=async.some,async.every=function(arr,iterator,main_callback){async.each(arr,function(x,callback){iterator(x,function(v){v||(main_callback(!1),main_callback=function(){}),callback()})},function(){main_callback(!0)})},async.all=async.every,async.sortBy=function(arr,iterator,callback){async.map(arr,function(x,callback){iterator(x,function(err,criteria){err?callback(err):callback(null,{value:x,criteria:criteria})})},function(err,results){if(err)return callback(err);var fn=function(left,right){var a=left.criteria,b=right.criteria;return b>a?-1:a>b?1:0};callback(null,_map(results.sort(fn),function(x){return x.value}))})},async.auto=function(tasks,callback){callback=callback||function(){};var keys=_keys(tasks),remainingTasks=keys.length;if(!remainingTasks)return callback();var results={},listeners=[],addListener=function(fn){listeners.unshift(fn)},removeListener=function(fn){for(var i=0;i<listeners.length;i+=1)if(listeners[i]===fn)return void listeners.splice(i,1)},taskComplete=function(){remainingTasks--,_each(listeners.slice(0),function(fn){fn()})};addListener(function(){if(!remainingTasks){var theCallback=callback;callback=function(){},theCallback(null,results)}}),_each(keys,function(k){var task=_isArray(tasks[k])?tasks[k]:[tasks[k]],taskCallback=function(err){var args=Array.prototype.slice.call(arguments,1);if(args.length<=1&&(args=args[0]),err){var safeResults={};_each(_keys(results),function(rkey){safeResults[rkey]=results[rkey]}),safeResults[k]=args,callback(err,safeResults),callback=function(){}}else results[k]=args,async.setImmediate(taskComplete)},requires=task.slice(0,Math.abs(task.length-1))||[],ready=function(){return _reduce(requires,function(a,x){return a&&results.hasOwnProperty(x)},!0)&&!results.hasOwnProperty(k)};if(ready())task[task.length-1](taskCallback,results);else{var listener=function(){ready()&&(removeListener(listener),task[task.length-1](taskCallback,results))};addListener(listener)}})},async.retry=function(times,task,callback){var DEFAULT_TIMES=5,attempts=[];"function"==typeof times&&(callback=task,task=times,times=DEFAULT_TIMES),times=parseInt(times,10)||DEFAULT_TIMES;var wrappedTask=function(wrappedCallback,wrappedResults){for(var retryAttempt=function(task,finalAttempt){return function(seriesCallback){task(function(err,result){seriesCallback(!err||finalAttempt,{err:err,result:result})},wrappedResults)}};times;)attempts.push(retryAttempt(task,!(times-=1)));async.series(attempts,function(done,data){data=data[data.length-1],(wrappedCallback||callback)(data.err,data.result)})};return callback?wrappedTask():wrappedTask},async.waterfall=function(tasks,callback){if(callback=callback||function(){},!_isArray(tasks)){var err=new Error("First argument to waterfall must be an array of functions");return callback(err)}if(!tasks.length)return callback();var wrapIterator=function(iterator){return function(err){if(err)callback.apply(null,arguments),callback=function(){};else{var args=Array.prototype.slice.call(arguments,1),next=iterator.next();args.push(next?wrapIterator(next):callback),async.setImmediate(function(){iterator.apply(null,args)})}}};wrapIterator(async.iterator(tasks))()};var _parallel=function(eachfn,tasks,callback){if(callback=callback||function(){},_isArray(tasks))eachfn.map(tasks,function(fn,callback){fn&&fn(function(err){var args=Array.prototype.slice.call(arguments,1);args.length<=1&&(args=args[0]),callback.call(null,err,args)})},callback);else{var results={};eachfn.each(_keys(tasks),function(k,callback){tasks[k](function(err){var args=Array.prototype.slice.call(arguments,1);args.length<=1&&(args=args[0]),results[k]=args,callback(err)})},function(err){callback(err,results)})}};async.parallel=function(tasks,callback){_parallel({map:async.map,each:async.each},tasks,callback)},async.parallelLimit=function(tasks,limit,callback){_parallel({map:_mapLimit(limit),each:_eachLimit(limit)},tasks,callback)},async.series=function(tasks,callback){if(callback=callback||function(){},_isArray(tasks))async.mapSeries(tasks,function(fn,callback){fn&&fn(function(err){var args=Array.prototype.slice.call(arguments,1);args.length<=1&&(args=args[0]),callback.call(null,err,args)})},callback);else{var results={};async.eachSeries(_keys(tasks),function(k,callback){tasks[k](function(err){var args=Array.prototype.slice.call(arguments,1);args.length<=1&&(args=args[0]),results[k]=args,callback(err)})},function(err){callback(err,results)})}},async.iterator=function(tasks){var makeCallback=function(index){var fn=function(){return tasks.length&&tasks[index].apply(null,arguments),fn.next()};return fn.next=function(){return index<tasks.length-1?makeCallback(index+1):null},fn};return makeCallback(0)},async.apply=function(fn){var args=Array.prototype.slice.call(arguments,1);return function(){return fn.apply(null,args.concat(Array.prototype.slice.call(arguments)))}};var _concat=function(eachfn,arr,fn,callback){var r=[];eachfn(arr,function(x,cb){fn(x,function(err,y){r=r.concat(y||[]),cb(err)})},function(err){callback(err,r)})};async.concat=doParallel(_concat),async.concatSeries=doSeries(_concat),async.whilst=function(test,iterator,callback){test()?iterator(function(err){return err?callback(err):void async.whilst(test,iterator,callback)}):callback()},async.doWhilst=function(iterator,test,callback){iterator(function(err){if(err)return callback(err);var args=Array.prototype.slice.call(arguments,1);test.apply(null,args)?async.doWhilst(iterator,test,callback):callback()})},async.until=function(test,iterator,callback){test()?callback():iterator(function(err){return err?callback(err):void async.until(test,iterator,callback)})},async.doUntil=function(iterator,test,callback){iterator(function(err){if(err)return callback(err);var args=Array.prototype.slice.call(arguments,1);test.apply(null,args)?callback():async.doUntil(iterator,test,callback)})},async.queue=function(worker,concurrency){function _insert(q,data,pos,callback){return q.started||(q.started=!0),_isArray(data)||(data=[data]),0==data.length?async.setImmediate(function(){q.drain&&q.drain()}):void _each(data,function(task){var item={data:task,callback:"function"==typeof callback?callback:null};pos?q.tasks.unshift(item):q.tasks.push(item),q.saturated&&q.tasks.length===q.concurrency&&q.saturated(),async.setImmediate(q.process)})}void 0===concurrency&&(concurrency=1);var workers=0,q={tasks:[],concurrency:concurrency,saturated:null,empty:null,drain:null,started:!1,paused:!1,push:function(data,callback){_insert(q,data,!1,callback)},kill:function(){q.drain=null,q.tasks=[]},unshift:function(data,callback){_insert(q,data,!0,callback)},process:function(){if(!q.paused&&workers<q.concurrency&&q.tasks.length){var task=q.tasks.shift();q.empty&&0===q.tasks.length&&q.empty(),workers+=1;var next=function(){workers-=1,task.callback&&task.callback.apply(task,arguments),q.drain&&q.tasks.length+workers===0&&q.drain(),q.process()},cb=only_once(next);worker(task.data,cb)}},length:function(){return q.tasks.length},running:function(){return workers},idle:function(){return q.tasks.length+workers===0},pause:function(){q.paused!==!0&&(q.paused=!0,q.process())},resume:function(){q.paused!==!1&&(q.paused=!1,q.process())}};return q},async.priorityQueue=function(worker,concurrency){function _compareTasks(a,b){return a.priority-b.priority}function _binarySearch(sequence,item,compare){for(var beg=-1,end=sequence.length-1;end>beg;){var mid=beg+(end-beg+1>>>1);compare(item,sequence[mid])>=0?beg=mid:end=mid-1}return beg}function _insert(q,data,priority,callback){return q.started||(q.started=!0),_isArray(data)||(data=[data]),0==data.length?async.setImmediate(function(){q.drain&&q.drain()}):void _each(data,function(task){var item={data:task,priority:priority,callback:"function"==typeof callback?callback:null};q.tasks.splice(_binarySearch(q.tasks,item,_compareTasks)+1,0,item),q.saturated&&q.tasks.length===q.concurrency&&q.saturated(),async.setImmediate(q.process)})}var q=async.queue(worker,concurrency);return q.push=function(data,priority,callback){_insert(q,data,priority,callback)},delete q.unshift,q},async.cargo=function(worker,payload){var working=!1,tasks=[],cargo={tasks:tasks,payload:payload,saturated:null,empty:null,drain:null,drained:!0,push:function(data,callback){_isArray(data)||(data=[data]),_each(data,function(task){tasks.push({data:task,callback:"function"==typeof callback?callback:null}),cargo.drained=!1,cargo.saturated&&tasks.length===payload&&cargo.saturated()}),async.setImmediate(cargo.process)},process:function process(){if(!working){if(0===tasks.length)return cargo.drain&&!cargo.drained&&cargo.drain(),void(cargo.drained=!0);var ts="number"==typeof payload?tasks.splice(0,payload):tasks.splice(0,tasks.length),ds=_map(ts,function(task){return task.data});cargo.empty&&cargo.empty(),working=!0,worker(ds,function(){working=!1;var args=arguments;_each(ts,function(data){data.callback&&data.callback.apply(null,args)}),process()})}},length:function(){return tasks.length},running:function(){return working}};return cargo};var _console_fn=function(name){return function(fn){var args=Array.prototype.slice.call(arguments,1);fn.apply(null,args.concat([function(err){var args=Array.prototype.slice.call(arguments,1);"undefined"!=typeof console&&(err?console.error&&console.error(err):console[name]&&_each(args,function(x){console[name](x)}))}]))}};async.log=_console_fn("log"),async.dir=_console_fn("dir"),async.memoize=function(fn,hasher){var memo={},queues={};hasher=hasher||function(x){return x};var memoized=function(){var args=Array.prototype.slice.call(arguments),callback=args.pop(),key=hasher.apply(null,args);key in memo?async.nextTick(function(){callback.apply(null,memo[key])}):key in queues?queues[key].push(callback):(queues[key]=[callback],fn.apply(null,args.concat([function(){memo[key]=arguments;var q=queues[key];delete queues[key];for(var i=0,l=q.length;l>i;i++)q[i].apply(null,arguments)}])))};return memoized.memo=memo,memoized.unmemoized=fn,memoized},async.unmemoize=function(fn){return function(){return(fn.unmemoized||fn).apply(null,arguments)}},async.times=function(count,iterator,callback){for(var counter=[],i=0;count>i;i++)counter.push(i);return async.map(counter,iterator,callback)},async.timesSeries=function(count,iterator,callback){for(var counter=[],i=0;count>i;i++)counter.push(i);return async.mapSeries(counter,iterator,callback)},async.seq=function(){var fns=arguments;return function(){var that=this,args=Array.prototype.slice.call(arguments),callback=args.pop();async.reduce(fns,args,function(newargs,fn,cb){fn.apply(that,newargs.concat([function(){var err=arguments[0],nextargs=Array.prototype.slice.call(arguments,1);cb(err,nextargs)}]))},function(err,results){callback.apply(that,[err].concat(results))})}},async.compose=function(){return async.seq.apply(null,Array.prototype.reverse.call(arguments))};var _applyEach=function(eachfn,fns){var go=function(){var that=this,args=Array.prototype.slice.call(arguments),callback=args.pop();return eachfn(fns,function(fn,cb){fn.apply(that,args.concat([cb]))},callback)};if(arguments.length>2){var args=Array.prototype.slice.call(arguments,2);return go.apply(this,args)}return go};async.applyEach=doParallel(_applyEach),async.applyEachSeries=doSeries(_applyEach),async.forever=function(fn,callback){function next(err){if(err){if(callback)return callback(err);throw err}fn(next)}next()},"undefined"!=typeof module&&module.exports?module.exports=async:"undefined"!=typeof define&&define.amd?define([],function(){return async}):root.async=async}(),function(){var _nodejs="undefined"!=typeof process&&process.versions&&process.versions.node,_browser=!_nodejs&&("undefined"!=typeof window||"undefined"!=typeof self);_browser&&"undefined"==typeof global&&("undefined"!=typeof window?global=window:"undefined"!=typeof self?global=self:"undefined"!=typeof $&&(global=$));var wrapper=function(jsonld){function JsonLdProcessor(){}function _expandLanguageMap(languageMap){for(var rval=[],keys=Object.keys(languageMap).sort(),ki=0;ki<keys.length;++ki){var key=keys[ki],val=languageMap[key];_isArray(val)||(val=[val]);for(var vi=0;vi<val.length;++vi){var item=val[vi];if(!_isString(item))throw new JsonLdError("Invalid JSON-LD syntax; language map values must be strings.","jsonld.SyntaxError",{code:"invalid language map value",languageMap:languageMap});rval.push({"@value":item,"@language":key.toLowerCase()})}}return rval}function _labelBlankNodes(namer,element){if(_isArray(element))for(var i=0;i<element.length;++i)element[i]=_labelBlankNodes(namer,element[i]);else if(_isList(element))element["@list"]=_labelBlankNodes(namer,element["@list"]);else if(_isObject(element)){_isBlankNode(element)&&(element["@id"]=namer.getName(element["@id"]));for(var keys=Object.keys(element).sort(),ki=0;ki<keys.length;++ki){var key=keys[ki];"@id"!==key&&(element[key]=_labelBlankNodes(namer,element[key]))}}return element}function _expandValue(activeCtx,activeProperty,value){if(null===value||void 0===value)return null;var expandedProperty=_expandIri(activeCtx,activeProperty,{vocab:!0});if("@id"===expandedProperty)return _expandIri(activeCtx,value,{base:!0});if("@type"===expandedProperty)return _expandIri(activeCtx,value,{vocab:!0,base:!0});var type=jsonld.getContextValue(activeCtx,activeProperty,"@type");if("@id"===type||"@graph"===expandedProperty&&_isString(value))return{"@id":_expandIri(activeCtx,value,{base:!0})};if("@vocab"===type)return{"@id":_expandIri(activeCtx,value,{vocab:!0,base:!0})};if(_isKeyword(expandedProperty))return value;var rval={};if(null!==type)rval["@type"]=type;else if(_isString(value)){var language=jsonld.getContextValue(activeCtx,activeProperty,"@language");null!==language&&(rval["@language"]=language)}return-1===["boolean","number","string"].indexOf(typeof value)&&(value=value.toString()),rval["@value"]=value,rval}function _graphToRDF(graph,namer,options){for(var rval=[],ids=Object.keys(graph).sort(),i=0;i<ids.length;++i)for(var id=ids[i],node=graph[id],properties=Object.keys(node).sort(),pi=0;pi<properties.length;++pi){var property=properties[pi],items=node[property];if("@type"===property)property=RDF_TYPE;else if(_isKeyword(property))continue;for(var ii=0;ii<items.length;++ii){var item=items[ii],subject={};if(subject.type=0===id.indexOf("_:")?"blank node":"IRI",subject.value=id,_isAbsoluteIri(id)){var predicate={};if(predicate.type=0===property.indexOf("_:")?"blank node":"IRI",predicate.value=property,_isAbsoluteIri(property)&&("blank node"!==predicate.type||options.produceGeneralizedRdf))if(_isList(item))_listToRDF(item["@list"],namer,subject,predicate,rval);else{var object=_objectToRDF(item);object&&rval.push({subject:subject,predicate:predicate,object:object})}}}}return rval}function _listToRDF(list,namer,subject,predicate,triples){for(var first={type:"IRI",value:RDF_FIRST},rest={type:"IRI",value:RDF_REST},nil={type:"IRI",value:RDF_NIL},i=0;i<list.length;++i){var item=list[i],blankNode={type:"blank node",value:namer.getName()};triples.push({subject:subject,predicate:predicate,object:blankNode}),subject=blankNode,predicate=first;var object=_objectToRDF(item);object&&triples.push({subject:subject,predicate:predicate,object:object}),predicate=rest}triples.push({subject:subject,predicate:predicate,object:nil})}function _objectToRDF(item){var object={};if(_isValue(item)){object.type="literal";var value=item["@value"],datatype=item["@type"]||null;_isBoolean(value)?(object.value=value.toString(),object.datatype=datatype||XSD_BOOLEAN):_isDouble(value)||datatype===XSD_DOUBLE?(_isDouble(value)||(value=parseFloat(value)),object.value=value.toExponential(15).replace(/(\d)0*e\+?/,"$1E"),object.datatype=datatype||XSD_DOUBLE):_isNumber(value)?(object.value=value.toFixed(0),object.datatype=datatype||XSD_INTEGER):"@language"in item?(object.value=value,object.datatype=datatype||RDF_LANGSTRING,object.language=item["@language"]):(object.value=value,object.datatype=datatype||XSD_STRING)}else{var id=_isObject(item)?item["@id"]:item;object.type=0===id.indexOf("_:")?"blank node":"IRI",object.value=id}return"IRI"!==object.type||_isAbsoluteIri(object.value)?object:null}function _RDFToObject(o,useNativeTypes){if("IRI"===o.type||"blank node"===o.type)return{"@id":o.value};var rval={"@value":o.value};if(o.language)rval["@language"]=o.language;else{var type=o.datatype;if(type||(type=XSD_STRING),useNativeTypes){if(type===XSD_BOOLEAN)"true"===rval["@value"]?rval["@value"]=!0:"false"===rval["@value"]&&(rval["@value"]=!1);else if(_isNumeric(rval["@value"]))if(type===XSD_INTEGER){var i=parseInt(rval["@value"],10);i.toFixed(0)===rval["@value"]&&(rval["@value"]=i)}else type===XSD_DOUBLE&&(rval["@value"]=parseFloat(rval["@value"]));-1===[XSD_BOOLEAN,XSD_INTEGER,XSD_DOUBLE,XSD_STRING].indexOf(type)&&(rval["@type"]=type)}else type!==XSD_STRING&&(rval["@type"]=type)}return rval}function _compareRDFTriples(t1,t2){for(var attrs=["subject","predicate","object"],i=0;i<attrs.length;++i){var attr=attrs[i];if(t1[attr].type!==t2[attr].type||t1[attr].value!==t2[attr].value)return!1}return t1.object.language!==t2.object.language?!1:t1.object.datatype!==t2.object.datatype?!1:!0}function _hashQuads(id,bnodes){if("hash"in bnodes[id])return bnodes[id].hash;for(var quads=bnodes[id].quads,nquads=[],i=0;i<quads.length;++i)nquads.push(_toNQuad(quads[i],quads[i].name?quads[i].name.value:null,id));nquads.sort();var hash=bnodes[id].hash=sha1.hash(nquads);return hash}function _hashPaths(id,bnodes,namer,pathNamer,callback){function groupNodes(i){if(i===quads.length)return groupHashes=Object.keys(groups).sort(),hashGroup(0);var quad=quads[i],bnode=_getAdjacentBlankNodeName(quad.subject,id),direction=null;if(null!==bnode?direction="p":(bnode=_getAdjacentBlankNodeName(quad.object,id),null!==bnode&&(direction="r")),null!==bnode){var name;name=namer.isNamed(bnode)?namer.getName(bnode):pathNamer.isNamed(bnode)?pathNamer.getName(bnode):_hashQuads(bnode,bnodes);var md=sha1.create();md.update(direction),md.update(quad.predicate.value),md.update(name);var groupHash=md.digest();groupHash in groups?groups[groupHash].push(bnode):groups[groupHash]=[bnode]}jsonld.setImmediate(function(){groupNodes(i+1)})}function hashGroup(i){function permutate(){function nextRecursion(n){if(n===recurse.length)return nextPermutation(!1);var bnode=recurse[n];_hashPaths(bnode,bnodes,namer,pathNamerCopy,function(err,result){return err?callback(err):(path+=pathNamerCopy.getName(bnode)+"<"+result.hash+">",pathNamerCopy=result.pathNamer,null!==chosenPath&&path.length>=chosenPath.length&&path>chosenPath?nextPermutation(!0):void nextRecursion(n+1))})}function nextPermutation(skipped){!skipped&&(null===chosenPath||chosenPath>path)&&(chosenPath=path,chosenNamer=pathNamerCopy),permutator.hasNext()?jsonld.setImmediate(function(){permutate()}):(md.update(chosenPath),pathNamer=chosenNamer,hashGroup(i+1))}var permutation=permutator.next(),pathNamerCopy=pathNamer.clone(),path="",recurse=[];for(var n in permutation){var bnode=permutation[n];if(namer.isNamed(bnode)?path+=namer.getName(bnode):(pathNamerCopy.isNamed(bnode)||recurse.push(bnode),path+=pathNamerCopy.getName(bnode)),null!==chosenPath&&path.length>=chosenPath.length&&path>chosenPath)return nextPermutation(!0)}nextRecursion(0)}if(i===groupHashes.length)return callback(null,{hash:md.digest(),pathNamer:pathNamer});var groupHash=groupHashes[i];md.update(groupHash);var chosenPath=null,chosenNamer=null,permutator=new Permutator(groups[groupHash]);jsonld.setImmediate(function(){permutate()})}var groupHashes,md=sha1.create(),groups={},quads=bnodes[id].quads;jsonld.setImmediate(function(){groupNodes(0)})}function _getAdjacentBlankNodeName(node,id){return"blank node"===node.type&&node.value!==id?node.value:null}function _createNodeMap(input,graphs,graph,namer,name,list){if(_isArray(input))for(var i=0;i<input.length;++i)_createNodeMap(input[i],graphs,graph,namer,void 0,list);else{if(!_isObject(input))return void(list&&list.push(input));if(_isValue(input)){if("@type"in input){var type=input["@type"];0===type.indexOf("_:")&&(input["@type"]=type=namer.getName(type))}return void(list&&list.push(input))}if("@type"in input)for(var types=input["@type"],i=0;i<types.length;++i){var type=types[i];0===type.indexOf("_:")&&namer.getName(type)}_isUndefined(name)&&(name=_isBlankNode(input)?namer.getName(input["@id"]):input["@id"]),list&&list.push({"@id":name});var subjects=graphs[graph],subject=subjects[name]=subjects[name]||{};subject["@id"]=name;for(var properties=Object.keys(input).sort(),pi=0;pi<properties.length;++pi){var property=properties[pi];if("@id"!==property)if("@reverse"!==property)if("@graph"!==property)if("@type"!==property&&_isKeyword(property)){if("@index"===property&&"@index"in subject)throw new JsonLdError("Invalid JSON-LD syntax; conflicting @index property detected.","jsonld.SyntaxError",{code:"conflicting indexes",subject:subject});subject[property]=input[property]}else{var objects=input[property];if(0===property.indexOf("_:")&&(property=namer.getName(property)),0!==objects.length)for(var oi=0;oi<objects.length;++oi){var o=objects[oi];if("@type"===property&&(o=0===o.indexOf("_:")?namer.getName(o):o),_isSubject(o)||_isSubjectReference(o)){var id=_isBlankNode(o)?namer.getName(o["@id"]):o["@id"];jsonld.addValue(subject,property,{"@id":id},{propertyIsArray:!0,allowDuplicate:!1}),_createNodeMap(o,graphs,graph,namer,id)}else if(_isList(o)){var _list=[];_createNodeMap(o["@list"],graphs,graph,namer,name,_list),o={"@list":_list},jsonld.addValue(subject,property,o,{propertyIsArray:!0,allowDuplicate:!1})}else _createNodeMap(o,graphs,graph,namer,name),jsonld.addValue(subject,property,o,{propertyIsArray:!0,allowDuplicate:!1})}else jsonld.addValue(subject,property,[],{propertyIsArray:!0})}else{name in graphs||(graphs[name]={});var g="@merged"===graph?graph:name;_createNodeMap(input[property],graphs,g,namer)}else{var referencedNode={"@id":name},reverseMap=input["@reverse"];for(var reverseProperty in reverseMap)for(var items=reverseMap[reverseProperty],ii=0;ii<items.length;++ii){var item=items[ii],itemName=item["@id"];_isBlankNode(item)&&(itemName=namer.getName(itemName)),_createNodeMap(item,graphs,graph,namer,itemName),jsonld.addValue(subjects[itemName],reverseProperty,referencedNode,{propertyIsArray:!0,allowDuplicate:!1})}}}}}function _mergeNodeMaps(graphs){for(var defaultGraph=graphs["@default"],graphNames=Object.keys(graphs).sort(),i=0;i<graphNames.length;++i){var graphName=graphNames[i];if("@default"!==graphName){var nodeMap=graphs[graphName],subject=defaultGraph[graphName];subject?"@graph"in subject||(subject["@graph"]=[]):defaultGraph[graphName]=subject={"@id":graphName,"@graph":[]};for(var graph=subject["@graph"],ids=Object.keys(nodeMap).sort(),ii=0;ii<ids.length;++ii){var node=nodeMap[ids[ii]];_isSubjectReference(node)||graph.push(node)}}}return defaultGraph}function _frame(state,subjects,frame,parent,property){_validateFrame(frame),frame=frame[0];var options=state.options,flags={embed:_getFrameFlag(frame,options,"embed"),explicit:_getFrameFlag(frame,options,"explicit"),requireAll:_getFrameFlag(frame,options,"requireAll")},matches=_filterSubjects(state,subjects,frame,flags),ids=Object.keys(matches).sort();for(var idx in ids){var id=ids[idx],subject=matches[id];if("@link"===flags.embed&&id in state.link)_addFrameOutput(parent,property,state.link[id]);else{null===property&&(state.uniqueEmbeds={});var output={};if(output["@id"]=id,state.link[id]=output,"@never"===flags.embed||_createsCircularReference(subject,state.subjectStack))_addFrameOutput(parent,property,output);else{"@last"===flags.embed&&(id in state.uniqueEmbeds&&_removeEmbed(state,id),state.uniqueEmbeds[id]={parent:parent,property:property}),state.subjectStack.push(subject);for(var props=Object.keys(subject).sort(),i=0;i<props.length;i++){var prop=props[i];if(_isKeyword(prop))output[prop]=_clone(subject[prop]);else if(!flags.explicit||prop in frame)for(var objects=subject[prop],oi=0;oi<objects.length;++oi){var o=objects[oi];if(_isList(o)){var list={"@list":[]};_addFrameOutput(output,prop,list);var src=o["@list"];for(var n in src)if(o=src[n],_isSubjectReference(o)){var subframe=prop in frame?frame[prop][0]["@list"]:_createImplicitFrame(flags);_frame(state,[o["@id"]],subframe,list,"@list")}else _addFrameOutput(list,"@list",_clone(o))}else if(_isSubjectReference(o)){var subframe=prop in frame?frame[prop]:_createImplicitFrame(flags);_frame(state,[o["@id"]],subframe,output,prop)}else _addFrameOutput(output,prop,_clone(o))}}for(var props=Object.keys(frame).sort(),i=0;i<props.length;++i){var prop=props[i];if(!_isKeyword(prop)){var next=frame[prop][0],omitDefaultOn=_getFrameFlag(next,options,"omitDefault");if(!(omitDefaultOn||prop in output)){var preserve="@null";"@default"in next&&(preserve=_clone(next["@default"])),_isArray(preserve)||(preserve=[preserve]),output[prop]=[{"@preserve":preserve}]}}}_addFrameOutput(parent,property,output),state.subjectStack.pop()}}}}function _createImplicitFrame(flags){var frame={};for(var key in flags)void 0!==flags[key]&&(frame["@"+key]=[flags[key]]);return[frame]}function _createsCircularReference(subjectToEmbed,subjectStack){for(var i=subjectStack.length-1;i>=0;--i)if(subjectStack[i]["@id"]===subjectToEmbed["@id"])return!0;return!1}function _getFrameFlag(frame,options,name){var flag="@"+name,rval=flag in frame?frame[flag][0]:options[name];return"embed"===name&&(rval===!0?rval="@last":rval===!1?rval="@never":"@always"!==rval&&"@never"!==rval&&"@link"!==rval&&(rval="@last")),rval}function _validateFrame(frame){if(!_isArray(frame)||1!==frame.length||!_isObject(frame[0]))throw new JsonLdError("Invalid JSON-LD syntax; a JSON-LD frame must be a single object.","jsonld.SyntaxError",{frame:frame})}function _filterSubjects(state,subjects,frame,flags){for(var rval={},i=0;i<subjects.length;++i){var id=subjects[i],subject=state.subjects[id];_filterSubject(subject,frame,flags)&&(rval[id]=subject)}return rval}function _filterSubject(subject,frame,flags){if("@type"in frame&&(1!==frame["@type"].length||!_isObject(frame["@type"][0]))){for(var types=frame["@type"],i=0;i<types.length;++i)if(jsonld.hasValue(subject,"@type",types[i]))return!0;return!1}var wildcard=!0,matchesSome=!1;for(var key in frame){if(_isKeyword(key)){if("@id"!==key&&"@type"!==key)continue;if(wildcard=!1,"@id"===key&&_isString(frame[key])){if(subject[key]!==frame[key])return!1;matchesSome=!0;continue}}if(wildcard=!1,key in subject){if(_isArray(frame[key])&&0===frame[key].length&&void 0!==subject[key])return!1;matchesSome=!0}else{var hasDefault=_isArray(frame[key])&&_isObject(frame[key][0])&&"@default"in frame[key][0];if(flags.requireAll&&!hasDefault)return!1}}return wildcard||matchesSome
}function _removeEmbed(state,id){var embeds=state.uniqueEmbeds,embed=embeds[id],parent=embed.parent,property=embed.property,subject={"@id":id};if(_isArray(parent)){for(var i=0;i<parent.length;++i)if(jsonld.compareValues(parent[i],subject)){parent[i]=subject;break}}else{var useArray=_isArray(parent[property]);jsonld.removeValue(parent,property,subject,{propertyIsArray:useArray}),jsonld.addValue(parent,property,subject,{propertyIsArray:useArray})}var removeDependents=function(id){for(var ids=Object.keys(embeds),i=0;i<ids.length;++i){var next=ids[i];next in embeds&&_isObject(embeds[next].parent)&&embeds[next].parent["@id"]===id&&(delete embeds[next],removeDependents(next))}};removeDependents(id)}function _addFrameOutput(parent,property,output){_isObject(parent)?jsonld.addValue(parent,property,output,{propertyIsArray:!0}):parent.push(output)}function _removePreserve(ctx,input,options){if(_isArray(input)){for(var output=[],i=0;i<input.length;++i){var result=_removePreserve(ctx,input[i],options);null!==result&&output.push(result)}input=output}else if(_isObject(input)){if("@preserve"in input)return"@null"===input["@preserve"]?null:input["@preserve"];if(_isValue(input))return input;if(_isList(input))return input["@list"]=_removePreserve(ctx,input["@list"],options),input;var idAlias=_compactIri(ctx,"@id");if(idAlias in input){var id=input[idAlias];if(id in options.link){var idx=options.link[id].indexOf(input);if(-1!==idx)return options.link[id][idx];options.link[id].push(input)}else options.link[id]=[input]}for(var prop in input){var result=_removePreserve(ctx,input[prop],options),container=jsonld.getContextValue(ctx,prop,"@container");options.compactArrays&&_isArray(result)&&1===result.length&&null===container&&(result=result[0]),input[prop]=result}}return input}function _compareShortestLeast(a,b){return a.length<b.length?-1:b.length<a.length?1:a===b?0:b>a?-1:1}function _selectTerm(activeCtx,iri,value,containers,typeOrLanguage,typeOrLanguageValue){null===typeOrLanguageValue&&(typeOrLanguageValue="@null");var prefs=[];if("@id"!==typeOrLanguageValue&&"@reverse"!==typeOrLanguageValue||!_isSubjectReference(value))prefs.push(typeOrLanguageValue);else{"@reverse"===typeOrLanguageValue&&prefs.push("@reverse");var term=_compactIri(activeCtx,value["@id"],null,{vocab:!0});term in activeCtx.mappings&&activeCtx.mappings[term]&&activeCtx.mappings[term]["@id"]===value["@id"]?prefs.push.apply(prefs,["@vocab","@id"]):prefs.push.apply(prefs,["@id","@vocab"])}prefs.push("@none");for(var containerMap=activeCtx.inverse[iri],ci=0;ci<containers.length;++ci){var container=containers[ci];if(container in containerMap)for(var typeOrLanguageValueMap=containerMap[container][typeOrLanguage],pi=0;pi<prefs.length;++pi){var pref=prefs[pi];if(pref in typeOrLanguageValueMap)return typeOrLanguageValueMap[pref]}}return null}function _compactIri(activeCtx,iri,value,relativeTo,reverse){if(null===iri)return iri;if(_isUndefined(value)&&(value=null),_isUndefined(reverse)&&(reverse=!1),relativeTo=relativeTo||{},_isKeyword(iri)&&(relativeTo.vocab=!0),relativeTo.vocab&&iri in activeCtx.getInverse()){var defaultLanguage=activeCtx["@language"]||"@none",containers=[];_isObject(value)&&"@index"in value&&containers.push("@index");var typeOrLanguage="@language",typeOrLanguageValue="@null";if(reverse)typeOrLanguage="@type",typeOrLanguageValue="@reverse",containers.push("@set");else if(_isList(value)){"@index"in value||containers.push("@list");for(var list=value["@list"],commonLanguage=0===list.length?defaultLanguage:null,commonType=null,i=0;i<list.length;++i){var item=list[i],itemLanguage="@none",itemType="@none";if(_isValue(item)?"@language"in item?itemLanguage=item["@language"]:"@type"in item?itemType=item["@type"]:itemLanguage="@null":itemType="@id",null===commonLanguage?commonLanguage=itemLanguage:itemLanguage!==commonLanguage&&_isValue(item)&&(commonLanguage="@none"),null===commonType?commonType=itemType:itemType!==commonType&&(commonType="@none"),"@none"===commonLanguage&&"@none"===commonType)break}commonLanguage=commonLanguage||"@none",commonType=commonType||"@none","@none"!==commonType?(typeOrLanguage="@type",typeOrLanguageValue=commonType):typeOrLanguageValue=commonLanguage}else _isValue(value)?"@language"in value&&!("@index"in value)?(containers.push("@language"),typeOrLanguageValue=value["@language"]):"@type"in value&&(typeOrLanguage="@type",typeOrLanguageValue=value["@type"]):(typeOrLanguage="@type",typeOrLanguageValue="@id"),containers.push("@set");containers.push("@none");var term=_selectTerm(activeCtx,iri,value,containers,typeOrLanguage,typeOrLanguageValue);if(null!==term)return term}if(relativeTo.vocab&&"@vocab"in activeCtx){var vocab=activeCtx["@vocab"];if(0===iri.indexOf(vocab)&&iri!==vocab){var suffix=iri.substr(vocab.length);if(!(suffix in activeCtx.mappings))return suffix}}var choice=null;for(var term in activeCtx.mappings)if(-1===term.indexOf(":")){var definition=activeCtx.mappings[term];if(definition&&definition["@id"]!==iri&&0===iri.indexOf(definition["@id"])){var curie=term+":"+iri.substr(definition["@id"].length),isUsableCurie=!(curie in activeCtx.mappings)||null===value&&activeCtx.mappings[curie]&&activeCtx.mappings[curie]["@id"]===iri;isUsableCurie&&(null===choice||_compareShortestLeast(curie,choice)<0)&&(choice=curie)}}return null!==choice?choice:relativeTo.vocab?iri:_removeBase(activeCtx["@base"],iri)}function _compactValue(activeCtx,activeProperty,value){if(_isValue(value)){var type=jsonld.getContextValue(activeCtx,activeProperty,"@type"),language=jsonld.getContextValue(activeCtx,activeProperty,"@language"),container=jsonld.getContextValue(activeCtx,activeProperty,"@container"),preserveIndex="@index"in value&&"@index"!==container;if(!preserveIndex&&(value["@type"]===type||value["@language"]===language))return value["@value"];var keyCount=Object.keys(value).length,isValueOnlyKey=1===keyCount||2===keyCount&&"@index"in value&&!preserveIndex,hasDefaultLanguage="@language"in activeCtx,isValueString=_isString(value["@value"]),hasNullMapping=activeCtx.mappings[activeProperty]&&null===activeCtx.mappings[activeProperty]["@language"];if(isValueOnlyKey&&(!hasDefaultLanguage||!isValueString||hasNullMapping))return value["@value"];var rval={};return preserveIndex&&(rval[_compactIri(activeCtx,"@index")]=value["@index"]),"@type"in value?rval[_compactIri(activeCtx,"@type")]=_compactIri(activeCtx,value["@type"],null,{vocab:!0}):"@language"in value&&(rval[_compactIri(activeCtx,"@language")]=value["@language"]),rval[_compactIri(activeCtx,"@value")]=value["@value"],rval}var expandedProperty=_expandIri(activeCtx,activeProperty,{vocab:!0}),type=jsonld.getContextValue(activeCtx,activeProperty,"@type"),compacted=_compactIri(activeCtx,value["@id"],null,{vocab:"@vocab"===type});if("@id"===type||"@vocab"===type||"@graph"===expandedProperty)return compacted;var rval={};return rval[_compactIri(activeCtx,"@id")]=compacted,rval}function _createTermDefinition(activeCtx,localCtx,term,defined){if(term in defined){if(defined[term])return;throw new JsonLdError("Cyclical context definition detected.","jsonld.CyclicalContext",{code:"cyclic IRI mapping",context:localCtx,term:term})}if(defined[term]=!1,_isKeyword(term))throw new JsonLdError("Invalid JSON-LD syntax; keywords cannot be overridden.","jsonld.SyntaxError",{code:"keyword redefinition",context:localCtx,term:term});if(""===term)throw new JsonLdError("Invalid JSON-LD syntax; a term cannot be an empty string.","jsonld.SyntaxError",{code:"invalid term definition",context:localCtx});activeCtx.mappings[term]&&delete activeCtx.mappings[term];var value=localCtx[term];if(null===value||_isObject(value)&&null===value["@id"])return activeCtx.mappings[term]=null,void(defined[term]=!0);if(_isString(value)&&(value={"@id":value}),!_isObject(value))throw new JsonLdError("Invalid JSON-LD syntax; @context property values must be strings or objects.","jsonld.SyntaxError",{code:"invalid term definition",context:localCtx});var mapping=activeCtx.mappings[term]={};if(mapping.reverse=!1,"@reverse"in value){if("@id"in value)throw new JsonLdError("Invalid JSON-LD syntax; a @reverse term definition must not contain @id.","jsonld.SyntaxError",{code:"invalid reverse property",context:localCtx});var reverse=value["@reverse"];if(!_isString(reverse))throw new JsonLdError("Invalid JSON-LD syntax; a @context @reverse value must be a string.","jsonld.SyntaxError",{code:"invalid IRI mapping",context:localCtx});var id=_expandIri(activeCtx,reverse,{vocab:!0,base:!1},localCtx,defined);if(!_isAbsoluteIri(id))throw new JsonLdError("Invalid JSON-LD syntax; a @context @reverse value must be an absolute IRI or a blank node identifier.","jsonld.SyntaxError",{code:"invalid IRI mapping",context:localCtx});mapping["@id"]=id,mapping.reverse=!0}else if("@id"in value){var id=value["@id"];if(!_isString(id))throw new JsonLdError("Invalid JSON-LD syntax; a @context @id value must be an array of strings or a string.","jsonld.SyntaxError",{code:"invalid IRI mapping",context:localCtx});if(id!==term){if(id=_expandIri(activeCtx,id,{vocab:!0,base:!1},localCtx,defined),!_isAbsoluteIri(id)&&!_isKeyword(id))throw new JsonLdError("Invalid JSON-LD syntax; a @context @id value must be an absolute IRI, a blank node identifier, or a keyword.","jsonld.SyntaxError",{code:"invalid IRI mapping",context:localCtx});mapping["@id"]=id}}if(!("@id"in mapping)){var colon=term.indexOf(":");if(-1!==colon){var prefix=term.substr(0,colon);if(prefix in localCtx&&_createTermDefinition(activeCtx,localCtx,prefix,defined),activeCtx.mappings[prefix]){var suffix=term.substr(colon+1);mapping["@id"]=activeCtx.mappings[prefix]["@id"]+suffix}else mapping["@id"]=term}else{if(!("@vocab"in activeCtx))throw new JsonLdError("Invalid JSON-LD syntax; @context terms must define an @id.","jsonld.SyntaxError",{code:"invalid IRI mapping",context:localCtx,term:term});mapping["@id"]=activeCtx["@vocab"]+term}}if(defined[term]=!0,"@type"in value){var type=value["@type"];if(!_isString(type))throw new JsonLdError("Invalid JSON-LD syntax; an @context @type values must be a string.","jsonld.SyntaxError",{code:"invalid type mapping",context:localCtx});if("@id"!==type&&"@vocab"!==type){if(type=_expandIri(activeCtx,type,{vocab:!0,base:!1},localCtx,defined),!_isAbsoluteIri(type))throw new JsonLdError("Invalid JSON-LD syntax; an @context @type value must be an absolute IRI.","jsonld.SyntaxError",{code:"invalid type mapping",context:localCtx});if(0===type.indexOf("_:"))throw new JsonLdError("Invalid JSON-LD syntax; an @context @type values must be an IRI, not a blank node identifier.","jsonld.SyntaxError",{code:"invalid type mapping",context:localCtx})}mapping["@type"]=type}if("@container"in value){var container=value["@container"];if("@list"!==container&&"@set"!==container&&"@index"!==container&&"@language"!==container)throw new JsonLdError("Invalid JSON-LD syntax; @context @container value must be one of the following: @list, @set, @index, or @language.","jsonld.SyntaxError",{code:"invalid container mapping",context:localCtx});if(mapping.reverse&&"@index"!==container&&"@set"!==container&&null!==container)throw new JsonLdError("Invalid JSON-LD syntax; @context @container value for a @reverse type definition must be @index or @set.","jsonld.SyntaxError",{code:"invalid reverse property",context:localCtx});mapping["@container"]=container}if("@language"in value&&!("@type"in value)){var language=value["@language"];if(null!==language&&!_isString(language))throw new JsonLdError("Invalid JSON-LD syntax; @context @language value must be a string or null.","jsonld.SyntaxError",{code:"invalid language mapping",context:localCtx});null!==language&&(language=language.toLowerCase()),mapping["@language"]=language}var id=mapping["@id"];if("@context"===id||"@preserve"===id)throw new JsonLdError("Invalid JSON-LD syntax; @context and @preserve cannot be aliased.","jsonld.SyntaxError",{code:"invalid keyword alias",context:localCtx})}function _expandIri(activeCtx,value,relativeTo,localCtx,defined){if(null===value||_isKeyword(value))return value;if(localCtx&&value in localCtx&&defined[value]!==!0&&_createTermDefinition(activeCtx,localCtx,value,defined),relativeTo=relativeTo||{},relativeTo.vocab){var mapping=activeCtx.mappings[value];if(null===mapping)return null;if(mapping)return mapping["@id"]}var colon=value.indexOf(":");if(-1!==colon){var prefix=value.substr(0,colon),suffix=value.substr(colon+1);if("_"===prefix||0===suffix.indexOf("//"))return value;localCtx&&prefix in localCtx&&_createTermDefinition(activeCtx,localCtx,prefix,defined);var mapping=activeCtx.mappings[prefix];return mapping?mapping["@id"]+suffix:value}if(relativeTo.vocab&&"@vocab"in activeCtx)return activeCtx["@vocab"]+value;var rval=value;return relativeTo.base&&(rval=_prependBase(activeCtx["@base"],rval)),rval}function _prependBase(base,iri){if(null===base)return iri;if(-1!==iri.indexOf(":"))return iri;_isString(base)&&(base=jsonld.url.parse(base||""));var rel=jsonld.url.parse(iri),transform={protocol:base.protocol||""};if(null!==rel.authority)transform.authority=rel.authority,transform.path=rel.path,transform.query=rel.query;else if(transform.authority=base.authority,""===rel.path)transform.path=base.path,transform.query=null!==rel.query?rel.query:base.query;else{if(0===rel.path.indexOf("/"))transform.path=rel.path;else{var path=base.path;""!==rel.path&&(path=path.substr(0,path.lastIndexOf("/")+1),path.length>0&&"/"!==path.substr(-1)&&(path+="/"),path+=rel.path),transform.path=path}transform.query=rel.query}transform.path=_removeDotSegments(transform.path,!!transform.authority);var rval=transform.protocol;return null!==transform.authority&&(rval+="//"+transform.authority),rval+=transform.path,null!==transform.query&&(rval+="?"+transform.query),null!==rel.fragment&&(rval+="#"+rel.fragment),""===rval&&(rval="./"),rval}function _removeBase(base,iri){if(null===base)return iri;_isString(base)&&(base=jsonld.url.parse(base||""));var root="";if(""!==base.href?root+=(base.protocol||"")+"//"+(base.authority||""):iri.indexOf("//")&&(root+="//"),0!==iri.indexOf(root))return iri;for(var rel=jsonld.url.parse(iri.substr(root.length)),baseSegments=base.normalizedPath.split("/"),iriSegments=rel.normalizedPath.split("/"),last=rel.fragment||rel.query?0:1;baseSegments.length>0&&iriSegments.length>last&&baseSegments[0]===iriSegments[0];)baseSegments.shift(),iriSegments.shift();var rval="";if(baseSegments.length>0){baseSegments.pop();for(var i=0;i<baseSegments.length;++i)rval+="../"}return rval+=iriSegments.join("/"),null!==rel.query&&(rval+="?"+rel.query),null!==rel.fragment&&(rval+="#"+rel.fragment),""===rval&&(rval="./"),rval}function _getInitialContext(options){function _createInverseContext(){var activeCtx=this;if(activeCtx.inverse)return activeCtx.inverse;for(var inverse=activeCtx.inverse={},defaultLanguage=activeCtx["@language"]||"@none",mappings=activeCtx.mappings,terms=Object.keys(mappings).sort(_compareShortestLeast),i=0;i<terms.length;++i){var term=terms[i],mapping=mappings[term];if(null!==mapping){var container=mapping["@container"]||"@none",ids=mapping["@id"];_isArray(ids)||(ids=[ids]);for(var ii=0;ii<ids.length;++ii){var iri=ids[ii],entry=inverse[iri];if(entry||(inverse[iri]=entry={}),entry[container]||(entry[container]={"@language":{},"@type":{}}),entry=entry[container],mapping.reverse)_addPreferredTerm(mapping,term,entry["@type"],"@reverse");else if("@type"in mapping)_addPreferredTerm(mapping,term,entry["@type"],mapping["@type"]);else if("@language"in mapping){var language=mapping["@language"]||"@null";_addPreferredTerm(mapping,term,entry["@language"],language)}else _addPreferredTerm(mapping,term,entry["@language"],defaultLanguage),_addPreferredTerm(mapping,term,entry["@type"],"@none"),_addPreferredTerm(mapping,term,entry["@language"],"@none")}}}return inverse}function _addPreferredTerm(mapping,term,entry,typeOrLanguageValue){typeOrLanguageValue in entry||(entry[typeOrLanguageValue]=term)}function _cloneActiveContext(){var child={};return child["@base"]=this["@base"],child.mappings=_clone(this.mappings),child.clone=this.clone,child.inverse=null,child.getInverse=this.getInverse,"@language"in this&&(child["@language"]=this["@language"]),"@vocab"in this&&(child["@vocab"]=this["@vocab"]),child}var base=jsonld.url.parse(options.base||"");return{"@base":base,mappings:{},inverse:null,getInverse:_createInverseContext,clone:_cloneActiveContext}}function _isKeyword(v){if(!_isString(v))return!1;switch(v){case"@base":case"@context":case"@container":case"@default":case"@embed":case"@explicit":case"@graph":case"@id":case"@index":case"@language":case"@list":case"@omitDefault":case"@preserve":case"@requireAll":case"@reverse":case"@set":case"@type":case"@value":case"@vocab":return!0}return!1}function _isObject(v){return"[object Object]"===Object.prototype.toString.call(v)}function _isEmptyObject(v){return _isObject(v)&&0===Object.keys(v).length}function _isArray(v){return Array.isArray(v)}function _validateTypeValue(v){if(!_isString(v)&&!_isEmptyObject(v)){var isValid=!1;if(_isArray(v)){isValid=!0;for(var i=0;i<v.length;++i)if(!_isString(v[i])){isValid=!1;break}}if(!isValid)throw new JsonLdError('Invalid JSON-LD syntax; "@type" value must a string, an array of strings, or an empty object.',"jsonld.SyntaxError",{code:"invalid type value",value:v})}}function _isString(v){return"string"==typeof v||"[object String]"===Object.prototype.toString.call(v)}function _isNumber(v){return"number"==typeof v||"[object Number]"===Object.prototype.toString.call(v)}function _isDouble(v){return _isNumber(v)&&-1!==String(v).indexOf(".")}function _isNumeric(v){return!isNaN(parseFloat(v))&&isFinite(v)}function _isBoolean(v){return"boolean"==typeof v||"[object Boolean]"===Object.prototype.toString.call(v)}function _isUndefined(v){return"undefined"==typeof v}function _isSubject(v){var rval=!1;if(_isObject(v)&&!("@value"in v||"@set"in v||"@list"in v)){var keyCount=Object.keys(v).length;rval=keyCount>1||!("@id"in v)}return rval}function _isSubjectReference(v){return _isObject(v)&&1===Object.keys(v).length&&"@id"in v}function _isValue(v){return _isObject(v)&&"@value"in v}function _isList(v){return _isObject(v)&&"@list"in v}function _isBlankNode(v){var rval=!1;return _isObject(v)&&(rval="@id"in v?0===v["@id"].indexOf("_:"):0===Object.keys(v).length||!("@value"in v||"@set"in v||"@list"in v)),rval}function _isAbsoluteIri(v){return _isString(v)&&-1!==v.indexOf(":")}function _clone(value){if(value&&"object"==typeof value){var rval;if(_isArray(value)){rval=[];for(var i=0;i<value.length;++i)rval[i]=_clone(value[i])}else if(_isObject(value)){rval={};for(var key in value)rval[key]=_clone(value[key])}else rval=value.toString();return rval}return value}function _findContextUrls(input,urls,replace,base){var count=Object.keys(urls).length;if(_isArray(input)){for(var i=0;i<input.length;++i)_findContextUrls(input[i],urls,replace,base);return count<Object.keys(urls).length}if(_isObject(input)){for(var key in input)if("@context"===key){var ctx=input[key];if(_isArray(ctx))for(var length=ctx.length,i=0;length>i;++i){var _ctx=ctx[i];_isString(_ctx)&&(_ctx=_prependBase(base,_ctx),replace?(_ctx=urls[_ctx],_isArray(_ctx)?(Array.prototype.splice.apply(ctx,[i,1].concat(_ctx)),i+=_ctx.length-1,length=ctx.length):ctx[i]=_ctx):_ctx in urls||(urls[_ctx]=!1))}else _isString(ctx)&&(ctx=_prependBase(base,ctx),replace?input[key]=urls[ctx]:ctx in urls||(urls[ctx]=!1))}else _findContextUrls(input[key],urls,replace,base);return count<Object.keys(urls).length}return!1}function _retrieveContextUrls(input,options,callback){var error=null,documentLoader=options.documentLoader,retrieve=function(input,cycles,documentLoader,base,callback){if(Object.keys(cycles).length>MAX_CONTEXT_URLS)return error=new JsonLdError("Maximum number of @context URLs exceeded.","jsonld.ContextUrlError",{code:"loading remote context failed",max:MAX_CONTEXT_URLS}),callback(error);var urls={},finished=function(){_findContextUrls(input,urls,!0,base),callback(null,input)};_findContextUrls(input,urls,!1,base)||finished();var queue=[];for(var url in urls)urls[url]===!1&&queue.push(url);for(var count=queue.length,i=0;i<queue.length;++i)!function(url){if(url in cycles)return error=new JsonLdError("Cyclical @context URLs detected.","jsonld.ContextUrlError",{code:"recursive context inclusion",url:url}),callback(error);var _cycles=_clone(cycles);_cycles[url]=!0;var done=function(err,remoteDoc){if(!error){var ctx=remoteDoc?remoteDoc.document:null;if(!err&&_isString(ctx))try{ctx=JSON.parse(ctx)}catch(ex){err=ex}if(err?err=new JsonLdError("Dereferencing a URL did not result in a valid JSON-LD object. Possible causes are an inaccessible URL perhaps due to a same-origin policy (ensure the server uses CORS if you are using client-side JavaScript), too many redirects, a non-JSON response, or more than one HTTP Link Header was provided for a remote context.","jsonld.InvalidUrl",{code:"loading remote context failed",url:url,cause:err}):_isObject(ctx)||(err=new JsonLdError("Dereferencing a URL did not result in a JSON object. The response was valid JSON, but it was not a JSON object.","jsonld.InvalidUrl",{code:"invalid remote context",url:url,cause:err})),err)return error=err,callback(error);ctx="@context"in ctx?{"@context":ctx["@context"]}:{"@context":{}},remoteDoc.contextUrl&&(_isArray(ctx["@context"])||(ctx["@context"]=[ctx["@context"]]),ctx["@context"].push(remoteDoc.contextUrl)),retrieve(ctx,_cycles,documentLoader,url,function(err,ctx){return err?callback(err):(urls[url]=ctx["@context"],count-=1,void(0===count&&finished()))})}},promise=documentLoader(url,done);promise&&"then"in promise&&promise.then(done.bind(null,null),done)}(queue[i])};retrieve(input,{},documentLoader,options.base,callback)}function _parseNQuads(input){for(var iri="(?:<([^:]+:[^>]*)>)",bnode="(_:(?:[A-Za-z0-9]+))",plain='"([^"\\\\]*(?:\\\\.[^"\\\\]*)*)"',datatype="(?:\\^\\^"+iri+")",language="(?:@([a-z]+(?:-[a-z0-9]+)*))",literal="(?:"+plain+"(?:"+datatype+"|"+language+")?)",ws="[ \\t]+",wso="[ \\t]*",eoln=/(?:\r\n)|(?:\n)|(?:\r)/g,empty=new RegExp("^"+wso+"$"),subject="(?:"+iri+"|"+bnode+")"+ws,property=iri+ws,object="(?:"+iri+"|"+bnode+"|"+literal+")"+wso,graphName="(?:\\.|(?:(?:"+iri+"|"+bnode+")"+wso+"\\.))",quad=new RegExp("^"+wso+subject+property+object+graphName+wso+"$"),dataset={},lines=input.split(eoln),lineNumber=0,li=0;li<lines.length;++li){var line=lines[li];if(lineNumber++,!empty.test(line)){var match=line.match(quad);if(null===match)throw new JsonLdError("Error while parsing N-Quads; invalid quad.","jsonld.ParseError",{line:lineNumber});var triple={};if(triple.subject=_isUndefined(match[1])?{type:"blank node",value:match[2]}:{type:"IRI",value:match[1]},triple.predicate={type:"IRI",value:match[3]},_isUndefined(match[4]))if(_isUndefined(match[5])){triple.object={type:"literal"},_isUndefined(match[7])?_isUndefined(match[8])?triple.object.datatype=XSD_STRING:(triple.object.datatype=RDF_LANGSTRING,triple.object.language=match[8]):triple.object.datatype=match[7];var unescaped=match[6].replace(/\\"/g,'"').replace(/\\t/g,"	").replace(/\\n/g,"\n").replace(/\\r/g,"\r").replace(/\\\\/g,"\\");triple.object.value=unescaped}else triple.object={type:"blank node",value:match[5]};else triple.object={type:"IRI",value:match[4]};var name="@default";if(_isUndefined(match[9])?_isUndefined(match[10])||(name=match[10]):name=match[9],name in dataset){for(var unique=!0,triples=dataset[name],ti=0;unique&&ti<triples.length;++ti)_compareRDFTriples(triples[ti],triple)&&(unique=!1);unique&&triples.push(triple)}else dataset[name]=[triple]}}return dataset}function _toNQuads(dataset){var quads=[];for(var graphName in dataset)for(var triples=dataset[graphName],ti=0;ti<triples.length;++ti){var triple=triples[ti];"@default"===graphName&&(graphName=null),quads.push(_toNQuad(triple,graphName))}return quads.sort(),quads.join("")}function _toNQuad(triple,graphName,bnode){var s=triple.subject,p=triple.predicate,o=triple.object,g=graphName,quad="";if(quad+="IRI"===s.type?"<"+s.value+">":bnode?s.value===bnode?"_:a":"_:z":s.value,quad+=" ",quad+="IRI"===p.type?"<"+p.value+">":bnode?"_:p":p.value,quad+=" ","IRI"===o.type)quad+="<"+o.value+">";else if("blank node"===o.type)quad+=bnode?o.value===bnode?"_:a":"_:z":o.value;else{var escaped=o.value.replace(/\\/g,"\\\\").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\"/g,'\\"');quad+='"'+escaped+'"',o.datatype===RDF_LANGSTRING?o.language&&(quad+="@"+o.language):o.datatype!==XSD_STRING&&(quad+="^^<"+o.datatype+">")}return null!==g&&(quad+=0!==g.indexOf("_:")?" <"+g+">":bnode?" _:g":" "+g),quad+=" .\n"}function _parseRdfaApiData(data){var dataset={};dataset["@default"]=[];for(var subjects=data.getSubjects(),si=0;si<subjects.length;++si){var subject=subjects[si];if(null!==subject){var triples=data.getSubjectTriples(subject);if(null!==triples){var predicates=triples.predicates;for(var predicate in predicates)for(var objects=predicates[predicate].objects,oi=0;oi<objects.length;++oi){var object=objects[oi],triple={};triple.subject=0===subject.indexOf("_:")?{type:"blank node",value:subject}:{type:"IRI",value:subject},triple.predicate=0===predicate.indexOf("_:")?{type:"blank node",value:predicate}:{type:"IRI",value:predicate};var value=object.value;if(object.type===RDF_XML_LITERAL){XMLSerializer||_defineXMLSerializer();var serializer=new XMLSerializer;value="";for(var x=0;x<object.value.length;x++)object.value[x].nodeType===Node.ELEMENT_NODE?value+=serializer.serializeToString(object.value[x]):object.value[x].nodeType===Node.TEXT_NODE&&(value+=object.value[x].nodeValue)}triple.object={},object.type===RDF_OBJECT?triple.object.type=0===object.value.indexOf("_:")?"blank node":"IRI":(triple.object.type="literal",object.type===RDF_PLAIN_LITERAL?object.language?(triple.object.datatype=RDF_LANGSTRING,triple.object.language=object.language):triple.object.datatype=XSD_STRING:triple.object.datatype=object.type),triple.object.value=value,dataset["@default"].push(triple)}}}}return dataset}function UniqueNamer(prefix){this.prefix=prefix,this.counter=0,this.existing={}}function _removeDotSegments(path,hasAuthority){var rval="";0===path.indexOf("/")&&(rval="/");for(var input=path.split("/"),output=[];input.length>0;)"."===input[0]||""===input[0]&&input.length>1?input.shift():".."!==input[0]?output.push(input.shift()):(input.shift(),hasAuthority||output.length>0&&".."!==output[output.length-1]?output.pop():output.push(".."));return rval+output.join("/")}jsonld.compact=function(input,ctx,options,callback){function cleanup(err,compacted,activeCtx,options){if(err)return callback(err);options.compactArrays&&!options.graph&&_isArray(compacted)?1===compacted.length?compacted=compacted[0]:0===compacted.length&&(compacted={}):options.graph&&_isObject(compacted)&&(compacted=[compacted]),_isObject(ctx)&&"@context"in ctx&&(ctx=ctx["@context"]),ctx=_clone(ctx),_isArray(ctx)||(ctx=[ctx]);var tmp=ctx;ctx=[];for(var i=0;i<tmp.length;++i)(!_isObject(tmp[i])||Object.keys(tmp[i]).length>0)&&ctx.push(tmp[i]);var hasContext=ctx.length>0;if(1===ctx.length&&(ctx=ctx[0]),_isArray(compacted)){var kwgraph=_compactIri(activeCtx,"@graph"),graph=compacted;compacted={},hasContext&&(compacted["@context"]=ctx),compacted[kwgraph]=graph}else if(_isObject(compacted)&&hasContext){var graph=compacted;compacted={"@context":ctx};for(var key in graph)compacted[key]=graph[key]}callback(null,compacted,activeCtx)}if(arguments.length<2)return jsonld.nextTick(function(){callback(new TypeError("Could not compact, too few arguments."))});if("function"==typeof options&&(callback=options,options={}),options=options||{},null===ctx)return jsonld.nextTick(function(){callback(new JsonLdError("The compaction context must not be null.","jsonld.CompactError",{code:"invalid local context"}))});if(null===input)return jsonld.nextTick(function(){callback(null,null)});"base"in options||(options.base="string"==typeof input?input:""),"compactArrays"in options||(options.compactArrays=!0),"graph"in options||(options.graph=!1),"skipExpansion"in options||(options.skipExpansion=!1),"documentLoader"in options||(options.documentLoader=jsonld.loadDocument),"link"in options||(options.link=!1),options.link&&(options.skipExpansion=!0);var expand=function(input,options,callback){jsonld.nextTick(function(){return options.skipExpansion?callback(null,input):void jsonld.expand(input,options,callback)})};expand(input,options,function(err,expanded){if(err)return callback(new JsonLdError("Could not expand input before compaction.","jsonld.CompactError",{cause:err}));var activeCtx=_getInitialContext(options);jsonld.processContext(activeCtx,ctx,options,function(err,activeCtx){if(err)return callback(new JsonLdError("Could not process context before compaction.","jsonld.CompactError",{cause:err}));var compacted;try{compacted=(new Processor).compact(activeCtx,null,expanded,options)}catch(ex){return callback(ex)}cleanup(null,compacted,activeCtx,options)})})},jsonld.expand=function(input,options,callback){function expand(remoteDoc){"base"in options||(options.base=remoteDoc.documentUrl||"");var input={document:_clone(remoteDoc.document),remoteContext:{"@context":remoteDoc.contextUrl}};if("expandContext"in options){var expandContext=_clone(options.expandContext);input.expandContext="object"==typeof expandContext&&"@context"in expandContext?expandContext:{"@context":expandContext}}_retrieveContextUrls(input,options,function(err,input){if(err)return callback(err);var expanded;try{var processor=new Processor,activeCtx=_getInitialContext(options),document=input.document,remoteContext=input.remoteContext["@context"];input.expandContext&&(activeCtx=processor.processContext(activeCtx,input.expandContext["@context"],options)),remoteContext&&(activeCtx=processor.processContext(activeCtx,remoteContext,options)),expanded=processor.expand(activeCtx,null,document,options,!1),_isObject(expanded)&&"@graph"in expanded&&1===Object.keys(expanded).length?expanded=expanded["@graph"]:null===expanded&&(expanded=[]),_isArray(expanded)||(expanded=[expanded])}catch(ex){return callback(ex)}callback(null,expanded)})}return arguments.length<1?jsonld.nextTick(function(){callback(new TypeError("Could not expand, too few arguments."))}):("function"==typeof options&&(callback=options,options={}),options=options||{},"documentLoader"in options||(options.documentLoader=jsonld.loadDocument),"keepFreeFloatingNodes"in options||(options.keepFreeFloatingNodes=!1),void jsonld.nextTick(function(){if("string"==typeof input){var done=function(err,remoteDoc){if(err)return callback(err);try{if(!remoteDoc.document)throw new JsonLdError("No remote document found at the given URL.","jsonld.NullRemoteDocument");"string"==typeof remoteDoc.document&&(remoteDoc.document=JSON.parse(remoteDoc.document))}catch(ex){return callback(new JsonLdError("Could not retrieve a JSON-LD document from the URL. URL dereferencing not implemented.","jsonld.LoadDocumentError",{code:"loading document failed",cause:ex,remoteDoc:remoteDoc}))}expand(remoteDoc)},promise=options.documentLoader(input,done);return void(promise&&"then"in promise&&promise.then(done.bind(null,null),done))}expand({contextUrl:null,documentUrl:null,document:input})}))},jsonld.flatten=function(input,ctx,options,callback){return arguments.length<1?jsonld.nextTick(function(){callback(new TypeError("Could not flatten, too few arguments."))}):("function"==typeof options?(callback=options,options={}):"function"==typeof ctx&&(callback=ctx,ctx=null,options={}),options=options||{},"base"in options||(options.base="string"==typeof input?input:""),"documentLoader"in options||(options.documentLoader=jsonld.loadDocument),void jsonld.expand(input,options,function(err,_input){if(err)return callback(new JsonLdError("Could not expand input before flattening.","jsonld.FlattenError",{cause:err}));var flattened;try{flattened=(new Processor).flatten(_input)}catch(ex){return callback(ex)}return null===ctx?callback(null,flattened):(options.graph=!0,options.skipExpansion=!0,void jsonld.compact(flattened,ctx,options,function(err,compacted){return err?callback(new JsonLdError("Could not compact flattened output.","jsonld.FlattenError",{cause:err})):void callback(null,compacted)
}))}))},jsonld.frame=function(input,frame,options,callback){function doFrame(remoteFrame){var ctx,frame=remoteFrame.document;frame?(ctx=frame["@context"],remoteFrame.contextUrl?(ctx?_isArray(ctx)?ctx.push(remoteFrame.contextUrl):ctx=[ctx,remoteFrame.contextUrl]:ctx=remoteFrame.contextUrl,frame["@context"]=ctx):ctx=ctx||{}):ctx={},jsonld.expand(input,options,function(err,expanded){if(err)return callback(new JsonLdError("Could not expand input before framing.","jsonld.FrameError",{cause:err}));var opts=_clone(options);opts.isFrame=!0,opts.keepFreeFloatingNodes=!0,jsonld.expand(frame,opts,function(err,expandedFrame){if(err)return callback(new JsonLdError("Could not expand frame before framing.","jsonld.FrameError",{cause:err}));var framed;try{framed=(new Processor).frame(expanded,expandedFrame,opts)}catch(ex){return callback(ex)}opts.graph=!0,opts.skipExpansion=!0,opts.link={},jsonld.compact(framed,ctx,opts,function(err,compacted,ctx){if(err)return callback(new JsonLdError("Could not compact framed output.","jsonld.FrameError",{cause:err}));var graph=_compactIri(ctx,"@graph");opts.link={},compacted[graph]=_removePreserve(ctx,compacted[graph],opts),callback(null,compacted)})})})}return arguments.length<2?jsonld.nextTick(function(){callback(new TypeError("Could not frame, too few arguments."))}):("function"==typeof options&&(callback=options,options={}),options=options||{},"base"in options||(options.base="string"==typeof input?input:""),"documentLoader"in options||(options.documentLoader=jsonld.loadDocument),"embed"in options||(options.embed="@last"),options.explicit=options.explicit||!1,"requireAll"in options||(options.requireAll=!0),options.omitDefault=options.omitDefault||!1,void jsonld.nextTick(function(){if("string"==typeof frame){var done=function(err,remoteDoc){if(err)return callback(err);try{if(!remoteDoc.document)throw new JsonLdError("No remote document found at the given URL.","jsonld.NullRemoteDocument");"string"==typeof remoteDoc.document&&(remoteDoc.document=JSON.parse(remoteDoc.document))}catch(ex){return callback(new JsonLdError("Could not retrieve a JSON-LD document from the URL. URL dereferencing not implemented.","jsonld.LoadDocumentError",{code:"loading document failed",cause:ex,remoteDoc:remoteDoc}))}doFrame(remoteDoc)},promise=options.documentLoader(frame,done);return void(promise&&"then"in promise&&promise.then(done.bind(null,null),done))}doFrame({contextUrl:null,documentUrl:null,document:frame})}))},jsonld.link=function(input,ctx,options,callback){var frame={};ctx&&(frame["@context"]=ctx),frame["@embed"]="@link",jsonld.frame(input,frame,options,callback)},jsonld.objectify=function(input,ctx,options,callback){"function"==typeof options&&(callback=options,options={}),options=options||{},"base"in options||(options.base="string"==typeof input?input:""),"documentLoader"in options||(options.documentLoader=jsonld.loadDocument),jsonld.expand(input,options,function(err,_input){if(err)return callback(new JsonLdError("Could not expand input before linking.","jsonld.LinkError",{cause:err}));var flattened;try{flattened=(new Processor).flatten(_input)}catch(ex){return callback(ex)}options.graph=!0,options.skipExpansion=!0,jsonld.compact(flattened,ctx,options,function(err,compacted,ctx){if(err)return callback(new JsonLdError("Could not compact flattened output before linking.","jsonld.LinkError",{cause:err}));var graph=_compactIri(ctx,"@graph"),top=compacted[graph][0],recurse=function(subject){if(_isObject(subject)||_isArray(subject)){if(_isObject(subject)){if(recurse.visited[subject["@id"]])return;recurse.visited[subject["@id"]]=!0}for(var k in subject){var obj=subject[k],isid="@id"===jsonld.getContextValue(ctx,k,"@type");if(_isArray(obj)||_isObject(obj)||isid)if(_isString(obj)&&isid)subject[k]=obj=top[obj],recurse(obj);else if(_isArray(obj))for(var i=0;i<obj.length;++i)_isString(obj[i])&&isid?obj[i]=top[obj[i]]:_isObject(obj[i])&&"@id"in obj[i]&&(obj[i]=top[obj[i]["@id"]]),recurse(obj[i]);else if(_isObject(obj)){var sid=obj["@id"];subject[k]=obj=top[sid],recurse(obj)}}}};recurse.visited={},recurse(top),compacted.of_type={};for(var s in top)if("@type"in top[s]){var types=top[s]["@type"];_isArray(types)||(types=[types]);for(var t in types)types[t]in compacted.of_type||(compacted.of_type[types[t]]=[]),compacted.of_type[types[t]].push(top[s])}callback(null,compacted)})})},jsonld.normalize=function(input,options,callback){if(arguments.length<1)return jsonld.nextTick(function(){callback(new TypeError("Could not normalize, too few arguments."))});"function"==typeof options&&(callback=options,options={}),options=options||{},"base"in options||(options.base="string"==typeof input?input:""),"documentLoader"in options||(options.documentLoader=jsonld.loadDocument);var opts=_clone(options);delete opts.format,opts.produceGeneralizedRdf=!1,jsonld.toRDF(input,opts,function(err,dataset){return err?callback(new JsonLdError("Could not convert input to RDF dataset before normalization.","jsonld.NormalizeError",{cause:err})):void(new Processor).normalize(dataset,options,callback)})},jsonld.fromRDF=function(dataset,options,callback){return arguments.length<1?jsonld.nextTick(function(){callback(new TypeError("Could not convert from RDF, too few arguments."))}):("function"==typeof options&&(callback=options,options={}),options=options||{},"useRdfType"in options||(options.useRdfType=!1),"useNativeTypes"in options||(options.useNativeTypes=!1),"format"in options||!_isString(dataset)||"format"in options||(options.format="application/nquads"),void jsonld.nextTick(function(){function fromRDF(dataset,options,callback){(new Processor).fromRDF(dataset,options,callback)}var rdfParser;if(options.format){if(rdfParser=options.rdfParser||_rdfParsers[options.format],!rdfParser)return callback(new JsonLdError("Unknown input format.","jsonld.UnknownFormat",{format:options.format}))}else rdfParser=function(){return dataset};var callbackCalled=!1;try{dataset=rdfParser(dataset,function(err,dataset){return callbackCalled=!0,err?callback(err):void fromRDF(dataset,options,callback)})}catch(e){if(!callbackCalled)return callback(e);throw e}if(dataset){if("then"in dataset)return dataset.then(function(dataset){fromRDF(dataset,options,callback)},callback);fromRDF(dataset,options,callback)}}))},jsonld.toRDF=function(input,options,callback){return arguments.length<1?jsonld.nextTick(function(){callback(new TypeError("Could not convert to RDF, too few arguments."))}):("function"==typeof options&&(callback=options,options={}),options=options||{},"base"in options||(options.base="string"==typeof input?input:""),"documentLoader"in options||(options.documentLoader=jsonld.loadDocument),void jsonld.expand(input,options,function(err,expanded){if(err)return callback(new JsonLdError("Could not expand input before serialization to RDF.","jsonld.RdfError",{cause:err}));var dataset;try{if(dataset=Processor.prototype.toRDF(expanded,options),options.format){if("application/nquads"===options.format)return callback(null,_toNQuads(dataset));throw new JsonLdError("Unknown output format.","jsonld.UnknownFormat",{format:options.format})}}catch(ex){return callback(ex)}callback(null,dataset)}))},jsonld.createNodeMap=function(input,options,callback){return arguments.length<1?jsonld.nextTick(function(){callback(new TypeError("Could not create node map, too few arguments."))}):("function"==typeof options&&(callback=options,options={}),options=options||{},"base"in options||(options.base="string"==typeof input?input:""),"documentLoader"in options||(options.documentLoader=jsonld.loadDocument),void jsonld.expand(input,options,function(err,_input){if(err)return callback(new JsonLdError("Could not expand input before creating node map.","jsonld.CreateNodeMapError",{cause:err}));var nodeMap;try{nodeMap=(new Processor).createNodeMap(_input,options)}catch(ex){return callback(ex)}callback(null,nodeMap)}))},jsonld.merge=function(docs,ctx,options,callback){function expandComplete(err,_input){if(!error){if(err)return error=err,callback(new JsonLdError("Could not expand input before flattening.","jsonld.FlattenError",{cause:err}));expanded.push(_input),0===--count&&merge(expanded)}}function merge(expanded){var mergeNodes=!0;"mergeNodes"in options&&(mergeNodes=options.mergeNodes);var defaultGraph,namer=options.namer||new UniqueNamer("_:b"),graphs={"@default":{}};try{for(var i=0;i<expanded.length;++i){var doc=expanded[i];doc=jsonld.relabelBlankNodes(doc,{namer:new UniqueNamer("_:b"+i+"-")});var _graphs=mergeNodes||0===i?graphs:{"@default":{}};if(_createNodeMap(doc,_graphs,"@default",namer),_graphs!==graphs)for(var graphName in _graphs){var _nodeMap=_graphs[graphName];if(graphName in graphs){var nodeMap=graphs[graphName];for(var key in _nodeMap)key in nodeMap||(nodeMap[key]=_nodeMap[key])}else graphs[graphName]=_nodeMap}}defaultGraph=_mergeNodeMaps(graphs)}catch(ex){return callback(ex)}for(var flattened=[],keys=Object.keys(defaultGraph).sort(),ki=0;ki<keys.length;++ki){var node=defaultGraph[keys[ki]];_isSubjectReference(node)||flattened.push(node)}return null===ctx?callback(null,flattened):(options.graph=!0,options.skipExpansion=!0,void jsonld.compact(flattened,ctx,options,function(err,compacted){return err?callback(new JsonLdError("Could not compact merged output.","jsonld.MergeError",{cause:err})):void callback(null,compacted)}))}if(arguments.length<1)return jsonld.nextTick(function(){callback(new TypeError("Could not merge, too few arguments."))});if(!_isArray(docs))return jsonld.nextTick(function(){callback(new TypeError('Could not merge, "docs" must be an array.'))});"function"==typeof options?(callback=options,options={}):"function"==typeof ctx&&(callback=ctx,ctx=null,options={}),options=options||{};for(var expanded=[],error=null,count=docs.length,i=0;i<docs.length;++i){var opts={};for(var key in options)opts[key]=options[key];jsonld.expand(docs[i],opts,expandComplete)}},jsonld.relabelBlankNodes=function(input,options){options=options||{};var namer=options.namer||new UniqueNamer("_:b");return _labelBlankNodes(namer,input)},jsonld.documentLoader=function(url,callback){var err=new JsonLdError("Could not retrieve a JSON-LD document from the URL. URL dereferencing not implemented.","jsonld.LoadDocumentError",{code:"loading document failed"});return _nodejs?callback(err,{contextUrl:null,documentUrl:url,document:null}):jsonld.promisify(function(callback){callback(err)})},jsonld.loadDocument=function(url,callback){var promise=jsonld.documentLoader(url,callback);promise&&"then"in promise&&promise.then(callback.bind(null,null),callback)},jsonld.promises=function(options){options=options||{};var slice=Array.prototype.slice,promisify=jsonld.promisify,api=options.api||{},version=options.version||"jsonld.js";"string"==typeof options.api&&(options.version||(version=options.api),api={}),api.expand=function(){if(arguments.length<1)throw new TypeError("Could not expand, too few arguments.");return promisify.apply(null,[jsonld.expand].concat(slice.call(arguments)))},api.compact=function(){if(arguments.length<2)throw new TypeError("Could not compact, too few arguments.");var compact=function(input,ctx,options,callback){jsonld.compact(input,ctx,options,function(err,compacted){callback(err,compacted)})};return promisify.apply(null,[compact].concat(slice.call(arguments)))},api.flatten=function(){if(arguments.length<1)throw new TypeError("Could not flatten, too few arguments.");return promisify.apply(null,[jsonld.flatten].concat(slice.call(arguments)))},api.frame=function(){if(arguments.length<2)throw new TypeError("Could not frame, too few arguments.");return promisify.apply(null,[jsonld.frame].concat(slice.call(arguments)))},api.fromRDF=function(){if(arguments.length<1)throw new TypeError("Could not convert from RDF, too few arguments.");return promisify.apply(null,[jsonld.fromRDF].concat(slice.call(arguments)))},api.toRDF=function(){if(arguments.length<1)throw new TypeError("Could not convert to RDF, too few arguments.");return promisify.apply(null,[jsonld.toRDF].concat(slice.call(arguments)))},api.normalize=function(){if(arguments.length<1)throw new TypeError("Could not normalize, too few arguments.");return promisify.apply(null,[jsonld.normalize].concat(slice.call(arguments)))},"jsonld.js"===version&&(api.link=function(){if(arguments.length<2)throw new TypeError("Could not link, too few arguments.");return promisify.apply(null,[jsonld.link].concat(slice.call(arguments)))},api.objectify=function(){return promisify.apply(null,[jsonld.objectify].concat(slice.call(arguments)))},api.createNodeMap=function(){return promisify.apply(null,[jsonld.createNodeMap].concat(slice.call(arguments)))},api.merge=function(){return promisify.apply(null,[jsonld.merge].concat(slice.call(arguments)))});try{jsonld.Promise=global.Promise||require("es6-promise").Promise}catch(e){var f=function(){throw new Error("Unable to find a Promise implementation.")};for(var method in api)api[method]=f}return api},jsonld.promisify=function(op){if(!jsonld.Promise)try{jsonld.Promise=global.Promise||require("es6-promise").Promise}catch(e){throw new Error("Unable to find a Promise implementation.")}var args=Array.prototype.slice.call(arguments,1);return new jsonld.Promise(function(resolve,reject){op.apply(null,args.concat(function(err,value){err?reject(err):resolve(value)}))})},jsonld.promises({api:jsonld.promises}),JsonLdProcessor.prototype=jsonld.promises({version:"json-ld-1.0"}),JsonLdProcessor.prototype.toString=function(){return this instanceof JsonLdProcessor?"[object JsonLdProcessor]":"[object JsonLdProcessorPrototype]"},jsonld.JsonLdProcessor=JsonLdProcessor;var canDefineProperty=!!Object.defineProperty;if(canDefineProperty)try{Object.defineProperty({},"x",{})}catch(e){canDefineProperty=!1}canDefineProperty&&(Object.defineProperty(JsonLdProcessor,"prototype",{writable:!1,enumerable:!1}),Object.defineProperty(JsonLdProcessor.prototype,"constructor",{writable:!0,enumerable:!1,configurable:!0,value:JsonLdProcessor})),_browser&&"undefined"==typeof global.JsonLdProcessor&&(canDefineProperty?Object.defineProperty(global,"JsonLdProcessor",{writable:!0,enumerable:!1,configurable:!0,value:JsonLdProcessor}):global.JsonLdProcessor=JsonLdProcessor),"undefined"!=typeof process&&process.nextTick?(jsonld.nextTick=process.nextTick,jsonld.setImmediate="function"==typeof setImmediate?setImmediate:jsonld.nextTick):"function"==typeof setImmediate?jsonld.setImmediate=jsonld.nextTick=function(callback){return setImmediate(callback)}:(jsonld.setImmediate=function(callback){setTimeout(callback,0)},jsonld.nextTick=jsonld.setImmediate),jsonld.parseLinkHeader=function(header){for(var rval={},entries=header.match(/(?:<[^>]*?>|"[^"]*?"|[^,])+/g),rLinkHeader=/\s*<([^>]*?)>\s*(?:;\s*(.*))?/,i=0;i<entries.length;++i){var match=entries[i].match(rLinkHeader);if(match){for(var result={target:match[1]},params=match[2],rParams=/(.*?)=(?:(?:"([^"]*?)")|([^"]*?))\s*(?:(?:;\s*)|$)/g;match=rParams.exec(params);)result[match[1]]=void 0===match[2]?match[3]:match[2];var rel=result.rel||"";_isArray(rval[rel])?rval[rel].push(result):rval[rel]=rel in rval?[rval[rel],result]:result}}return rval},jsonld.DocumentCache=function(size){this.order=[],this.cache={},this.size=size||50,this.expires=3e4},jsonld.DocumentCache.prototype.get=function(url){if(url in this.cache){var entry=this.cache[url];if(entry.expires>=+new Date)return entry.ctx;delete this.cache[url],this.order.splice(this.order.indexOf(url),1)}return null},jsonld.DocumentCache.prototype.set=function(url,ctx){this.order.length===this.size&&delete this.cache[this.order.shift()],this.order.push(url),this.cache[url]={ctx:ctx,expires:+new Date+this.expires}},jsonld.ActiveContextCache=function(size){this.order=[],this.cache={},this.size=size||100},jsonld.ActiveContextCache.prototype.get=function(activeCtx,localCtx){var key1=JSON.stringify(activeCtx),key2=JSON.stringify(localCtx),level1=this.cache[key1];return level1&&key2 in level1?level1[key2]:null},jsonld.ActiveContextCache.prototype.set=function(activeCtx,localCtx,result){if(this.order.length===this.size){var entry=this.order.shift();delete this.cache[entry.activeCtx][entry.localCtx]}var key1=JSON.stringify(activeCtx),key2=JSON.stringify(localCtx);this.order.push({activeCtx:key1,localCtx:key2}),key1 in this.cache||(this.cache[key1]={}),this.cache[key1][key2]=_clone(result)},jsonld.cache={activeCtx:new jsonld.ActiveContextCache},jsonld.documentLoaders={},jsonld.documentLoaders.jquery=function($,options){options=options||{};var loader=function(url,callback){return 0!==url.indexOf("http:")&&0!==url.indexOf("https:")?callback(new JsonLdError('URL could not be dereferenced; only "http" and "https" URLs are supported.',"jsonld.InvalidUrl",{code:"loading document failed",url:url}),{contextUrl:null,documentUrl:url,document:null}):options.secure&&0!==url.indexOf("https")?callback(new JsonLdError('URL could not be dereferenced; secure mode is enabled and the URL\'s scheme is not "https".',"jsonld.InvalidUrl",{code:"loading document failed",url:url}),{contextUrl:null,documentUrl:url,document:null}):void $.ajax({url:url,accepts:{json:"application/ld+json, application/json"},headers:{Accept:"application/ld+json, application/json"},dataType:"json",crossDomain:!0,success:function(data,textStatus,jqXHR){var doc={contextUrl:null,documentUrl:url,document:data},contentType=jqXHR.getResponseHeader("Content-Type"),linkHeader=jqXHR.getResponseHeader("Link");if(linkHeader&&"application/ld+json"!==contentType){if(linkHeader=jsonld.parseLinkHeader(linkHeader)[LINK_HEADER_REL],_isArray(linkHeader))return callback(new JsonLdError("URL could not be dereferenced, it has more than one associated HTTP Link Header.","jsonld.InvalidUrl",{code:"multiple context link headers",url:url}),doc);linkHeader&&(doc.contextUrl=linkHeader.target)}callback(null,doc)},error:function(jqXHR,textStatus,err){callback(new JsonLdError("URL could not be dereferenced, an error occurred.","jsonld.LoadDocumentError",{code:"loading document failed",url:url,cause:err}),{contextUrl:null,documentUrl:url,document:null})}})},usePromise="undefined"!=typeof Promise;return"usePromise"in options&&(usePromise=options.usePromise),usePromise?function(url){return jsonld.promisify(loader,url)}:loader},jsonld.documentLoaders.node=function(options){function loadDocument(url,redirects,callback){function handleResponse(err,res,body){if(doc={contextUrl:null,documentUrl:url,document:body||null},err)return callback(new JsonLdError("URL could not be dereferenced, an error occurred.","jsonld.LoadDocumentError",{code:"loading document failed",url:url,cause:err}),doc);var statusText=http.STATUS_CODES[res.statusCode];if(res.statusCode>=400)return callback(new JsonLdError("URL could not be dereferenced: "+statusText,"jsonld.InvalidUrl",{code:"loading document failed",url:url,httpStatusCode:res.statusCode}),doc);if(res.headers.link&&"application/ld+json"!==res.headers["content-type"]){var linkHeader=jsonld.parseLinkHeader(res.headers.link)[LINK_HEADER_REL];if(_isArray(linkHeader))return callback(new JsonLdError("URL could not be dereferenced, it has more than one associated HTTP Link Header.","jsonld.InvalidUrl",{code:"multiple context link headers",url:url}),doc);linkHeader&&(doc.contextUrl=linkHeader.target)}if(res.statusCode>=300&&res.statusCode<400&&res.headers.location)return redirects.length===maxRedirects?callback(new JsonLdError("URL could not be dereferenced; there were too many redirects.","jsonld.TooManyRedirects",{code:"loading document failed",url:url,httpStatusCode:res.statusCode,redirects:redirects}),doc):-1!==redirects.indexOf(url)?callback(new JsonLdError("URL could not be dereferenced; infinite redirection was detected.","jsonld.InfiniteRedirectDetected",{code:"recursive context inclusion",url:url,httpStatusCode:res.statusCode,redirects:redirects}),doc):(redirects.push(url),loadDocument(res.headers.location,redirects,callback));redirects.push(url);for(var i=0;i<redirects.length;++i)cache.set(redirects[i],{contextUrl:null,documentUrl:redirects[i],document:body});callback(err,doc)}if(0!==url.indexOf("http:")&&0!==url.indexOf("https:"))return callback(new JsonLdError('URL could not be dereferenced; only "http" and "https" URLs are supported.',"jsonld.InvalidUrl",{code:"loading document failed",url:url}),{contextUrl:null,documentUrl:url,document:null});if(options.secure&&0!==url.indexOf("https"))return callback(new JsonLdError('URL could not be dereferenced; secure mode is enabled and the URL\'s scheme is not "https".',"jsonld.InvalidUrl",{code:"loading document failed",url:url}),{contextUrl:null,documentUrl:url,document:null});var doc=cache.get(url);return null!==doc?callback(null,doc):void request({url:url,headers:{Accept:"application/ld+json, application/json"},strictSSL:strictSSL,followRedirect:!1},handleResponse)}options=options||{};var strictSSL="strictSSL"in options?options.strictSSL:!0,maxRedirects="maxRedirects"in options?options.maxRedirects:-1,request=require("request"),http=require("http"),cache=new jsonld.DocumentCache,loader=function(url,callback){loadDocument(url,[],callback)};return options.usePromise?function(url){return jsonld.promisify(loader,url)}:loader},jsonld.documentLoaders.xhr=function(options){var rlink=/(^|(\r\n))link:/i;options=options||{};var loader=function(url,callback){if(0!==url.indexOf("http:")&&0!==url.indexOf("https:"))return callback(new JsonLdError('URL could not be dereferenced; only "http" and "https" URLs are supported.',"jsonld.InvalidUrl",{code:"loading document failed",url:url}),{contextUrl:null,documentUrl:url,document:null});if(options.secure&&0!==url.indexOf("https"))return callback(new JsonLdError('URL could not be dereferenced; secure mode is enabled and the URL\'s scheme is not "https".',"jsonld.InvalidUrl",{code:"loading document failed",url:url}),{contextUrl:null,documentUrl:url,document:null});var xhr=options.xhr||XMLHttpRequest,req=new xhr;req.onload=function(){if(req.status>=400)return callback(new JsonLdError("URL could not be dereferenced: "+req.statusText,"jsonld.LoadDocumentError",{code:"loading document failed",url:url,httpStatusCode:req.status}),{contextUrl:null,documentUrl:url,document:null});var linkHeader,doc={contextUrl:null,documentUrl:url,document:req.response},contentType=req.getResponseHeader("Content-Type");if(rlink.test(req.getAllResponseHeaders())&&(linkHeader=req.getResponseHeader("Link")),linkHeader&&"application/ld+json"!==contentType){if(linkHeader=jsonld.parseLinkHeader(linkHeader)[LINK_HEADER_REL],_isArray(linkHeader))return callback(new JsonLdError("URL could not be dereferenced, it has more than one associated HTTP Link Header.","jsonld.InvalidUrl",{code:"multiple context link headers",url:url}),doc);linkHeader&&(doc.contextUrl=linkHeader.target)}callback(null,doc)},req.onerror=function(){callback(new JsonLdError("URL could not be dereferenced, an error occurred.","jsonld.LoadDocumentError",{code:"loading document failed",url:url}),{contextUrl:null,documentUrl:url,document:null})},req.open("GET",url,!0),req.setRequestHeader("Accept","application/ld+json, application/json"),req.send()},usePromise="undefined"!=typeof Promise;return"usePromise"in options&&(usePromise=options.usePromise),usePromise?function(url){return jsonld.promisify(loader,url)}:loader},jsonld.useDocumentLoader=function(type){if(!(type in jsonld.documentLoaders))throw new JsonLdError('Unknown document loader type: "'+type+'"',"jsonld.UnknownDocumentLoader",{type:type});jsonld.documentLoader=jsonld.documentLoaders[type].apply(jsonld,Array.prototype.slice.call(arguments,1))},jsonld.processContext=function(activeCtx,localCtx){var options={},callbackArg=2;arguments.length>3&&(options=arguments[2]||{},callbackArg+=1);var callback=arguments[callbackArg];return"base"in options||(options.base=""),"documentLoader"in options||(options.documentLoader=jsonld.loadDocument),null===localCtx?callback(null,_getInitialContext(options)):(localCtx=_clone(localCtx),_isObject(localCtx)&&"@context"in localCtx||(localCtx={"@context":localCtx}),void _retrieveContextUrls(localCtx,options,function(err,ctx){if(err)return callback(err);try{ctx=(new Processor).processContext(activeCtx,ctx,options)}catch(ex){return callback(ex)}callback(null,ctx)}))},jsonld.hasProperty=function(subject,property){var rval=!1;if(property in subject){var value=subject[property];rval=!_isArray(value)||value.length>0}return rval},jsonld.hasValue=function(subject,property,value){var rval=!1;if(jsonld.hasProperty(subject,property)){var val=subject[property],isList=_isList(val);if(_isArray(val)||isList){isList&&(val=val["@list"]);for(var i=0;i<val.length;++i)if(jsonld.compareValues(value,val[i])){rval=!0;break}}else _isArray(value)||(rval=jsonld.compareValues(value,val))}return rval},jsonld.addValue=function(subject,property,value,options){if(options=options||{},"propertyIsArray"in options||(options.propertyIsArray=!1),"allowDuplicate"in options||(options.allowDuplicate=!0),_isArray(value)){0!==value.length||!options.propertyIsArray||property in subject||(subject[property]=[]);for(var i=0;i<value.length;++i)jsonld.addValue(subject,property,value[i],options)}else if(property in subject){var hasValue=!options.allowDuplicate&&jsonld.hasValue(subject,property,value);_isArray(subject[property])||hasValue&&!options.propertyIsArray||(subject[property]=[subject[property]]),hasValue||subject[property].push(value)}else subject[property]=options.propertyIsArray?[value]:value},jsonld.getValues=function(subject,property){var rval=subject[property]||[];return _isArray(rval)||(rval=[rval]),rval},jsonld.removeProperty=function(subject,property){delete subject[property]},jsonld.removeValue=function(subject,property,value,options){options=options||{},"propertyIsArray"in options||(options.propertyIsArray=!1);var values=jsonld.getValues(subject,property).filter(function(e){return!jsonld.compareValues(e,value)});0===values.length?jsonld.removeProperty(subject,property):subject[property]=1!==values.length||options.propertyIsArray?values:values[0]},jsonld.compareValues=function(v1,v2){return v1===v2?!0:_isValue(v1)&&_isValue(v2)&&v1["@value"]===v2["@value"]&&v1["@type"]===v2["@type"]&&v1["@language"]===v2["@language"]&&v1["@index"]===v2["@index"]?!0:_isObject(v1)&&"@id"in v1&&_isObject(v2)&&"@id"in v2?v1["@id"]===v2["@id"]:!1},jsonld.getContextValue=function(ctx,key,type){var rval=null;if(null===key)return rval;if("@language"===type&&type in ctx&&(rval=ctx[type]),ctx.mappings[key]){var entry=ctx.mappings[key];_isUndefined(type)?rval=entry:type in entry&&(rval=entry[type])}return rval};var _rdfParsers={};if(jsonld.registerRDFParser=function(contentType,parser){_rdfParsers[contentType]=parser},jsonld.unregisterRDFParser=function(contentType){delete _rdfParsers[contentType]},_nodejs){if("undefined"==typeof XMLSerializer)var XMLSerializer=null;if("undefined"==typeof Node)var Node={ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12}}var XSD_BOOLEAN="http://www.w3.org/2001/XMLSchema#boolean",XSD_DOUBLE="http://www.w3.org/2001/XMLSchema#double",XSD_INTEGER="http://www.w3.org/2001/XMLSchema#integer",XSD_STRING="http://www.w3.org/2001/XMLSchema#string",RDF="http://www.w3.org/1999/02/22-rdf-syntax-ns#",RDF_LIST=RDF+"List",RDF_FIRST=RDF+"first",RDF_REST=RDF+"rest",RDF_NIL=RDF+"nil",RDF_TYPE=RDF+"type",RDF_PLAIN_LITERAL=RDF+"PlainLiteral",RDF_XML_LITERAL=RDF+"XMLLiteral",RDF_OBJECT=RDF+"object",RDF_LANGSTRING=RDF+"langString",LINK_HEADER_REL="http://www.w3.org/ns/json-ld#context",MAX_CONTEXT_URLS=10,JsonLdError=function(msg,type,details){_nodejs?(Error.call(this),Error.captureStackTrace(this,this.constructor)):"undefined"!=typeof Error&&(this.stack=(new Error).stack),this.name=type||"jsonld.Error",this.message=msg||"An unspecified JSON-LD error occurred.",this.details=details||{}};_nodejs?require("util").inherits(JsonLdError,Error):"undefined"!=typeof Error&&(JsonLdError.prototype=new Error);var Processor=function(){};Processor.prototype.compact=function(activeCtx,activeProperty,element,options){if(_isArray(element)){for(var rval=[],i=0;i<element.length;++i){var compacted=this.compact(activeCtx,activeProperty,element[i],options);null!==compacted&&rval.push(compacted)}if(options.compactArrays&&1===rval.length){var container=jsonld.getContextValue(activeCtx,activeProperty,"@container");null===container&&(rval=rval[0])}return rval}if(_isObject(element)){if(options.link&&"@id"in element&&element["@id"]in options.link)for(var linked=options.link[element["@id"]],i=0;i<linked.length;++i)if(linked[i].expanded===element)return linked[i].compacted;if(_isValue(element)||_isSubjectReference(element)){var rval=_compactValue(activeCtx,activeProperty,element);return options.link&&_isSubjectReference(element)&&(element["@id"]in options.link||(options.link[element["@id"]]=[]),options.link[element["@id"]].push({expanded:element,compacted:rval})),rval}var insideReverse="@reverse"===activeProperty,rval={};options.link&&"@id"in element&&(element["@id"]in options.link||(options.link[element["@id"]]=[]),options.link[element["@id"]].push({expanded:element,compacted:rval}));for(var keys=Object.keys(element).sort(),ki=0;ki<keys.length;++ki){var expandedProperty=keys[ki],expandedValue=element[expandedProperty];if("@id"!==expandedProperty&&"@type"!==expandedProperty)if("@reverse"!==expandedProperty)if("@index"!==expandedProperty)if("@graph"!==expandedProperty&&"@list"!==expandedProperty&&_isKeyword(expandedProperty)){var alias=_compactIri(activeCtx,expandedProperty);jsonld.addValue(rval,alias,expandedValue)}else{if(0===expandedValue.length){var itemActiveProperty=_compactIri(activeCtx,expandedProperty,expandedValue,{vocab:!0},insideReverse);jsonld.addValue(rval,itemActiveProperty,expandedValue,{propertyIsArray:!0})}for(var vi=0;vi<expandedValue.length;++vi){var expandedItem=expandedValue[vi],itemActiveProperty=_compactIri(activeCtx,expandedProperty,expandedItem,{vocab:!0},insideReverse),container=jsonld.getContextValue(activeCtx,itemActiveProperty,"@container"),isList=_isList(expandedItem),list=null;isList&&(list=expandedItem["@list"]);var compactedItem=this.compact(activeCtx,itemActiveProperty,isList?list:expandedItem,options);if(isList)if(_isArray(compactedItem)||(compactedItem=[compactedItem]),"@list"!==container){var wrapper={};wrapper[_compactIri(activeCtx,"@list")]=compactedItem,compactedItem=wrapper,"@index"in expandedItem&&(compactedItem[_compactIri(activeCtx,"@index")]=expandedItem["@index"])}else if(itemActiveProperty in rval)throw new JsonLdError('JSON-LD compact error; property has a "@list" @container rule but there is more than a single @list that matches the compacted term in the document. Compaction might mix unwanted items into the list.',"jsonld.SyntaxError",{code:"compaction to list of lists"});if("@language"===container||"@index"===container){var mapObject;itemActiveProperty in rval?mapObject=rval[itemActiveProperty]:rval[itemActiveProperty]=mapObject={},"@language"===container&&_isValue(compactedItem)&&(compactedItem=compactedItem["@value"]),jsonld.addValue(mapObject,expandedItem[container],compactedItem)}else{var isArray=!options.compactArrays||"@set"===container||"@list"===container||_isArray(compactedItem)&&0===compactedItem.length||"@list"===expandedProperty||"@graph"===expandedProperty;jsonld.addValue(rval,itemActiveProperty,compactedItem,{propertyIsArray:isArray})}}}else{var container=jsonld.getContextValue(activeCtx,activeProperty,"@container");if("@index"===container)continue;var alias=_compactIri(activeCtx,expandedProperty);jsonld.addValue(rval,alias,expandedValue)}else{var compactedValue=this.compact(activeCtx,"@reverse",expandedValue,options);for(var compactedProperty in compactedValue)if(activeCtx.mappings[compactedProperty]&&activeCtx.mappings[compactedProperty].reverse){var value=compactedValue[compactedProperty],container=jsonld.getContextValue(activeCtx,compactedProperty,"@container"),useArray="@set"===container||!options.compactArrays;
jsonld.addValue(rval,compactedProperty,value,{propertyIsArray:useArray}),delete compactedValue[compactedProperty]}if(Object.keys(compactedValue).length>0){var alias=_compactIri(activeCtx,expandedProperty);jsonld.addValue(rval,alias,compactedValue)}}else{var compactedValue;if(_isString(expandedValue))compactedValue=_compactIri(activeCtx,expandedValue,null,{vocab:"@type"===expandedProperty});else{compactedValue=[];for(var vi=0;vi<expandedValue.length;++vi)compactedValue.push(_compactIri(activeCtx,expandedValue[vi],null,{vocab:!0}))}var alias=_compactIri(activeCtx,expandedProperty),isArray=_isArray(compactedValue)&&0===expandedValue.length;jsonld.addValue(rval,alias,compactedValue,{propertyIsArray:isArray})}}return rval}return element},Processor.prototype.expand=function(activeCtx,activeProperty,element,options,insideList){var self=this;if(null===element||void 0===element)return null;if(!_isArray(element)&&!_isObject(element))return insideList||null!==activeProperty&&"@graph"!==_expandIri(activeCtx,activeProperty,{vocab:!0})?_expandValue(activeCtx,activeProperty,element):null;if(_isArray(element)){var rval=[],container=jsonld.getContextValue(activeCtx,activeProperty,"@container");insideList=insideList||"@list"===container;for(var i=0;i<element.length;++i){var e=self.expand(activeCtx,activeProperty,element[i],options);if(insideList&&(_isArray(e)||_isList(e)))throw new JsonLdError("Invalid JSON-LD syntax; lists of lists are not permitted.","jsonld.SyntaxError",{code:"list of lists"});null!==e&&(_isArray(e)?rval=rval.concat(e):rval.push(e))}return rval}"@context"in element&&(activeCtx=self.processContext(activeCtx,element["@context"],options));for(var expandedActiveProperty=_expandIri(activeCtx,activeProperty,{vocab:!0}),rval={},keys=Object.keys(element).sort(),ki=0;ki<keys.length;++ki){var expandedValue,key=keys[ki],value=element[key];if("@context"!==key){var expandedProperty=_expandIri(activeCtx,key,{vocab:!0});if(null!==expandedProperty&&(_isAbsoluteIri(expandedProperty)||_isKeyword(expandedProperty))){if(_isKeyword(expandedProperty)){if("@reverse"===expandedActiveProperty)throw new JsonLdError("Invalid JSON-LD syntax; a keyword cannot be used as a @reverse property.","jsonld.SyntaxError",{code:"invalid reverse property map",value:value});if(expandedProperty in rval)throw new JsonLdError("Invalid JSON-LD syntax; colliding keywords detected.","jsonld.SyntaxError",{code:"colliding keywords",keyword:expandedProperty})}if("@id"===expandedProperty&&!_isString(value)){if(!options.isFrame)throw new JsonLdError('Invalid JSON-LD syntax; "@id" value must a string.',"jsonld.SyntaxError",{code:"invalid @id value",value:value});if(!_isObject(value))throw new JsonLdError('Invalid JSON-LD syntax; "@id" value must be a string or an object.',"jsonld.SyntaxError",{code:"invalid @id value",value:value})}if("@type"===expandedProperty&&_validateTypeValue(value),"@graph"===expandedProperty&&!_isObject(value)&&!_isArray(value))throw new JsonLdError('Invalid JSON-LD syntax; "@graph" value must not be an object or an array.',"jsonld.SyntaxError",{code:"invalid @graph value",value:value});if("@value"===expandedProperty&&(_isObject(value)||_isArray(value)))throw new JsonLdError('Invalid JSON-LD syntax; "@value" value must not be an object or an array.',"jsonld.SyntaxError",{code:"invalid value object value",value:value});if("@language"===expandedProperty){if(null===value)continue;if(!_isString(value))throw new JsonLdError('Invalid JSON-LD syntax; "@language" value must be a string.',"jsonld.SyntaxError",{code:"invalid language-tagged string",value:value});value=value.toLowerCase()}if("@index"===expandedProperty&&!_isString(value))throw new JsonLdError('Invalid JSON-LD syntax; "@index" value must be a string.',"jsonld.SyntaxError",{code:"invalid @index value",value:value});if("@reverse"!==expandedProperty){var container=jsonld.getContextValue(activeCtx,key,"@container");if("@language"===container&&_isObject(value))expandedValue=_expandLanguageMap(value);else if("@index"===container&&_isObject(value))expandedValue=function(activeProperty){for(var rval=[],keys=Object.keys(value).sort(),ki=0;ki<keys.length;++ki){var key=keys[ki],val=value[key];_isArray(val)||(val=[val]),val=self.expand(activeCtx,activeProperty,val,options,!1);for(var vi=0;vi<val.length;++vi){var item=val[vi];"@index"in item||(item["@index"]=key),rval.push(item)}}return rval}(key);else{var isList="@list"===expandedProperty;if(isList||"@set"===expandedProperty){var nextActiveProperty=activeProperty;if(isList&&"@graph"===expandedActiveProperty&&(nextActiveProperty=null),expandedValue=self.expand(activeCtx,nextActiveProperty,value,options,isList),isList&&_isList(expandedValue))throw new JsonLdError("Invalid JSON-LD syntax; lists of lists are not permitted.","jsonld.SyntaxError",{code:"list of lists"})}else expandedValue=self.expand(activeCtx,key,value,options,!1)}if(null!==expandedValue||"@value"===expandedProperty)if("@list"===expandedProperty||_isList(expandedValue)||"@list"!==container||(expandedValue=_isArray(expandedValue)?expandedValue:[expandedValue],expandedValue={"@list":expandedValue}),activeCtx.mappings[key]&&activeCtx.mappings[key].reverse){var reverseMap=rval["@reverse"]=rval["@reverse"]||{};_isArray(expandedValue)||(expandedValue=[expandedValue]);for(var ii=0;ii<expandedValue.length;++ii){var item=expandedValue[ii];if(_isValue(item)||_isList(item))throw new JsonLdError('Invalid JSON-LD syntax; "@reverse" value must not be a @value or an @list.',"jsonld.SyntaxError",{code:"invalid reverse property value",value:expandedValue});jsonld.addValue(reverseMap,expandedProperty,item,{propertyIsArray:!0})}}else{var useArray=-1===["@index","@id","@type","@value","@language"].indexOf(expandedProperty);jsonld.addValue(rval,expandedProperty,expandedValue,{propertyIsArray:useArray})}}else{if(!_isObject(value))throw new JsonLdError('Invalid JSON-LD syntax; "@reverse" value must be an object.',"jsonld.SyntaxError",{code:"invalid @reverse value",value:value});if(expandedValue=self.expand(activeCtx,"@reverse",value,options),"@reverse"in expandedValue)for(var property in expandedValue["@reverse"])jsonld.addValue(rval,property,expandedValue["@reverse"][property],{propertyIsArray:!0});var reverseMap=rval["@reverse"]||null;for(var property in expandedValue)if("@reverse"!==property){null===reverseMap&&(reverseMap=rval["@reverse"]={}),jsonld.addValue(reverseMap,property,[],{propertyIsArray:!0});for(var items=expandedValue[property],ii=0;ii<items.length;++ii){var item=items[ii];if(_isValue(item)||_isList(item))throw new JsonLdError('Invalid JSON-LD syntax; "@reverse" value must not be a @value or an @list.',"jsonld.SyntaxError",{code:"invalid reverse property value",value:expandedValue});jsonld.addValue(reverseMap,property,item,{propertyIsArray:!0})}}}}}}keys=Object.keys(rval);var count=keys.length;if("@value"in rval){if("@type"in rval&&"@language"in rval)throw new JsonLdError('Invalid JSON-LD syntax; an element containing "@value" may not contain both "@type" and "@language".',"jsonld.SyntaxError",{code:"invalid value object",element:rval});var validCount=count-1;if("@type"in rval&&(validCount-=1),"@index"in rval&&(validCount-=1),"@language"in rval&&(validCount-=1),0!==validCount)throw new JsonLdError('Invalid JSON-LD syntax; an element containing "@value" may only have an "@index" property and at most one other property which can be "@type" or "@language".',"jsonld.SyntaxError",{code:"invalid value object",element:rval});if(null===rval["@value"])rval=null;else{if("@language"in rval&&!_isString(rval["@value"]))throw new JsonLdError("Invalid JSON-LD syntax; only strings may be language-tagged.","jsonld.SyntaxError",{code:"invalid language-tagged value",element:rval});if("@type"in rval&&(!_isAbsoluteIri(rval["@type"])||0===rval["@type"].indexOf("_:")))throw new JsonLdError('Invalid JSON-LD syntax; an element containing "@value" and "@type" must have an absolute IRI for the value of "@type".',"jsonld.SyntaxError",{code:"invalid typed value",element:rval})}}else if("@type"in rval&&!_isArray(rval["@type"]))rval["@type"]=[rval["@type"]];else if("@set"in rval||"@list"in rval){if(count>1&&!(2===count&&"@index"in rval))throw new JsonLdError('Invalid JSON-LD syntax; if an element has the property "@set" or "@list", then it can have at most one other property that is "@index".',"jsonld.SyntaxError",{code:"invalid set or list object",element:rval});"@set"in rval&&(rval=rval["@set"],keys=Object.keys(rval),count=keys.length)}else 1===count&&"@language"in rval&&(rval=null);return!_isObject(rval)||options.keepFreeFloatingNodes||insideList||null!==activeProperty&&"@graph"!==expandedActiveProperty||(0===count||"@value"in rval||"@list"in rval||1===count&&"@id"in rval)&&(rval=null),rval},Processor.prototype.createNodeMap=function(input,options){options=options||{};var namer=options.namer||new UniqueNamer("_:b"),graphs={"@default":{}};return _createNodeMap(input,graphs,"@default",namer),_mergeNodeMaps(graphs)},Processor.prototype.flatten=function(input){for(var defaultGraph=this.createNodeMap(input),flattened=[],keys=Object.keys(defaultGraph).sort(),ki=0;ki<keys.length;++ki){var node=defaultGraph[keys[ki]];_isSubjectReference(node)||flattened.push(node)}return flattened},Processor.prototype.frame=function(input,frame,options){var state={options:options,graphs:{"@default":{},"@merged":{}},subjectStack:[],link:{}},namer=new UniqueNamer("_:b");_createNodeMap(input,state.graphs,"@merged",namer),state.subjects=state.graphs["@merged"];var framed=[];return _frame(state,Object.keys(state.subjects).sort(),frame,framed,null),framed},Processor.prototype.normalize=function(dataset,options,callback){function hashBlankNodes(unnamed){function hashUnnamed(i){if(i===unnamed.length)return nameBlankNodes(unique,duplicates,nextUnnamed);var bnode=unnamed[i],hash=_hashQuads(bnode,bnodes);hash in duplicates?(duplicates[hash].push(bnode),nextUnnamed.push(bnode)):hash in unique?(duplicates[hash]=[unique[hash],bnode],nextUnnamed.push(unique[hash]),nextUnnamed.push(bnode),delete unique[hash]):unique[hash]=bnode,jsonld.setImmediate(function(){hashUnnamed(i+1)})}var nextUnnamed=[],duplicates={},unique={};jsonld.setImmediate(function(){hashUnnamed(0)})}function nameBlankNodes(unique,duplicates,unnamed){for(var named=!1,hashes=Object.keys(unique).sort(),i=0;i<hashes.length;++i){var bnode=unique[hashes[i]];namer.getName(bnode),named=!0}named?hashBlankNodes(unnamed):nameDuplicates(duplicates)}function nameDuplicates(duplicates){function processGroup(i){function nameGroupMember(group,n){if(n===group.length){results.sort(function(a,b){return a=a.hash,b=b.hash,b>a?-1:a>b?1:0});for(var r in results)for(var key in results[r].pathNamer.existing)namer.getName(key);return processGroup(i+1)}var bnode=group[n];if(namer.isNamed(bnode))return nameGroupMember(group,n+1);var pathNamer=new UniqueNamer("_:b");pathNamer.getName(bnode),_hashPaths(bnode,bnodes,namer,pathNamer,function(err,result){return err?callback(err):(results.push(result),void nameGroupMember(group,n+1))})}if(i===hashes.length)return createArray();var group=duplicates[hashes[i]],results=[];nameGroupMember(group,0)}var hashes=Object.keys(duplicates).sort();processGroup(0)}function createArray(){for(var normalized=[],i=0;i<quads.length;++i){for(var quad=quads[i],attrs=["subject","object","name"],ai=0;ai<attrs.length;++ai){var attr=attrs[ai];quad[attr]&&"blank node"===quad[attr].type&&0!==quad[attr].value.indexOf("_:c14n")&&(quad[attr].value=namer.getName(quad[attr].value))}normalized.push(_toNQuad(quad,quad.name?quad.name.value:null))}return normalized.sort(),options.format?"application/nquads"===options.format?callback(null,normalized.join("")):callback(new JsonLdError("Unknown output format.","jsonld.UnknownFormat",{format:options.format})):void callback(null,_parseNQuads(normalized.join("")))}var quads=[],bnodes={};for(var graphName in dataset){var triples=dataset[graphName];"@default"===graphName&&(graphName=null);for(var ti=0;ti<triples.length;++ti){var quad=triples[ti];null!==graphName&&(quad.name=0===graphName.indexOf("_:")?{type:"blank node",value:graphName}:{type:"IRI",value:graphName}),quads.push(quad);for(var attrs=["subject","object","name"],ai=0;ai<attrs.length;++ai){var attr=attrs[ai];if(quad[attr]&&"blank node"===quad[attr].type){var id=quad[attr].value;id in bnodes?bnodes[id].quads.push(quad):bnodes[id]={quads:[quad]}}}}}var namer=new UniqueNamer("_:c14n");return hashBlankNodes(Object.keys(bnodes))},Processor.prototype.fromRDF=function(dataset,options,callback){var defaultGraph={},graphMap={"@default":defaultGraph},referencedOnce={};for(var name in dataset){var graph=dataset[name];name in graphMap||(graphMap[name]={}),"@default"===name||name in defaultGraph||(defaultGraph[name]={"@id":name});for(var nodeMap=graphMap[name],ti=0;ti<graph.length;++ti){var triple=graph[ti],s=triple.subject.value,p=triple.predicate.value,o=triple.object;s in nodeMap||(nodeMap[s]={"@id":s});var node=nodeMap[s],objectIsId="IRI"===o.type||"blank node"===o.type;if(!objectIsId||o.value in nodeMap||(nodeMap[o.value]={"@id":o.value}),p!==RDF_TYPE||options.useRdfType||!objectIsId){var value=_RDFToObject(o,options.useNativeTypes);if(jsonld.addValue(node,p,value,{propertyIsArray:!0}),objectIsId)if(o.value===RDF_NIL){var object=nodeMap[o.value];"usages"in object||(object.usages=[]),object.usages.push({node:node,property:p,value:value})}else referencedOnce[o.value]=o.value in referencedOnce?!1:{node:node,property:p,value:value}}else jsonld.addValue(node,"@type",o.value,{propertyIsArray:!0})}}for(var name in graphMap){var graphObject=graphMap[name];if(RDF_NIL in graphObject){for(var nil=graphObject[RDF_NIL],i=0;i<nil.usages.length;++i){for(var usage=nil.usages[i],node=usage.node,property=usage.property,head=usage.value,list=[],listNodes=[],nodeKeyCount=Object.keys(node).length;property===RDF_REST&&_isObject(referencedOnce[node["@id"]])&&_isArray(node[RDF_FIRST])&&1===node[RDF_FIRST].length&&_isArray(node[RDF_REST])&&1===node[RDF_REST].length&&(3===nodeKeyCount||4===nodeKeyCount&&_isArray(node["@type"])&&1===node["@type"].length&&node["@type"][0]===RDF_LIST)&&(list.push(node[RDF_FIRST][0]),listNodes.push(node["@id"]),usage=referencedOnce[node["@id"]],node=usage.node,property=usage.property,head=usage.value,nodeKeyCount=Object.keys(node).length,0===node["@id"].indexOf("_:")););if(property===RDF_FIRST){if(node["@id"]===RDF_NIL)continue;head=graphObject[head["@id"]][RDF_REST][0],list.pop(),listNodes.pop()}delete head["@id"],head["@list"]=list.reverse();for(var j=0;j<listNodes.length;++j)delete graphObject[listNodes[j]]}delete nil.usages}}for(var result=[],subjects=Object.keys(defaultGraph).sort(),i=0;i<subjects.length;++i){var subject=subjects[i],node=defaultGraph[subject];if(subject in graphMap)for(var graph=node["@graph"]=[],graphObject=graphMap[subject],subjects_=Object.keys(graphObject).sort(),si=0;si<subjects_.length;++si){var node_=graphObject[subjects_[si]];_isSubjectReference(node_)||graph.push(node_)}_isSubjectReference(node)||result.push(node)}callback(null,result)},Processor.prototype.toRDF=function(input,options){var namer=new UniqueNamer("_:b"),nodeMap={"@default":{}};_createNodeMap(input,nodeMap,"@default",namer);for(var dataset={},graphNames=Object.keys(nodeMap).sort(),i=0;i<graphNames.length;++i){var graphName=graphNames[i];("@default"===graphName||_isAbsoluteIri(graphName))&&(dataset[graphName]=_graphToRDF(nodeMap[graphName],namer,options))}return dataset},Processor.prototype.processContext=function(activeCtx,localCtx,options){_isObject(localCtx)&&"@context"in localCtx&&_isArray(localCtx["@context"])&&(localCtx=localCtx["@context"]);var ctxs=_isArray(localCtx)?localCtx:[localCtx];if(0===ctxs.length)return activeCtx.clone();for(var rval=activeCtx,i=0;i<ctxs.length;++i){var ctx=ctxs[i];if(null!==ctx){if(_isObject(ctx)&&"@context"in ctx&&(ctx=ctx["@context"]),!_isObject(ctx))throw new JsonLdError("Invalid JSON-LD syntax; @context must be an object.","jsonld.SyntaxError",{code:"invalid local context",context:ctx});if(jsonld.cache.activeCtx){var cached=jsonld.cache.activeCtx.get(activeCtx,ctx);if(cached){rval=activeCtx=cached;continue}}activeCtx=rval,rval=rval.clone();var defined={};if("@base"in ctx){var base=ctx["@base"];if(null===base)base=null;else{if(!_isString(base))throw new JsonLdError('Invalid JSON-LD syntax; the value of "@base" in a @context must be a string or null.',"jsonld.SyntaxError",{code:"invalid base IRI",context:ctx});if(""!==base&&!_isAbsoluteIri(base))throw new JsonLdError('Invalid JSON-LD syntax; the value of "@base" in a @context must be an absolute IRI or the empty string.',"jsonld.SyntaxError",{code:"invalid base IRI",context:ctx})}null!==base&&(base=jsonld.url.parse(base||"")),rval["@base"]=base,defined["@base"]=!0}if("@vocab"in ctx){var value=ctx["@vocab"];if(null===value)delete rval["@vocab"];else{if(!_isString(value))throw new JsonLdError('Invalid JSON-LD syntax; the value of "@vocab" in a @context must be a string or null.',"jsonld.SyntaxError",{code:"invalid vocab mapping",context:ctx});if(!_isAbsoluteIri(value))throw new JsonLdError('Invalid JSON-LD syntax; the value of "@vocab" in a @context must be an absolute IRI.',"jsonld.SyntaxError",{code:"invalid vocab mapping",context:ctx});rval["@vocab"]=value}defined["@vocab"]=!0}if("@language"in ctx){var value=ctx["@language"];if(null===value)delete rval["@language"];else{if(!_isString(value))throw new JsonLdError('Invalid JSON-LD syntax; the value of "@language" in a @context must be a string or null.',"jsonld.SyntaxError",{code:"invalid default language",context:ctx});rval["@language"]=value.toLowerCase()}defined["@language"]=!0}for(var key in ctx)_createTermDefinition(rval,ctx,key,defined);jsonld.cache.activeCtx&&jsonld.cache.activeCtx.set(activeCtx,ctx,rval)}else rval=activeCtx=_getInitialContext(options)}return rval},Object.keys||(Object.keys=function(o){if(o!==Object(o))throw new TypeError("Object.keys called on non-object");var rval=[];for(var p in o)Object.prototype.hasOwnProperty.call(o,p)&&rval.push(p);return rval}),jsonld.registerRDFParser("application/nquads",_parseNQuads),jsonld.registerRDFParser("rdfa-api",_parseRdfaApiData),jsonld.UniqueNamer=UniqueNamer,UniqueNamer.prototype.clone=function(){var copy=new UniqueNamer(this.prefix);return copy.counter=this.counter,copy.existing=_clone(this.existing),copy},UniqueNamer.prototype.getName=function(oldName){if(oldName&&oldName in this.existing)return this.existing[oldName];var name=this.prefix+this.counter;return this.counter+=1,oldName&&(this.existing[oldName]=name),name},UniqueNamer.prototype.isNamed=function(oldName){return oldName in this.existing};var Permutator=function(list){this.list=list.sort(),this.done=!1,this.left={};for(var i=0;i<list.length;++i)this.left[list[i]]=!0};Permutator.prototype.hasNext=function(){return!this.done},Permutator.prototype.next=function(){for(var rval=this.list.slice(),k=null,pos=0,length=this.list.length,i=0;length>i;++i){var element=this.list[i],left=this.left[element];(null===k||element>k)&&(left&&i>0&&element>this.list[i-1]||!left&&length-1>i&&element>this.list[i+1])&&(k=element,pos=i)}if(null===k)this.done=!0;else{var swap=this.left[k]?pos-1:pos+1;this.list[pos]=this.list[swap],this.list[swap]=k;for(var i=0;length>i;++i)this.list[i]>k&&(this.left[this.list[i]]=!this.left[this.list[i]])}return rval};var sha1=jsonld.sha1={};if(_nodejs){var crypto=require("crypto");sha1.create=function(){var md=crypto.createHash("sha1");return{update:function(data){md.update(data,"utf8")},digest:function(){return md.digest("hex")}}}}else sha1.create=function(){return new sha1.MessageDigest};if(sha1.hash=function(nquads){for(var md=sha1.create(),i=0;i<nquads.length;++i)md.update(nquads[i]);return md.digest()},!_nodejs){sha1.Buffer=function(){this.data="",this.read=0},sha1.Buffer.prototype.putInt32=function(i){this.data+=String.fromCharCode(i>>24&255)+String.fromCharCode(i>>16&255)+String.fromCharCode(i>>8&255)+String.fromCharCode(255&i)},sha1.Buffer.prototype.getInt32=function(){var rval=this.data.charCodeAt(this.read)<<24^this.data.charCodeAt(this.read+1)<<16^this.data.charCodeAt(this.read+2)<<8^this.data.charCodeAt(this.read+3);return this.read+=4,rval},sha1.Buffer.prototype.bytes=function(){return this.data.slice(this.read)},sha1.Buffer.prototype.length=function(){return this.data.length-this.read},sha1.Buffer.prototype.compact=function(){this.data=this.data.slice(this.read),this.read=0},sha1.Buffer.prototype.toHex=function(){for(var rval="",i=this.read;i<this.data.length;++i){var b=this.data.charCodeAt(i);16>b&&(rval+="0"),rval+=b.toString(16)}return rval},sha1.MessageDigest=function(){_sha1.initialized||_sha1.init(),this.blockLength=64,this.digestLength=20,this.messageLength=0,this.input=new sha1.Buffer,this.words=new Array(80),this.state={h0:1732584193,h1:4023233417,h2:2562383102,h3:271733878,h4:3285377520}},sha1.MessageDigest.prototype.update=function(msg){msg=unescape(encodeURIComponent(msg)),this.messageLength+=msg.length,this.input.data+=msg,_sha1.update(this.state,this.words,this.input),(this.input.read>2048||0===this.input.length())&&this.input.compact()},sha1.MessageDigest.prototype.digest=function(){var len=this.messageLength,padBytes=new sha1.Buffer;padBytes.data+=this.input.bytes(),padBytes.data+=_sha1.padding.substr(0,64-(len+8)%64),padBytes.putInt32(len>>>29&255),padBytes.putInt32(len<<3&4294967295),_sha1.update(this.state,this.words,padBytes);var rval=new sha1.Buffer;return rval.putInt32(this.state.h0),rval.putInt32(this.state.h1),rval.putInt32(this.state.h2),rval.putInt32(this.state.h3),rval.putInt32(this.state.h4),rval.toHex()};var _sha1={padding:null,initialized:!1};_sha1.init=function(){_sha1.padding=String.fromCharCode(128);for(var c=String.fromCharCode(0),n=64;n>0;)1&n&&(_sha1.padding+=c),n>>>=1,n>0&&(c+=c);_sha1.initialized=!0},_sha1.update=function(s,w,input){for(var t,a,b,c,d,e,f,i,len=input.length();len>=64;){for(a=s.h0,b=s.h1,c=s.h2,d=s.h3,e=s.h4,i=0;16>i;++i)t=input.getInt32(),w[i]=t,f=d^b&(c^d),t=(a<<5|a>>>27)+f+e+1518500249+t,e=d,d=c,c=b<<30|b>>>2,b=a,a=t;for(;20>i;++i)t=w[i-3]^w[i-8]^w[i-14]^w[i-16],t=t<<1|t>>>31,w[i]=t,f=d^b&(c^d),t=(a<<5|a>>>27)+f+e+1518500249+t,e=d,d=c,c=b<<30|b>>>2,b=a,a=t;for(;32>i;++i)t=w[i-3]^w[i-8]^w[i-14]^w[i-16],t=t<<1|t>>>31,w[i]=t,f=b^c^d,t=(a<<5|a>>>27)+f+e+1859775393+t,e=d,d=c,c=b<<30|b>>>2,b=a,a=t;for(;40>i;++i)t=w[i-6]^w[i-16]^w[i-28]^w[i-32],t=t<<2|t>>>30,w[i]=t,f=b^c^d,t=(a<<5|a>>>27)+f+e+1859775393+t,e=d,d=c,c=b<<30|b>>>2,b=a,a=t;for(;60>i;++i)t=w[i-6]^w[i-16]^w[i-28]^w[i-32],t=t<<2|t>>>30,w[i]=t,f=b&c|d&(b^c),t=(a<<5|a>>>27)+f+e+2400959708+t,e=d,d=c,c=b<<30|b>>>2,b=a,a=t;for(;80>i;++i)t=w[i-6]^w[i-16]^w[i-28]^w[i-32],t=t<<2|t>>>30,w[i]=t,f=b^c^d,t=(a<<5|a>>>27)+f+e+3395469782+t,e=d,d=c,c=b<<30|b>>>2,b=a,a=t;s.h0+=a,s.h1+=b,s.h2+=c,s.h3+=d,s.h4+=e,len-=64}}}if(!XMLSerializer)var _defineXMLSerializer=function(){XMLSerializer=require("xmldom").XMLSerializer};if(jsonld.url={},jsonld.url.parsers={simple:{keys:["href","scheme","authority","path","query","fragment"],regex:/^(?:([^:\/?#]+):)?(?:\/\/([^\/?#]*))?([^?#]*)(?:\?([^#]*))?(?:#(.*))?/},full:{keys:["href","protocol","scheme","authority","auth","user","password","hostname","port","path","directory","file","query","fragment"],regex:/^(([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?(?:(((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/}},jsonld.url.parse=function(str,parser){for(var parsed={},o=jsonld.url.parsers[parser||"full"],m=o.regex.exec(str),i=o.keys.length;i--;)parsed[o.keys[i]]=void 0===m[i]?null:m[i];return parsed.normalizedPath=_removeDotSegments(parsed.path,!!parsed.authority),parsed},_nodejs?jsonld.useDocumentLoader("node"):"undefined"!=typeof XMLHttpRequest&&jsonld.useDocumentLoader("xhr"),_nodejs){jsonld.use=function(extension){switch(extension){case"request":jsonld.request=require("./request");break;default:throw new JsonLdError("Unknown extension.","jsonld.UnknownExtension",{extension:extension})}};var _module={exports:{},filename:__dirname};require("pkginfo")(_module,"version"),jsonld.version=_module.exports.version}return jsonld},factory=function(){return wrapper(function(){return factory()})};return!_nodejs&&"function"==typeof define&&define.amd?define([],function(){return wrapper(factory),factory}):(wrapper(factory),"function"==typeof require&&"undefined"!=typeof module&&module.exports&&(module.exports=factory),_browser&&("undefined"==typeof jsonld?jsonld=jsonldjs=factory:jsonldjs=factory)),factory}(),"undefined"==typeof Paho&&(Paho={}),Paho.MQTT=function(global){function decodeMessage(input,pos){var startingPos=pos,first=input[pos],type=first>>4,messageInfo=first&=15;pos+=1;var digit,remLength=0,multiplier=1;do{if(pos==input.length)return[null,startingPos];digit=input[pos++],remLength+=(127&digit)*multiplier,multiplier*=128}while(0!=(128&digit));var endPos=pos+remLength;if(endPos>input.length)return[null,startingPos];var wireMessage=new WireMessage(type);switch(type){case MESSAGE_TYPE.CONNACK:var connectAcknowledgeFlags=input[pos++];1&connectAcknowledgeFlags&&(wireMessage.sessionPresent=!0),wireMessage.returnCode=input[pos++];break;case MESSAGE_TYPE.PUBLISH:var qos=messageInfo>>1&3,len=readUint16(input,pos);pos+=2;var topicName=parseUTF8(input,pos,len);pos+=len,qos>0&&(wireMessage.messageIdentifier=readUint16(input,pos),pos+=2);var message=new Paho.MQTT.Message(input.subarray(pos,endPos));1==(1&messageInfo)&&(message.retained=!0),8==(8&messageInfo)&&(message.duplicate=!0),message.qos=qos,message.destinationName=topicName,wireMessage.payloadMessage=message;break;case MESSAGE_TYPE.PUBACK:case MESSAGE_TYPE.PUBREC:case MESSAGE_TYPE.PUBREL:case MESSAGE_TYPE.PUBCOMP:case MESSAGE_TYPE.UNSUBACK:wireMessage.messageIdentifier=readUint16(input,pos);break;case MESSAGE_TYPE.SUBACK:wireMessage.messageIdentifier=readUint16(input,pos),pos+=2,wireMessage.returnCode=input.subarray(pos,endPos)}return[wireMessage,endPos]}function writeUint16(input,buffer,offset){return buffer[offset++]=input>>8,buffer[offset++]=input%256,offset}function writeString(input,utf8Length,buffer,offset){return offset=writeUint16(utf8Length,buffer,offset),stringToUTF8(input,buffer,offset),offset+utf8Length}function readUint16(buffer,offset){return 256*buffer[offset]+buffer[offset+1]}function encodeMBI(number){var output=new Array(1),numBytes=0;do{var digit=number%128;number>>=7,number>0&&(digit|=128),output[numBytes++]=digit}while(number>0&&4>numBytes);return output}function UTF8Length(input){for(var output=0,i=0;i<input.length;i++){var charCode=input.charCodeAt(i);charCode>2047?(charCode>=55296&&56319>=charCode&&(i++,output++),output+=3):charCode>127?output+=2:output++}return output}function stringToUTF8(input,output,start){for(var pos=start,i=0;i<input.length;i++){var charCode=input.charCodeAt(i);if(charCode>=55296&&56319>=charCode){var lowCharCode=input.charCodeAt(++i);if(isNaN(lowCharCode))throw new Error(format(ERROR.MALFORMED_UNICODE,[charCode,lowCharCode]));charCode=(charCode-55296<<10)+(lowCharCode-56320)+65536}127>=charCode?output[pos++]=charCode:2047>=charCode?(output[pos++]=charCode>>6&31|192,output[pos++]=63&charCode|128):65535>=charCode?(output[pos++]=charCode>>12&15|224,output[pos++]=charCode>>6&63|128,output[pos++]=63&charCode|128):(output[pos++]=charCode>>18&7|240,output[pos++]=charCode>>12&63|128,output[pos++]=charCode>>6&63|128,output[pos++]=63&charCode|128)}return output}function parseUTF8(input,offset,length){for(var utf16,output="",pos=offset;offset+length>pos;){var byte1=input[pos++];if(128>byte1)utf16=byte1;else{var byte2=input[pos++]-128;if(0>byte2)throw new Error(format(ERROR.MALFORMED_UTF,[byte1.toString(16),byte2.toString(16),""]));if(224>byte1)utf16=64*(byte1-192)+byte2;else{var byte3=input[pos++]-128;if(0>byte3)throw new Error(format(ERROR.MALFORMED_UTF,[byte1.toString(16),byte2.toString(16),byte3.toString(16)]));if(240>byte1)utf16=4096*(byte1-224)+64*byte2+byte3;else{var byte4=input[pos++]-128;if(0>byte4)throw new Error(format(ERROR.MALFORMED_UTF,[byte1.toString(16),byte2.toString(16),byte3.toString(16),byte4.toString(16)]));if(!(248>byte1))throw new Error(format(ERROR.MALFORMED_UTF,[byte1.toString(16),byte2.toString(16),byte3.toString(16),byte4.toString(16)]));utf16=262144*(byte1-240)+4096*byte2+64*byte3+byte4}}}utf16>65535&&(utf16-=65536,output+=String.fromCharCode(55296+(utf16>>10)),utf16=56320+(1023&utf16)),output+=String.fromCharCode(utf16)}return output}var version="@VERSION@",MESSAGE_TYPE={CONNECT:1,CONNACK:2,PUBLISH:3,PUBACK:4,PUBREC:5,PUBREL:6,PUBCOMP:7,SUBSCRIBE:8,SUBACK:9,UNSUBSCRIBE:10,UNSUBACK:11,PINGREQ:12,PINGRESP:13,DISCONNECT:14},validate=function(obj,keys){for(var key in obj)if(obj.hasOwnProperty(key)){if(!keys.hasOwnProperty(key)){var errorStr="Unknown property, "+key+". Valid properties are:";for(var key in keys)keys.hasOwnProperty(key)&&(errorStr=errorStr+" "+key);throw new Error(errorStr)}if(typeof obj[key]!==keys[key])throw new Error(format(ERROR.INVALID_TYPE,[typeof obj[key],key]))}},scope=function(f,scope){return function(){return f.apply(scope,arguments)}},ERROR={OK:{code:0,text:"AMQJSC0000I OK."},CONNECT_TIMEOUT:{code:1,text:"AMQJSC0001E Connect timed out."},SUBSCRIBE_TIMEOUT:{code:2,text:"AMQJS0002E Subscribe timed out."},UNSUBSCRIBE_TIMEOUT:{code:3,text:"AMQJS0003E Unsubscribe timed out."},PING_TIMEOUT:{code:4,text:"AMQJS0004E Ping timed out."},INTERNAL_ERROR:{code:5,text:"AMQJS0005E Internal error. Error Message: {0}, Stack trace: {1}"},CONNACK_RETURNCODE:{code:6,text:"AMQJS0006E Bad Connack return code:{0} {1}."},SOCKET_ERROR:{code:7,text:"AMQJS0007E Socket error:{0}."},SOCKET_CLOSE:{code:8,text:"AMQJS0008I Socket closed."},MALFORMED_UTF:{code:9,text:"AMQJS0009E Malformed UTF data:{0} {1} {2}."},UNSUPPORTED:{code:10,text:"AMQJS0010E {0} is not supported by this browser."},INVALID_STATE:{code:11,text:"AMQJS0011E Invalid state {0}."},INVALID_TYPE:{code:12,text:"AMQJS0012E Invalid type {0} for {1}."},INVALID_ARGUMENT:{code:13,text:"AMQJS0013E Invalid argument {0} for {1}."},UNSUPPORTED_OPERATION:{code:14,text:"AMQJS0014E Unsupported operation."},INVALID_STORED_DATA:{code:15,text:"AMQJS0015E Invalid data in local storage key={0} value={1}."},INVALID_MQTT_MESSAGE_TYPE:{code:16,text:"AMQJS0016E Invalid MQTT message type {0}."},MALFORMED_UNICODE:{code:17,text:"AMQJS0017E Malformed Unicode string:{0} {1}."}},CONNACK_RC={0:"Connection Accepted",1:"Connection Refused: unacceptable protocol version",2:"Connection Refused: identifier rejected",3:"Connection Refused: server unavailable",4:"Connection Refused: bad user name or password",5:"Connection Refused: not authorized"},format=function(error,substitutions){var text=error.text;if(substitutions)for(var field,start,i=0;i<substitutions.length;i++)if(field="{"+i+"}",start=text.indexOf(field),start>0){var part1=text.substring(0,start),part2=text.substring(start+field.length);text=part1+substitutions[i]+part2}return text},MqttProtoIdentifierv3=[0,6,77,81,73,115,100,112,3],MqttProtoIdentifierv4=[0,4,77,81,84,84,4],WireMessage=function(type,options){this.type=type;for(var name in options)options.hasOwnProperty(name)&&(this[name]=options[name])};WireMessage.prototype.encode=function(){var first=(15&this.type)<<4,remLength=0,topicStrLength=new Array,destinationNameLength=0;switch(void 0!=this.messageIdentifier&&(remLength+=2),this.type){case MESSAGE_TYPE.CONNECT:switch(this.mqttVersion){case 3:remLength+=MqttProtoIdentifierv3.length+3;break;case 4:remLength+=MqttProtoIdentifierv4.length+3}if(remLength+=UTF8Length(this.clientId)+2,void 0!=this.willMessage){remLength+=UTF8Length(this.willMessage.destinationName)+2;var willMessagePayloadBytes=this.willMessage.payloadBytes;willMessagePayloadBytes instanceof Uint8Array||(willMessagePayloadBytes=new Uint8Array(payloadBytes)),remLength+=willMessagePayloadBytes.byteLength+2}void 0!=this.userName&&(remLength+=UTF8Length(this.userName)+2),void 0!=this.password&&(remLength+=UTF8Length(this.password)+2);break;case MESSAGE_TYPE.SUBSCRIBE:first|=2;for(var i=0;i<this.topics.length;i++)topicStrLength[i]=UTF8Length(this.topics[i]),remLength+=topicStrLength[i]+2;
remLength+=this.requestedQos.length;break;case MESSAGE_TYPE.UNSUBSCRIBE:first|=2;for(var i=0;i<this.topics.length;i++)topicStrLength[i]=UTF8Length(this.topics[i]),remLength+=topicStrLength[i]+2;break;case MESSAGE_TYPE.PUBREL:first|=2;break;case MESSAGE_TYPE.PUBLISH:this.payloadMessage.duplicate&&(first|=8),first=first|=this.payloadMessage.qos<<1,this.payloadMessage.retained&&(first|=1),destinationNameLength=UTF8Length(this.payloadMessage.destinationName),remLength+=destinationNameLength+2;var payloadBytes=this.payloadMessage.payloadBytes;remLength+=payloadBytes.byteLength,payloadBytes instanceof ArrayBuffer?payloadBytes=new Uint8Array(payloadBytes):payloadBytes instanceof Uint8Array||(payloadBytes=new Uint8Array(payloadBytes.buffer));break;case MESSAGE_TYPE.DISCONNECT:}var mbi=encodeMBI(remLength),pos=mbi.length+1,buffer=new ArrayBuffer(remLength+pos),byteStream=new Uint8Array(buffer);if(byteStream[0]=first,byteStream.set(mbi,1),this.type==MESSAGE_TYPE.PUBLISH)pos=writeString(this.payloadMessage.destinationName,destinationNameLength,byteStream,pos);else if(this.type==MESSAGE_TYPE.CONNECT){switch(this.mqttVersion){case 3:byteStream.set(MqttProtoIdentifierv3,pos),pos+=MqttProtoIdentifierv3.length;break;case 4:byteStream.set(MqttProtoIdentifierv4,pos),pos+=MqttProtoIdentifierv4.length}var connectFlags=0;this.cleanSession&&(connectFlags=2),void 0!=this.willMessage&&(connectFlags|=4,connectFlags|=this.willMessage.qos<<3,this.willMessage.retained&&(connectFlags|=32)),void 0!=this.userName&&(connectFlags|=128),void 0!=this.password&&(connectFlags|=64),byteStream[pos++]=connectFlags,pos=writeUint16(this.keepAliveInterval,byteStream,pos)}switch(void 0!=this.messageIdentifier&&(pos=writeUint16(this.messageIdentifier,byteStream,pos)),this.type){case MESSAGE_TYPE.CONNECT:pos=writeString(this.clientId,UTF8Length(this.clientId),byteStream,pos),void 0!=this.willMessage&&(pos=writeString(this.willMessage.destinationName,UTF8Length(this.willMessage.destinationName),byteStream,pos),pos=writeUint16(willMessagePayloadBytes.byteLength,byteStream,pos),byteStream.set(willMessagePayloadBytes,pos),pos+=willMessagePayloadBytes.byteLength),void 0!=this.userName&&(pos=writeString(this.userName,UTF8Length(this.userName),byteStream,pos)),void 0!=this.password&&(pos=writeString(this.password,UTF8Length(this.password),byteStream,pos));break;case MESSAGE_TYPE.PUBLISH:byteStream.set(payloadBytes,pos);break;case MESSAGE_TYPE.SUBSCRIBE:for(var i=0;i<this.topics.length;i++)pos=writeString(this.topics[i],topicStrLength[i],byteStream,pos),byteStream[pos++]=this.requestedQos[i];break;case MESSAGE_TYPE.UNSUBSCRIBE:for(var i=0;i<this.topics.length;i++)pos=writeString(this.topics[i],topicStrLength[i],byteStream,pos)}return buffer};var Pinger=function(client,window,keepAliveInterval){this._client=client,this._window=window,this._keepAliveInterval=1e3*keepAliveInterval,this.isReset=!1;var pingReq=new WireMessage(MESSAGE_TYPE.PINGREQ).encode(),doTimeout=function(pinger){return function(){return doPing.apply(pinger)}},doPing=function(){this.isReset?(this.isReset=!1,this._client._trace("Pinger.doPing","send PINGREQ"),this._client.socket.send(pingReq),this.timeout=this._window.setTimeout(doTimeout(this),this._keepAliveInterval)):(this._client._trace("Pinger.doPing","Timed out"),this._client._disconnected(ERROR.PING_TIMEOUT.code,format(ERROR.PING_TIMEOUT)))};this.reset=function(){this.isReset=!0,this._window.clearTimeout(this.timeout),this._keepAliveInterval>0&&(this.timeout=setTimeout(doTimeout(this),this._keepAliveInterval))},this.cancel=function(){this._window.clearTimeout(this.timeout)}},Timeout=function(client,window,timeoutSeconds,action,args){this._window=window,timeoutSeconds||(timeoutSeconds=30);var doTimeout=function(action,client,args){return function(){return action.apply(client,args)}};this.timeout=setTimeout(doTimeout(action,client,args),1e3*timeoutSeconds),this.cancel=function(){this._window.clearTimeout(this.timeout)}},ClientImpl=function(uri,host,port,path,clientId){if(!("WebSocket"in global&&null!==global.WebSocket))throw new Error(format(ERROR.UNSUPPORTED,["WebSocket"]));if(!("localStorage"in global&&null!==global.localStorage))throw new Error(format(ERROR.UNSUPPORTED,["localStorage"]));if(!("ArrayBuffer"in global&&null!==global.ArrayBuffer))throw new Error(format(ERROR.UNSUPPORTED,["ArrayBuffer"]));this._trace("Paho.MQTT.Client",uri,host,port,path,clientId),this.host=host,this.port=port,this.path=path,this.uri=uri,this.clientId=clientId,this._localKey=host+":"+port+("/mqtt"!=path?":"+path:"")+":"+clientId+":",this._msg_queue=[],this._sentMessages={},this._receivedMessages={},this._notify_msg_sent={},this._message_identifier=1,this._sequence=0;for(var key in localStorage)(0==key.indexOf("Sent:"+this._localKey)||0==key.indexOf("Received:"+this._localKey))&&this.restore(key)};ClientImpl.prototype.host,ClientImpl.prototype.port,ClientImpl.prototype.path,ClientImpl.prototype.uri,ClientImpl.prototype.clientId,ClientImpl.prototype.socket,ClientImpl.prototype.connected=!1,ClientImpl.prototype.maxMessageIdentifier=65536,ClientImpl.prototype.connectOptions,ClientImpl.prototype.hostIndex,ClientImpl.prototype.onConnectionLost,ClientImpl.prototype.onMessageDelivered,ClientImpl.prototype.onMessageArrived,ClientImpl.prototype.traceFunction,ClientImpl.prototype._msg_queue=null,ClientImpl.prototype._connectTimeout,ClientImpl.prototype.sendPinger=null,ClientImpl.prototype.receivePinger=null,ClientImpl.prototype.receiveBuffer=null,ClientImpl.prototype._traceBuffer=null,ClientImpl.prototype._MAX_TRACE_ENTRIES=100,ClientImpl.prototype.connect=function(connectOptions){var connectOptionsMasked=this._traceMask(connectOptions,"password");if(this._trace("Client.connect",connectOptionsMasked,this.socket,this.connected),this.connected)throw new Error(format(ERROR.INVALID_STATE,["already connected"]));if(this.socket)throw new Error(format(ERROR.INVALID_STATE,["already connected"]));this.connectOptions=connectOptions,connectOptions.uris?(this.hostIndex=0,this._doConnect(connectOptions.uris[0])):this._doConnect(this.uri)},ClientImpl.prototype.subscribe=function(filter,subscribeOptions){if(this._trace("Client.subscribe",filter,subscribeOptions),!this.connected)throw new Error(format(ERROR.INVALID_STATE,["not connected"]));var wireMessage=new WireMessage(MESSAGE_TYPE.SUBSCRIBE);wireMessage.topics=[filter],wireMessage.requestedQos=void 0!=subscribeOptions.qos?[subscribeOptions.qos]:[0],subscribeOptions.onSuccess&&(wireMessage.onSuccess=function(grantedQos){subscribeOptions.onSuccess({invocationContext:subscribeOptions.invocationContext,grantedQos:grantedQos})}),subscribeOptions.onFailure&&(wireMessage.onFailure=function(errorCode){subscribeOptions.onFailure({invocationContext:subscribeOptions.invocationContext,errorCode:errorCode})}),subscribeOptions.timeout&&(wireMessage.timeOut=new Timeout(this,window,subscribeOptions.timeout,subscribeOptions.onFailure,[{invocationContext:subscribeOptions.invocationContext,errorCode:ERROR.SUBSCRIBE_TIMEOUT.code,errorMessage:format(ERROR.SUBSCRIBE_TIMEOUT)}])),this._requires_ack(wireMessage),this._schedule_message(wireMessage)},ClientImpl.prototype.unsubscribe=function(filter,unsubscribeOptions){if(this._trace("Client.unsubscribe",filter,unsubscribeOptions),!this.connected)throw new Error(format(ERROR.INVALID_STATE,["not connected"]));var wireMessage=new WireMessage(MESSAGE_TYPE.UNSUBSCRIBE);wireMessage.topics=[filter],unsubscribeOptions.onSuccess&&(wireMessage.callback=function(){unsubscribeOptions.onSuccess({invocationContext:unsubscribeOptions.invocationContext})}),unsubscribeOptions.timeout&&(wireMessage.timeOut=new Timeout(this,window,unsubscribeOptions.timeout,unsubscribeOptions.onFailure,[{invocationContext:unsubscribeOptions.invocationContext,errorCode:ERROR.UNSUBSCRIBE_TIMEOUT.code,errorMessage:format(ERROR.UNSUBSCRIBE_TIMEOUT)}])),this._requires_ack(wireMessage),this._schedule_message(wireMessage)},ClientImpl.prototype.send=function(message){if(this._trace("Client.send",message),!this.connected)throw new Error(format(ERROR.INVALID_STATE,["not connected"]));wireMessage=new WireMessage(MESSAGE_TYPE.PUBLISH),wireMessage.payloadMessage=message,message.qos>0?this._requires_ack(wireMessage):this.onMessageDelivered&&(this._notify_msg_sent[wireMessage]=this.onMessageDelivered(wireMessage.payloadMessage)),this._schedule_message(wireMessage)},ClientImpl.prototype.disconnect=function(){if(this._trace("Client.disconnect"),!this.socket)throw new Error(format(ERROR.INVALID_STATE,["not connecting or connected"]));wireMessage=new WireMessage(MESSAGE_TYPE.DISCONNECT),this._notify_msg_sent[wireMessage]=scope(this._disconnected,this),this._schedule_message(wireMessage)},ClientImpl.prototype.getTraceLog=function(){if(null!==this._traceBuffer){this._trace("Client.getTraceLog",new Date),this._trace("Client.getTraceLog in flight messages",this._sentMessages.length);for(var key in this._sentMessages)this._trace("_sentMessages ",key,this._sentMessages[key]);for(var key in this._receivedMessages)this._trace("_receivedMessages ",key,this._receivedMessages[key]);return this._traceBuffer}},ClientImpl.prototype.startTrace=function(){null===this._traceBuffer&&(this._traceBuffer=[]),this._trace("Client.startTrace",new Date,version)},ClientImpl.prototype.stopTrace=function(){delete this._traceBuffer},ClientImpl.prototype._doConnect=function(wsurl){if(this.connectOptions.useSSL){var uriParts=wsurl.split(":");uriParts[0]="wss",wsurl=uriParts.join(":")}this.connected=!1,this.socket=this.connectOptions.mqttVersion<4?new WebSocket(wsurl,["mqttv3.1"]):new WebSocket(wsurl,["mqtt"]),this.socket.binaryType="arraybuffer",this.socket.onopen=scope(this._on_socket_open,this),this.socket.onmessage=scope(this._on_socket_message,this),this.socket.onerror=scope(this._on_socket_error,this),this.socket.onclose=scope(this._on_socket_close,this),this.sendPinger=new Pinger(this,window,this.connectOptions.keepAliveInterval),this.receivePinger=new Pinger(this,window,this.connectOptions.keepAliveInterval),this._connectTimeout=new Timeout(this,window,this.connectOptions.timeout,this._disconnected,[ERROR.CONNECT_TIMEOUT.code,format(ERROR.CONNECT_TIMEOUT)])},ClientImpl.prototype._schedule_message=function(message){this._msg_queue.push(message),this.connected&&this._process_queue()},ClientImpl.prototype.store=function(prefix,wireMessage){var storedMessage={type:wireMessage.type,messageIdentifier:wireMessage.messageIdentifier,version:1};switch(wireMessage.type){case MESSAGE_TYPE.PUBLISH:wireMessage.pubRecReceived&&(storedMessage.pubRecReceived=!0),storedMessage.payloadMessage={};for(var hex="",messageBytes=wireMessage.payloadMessage.payloadBytes,i=0;i<messageBytes.length;i++)messageBytes[i]<=15?hex=hex+"0"+messageBytes[i].toString(16):hex+=messageBytes[i].toString(16);storedMessage.payloadMessage.payloadHex=hex,storedMessage.payloadMessage.qos=wireMessage.payloadMessage.qos,storedMessage.payloadMessage.destinationName=wireMessage.payloadMessage.destinationName,wireMessage.payloadMessage.duplicate&&(storedMessage.payloadMessage.duplicate=!0),wireMessage.payloadMessage.retained&&(storedMessage.payloadMessage.retained=!0),0==prefix.indexOf("Sent:")&&(void 0===wireMessage.sequence&&(wireMessage.sequence=++this._sequence),storedMessage.sequence=wireMessage.sequence);break;default:throw Error(format(ERROR.INVALID_STORED_DATA,[key,storedMessage]))}localStorage.setItem(prefix+this._localKey+wireMessage.messageIdentifier,JSON.stringify(storedMessage))},ClientImpl.prototype.restore=function(key){var value=localStorage.getItem(key),storedMessage=JSON.parse(value),wireMessage=new WireMessage(storedMessage.type,storedMessage);switch(storedMessage.type){case MESSAGE_TYPE.PUBLISH:for(var hex=storedMessage.payloadMessage.payloadHex,buffer=new ArrayBuffer(hex.length/2),byteStream=new Uint8Array(buffer),i=0;hex.length>=2;){var x=parseInt(hex.substring(0,2),16);hex=hex.substring(2,hex.length),byteStream[i++]=x}var payloadMessage=new Paho.MQTT.Message(byteStream);payloadMessage.qos=storedMessage.payloadMessage.qos,payloadMessage.destinationName=storedMessage.payloadMessage.destinationName,storedMessage.payloadMessage.duplicate&&(payloadMessage.duplicate=!0),storedMessage.payloadMessage.retained&&(payloadMessage.retained=!0),wireMessage.payloadMessage=payloadMessage;break;default:throw Error(format(ERROR.INVALID_STORED_DATA,[key,value]))}0==key.indexOf("Sent:"+this._localKey)?(wireMessage.payloadMessage.duplicate=!0,this._sentMessages[wireMessage.messageIdentifier]=wireMessage):0==key.indexOf("Received:"+this._localKey)&&(this._receivedMessages[wireMessage.messageIdentifier]=wireMessage)},ClientImpl.prototype._process_queue=function(){for(var message=null,fifo=this._msg_queue.reverse();message=fifo.pop();)this._socket_send(message),this._notify_msg_sent[message]&&(this._notify_msg_sent[message](),delete this._notify_msg_sent[message])},ClientImpl.prototype._requires_ack=function(wireMessage){var messageCount=Object.keys(this._sentMessages).length;if(messageCount>this.maxMessageIdentifier)throw Error("Too many messages:"+messageCount);for(;void 0!==this._sentMessages[this._message_identifier];)this._message_identifier++;wireMessage.messageIdentifier=this._message_identifier,this._sentMessages[wireMessage.messageIdentifier]=wireMessage,wireMessage.type===MESSAGE_TYPE.PUBLISH&&this.store("Sent:",wireMessage),this._message_identifier===this.maxMessageIdentifier&&(this._message_identifier=1)},ClientImpl.prototype._on_socket_open=function(){var wireMessage=new WireMessage(MESSAGE_TYPE.CONNECT,this.connectOptions);wireMessage.clientId=this.clientId,this._socket_send(wireMessage)},ClientImpl.prototype._on_socket_message=function(event){this._trace("Client._on_socket_message",event.data),this.receivePinger.reset();for(var messages=this._deframeMessages(event.data),i=0;i<messages.length;i+=1)this._handleMessage(messages[i])},ClientImpl.prototype._deframeMessages=function(data){var byteArray=new Uint8Array(data);if(this.receiveBuffer){var newData=new Uint8Array(this.receiveBuffer.length+byteArray.length);newData.set(this.receiveBuffer),newData.set(byteArray,this.receiveBuffer.length),byteArray=newData,delete this.receiveBuffer}try{for(var offset=0,messages=[];offset<byteArray.length;){var result=decodeMessage(byteArray,offset),wireMessage=result[0];if(offset=result[1],null===wireMessage)break;messages.push(wireMessage)}offset<byteArray.length&&(this.receiveBuffer=byteArray.subarray(offset))}catch(error){return void this._disconnected(ERROR.INTERNAL_ERROR.code,format(ERROR.INTERNAL_ERROR,[error.message,error.stack.toString()]))}return messages},ClientImpl.prototype._handleMessage=function(wireMessage){this._trace("Client._handleMessage",wireMessage);try{switch(wireMessage.type){case MESSAGE_TYPE.CONNACK:if(this._connectTimeout.cancel(),this.connectOptions.cleanSession){for(var key in this._sentMessages){var sentMessage=this._sentMessages[key];localStorage.removeItem("Sent:"+this._localKey+sentMessage.messageIdentifier)}this._sentMessages={};for(var key in this._receivedMessages){var receivedMessage=this._receivedMessages[key];localStorage.removeItem("Received:"+this._localKey+receivedMessage.messageIdentifier)}this._receivedMessages={}}if(0!==wireMessage.returnCode){this._disconnected(ERROR.CONNACK_RETURNCODE.code,format(ERROR.CONNACK_RETURNCODE,[wireMessage.returnCode,CONNACK_RC[wireMessage.returnCode]]));break}this.connected=!0,this.connectOptions.uris&&(this.hostIndex=this.connectOptions.uris.length);var sequencedMessages=new Array;for(var msgId in this._sentMessages)this._sentMessages.hasOwnProperty(msgId)&&sequencedMessages.push(this._sentMessages[msgId]);for(var sequencedMessages=sequencedMessages.sort(function(a,b){return a.sequence-b.sequence}),i=0,len=sequencedMessages.length;len>i;i++){var sentMessage=sequencedMessages[i];if(sentMessage.type==MESSAGE_TYPE.PUBLISH&&sentMessage.pubRecReceived){var pubRelMessage=new WireMessage(MESSAGE_TYPE.PUBREL,{messageIdentifier:sentMessage.messageIdentifier});this._schedule_message(pubRelMessage)}else this._schedule_message(sentMessage)}this.connectOptions.onSuccess&&this.connectOptions.onSuccess({invocationContext:this.connectOptions.invocationContext}),this._process_queue();break;case MESSAGE_TYPE.PUBLISH:this._receivePublish(wireMessage);break;case MESSAGE_TYPE.PUBACK:var sentMessage=this._sentMessages[wireMessage.messageIdentifier];sentMessage&&(delete this._sentMessages[wireMessage.messageIdentifier],localStorage.removeItem("Sent:"+this._localKey+wireMessage.messageIdentifier),this.onMessageDelivered&&this.onMessageDelivered(sentMessage.payloadMessage));break;case MESSAGE_TYPE.PUBREC:var sentMessage=this._sentMessages[wireMessage.messageIdentifier];if(sentMessage){sentMessage.pubRecReceived=!0;var pubRelMessage=new WireMessage(MESSAGE_TYPE.PUBREL,{messageIdentifier:wireMessage.messageIdentifier});this.store("Sent:",sentMessage),this._schedule_message(pubRelMessage)}break;case MESSAGE_TYPE.PUBREL:var receivedMessage=this._receivedMessages[wireMessage.messageIdentifier];localStorage.removeItem("Received:"+this._localKey+wireMessage.messageIdentifier),receivedMessage&&(this._receiveMessage(receivedMessage),delete this._receivedMessages[wireMessage.messageIdentifier]);var pubCompMessage=new WireMessage(MESSAGE_TYPE.PUBCOMP,{messageIdentifier:wireMessage.messageIdentifier});this._schedule_message(pubCompMessage);break;case MESSAGE_TYPE.PUBCOMP:var sentMessage=this._sentMessages[wireMessage.messageIdentifier];delete this._sentMessages[wireMessage.messageIdentifier],localStorage.removeItem("Sent:"+this._localKey+wireMessage.messageIdentifier),this.onMessageDelivered&&this.onMessageDelivered(sentMessage.payloadMessage);break;case MESSAGE_TYPE.SUBACK:var sentMessage=this._sentMessages[wireMessage.messageIdentifier];sentMessage&&(sentMessage.timeOut&&sentMessage.timeOut.cancel(),wireMessage.returnCode.indexOf=Array.prototype.indexOf,-1!==wireMessage.returnCode.indexOf(128)?sentMessage.onFailure&&sentMessage.onFailure(wireMessage.returnCode):sentMessage.onSuccess&&sentMessage.onSuccess(wireMessage.returnCode),delete this._sentMessages[wireMessage.messageIdentifier]);break;case MESSAGE_TYPE.UNSUBACK:var sentMessage=this._sentMessages[wireMessage.messageIdentifier];sentMessage&&(sentMessage.timeOut&&sentMessage.timeOut.cancel(),sentMessage.callback&&sentMessage.callback(),delete this._sentMessages[wireMessage.messageIdentifier]);break;case MESSAGE_TYPE.PINGRESP:this.sendPinger.reset();break;case MESSAGE_TYPE.DISCONNECT:this._disconnected(ERROR.INVALID_MQTT_MESSAGE_TYPE.code,format(ERROR.INVALID_MQTT_MESSAGE_TYPE,[wireMessage.type]));break;default:this._disconnected(ERROR.INVALID_MQTT_MESSAGE_TYPE.code,format(ERROR.INVALID_MQTT_MESSAGE_TYPE,[wireMessage.type]))}}catch(error){return void this._disconnected(ERROR.INTERNAL_ERROR.code,format(ERROR.INTERNAL_ERROR,[error.message,error.stack.toString()]))}},ClientImpl.prototype._on_socket_error=function(error){this._disconnected(ERROR.SOCKET_ERROR.code,format(ERROR.SOCKET_ERROR,[error.data]))},ClientImpl.prototype._on_socket_close=function(){this._disconnected(ERROR.SOCKET_CLOSE.code,format(ERROR.SOCKET_CLOSE))},ClientImpl.prototype._socket_send=function(wireMessage){if(1==wireMessage.type){var wireMessageMasked=this._traceMask(wireMessage,"password");this._trace("Client._socket_send",wireMessageMasked)}else this._trace("Client._socket_send",wireMessage);this.socket.send(wireMessage.encode()),this.sendPinger.reset()},ClientImpl.prototype._receivePublish=function(wireMessage){switch(wireMessage.payloadMessage.qos){case"undefined":case 0:this._receiveMessage(wireMessage);break;case 1:var pubAckMessage=new WireMessage(MESSAGE_TYPE.PUBACK,{messageIdentifier:wireMessage.messageIdentifier});this._schedule_message(pubAckMessage),this._receiveMessage(wireMessage);break;case 2:this._receivedMessages[wireMessage.messageIdentifier]=wireMessage,this.store("Received:",wireMessage);var pubRecMessage=new WireMessage(MESSAGE_TYPE.PUBREC,{messageIdentifier:wireMessage.messageIdentifier});this._schedule_message(pubRecMessage);break;default:throw Error("Invaild qos="+wireMmessage.payloadMessage.qos)}},ClientImpl.prototype._receiveMessage=function(wireMessage){this.onMessageArrived&&this.onMessageArrived(wireMessage.payloadMessage)},ClientImpl.prototype._disconnected=function(errorCode,errorText){this._trace("Client._disconnected",errorCode,errorText),this.sendPinger.cancel(),this.receivePinger.cancel(),this._connectTimeout&&this._connectTimeout.cancel(),this._msg_queue=[],this._notify_msg_sent={},this.socket&&(this.socket.onopen=null,this.socket.onmessage=null,this.socket.onerror=null,this.socket.onclose=null,1===this.socket.readyState&&this.socket.close(),delete this.socket),this.connectOptions.uris&&this.hostIndex<this.connectOptions.uris.length-1?(this.hostIndex++,this._doConnect(this.connectOptions.uris[this.hostIndex])):(void 0===errorCode&&(errorCode=ERROR.OK.code,errorText=format(ERROR.OK)),this.connected?(this.connected=!1,this.onConnectionLost&&this.onConnectionLost({errorCode:errorCode,errorMessage:errorText})):4===this.connectOptions.mqttVersion&&this.connectOptions.mqttVersionExplicit===!1?(this._trace("Failed to connect V4, dropping back to V3"),this.connectOptions.mqttVersion=3,this.connectOptions.uris?(this.hostIndex=0,this._doConnect(this.connectOptions.uris[0])):this._doConnect(this.uri)):this.connectOptions.onFailure&&this.connectOptions.onFailure({invocationContext:this.connectOptions.invocationContext,errorCode:errorCode,errorMessage:errorText}))},ClientImpl.prototype._trace=function(){if(this.traceFunction){for(var i in arguments)"undefined"!=typeof arguments[i]&&(arguments[i]=JSON.stringify(arguments[i]));var record=Array.prototype.slice.call(arguments).join("");this.traceFunction({severity:"Debug",message:record})}if(null!==this._traceBuffer)for(var i=0,max=arguments.length;max>i;i++)this._traceBuffer.length==this._MAX_TRACE_ENTRIES&&this._traceBuffer.shift(),this._traceBuffer.push(0===i?arguments[i]:"undefined"==typeof arguments[i]?arguments[i]:"  "+JSON.stringify(arguments[i]))},ClientImpl.prototype._traceMask=function(traceObject,masked){var traceObjectMasked={};for(var attr in traceObject)traceObject.hasOwnProperty(attr)&&(traceObjectMasked[attr]=attr==masked?"******":traceObject[attr]);return traceObjectMasked};var Client=function(host,port,path,clientId){var uri;if("string"!=typeof host)throw new Error(format(ERROR.INVALID_TYPE,[typeof host,"host"]));if(2==arguments.length){clientId=port,uri=host;var match=uri.match(/^(wss?):\/\/((\[(.+)\])|([^\/]+?))(:(\d+))?(\/.*)$/);if(!match)throw new Error(format(ERROR.INVALID_ARGUMENT,[host,"host"]));host=match[4]||match[2],port=parseInt(match[7]),path=match[8]}else{if(3==arguments.length&&(clientId=path,path="/mqtt"),"number"!=typeof port||0>port)throw new Error(format(ERROR.INVALID_TYPE,[typeof port,"port"]));if("string"!=typeof path)throw new Error(format(ERROR.INVALID_TYPE,[typeof path,"path"]));var ipv6AddSBracket=-1!=host.indexOf(":")&&"["!=host.slice(0,1)&&"]"!=host.slice(-1);uri="ws://"+(ipv6AddSBracket?"["+host+"]":host)+":"+port+path}for(var clientIdLength=0,i=0;i<clientId.length;i++){var charCode=clientId.charCodeAt(i);charCode>=55296&&56319>=charCode&&i++,clientIdLength++}if("string"!=typeof clientId||clientIdLength>65535)throw new Error(format(ERROR.INVALID_ARGUMENT,[clientId,"clientId"]));var client=new ClientImpl(uri,host,port,path,clientId);this._getHost=function(){return host},this._setHost=function(){throw new Error(format(ERROR.UNSUPPORTED_OPERATION))},this._getPort=function(){return port},this._setPort=function(){throw new Error(format(ERROR.UNSUPPORTED_OPERATION))},this._getPath=function(){return path},this._setPath=function(){throw new Error(format(ERROR.UNSUPPORTED_OPERATION))},this._getURI=function(){return uri},this._setURI=function(){throw new Error(format(ERROR.UNSUPPORTED_OPERATION))},this._getClientId=function(){return client.clientId},this._setClientId=function(){throw new Error(format(ERROR.UNSUPPORTED_OPERATION))},this._getOnConnectionLost=function(){return client.onConnectionLost},this._setOnConnectionLost=function(newOnConnectionLost){if("function"!=typeof newOnConnectionLost)throw new Error(format(ERROR.INVALID_TYPE,[typeof newOnConnectionLost,"onConnectionLost"]));client.onConnectionLost=newOnConnectionLost},this._getOnMessageDelivered=function(){return client.onMessageDelivered},this._setOnMessageDelivered=function(newOnMessageDelivered){if("function"!=typeof newOnMessageDelivered)throw new Error(format(ERROR.INVALID_TYPE,[typeof newOnMessageDelivered,"onMessageDelivered"]));client.onMessageDelivered=newOnMessageDelivered},this._getOnMessageArrived=function(){return client.onMessageArrived},this._setOnMessageArrived=function(newOnMessageArrived){if("function"!=typeof newOnMessageArrived)throw new Error(format(ERROR.INVALID_TYPE,[typeof newOnMessageArrived,"onMessageArrived"]));client.onMessageArrived=newOnMessageArrived},this._getTrace=function(){return client.traceFunction},this._setTrace=function(trace){if("function"!=typeof trace)throw new Error(format(ERROR.INVALID_TYPE,[typeof trace,"onTrace"]));client.traceFunction=trace},this.connect=function(connectOptions){if(connectOptions=connectOptions||{},validate(connectOptions,{timeout:"number",userName:"string",password:"string",willMessage:"object",keepAliveInterval:"number",cleanSession:"boolean",useSSL:"boolean",invocationContext:"object",onSuccess:"function",onFailure:"function",hosts:"object",ports:"object",mqttVersion:"number"}),void 0===connectOptions.keepAliveInterval&&(connectOptions.keepAliveInterval=60),connectOptions.mqttVersion>4||connectOptions.mqttVersion<3)throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.mqttVersion,"connectOptions.mqttVersion"]));if(void 0===connectOptions.mqttVersion?(connectOptions.mqttVersionExplicit=!1,connectOptions.mqttVersion=4):connectOptions.mqttVersionExplicit=!0,void 0===connectOptions.password&&void 0!==connectOptions.userName)throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.password,"connectOptions.password"]));if(connectOptions.willMessage){if(!(connectOptions.willMessage instanceof Message))throw new Error(format(ERROR.INVALID_TYPE,[connectOptions.willMessage,"connectOptions.willMessage"]));if(connectOptions.willMessage.stringPayload,"undefined"==typeof connectOptions.willMessage.destinationName)throw new Error(format(ERROR.INVALID_TYPE,[typeof connectOptions.willMessage.destinationName,"connectOptions.willMessage.destinationName"]))}if("undefined"==typeof connectOptions.cleanSession&&(connectOptions.cleanSession=!0),connectOptions.hosts){if(!(connectOptions.hosts instanceof Array))throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.hosts,"connectOptions.hosts"]));if(connectOptions.hosts.length<1)throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.hosts,"connectOptions.hosts"]));for(var usingURIs=!1,i=0;i<connectOptions.hosts.length;i++){if("string"!=typeof connectOptions.hosts[i])throw new Error(format(ERROR.INVALID_TYPE,[typeof connectOptions.hosts[i],"connectOptions.hosts["+i+"]"]));if(/^(wss?):\/\/((\[(.+)\])|([^\/]+?))(:(\d+))?(\/.*)$/.test(connectOptions.hosts[i])){if(0==i)usingURIs=!0;else if(!usingURIs)throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.hosts[i],"connectOptions.hosts["+i+"]"]))}else if(usingURIs)throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.hosts[i],"connectOptions.hosts["+i+"]"]))}if(usingURIs)connectOptions.uris=connectOptions.hosts;else{if(!connectOptions.ports)throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.ports,"connectOptions.ports"]));if(!(connectOptions.ports instanceof Array))throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.ports,"connectOptions.ports"]));if(connectOptions.hosts.length!=connectOptions.ports.length)throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.ports,"connectOptions.ports"]));connectOptions.uris=[];for(var i=0;i<connectOptions.hosts.length;i++){if("number"!=typeof connectOptions.ports[i]||connectOptions.ports[i]<0)throw new Error(format(ERROR.INVALID_TYPE,[typeof connectOptions.ports[i],"connectOptions.ports["+i+"]"]));var host=connectOptions.hosts[i],port=connectOptions.ports[i],ipv6=-1!=host.indexOf(":");uri="ws://"+(ipv6?"["+host+"]":host)+":"+port+path,connectOptions.uris.push(uri)}}}client.connect(connectOptions)},this.subscribe=function(filter,subscribeOptions){if("string"!=typeof filter)throw new Error("Invalid argument:"+filter);if(subscribeOptions=subscribeOptions||{},validate(subscribeOptions,{qos:"number",invocationContext:"object",onSuccess:"function",onFailure:"function",timeout:"number"}),subscribeOptions.timeout&&!subscribeOptions.onFailure)throw new Error("subscribeOptions.timeout specified with no onFailure callback.");if("undefined"!=typeof subscribeOptions.qos&&0!==subscribeOptions.qos&&1!==subscribeOptions.qos&&2!==subscribeOptions.qos)throw new Error(format(ERROR.INVALID_ARGUMENT,[subscribeOptions.qos,"subscribeOptions.qos"]));client.subscribe(filter,subscribeOptions)},this.unsubscribe=function(filter,unsubscribeOptions){if("string"!=typeof filter)throw new Error("Invalid argument:"+filter);if(unsubscribeOptions=unsubscribeOptions||{},validate(unsubscribeOptions,{invocationContext:"object",onSuccess:"function",onFailure:"function",timeout:"number"}),unsubscribeOptions.timeout&&!unsubscribeOptions.onFailure)throw new Error("unsubscribeOptions.timeout specified with no onFailure callback.");client.unsubscribe(filter,unsubscribeOptions)},this.send=function(topic,payload,qos,retained){var message;if(0==arguments.length)throw new Error("Invalid argument.length");if(1==arguments.length){if(!(topic instanceof Message)&&"string"!=typeof topic)throw new Error("Invalid argument:"+typeof topic);if(message=topic,"undefined"==typeof message.destinationName)throw new Error(format(ERROR.INVALID_ARGUMENT,[message.destinationName,"Message.destinationName"]));client.send(message)}else message=new Message(payload),message.destinationName=topic,arguments.length>=3&&(message.qos=qos),arguments.length>=4&&(message.retained=retained),client.send(message)},this.disconnect=function(){client.disconnect()},this.getTraceLog=function(){return client.getTraceLog()},this.startTrace=function(){client.startTrace()},this.stopTrace=function(){client.stopTrace()},this.isConnected=function(){return client.connected}};Client.prototype={get host(){return this._getHost()},set host(newHost){this._setHost(newHost)},get port(){return this._getPort()},set port(newPort){this._setPort(newPort)},get path(){return this._getPath()},set path(newPath){this._setPath(newPath)},get clientId(){return this._getClientId()},set clientId(newClientId){this._setClientId(newClientId)},get onConnectionLost(){return this._getOnConnectionLost()},set onConnectionLost(newOnConnectionLost){this._setOnConnectionLost(newOnConnectionLost)},get onMessageDelivered(){return this._getOnMessageDelivered()},set onMessageDelivered(newOnMessageDelivered){this._setOnMessageDelivered(newOnMessageDelivered)},get onMessageArrived(){return this._getOnMessageArrived()},set onMessageArrived(newOnMessageArrived){this._setOnMessageArrived(newOnMessageArrived)},get trace(){return this._getTrace()},set trace(newTraceFunction){this._setTrace(newTraceFunction)}};var Message=function(newPayload){var payload;if(!("string"==typeof newPayload||newPayload instanceof ArrayBuffer||newPayload instanceof Int8Array||newPayload instanceof Uint8Array||newPayload instanceof Int16Array||newPayload instanceof Uint16Array||newPayload instanceof Int32Array||newPayload instanceof Uint32Array||newPayload instanceof Float32Array||newPayload instanceof Float64Array))throw format(ERROR.INVALID_ARGUMENT,[newPayload,"newPayload"]);payload=newPayload,this._getPayloadString=function(){return"string"==typeof payload?payload:parseUTF8(payload,0,payload.length)},this._getPayloadBytes=function(){if("string"==typeof payload){var buffer=new ArrayBuffer(UTF8Length(payload)),byteStream=new Uint8Array(buffer);
return stringToUTF8(payload,byteStream,0),byteStream}return payload};var destinationName=void 0;this._getDestinationName=function(){return destinationName},this._setDestinationName=function(newDestinationName){if("string"!=typeof newDestinationName)throw new Error(format(ERROR.INVALID_ARGUMENT,[newDestinationName,"newDestinationName"]));destinationName=newDestinationName};var qos=0;this._getQos=function(){return qos},this._setQos=function(newQos){if(0!==newQos&&1!==newQos&&2!==newQos)throw new Error("Invalid argument:"+newQos);qos=newQos};var retained=!1;this._getRetained=function(){return retained},this._setRetained=function(newRetained){if("boolean"!=typeof newRetained)throw new Error(format(ERROR.INVALID_ARGUMENT,[newRetained,"newRetained"]));retained=newRetained};var duplicate=!1;this._getDuplicate=function(){return duplicate},this._setDuplicate=function(newDuplicate){duplicate=newDuplicate}};return Message.prototype={get payloadString(){return this._getPayloadString()},get payloadBytes(){return this._getPayloadBytes()},get destinationName(){return this._getDestinationName()},set destinationName(newDestinationName){this._setDestinationName(newDestinationName)},get qos(){return this._getQos()},set qos(newQos){this._setQos(newQos)},get retained(){return this._getRetained()},set retained(newRetained){this._setRetained(newRetained)},get duplicate(){return this._getDuplicate()},set duplicate(newDuplicate){this._setDuplicate(newDuplicate)}},{Client:Client,Message:Message}}(window),"undefined"==typeof async||"undefined"==typeof async.setImmediate)throw new Error("async missing: https://github.com/caolan/async");if("undefined"==typeof jsonld||"undefined"==typeof jsonld.compact)throw new Error("jsonld missing: https://github.com/digitalbazaar/jsonld.js");var $thing=$thing||{};$thing.bootstrap="browser.js",$thing.usePaho=!0,$thing.async=async,$thing.jsonld=jsonld,$thing.getMicroTime=function(){return 1e3*Date.now()},window.chrome?$thing.getThreadId=function(first){first=first||0;var j=0,threadId=[void 0,"main","main"],prepareStackTrace=Error.prepareStackTrace;return first++,Error.prepareStackTrace=function(err,frame){if(frame.length>first){threadId[0]=frame[first].getFileName()+":"+frame[first].getLineNumber()+":"+frame[first].getColumnNumber();for(var i=1;i<frame.length&&!("$thing.$container"===frame[i-1].getFunctionName()&&(threadId[++j]=frame[i].getFileName()+":"+frame[i].getLineNumber()+":"+frame[i].getColumnNumber(),j>threadId.length));i++);}},(new Error).stack,Error.prepareStackTrace=prepareStackTrace,threadId}:($thing.getBacktrace=function(first){first=first||0;try{0()}catch(e){var trace=e.stack.replace(/Object\.\$thing\.\$container [^\r\n\t\f ]+/g,"$container:0:0").replace(/\$thing\.\$container@[^\r\n\t\f ]+/g,"$container:0:0").replace(/\$container@[^\r\n\t\f ]+/g,"$container:0:0");return null!==(trace=trace.match(/[^\r\n\t\f\( ]+\d\:\d+/g))?trace.slice(1+first):null!==(trace=trace.match(/\s+at /g))?trace.slice(1+first):[]}},$thing.getThreadId=function(first){var j=0,threadId=[void 0,"main","main"],frame=$thing.getBacktrace(first+1);threadId[0]=frame[0];for(var i=1;i<frame.length&&!(frame[i-1].indexOf("$container:0:0")>-1&&(threadId[++j]=frame[i],j>threadId.length));i++);return threadId}),$thing.createBuffer=function(byteArray){return{buf:byteArray,toString:function(){return String.fromCharCode.apply(null,new Uint16Array(byteArray))}}},$thing.Mash=function(){var n=4022871197,mash=function(data){data=data.toString();for(var i=0;i<data.length;i++){n+=data.charCodeAt(i);var h=.02519603282416938*n;n=h>>>0,h-=n,h*=n,n=h>>>0,h-=n,n+=4294967296*h}return 2.3283064365386963e-10*(n>>>0)};return mash},$thing.create64BitId=function(){for(var h1=new $thing.Mash,h2=new $thing.Mash,i=0;i<arguments.length;i++)h1(arguments[i]||"");return h1("").toString(16).split(".")[1]+h2($thing.getMicroTime()).toString(16).split(".")[1]},$thing.merge=function(){for(var args=$thing.arrayDup(arguments),obj=args[0],i=1;i<args.length;i++)if(void 0!==args[i])for(var k in args[i])void 0===obj[k]?obj[k]=args[i][k]:void 0;return obj},$thing.arrayDup=function(src,length,destroySrc,retainLength){var i,l=length||src.length,dest=new Array(length||src.length);if(void 0===destroySrc||destroySrc===!1)for(i=0;l>i;i++)dest[i]=src[i];else{for(i=0;l>i;i++)dest[i]=src[i],src[i]=void 0;void 0===retainLength?src.length=0:src.length>retainLength&&(src.length=retainLength)}return dest},$thing.arrayAppend=function(src,value){for(var l=src.length,dest=new Array(l+1),i=0;l>i;i++)dest[i]=src[i];return dest[l]=value,dest},$thing.arrayToObject=function(values,predicates,cbTestFunc){var obj={};predicates=predicates||[];for(var i in values)(!cbTestFunc||cbTestFunc(values[i]))&&(obj[predicates[i]||i]=values[i]);return obj},$thing.containers={main:{source:"$thing",heap:[]}},$thing.$container=function(cb){$thing.getContainer($thing.getThreadId(1)),cb()},$thing.getContainer=function(threadId){var container=$thing.containers[threadId[1]],parent=$thing.containers[threadId[2]];if(void 0===container&&(container=$thing.containers[threadId[1]]={heap:[]},threadId[1]!==threadId[2]&&void 0!==parent))for(var k in parent.heap)parent.heap[k].isAbstract&&container.heap.push(parent.heap[k]);return container},$thing.attach=function(def,heap){if(void 0!==def._id)return def._id;for(var length=heap.length;0!==heap.length&&0===heap[heap.length-1]._refCount;)heap.pop()._id=void 0;if(heap.length&&heap.length===length){def._id=void 0;for(var i=heap.length-1;i>-1&&void 0===def._id;i--)0===heap[i]._refCount&&(heap[i]._id=void 0,heap[def._id=i]=def);void 0===def._id&&(def._id=heap.push(def)-1)}else def._id=heap.push(def)-1;return def._id},$thing.search=function(obj,heap){for(var match,i=heap.length-1;i>-1;i--)if(heap[i]._refCount>0){for(var k in obj)if(!(match=obj[k]===heap[i][k]))break;if(match)return heap[i]}return void 0},$thing.searchMeta=function(obj,predicate){var type="string",cb=arguments[2],meta=void 0!==obj.getMeta?obj.getMeta():obj._meta;switch(arguments[2]){case"int":case"boolean":case"string":type=arguments[2],cb=arguments[3]}meta.forEach(function(item){if(item=item.match(/\S+/g),null!==item&&item[0]===predicate)switch(item=item.slice(1),type){case"int":isNaN(item[0]=parseInt(item[0]))||cb.apply(obj,item);break;case"boolean":switch(item[0].toLowerCase()){case"true":item[0]=!0,cb.apply(obj,item);break;case"false":item[0]=!1,cb.apply(obj,item)}break;default:cb.apply(obj,item)}})},$thing.cbBuilder=function(threadId,self,args,cbDone){return cbDone=cbDone||function(){},$thing.Tasker.thread(threadId),0!==args.length?function(){$thing.agent(self).apply($thing,args).apply($thing,arguments.length?arguments:[$thing.Container]),cbDone()}:void cbDone()};var agent=$thing.agent=function(){var cb,threadId,selector,filter,pattern,selects,callChain,inlineDef,inlineThreadId,inlineObj=$thing.Container,refCount=0;switch(arguments.length){case 0:return $thing.Tasker.thread($thing.getThreadId(1));case 2:"function"==typeof arguments[1]&&(cb=arguments[1]);case 1:if(arguments[0]instanceof $thing.Pattern){pattern=arguments[0],threadId=pattern.getThreadId(),selector=new $thing.Selector(threadId,pattern,!0);break}if("object"==typeof arguments[0]&&void 0!==arguments[0].getInterfaces){selector=arguments[0],threadId=selector.getThreadId();break}default:var def=new $thing.Definition($thing.Container,$thing.Agent,threadId=$thing.getThreadId(1),$thing.arrayDup(arguments));if(void 0!==def["class"])return def.refObject(function(obj,cbRelease){cbRelease()});selects=[],$thing.searchMeta(def,"select",function(){selects.push($thing.arrayDup(arguments))}),selector=new $thing.Selector(threadId,pattern=selects.length?selects:def.name,!0)}return filter=function(filters,callArgs){return 2===arguments.length&&"string"==typeof callArgs[0]&&"^"===callArgs[0].charAt(0)?(void 0===inlineDef&&(inlineDef={},inlineThreadId=$thing.getThreadId(2)),inlineDef[callArgs[0].substring(1)]=callArgs[1],callChain):function(){var obj;switch(arguments.length){case 0:void 0===inlineDef?obj=inlineObj:(obj=inlineObj=new $thing.Definition($thing.Container,$thing.Agent,inlineThreadId,[inlineDef]),inlineDef=void 0);break;case 1:if("object"==typeof arguments[0]&&void 0!==arguments[0].getInterfaces){obj=arguments[0];break}default:var def=new $thing.Definition($thing.Container,$thing.Agent,$thing.getThreadId(1),$thing.arrayDup(arguments));void 0!==def["class"]?obj=def:(selects=[],$thing.searchMeta(def,"select",function(){selects.push($thing.arrayDup(arguments))}),obj=new $thing.Pattern(threadId,selects.length?selects:def.name))}return obj.refObject(function(obj,cbRelease){refCount++,void 0===pattern?selector.dispatch({filters:filters,method:callArgs[0],args:callArgs.slice(1)},function(){return $thing.cbBuilder(threadId,obj,arguments,function(){0===--refCount&&(void 0!==cb&&cb(),cbRelease())})}):(selector.select(),selector.schedule(),selector.dispatch({filters:filters,method:callArgs[0],args:callArgs.slice(1)},function(){return $thing.cbBuilder(threadId,obj,Array.prototype.slice.call(arguments,0,arguments.length-1),arguments[arguments.length-1])},function(){refCount>1?refCount--:$thing.async.setImmediate(function(){0===--refCount&&(void 0!==cb&&cb(),cbRelease(),selector.release())})}))}),callChain}},callChain=function(){return filter($thing.Filter.ALL,$thing.arrayDup(arguments))},callChain.all=callChain,callChain.first=function(){return filter($thing.Filter.FIRST,$thing.arrayDup(arguments))},callChain.last=function(){return filter($thing.Filter.LAST,$thing.arrayDup(arguments))},callChain};$thing.switchContext=function(functString,parentOrdinal,superOrdinal,ordinal,superName,methodName){return functString=functString||this.$vtable[ordinal][methodName].toString(),functString.indexOf("$parent")>-1||functString.indexOf("$super")>-1?function(){var ret,$parent=this.$parent,$super=this.$super;return this.$parent=this.$vtable[parentOrdinal]||$parent,this.$super=this.$vtable[superOrdinal][superName],ret=this.$vtable[ordinal][methodName].apply(this,arguments),this.$parent=$parent,this.$super=$super,ret}:this.$vtable[ordinal][methodName]},$thing.switchParentContext=function(functString,parentOrdinal,ordinal,methodName){return functString=functString||this.$vtable[ordinal][methodName].toString(),functString.indexOf("$parent")>-1?function(){var ret,$parent=this.$parent;return this.$parent=this.$vtable[parentOrdinal]||this.$parent,ret=this.$vtable[ordinal][methodName].apply(this,arguments),this.$parent=$parent,ret}:this.$vtable[ordinal][methodName]},$thing.Object=function(){},$thing.Object.prototype.getName=function(){return"Object"};var $inherit=$thing.Object.inherit=function(obj,parent){function $obj(){void 0!==this.init?this.init.apply(this,arguments):void 0}function replace(){return void 0!==obj["$"+arguments[1]]?obj["$"+arguments[1]]:arguments[0]}var i,j,k,v,functString,signature,signatures={},ontology={},inherit=this.prototype;$obj.prototype=new this,$obj.prototype.constructor=$obj,$obj.prototype.$vtable=void 0!==$obj.prototype.$vtable?$obj.prototype.$vtable.slice():[];var ordinal=$obj.prototype.$vtable.push(obj)-1,parentOrdinal=$obj.prototype.$vtable.push(parent)-1,superOrdinal=$obj.prototype.$vtable.push(inherit)-1;$obj.inherit=$inherit;for(i in obj){switch(i){case"$vtable":case"$signatures":case"$ontology":case"$owner":case"$parent":case"$super":continue}v=obj[i],k=i.replace(/\$\((.+?)\)/g,replace),j=k.substring(k.indexOf(".")+1),"function"!=typeof v?"$"===k.charAt(0)?$obj.prototype[k]=v:ontology[k]=v:(functString=v.toString(),signature=functString.match(/function[^(]*\(([^)]*)\)/),$obj.prototype[k]="function"!=typeof inherit[k]?"function"!=typeof inherit[j]?$thing.switchParentContext.apply($obj.prototype,[functString,parentOrdinal,ordinal,i]):$thing.switchContext.apply($obj.prototype,[functString,parentOrdinal,superOrdinal,ordinal,j,i]):$thing.switchContext.apply($obj.prototype,[functString,parentOrdinal,superOrdinal,ordinal,k,i]),null!==signature&&(signatures[k]=signature[1].length?signature[1].split(/,\s*/):[]))}return $obj.prototype.$owner=parent||$obj.prototype.$owner,$obj.prototype.$signatures=$thing.merge(signatures,$obj.prototype.$signatures),$obj.prototype.$ontology=$thing.merge(ontology,$obj.prototype.$ontology),$obj};if($thing.Base=$thing.Object.inherit({init:function(){},getName:function(){return"Base"},property:function(prop,cbGetter,cbSetter){var obj={};cbGetter?obj.get=cbGetter:void 0,cbSetter?obj.set=cbSetter:void 0,Object.defineProperty(this,prop,obj)},bind:function(funct){var self=this;return function(){return funct.apply(self,arguments)}}}),$thing.BURST_DECAY=3e8,$thing.State={EXPR_AND:1,EXPR_NOT:2,EXPR_OR:3,DEF_DESC:1,DEF_NAME:2,DEF_SOURCE:4,DEF_EXTENDS:16,DEF_IMPLEMENTS:64,DEF_USES:128,DEF_META:256,DEF_NOP:512,DEF_END:1024,LIFE_INITIATED:2048,LIFE_ACTIVE:4096,LIFE_WAITING:8192,LIFE_SUSPENDED:16384,LIFE_DELETED:32768,LIFE_TRANSIT:65536,LIFE_BLOCKED:131072},$thing.Definition=$thing.Base.inherit({$metaHandlers:{mobile:function(){this._isMobile=!0},passive:function(){this._isPassive=!0},singleton:function(){this._singleton=this._singleton||this._source},catchall:function(catchall,methodName){this._substitute.$__catchall__=methodName}},getName:function(){return"Definition"},init:function(parent,_super,threadId,stack){var k,item,search,self=this,heap=$thing.getContainer(threadId).heap;if(this.$super(),this._state=$thing.State.DEF_DESC,this._threadId=threadId,this._parent=parent,this._children=[],this._meta=[],this._interfaces=[],this._uses=[],this._super=_super,this._source=threadId[0],this._refCount=0,this._isAgent=this._super===$thing.Agent,this._isAbstract=!1,this._isPassive=!1,this._isMobile=!1,this._lastBurstTime=0,this._burstAverage=1,this._waitTime=$thing.getMicroTime(),this._interfaces=[$thing.create64BitId(this._source,heap.length),this._source],this._substitute={$id:this._interfaces[0],$source:this._source},this.parseStack(stack),void 0!==this._extends){if(item=$thing.search({_name:this._extends},heap),void 0===item)throw new Error("DefinitionError: Super Class '"+this._extends+"' is not defined");for(this._super=item._class,this._singleton=item._singleton,k=item._meta.length-1;k>-1;k--)this._meta.unshift(item._meta[k]);void 0===this._class?this._class={}:void 0}if(this._meta.forEach(function(item){var args=item.split(/ (.+)?/);void 0!==self.$metaHandlers[args[0]]?self.$metaHandlers[args[0]].apply(self,args):void 0}),this._isAbstract?search={_name:this._name,_source:this._source}:void 0!==this._singleton&&(search={_name:this._name,_singleton:this._singleton}),void 0!==search&&(item=$thing.search(search,heap)))this.refObject=item.bind(item.refObject),this.property("class",function(){return item._class}),this.property("refCount",function(){return item._refCount}),this.property("isAbstract",function(){return item._isAbstract}),this.property("isPassive",function(){return item._isPassive}),this.property("instance",function(){return item._instance}),this.property("state",function(){return item._state}),this.property("name",function(){return item._name}),this.property("parent",function(){return item._parent}),this.property("threadId",function(){return item._threadId});else{if(this._childrenWrapper={push:this.bind(this._pushChild),forEach:this.bind(this._forEachChild)},Object.defineProperty(this._childrenWrapper,"length",{get:this.bind(this._countChildren)}),void 0!==this._factory?this._class=this._factory.apply($thing,this._uses):void 0,void 0!==this._class){for(k in this._substitute)this._class[k]=this._substitute[k];var interfaces=void 0!==this._name?this._interfaces.concat(this._name):this._interfaces;this._class.getInterfaces=function(){return this.$super().concat(interfaces)},this._class=this._super.inherit(this._class,parent,this._isMobile),$thing.attach(this,heap)}this.property("class",function(){return this._class}),this.property("refCount",function(){return this._refCount}),this.property("isAbstract",function(){return this._isAbstract}),this.property("isPassive",function(){return this._isPassive}),this.property("instance",function(){return this._instance}),this.property("state",function(){return this._state}),this.property("name",function(){return this._name}),this.property("parent",function(){return this._parent}),this.property("threadId",function(){return this._threadId})}},_forEachChild:function(cb){this._children.forEach(function(args){void 0!==args[0].getHeapId?cb.apply(void 0,args):void 0})},_pushChild:function(obj){for(var id=obj.getHeapId(),i=0;i<this._children.length;i++)if(void 0===this._children[i][0].getHeapId)this._children.splice(i,1);else if(this._children[i][0].getHeapId()===id)return this._children.length;return this._children.push(arguments)},_countChildren:function(){var length=0;return this._forEachChild(function(child){child.getRefCount()&&length++}),length},parseStack:function(stack){function replace(){return void 0===arguments[1]?stack.shift():self._substitute["$"+arguments[1]]=stack.shift()}for(var item,match,self=this;this._state!==$thing.State.DEF_END&&void 0!==(item=stack.shift());){switch(typeof item){case"function":this._state=$thing.State.DEF_END,this._factory=item;continue;case"object":this._state=$thing.State.DEF_END,this._class=item;continue}switch(item){case"abstract":this._isPassive=this._isAbstract=!0;continue;case"source":this._state=$thing.State.DEF_SOURCE;continue;case"extends":this._state=$thing.State.DEF_EXTENDS;continue;case"implements":this._state=$thing.State.DEF_IMPLEMENTS;continue;case"uses":this._state=$thing.State.DEF_USES;continue;default:this._state===$thing.State.DEF_META||"@"===item.charAt(0)?this._state=$thing.State.DEF_META:item.match(/ /)?this._state=$thing.State.DEF_DESC:void 0}switch(this._state){case $thing.State.DEF_DESC:item=item.replace(/\$\((.+?)\)|\$/g,replace),item=item.split(" @"),stack=item[0].split(/ +/).filter(Boolean).concat(void 0!==item[1]?["@"+item[1]].concat(stack):stack),this._state=void 0===this._name?$thing.State.DEF_NAME:$thing.State.DEF_NOP;break;case $thing.State.DEF_META:item=item.replace(/\$\((.+?)\)|\$/g,replace),"+"===item.charAt(item.length-1)?stack=[item.slice(0,-1)+stack.shift()].concat(stack):(this._state=$thing.State.DEF_DESC,this._meta.push(item.slice(1)));break;case $thing.State.DEF_NAME:this._name=item||this._name;break;case $thing.State.DEF_SOURCE:this._source=item||this._source;break;case $thing.State.DEF_EXTENDS:this._extends=item||this._extends;break;case $thing.State.DEF_IMPLEMENTS:this._interfaces.push(null!==(match=item.match(/^\/(.*?)\/([gimy]*)$/))?new RegExp(match[1],match[2]):item);break;case $thing.State.DEF_USES:this._uses.push($thing.agent(item))}}},patchObject:function(obj){var self=this;return obj.refObject=this.bind(this.refObject),obj.getRefCount=function(){return self._refCount},obj.getHeapId=function(){return self._id},obj.getName=function(){return self._name},obj.getSource=function(){return self._source},obj.getChildren=function(){return self._childrenWrapper},obj.getState=function(){return self._state},obj.setState=function(){for(var k in arguments)self._state|=arguments[k];var states=$thing.arrayDup(arguments);this.getChildren().forEach(function(child){child.setState(states)})},obj.unsetState=function(){for(var k in arguments)self._state&=~arguments[k];var states=$thing.arrayDup(arguments);this.getChildren().forEach(function(child){child.unsetState(states)})},obj.getThreadId=function(){return $thing.arrayDup(self._threadId)},obj.getMeta=function(){return self._meta},obj.isAbstract=function(){return self._isAbstract},obj.waitTime=function(){self._waitTime=$thing.getMicroTime()},obj.burstTime=function(ticks){var now=$thing.getMicroTime();if(self._lastBurstTime){var a=1-Math.exp(-(now-self._lastBurstTime)/$thing.BURST_DECAY*60);self._burstAverage=a*ticks+(1-a)*self._burstAverage}else self._burstAverage=ticks;return self._lastBurstTime=now,self._burstAverage},obj.getResponseRatio=function(){var now=$thing.getMicroTime();return(now-self._waitTime+self._burstAverage)/self._burstAverage},obj},unpatchObject:function(obj){return delete obj.refObject,delete obj.getRefCount,delete obj.getHeapId,delete obj.getName,delete obj.getSource,delete obj.getChildren,delete obj.getState,delete obj.setState,delete obj.unsetState,delete obj.getThreadId,delete obj.getMeta,delete obj.isAbstract,delete obj.waitTime,delete obj.burstTime,delete obj.getResponseRatio,obj},refObject:function(cb){var self=this;this.parent.refObject(function(parent,cbRelease){var constructed;self._refCount?self._refCount++:(self._refCount=constructed=1,self._instance=self.patchObject(new self._class),self._instance.setState($thing.State.LIFE_INITIATED)),constructed&&self._isAgent&&!self._isAbstract&&self._instance.setup(),cb(self._instance,function(){self._isAgent&&self._isPassive||(0!==--self._refCount?cbRelease():self._isAgent?self._instance.takedown(function(){self._children=[],self.unpatchObject(self._instance),delete self._instance,cbRelease()}):(self._children=[],self.unpatchObject(self._instance),delete self._instance,cbRelease()))})})}}),$thing.Delegate=$thing.Base.inherit({init:function(){this.$super()},getName:function(){return"Delegate"},getInterfaces:function(){return[]},matchInterface:function(pattern){for(var interfaces=this.getInterfaces(),i=0;i<interfaces.length&&(interfaces[i]instanceof RegExp?null===pattern.match(interfaces[i]):interfaces[i]!==pattern);i++);return interfaces[i]},refObject:function(cb){cb(this,function(){})},dispatch:function(call,cb){var method,signature,predicates,args,thisHasOntology=!1,argHasContext=!1,self=this;if(cb=cb||function(){},"undefined"==typeof this.getRefCount)return cb();if("$"===call.method.charAt(0))return cb();void 0===this[method=call["interface"]+"."+call.method]&&void 0===this[method=call.method]?method=void 0:void 0;for(thisHasOntology in this.$ontology)break;if(thisHasOntology)for(var k in call.args)if(call.args[k].constructor===Object&&"undefined"!=typeof call.args[k]["@context"]){argHasContext=!0;break}void 0===method||void 0===(signature=this.$signatures[method])||signature.length<1||"$"!==signature[signature.length-1].charAt(0)||signature.length!==call.args.length+1?void 0===this[method=this.$__catchall__]||void 0===(signature=this.$signatures[method])||"$"!==signature[1].charAt(0)||2!==signature.length?cb():this[this.$__catchall__].apply(this,[call.args,cb]):thisHasOntology&&argHasContext&&1!==this.$signatures[method].length?$thing.jsonld.compact({"@graph":(predicates=Object.keys(args=$thing.arrayToObject(call.args,this.$signatures[method],function(value){return value&&value.constructor===Object&&"undefined"!=typeof value["@context"]}))).map(function(k){return args[k]})},this.$ontology,{graph:!0},function(err,graph){if(err)return cb();if(graph=graph["@graph"],graph.length!==predicates.length)cb();else{graph=$thing.merge($thing.arrayToObject(graph,predicates),$thing.arrayToObject(call.args,self.$signatures[method])),args=new Array(self.$signatures[method].length);for(var i=0;i<self.$signatures[method].length-1;i++)args[i]=graph[self.$signatures[method][i]];args[args.length-1]=cb,self[method].apply(self,args)}}):this[method].apply(this,$thing.arrayAppend(call.args,cb))}}),$thing.Pattern=$thing.Delegate.inherit({getName:function(){return"Pattern"},init:function(threadId,pattern){this.$super(),this._threadId=threadId,this._pattern=pattern},getThreadId:function(){return this._threadId},toArray:function(){return this._pattern instanceof Array?this._pattern:[[this._pattern]]}}),$thing.Agent=$thing.Delegate.inherit({getName:function(){return"Agent"},getInterfaces:function(){return["Agent"]},setup:function(cb){this.setState($thing.State.LIFE_ACTIVE),this.doActivate(cb)},takedown:function(cb){this.doDelete(cb)},doActivate:function(cb){this.unsetState($thing.State.LIFE_SUSPENDED),cb&&cb()},doDelete:function(cb){this.setState($thing.State.LIFE_DELETED),cb&&cb()},doSuspend:function(cb){this.setState($thing.State.LIFE_SUSPENDED),cb&&cb()},doWait:function(cb){this.setState($thing.State.LIFE_WAITING),cb&&cb()},doWake:function(cb){this.unsetState($thing.State.LIFE_WAITING),cb&&cb()},addBehaviour:function(){var obj,reset,self=this,threadId=$thing.getThreadId(1),args=$thing.arrayDup(arguments),def=new $thing.Definition(this,$thing.Behaviour,threadId,args);if(void 0!==def["class"]){var funct=function(){def.refCount?obj=def.instance:def.refObject(function(instance,cbRelease){$thing.attach(def),obj=instance,self.getChildren().push(obj,cbRelease)}),obj.unsetState($thing.State.LIFE_WAITING|$thing.State.LIFE_SUSPENDED|$thing.State.LIFE_DELETED|$thing.State.LIFE_TRANSIT|$thing.State.LIFE_BLOCKED),obj.setState(self.getState()|$thing.State.LIFE_ACTIVE)};funct(),reset=obj.reset,obj.reset=function(){funct(),reset.apply(obj,arguments)},$thing.async.setImmediate(function(){$thing.Tasker.thread(threadId)})}return obj},removeBehaviour:function(){var objs=[],children=this.getChildren();if("object"==typeof arguments[0]&&void 0!==arguments[0].getHeapId){var id=arguments[0].getHeapId();children.forEach(function(obj,cbRelease){obj.getHeapId()===id&&(obj.setState($thing.State.LIFE_DELETED),cbRelease(),objs.push(obj))})}else{var args=$thing.arrayDup(arguments),def=new $thing.Definition(this,$thing.Behaviour,$thing.getThreadId(1),args);children.forEach(function(obj,cbRelease){obj.getName()===def.name&&(obj.setState($thing.State.LIFE_DELETED),cbRelease(),objs.push(obj))})}return objs}}),$thing.Behaviour=$thing.Delegate.inherit({getName:function(){return"Behaviour"},getInterfaces:function(){return["Behaviour","parent:"+this.$parent.$id,"owner:"+this.$owner.$id]},done:function(){return!1},action:function($cb){this.done()&&this.$owner.removeBehaviour(this),$cb&&$cb()},block:function($cb){this.setState($thing.State.LIFE_BLOCKED),$cb&&$cb()},restart:function($cb){this.unsetState($thing.State.LIFE_BLOCKED),$cb&&$cb()},reset:function($cb){this.unsetState($thing.State.LIFE_WAITING|$thing.State.LIFE_SUSPENDED),this.setState($thing.State.LIFE_ACTIVE),$cb&&$cb()}}),$thing.Filter={ALL:1,FIRST:2,LAST:4},$thing.Selector=$thing.Base.inherit({getName:function(){return"Selector"},init:function(threadId,pattern,includePassive){if(this.$super(),this._threadId=threadId,this._includePassive=void 0===includePassive?!0:includePassive,this._exprs=[],this._schedule=[],this._selection=[],this._callbacks=[],this._filterStates=this._includePassive?$thing.State.LIFE_SUSPENDED:$thing.State.LIFE_WAITING,pattern instanceof $thing.Pattern)void 0===this._threadId&&(this._threadId=pattern.getThreadId()),pattern=pattern.toArray();else if("string"==typeof pattern){var expr={and:{},not:{}};expr.and[pattern]=!0,this._exprs.push(expr)}if(pattern instanceof Array)for(var i=0;i<pattern.length;i++)this.parseStack(pattern[i]);this.property("length",function(){return this._schedule.length})},parseStack:function(stack){for(var k,item,state=$thing.State.EXPR_AND,expr={and:{},not:{}};void 0!==(item=stack.shift());){switch(item){case"and":state=$thing.State.EXPR_AND;continue;case"not":state=$thing.State.EXPR_NOT;continue;case"or":state=$thing.State.EXPR_OR;continue}switch(state){case $thing.State.EXPR_AND:expr.and[item]=!0;break;case $thing.State.EXPR_NOT:expr.not[item]=!0;break;case $thing.State.EXPR_OR:for(k in expr.and){this._exprs.push(expr);break}expr={and:{},not:{}},expr.and[item]=!0}}for(k in expr.and){this._exprs.push(expr);break}},matchObject:function(obj,cbRelease){for(var k,match,i=0;i<this._exprs.length;i++){var m,expr=this._exprs[i];for(k in expr.and){if(void 0===(m=obj.matchInterface(k,this._source))){match=void 0;break}match=match||m}if(void 0!==match){for(k in expr.not)if(obj.matchInterface(k,this._source))return match=void 0,void cbRelease();if(void 0!==match)break}}void 0===match?cbRelease():(this._callbacks.push(cbRelease),this._selection.push({match:match,obj:obj}))},select:function(){var i,j,include,def,heap;for(this.release(),heap=$thing.getContainer(this._threadId).heap,i=0;i<heap.length;i++)def=heap[i],include=def.isPassive?def.isPassive&this._includePassive&&def.state<this._filterStates:def.state<this._filterStates,!def.isAbstract&&def.refCount>0&&def.state&$thing.State.LIFE_ACTIVE&&include&&def.refObject(this.bind(this.matchObject));if(this._schedule.length!==this._selection.length)for(this._schedule=new Array(this._selection.length),j=0;j<this._schedule.length;j++)this._schedule[j]=j},schedule:function(){if(1===this._schedule.length){var s=this._selection[this._schedule[0]].obj.getState()<this._filterStates;s||(this._schedule.length=0)}else{var shrink=!1,self=this;if(this._schedule.sort(function(x,y){x=self._selection[x].obj,y=self._selection[y].obj;var xr=x.getResponseRatio(),yr=y.getResponseRatio(),xs=x.getState()<self._filterStates,ys=y.getState()<self._filterStates;return ys?xs?xr>yr?-1:yr>xr?1:0:(shrink=!0,1):(shrink=!0,xs?-1:0)}),shrink)for(var i=0;i<this._schedule.length;i++){var s=this._selection[this._schedule[i]].obj.getState()<this.filterStates;if(!s){this._schedule.length=i;break}}}},dispatch:function(call,cbItem,cbDone){var self=this;if(call.filters&$thing.Filter.ALL&&1===this._schedule.length||call.filters&$thing.Filter.FIRST&&this._schedule.length>0){var item=this._selection[this._schedule[0]],match=item.match,obj=item.obj,start=$thing.getMicroTime();obj.dispatch({"interface":match,method:call.method,args:call.args},function(){return"undefined"==typeof obj.getRefCount?obj=$thing.Container:(obj.burstTime($thing.getMicroTime()-start),obj.waitTime()),cbItem.apply(obj,$thing.arrayAppend(arguments,cbDone))})}else if(call.filters&$thing.Filter.LAST&&this._schedule.length>0){var item=this._selection[this._schedule[this._schedule.length-1]],match=item.match,obj=item.obj,start=$thing.getMicroTime();obj.dispatch({"interface":match,method:call.method,args:call.args},function(){return"undefined"==typeof obj.getRefCount?obj=$thing.Container:(obj.burstTime($thing.getMicroTime()-start),obj.waitTime()),cbItem.apply(obj,$thing.arrayAppend(arguments,cbDone))})}else call.filters&$thing.Filter.ALL&&this._schedule.length>0?$thing.async.each(this._schedule,function(item,cbNext){item=self._selection[item];var match=item.match,obj=item.obj,start=$thing.getMicroTime();obj.dispatch({"interface":match,method:call.method,args:call.args},function(){return"undefined"==typeof obj.getRefCount?obj=$thing.Container:(obj.burstTime($thing.getMicroTime()-start),obj.waitTime()),cbItem.apply(obj,$thing.arrayAppend(arguments,cbNext))})},cbDone):cbDone()},release:function(){var i,callbacks=this._callbacks;for(this._schedule=[],this._callbacks=[],this._selection=[],i=0;i<callbacks.length;i++)callbacks[i]()}}),$thing.Container=new($thing.Agent.inherit({getName:function(){return"Container"},getInterfaces:function(){return["Container"]},getThreadId:function(){return["$thing","main","main"]},setup:void 0,takedown:void 0,addBehaviour:void 0,removeBehaviour:void 0})),$thing.Tasker=new($thing.Base.inherit({doAction:function(container,selector,iteration){var self=this;container.isTaskerQueued=!0,iteration>selector.length&&(selector.select(),iteration=0),0===selector.length?(selector.release(),container.isTaskerQueued=!1):(selector.schedule(),selector.dispatch({filters:$thing.Filter.FIRST,method:"action",args:[]},function(cbNext){cbNext()},function(){$thing.async.setImmediate(function(){self.doAction(container,selector,++iteration)})}))},thread:function(threadId){void 0===threadId&&(threadId=$thing.getThreadId(1));var container=$thing.getContainer(threadId);if(!container.isTaskerQueued){var selector=new $thing.Selector(threadId,[["Behaviour"]],!1);selector.select(),this.doAction(container,selector,0)}}})),$thing.agent("@singleton","abstract Heartbeat implements Container",{setup:function(cb){this.$super(cb);var self=this;this.keepAlive=this.addBehaviour("@passive",{}),this.intervalId=setInterval(function(){$thing.Tasker.thread(self.getThreadId())},$thing.WAKE_MIN_PERIOD/1e3)},destroy:function($cb){clearInterval(this.intervalId),this.removeBehaviour(this.keepAlive),$cb()}}),$thing.agent("@singleton",{setup:function(cb){this.$super(cb),this.addBehaviour("abstract Flow",{getFlow:function(){for(var flow,names,namesDict={},self=this,i=0;i<arguments.length;i++)namesDict[arguments[i]]=i;
return $thing.searchMeta(this,"flow",function(){for(var j=0;j<arguments.length;j++)namesDict[arguments[j]]=j+i;i+=j}),names=Object.keys(namesDict),flow=new Array(names.length),names.forEach(function(name,index){flow[index]=function(){var args=new Array(arguments.length);args[0]=name;for(var i=0;i<arguments.length-1;i++)args[i+1]=arguments[i];$thing.agent(self,arguments[arguments.length-1]).apply(self,args).apply(self,[self])}}),flow.remove=function(name){var k,l=0,index=namesDict[name];-1!==index&&(namesDict[name]=-1,flow[index]=function(){arguments[arguments.length-1]()});for(k in namesDict){if(-1!==namesDict[k])break;l++}flow.length===l&&this.removeAll()},flow.removeAll=function(){namesDict={},flow.length=0},this.getFlow=function(){return flow},flow},end:function(methodName,$cb){var flow=this.getFlow();if(methodName instanceof Array)for(var k in methodName)flow.remove(methodName[k]);else flow.remove(methodName);$cb&&$cb()},endAll:function($cb){this.getFlow().removeAll(),$cb&&$cb()},action:function($cb){0===this.getFlow().length&&(this.done=function(){return!0}),this.$super($cb)},done:function(){return!1}})}}),$thing.agent("@singleton",{setup:function(cb){this.$super(cb),this.addBehaviour("abstract Series extends Flow",{action:function($cb){this.$super($cb);var self=this,start=$thing.getMicroTime();$thing.async.series(this.getFlow(),function(){self.burstTime($thing.getMicroTime()-start)})}})}}),$thing.agent("@singleton",{setup:function(cb){this.$super(cb),this.addBehaviour("abstract Parallel extends Flow",{action:function($cb){this.$super($cb);var self=this,start=$thing.getMicroTime();$thing.async.parallel(this.getFlow(),function(){self.burstTime($thing.getMicroTime()-start)})}})}}),$thing.agent("@singleton",{setup:function(cb){this.$super(cb),this.addBehaviour("abstract Queue extends Flow",{getQueue:function(){var chunks,callbacks,cbCompletion,i=0,x=0,y=0,last=0,queueLength=0,limit=0,concurrency=1,active=0,paused=0,self=this,getQueue=this.getQueue,queue={action:function(){if(!paused){if(0===queueLength&&0===limit){var l=Math.max(chunks.length/2,1);chunks.length>l&&(chunks.length=l,callbacks.length=l)}if(0===queueLength&&limit>0)return void self.setState($thing.State.LIFE_WAITING);if(0===queueLength&&1===chunks.length)return void self.setState($thing.State.LIFE_WAITING);for(var j=0,flow=self.getFlow();flow.length>0&&concurrency+1>j+active&&queueLength>i;j++){var v,$cb,start=$thing.getMicroTime();i++,active++,chunks[y]instanceof Array?(v=chunks[y][x],x<chunks[y].length-1?x++:($cb=callbacks[y],chunks[y]=void 0,callbacks[y]=void 0,x=0,y++)):(v=chunks[y],$cb=callbacks[y],chunks[y]=void 0,callbacks[y]=void 0,x=0,y++),$thing.async.applyEachSeries(flow,v,cbCompletion.bind({start:start,$cb:$cb}))}}},push:function(items,$cb){var length=items instanceof Array?queueLength+items.length:queueLength+1;return 0===self.getFlow()?$cb?$cb("onError",-1)():void 0:limit>0&&length>limit?$cb?$cb("onError",-1)():void 0:(queueLength=length,last===chunks.length&&(chunks=$thing.arrayDup(chunks,2*chunks.length,!0),callbacks=$thing.arrayDup(callbacks,2*callbacks.length,!0)),chunks[last]=items,callbacks[last]=$cb,last++,paused||self.unsetState($thing.State.LIFE_WAITING),void $thing.Tasker.thread(self.getThreadId()))},clear:function(){i=queueLength,$thing.async.each(callbacks.slice(y),function(cbItem,cbNext){cbItem&&cbItem("onError",-1)(),cbNext()})},pause:function($cb){paused=!0,self.setState($thing.State.LIFE_WAITING),$cb&&$cb()},resume:function($cb){queueLength>0&&self.unsetState($thing.State.LIFE_WAITING),paused=!1,$cb&&$cb()},reset:function(){this.clear(),chunks.length=0,callbacks.length=0,queue=void 0,self.getQueue=getQueue}};return $thing.searchMeta(this,"concurrency","int",function(value){concurrency=value}),$thing.searchMeta(this,"limit","int",function(value){limit=value}),chunks=new Array(limit||1),callbacks=new Array(limit||1),cbCompletion=function(){var $cb=this.$cb,start=this.start,callDrain=!1;0===--active&&i===queueLength&&(queueLength=last=i=x=y=0,callDrain=!0),callDrain?self.drain(function(){self.burstTime($thing.getMicroTime()-start)}):self.burstTime($thing.getMicroTime()-start),$cb&&$cb("onComplete")()},Object.defineProperty(queue,"length",{get:function(){return queueLength}}),this.getQueue=function(){return queue},queue},action:function($cb){this.$super($cb),this.getQueue().action()},push:function(items,$cb){this.getQueue().push(items,$cb)},pause:function($cb){this.getQueue().pause($cb)},resume:function($cb){this.getQueue().resume($cb)},end:function(method,$cb){var ret=this.$super(method,$cb);return 0===this.getFlow().length&&this.getQueue().clear(),ret},endAll:function($cb){var ret=this.$super($cb);return this.getQueue().clear(),ret},reset:function($cb){this.getQueue().reset(),this.$super($cb)},drain:function(cb){cb()}})}}),$thing.agent("@singleton",{setup:function(cb){this.$super(cb),this.addBehaviour("abstract MapReduce extends Queue",{getMapReduce:function(){var keys={},values=[],lengths=[],last=0,shape=1,total=0,reduceIndex=0,drainRefs=0,pushes=[],self=this,getMapReduce=this.getMapReduce,mapReduce={write:function(key,value){var index;if(last===values.length){values=$thing.arrayDup(values,2*(1+values.length),!0),lengths=$thing.arrayDup(lengths,2*(1+lengths.length),!0);for(var i=last;i<lengths.length;i++)lengths[i]=0,values[i]=new Array(shape)}void 0===(index=keys[key])&&(index=keys[key]=last,last++),lengths[index]===values[index].length&&(values[index]=$thing.arrayDup(values[index],Math.max(2*(1+values[index].length),shape),!0)),values[index][lengths[index]]=value,lengths[index]++,shape=Math.ceil(++total/last)},drain:function(){1===++drainRefs&&(self.pause(),self.unsetState($thing.State.LIFE_WAITING))},action:function($cb){var start=$thing.getMicroTime(),valuesCopy=$thing.arrayDup(values[reduceIndex],lengths[reduceIndex],!0,shape);lengths[reduceIndex]=0,self.reduce(valuesCopy,function(reduced){if(++reduceIndex===last){var l=2*(1+last);values.length>l&&(values.length=l,lengths.length=l),keys={},drainRefs=last=reduceIndex=0,self.resume()}if(void 0!==reduced)for(var k in pushes)pushes[k]("push",reduced)(self);self.burstTime($thing.getMicroTime()-start),$cb()})},reset:function(){keys={},values.length=0,lengths.length=0,mapReduce=void 0,self.getMapReduce=getMapReduce}};return $thing.searchMeta(this,"push","string",function(){pushes.push($thing.agent("@select "+$thing.arrayDup(arguments).join(" ")))}),Object.defineProperty(mapReduce,"length",{get:function(){return total}}),Object.defineProperty(mapReduce,"isReducing",{get:function(){return drainRefs>0&&last>0}}),this.getMapReduce=function(){return mapReduce},mapReduce},action:function($cb){var mapReduce=this.getMapReduce();mapReduce.isReducing?mapReduce.action($cb):this.$super($cb)},reset:function($cb){this.getMapReduce().reset(),this.$super($cb)},write:function(key,value){this.getMapReduce().write(key,value)},reduce:function(values,cb){cb(values)},drain:function(cb){this.getMapReduce().drain(),this.$super(cb)}})}}),$thing.WAKE_MIN_PERIOD=5e5,$thing.agent("@singleton",{setup:function(cb){this.$super(cb),this.addBehaviour("abstract Waker",{getWakeTime:function(){var time,period=1e6,now=$thing.getMicroTime();return $thing.searchMeta(this,"period","int",function(value){period=1e3*value}),time=now+period-now%period,this.getWakeTime=function(){return time},this.getWakeTime()},wake:function(cb){cb()},action:function($cb){var time=this.getWakeTime();return void 0===time?this.$super($cb):$thing.getMicroTime()>=time?(this.getWakeTime=function(){return void 0},this.wake(this.bind(function(){this.$super($cb)}))):void this.$super($cb)},done:function(){return void 0!==this.getWakeTime()?!1:(delete this.getWakeTime,!0)},reset:function($cb){delete this.getWakeTime,this.$super($cb)},stop:function($cb){this.$owner.removeBehaviour(this),delete this.getWakeTime,$cb&&$cb()}})}}),$thing.agent("@singleton","Util",{setup:function(cb){this.$super(cb),this.addBehaviour("@passive","@catchall catchAll","Complete",{catchAll:function(args,$cb){$cb("onComplete")()}}),this.addBehaviour("@passive","@catchall catchAll","Error",{catchAll:function(args,$cb){$cb("onError",-1)()}}),this.addBehaviour("abstract Sensor extends Queue"),this.addBehaviour("abstract Actuator extends Queue"),this.addBehaviour("abstract Bridge extends Queue implements Actuator Sensor")}}),!$thing.usePaho)var mqtt=require("mqtt");(mqtt||$thing.usePaho&&Paho)&&$thing.agent("abstract Mqtt implements Container",{setup:function(cb){this.$super(cb),this.port=$thing.usePaho?80:1883,this.reconnectPeriod=1e3,this.isConnecting=!1,this.isConnected=!1,this.actuatorsTotal=0,this.topicRefs={},this.pendingSubs={},this.pendingUnsubs={};var z=-1,self=this;if($thing.searchMeta(this,"host","string",function(value){self.host=value}),$thing.searchMeta(this,"port","int",function(value){self.port=value}),$thing.searchMeta(this,"clientId","string",function(value){self.clientId=value}),$thing.searchMeta(this,"reconnectPeriod","int",function(value){self.reconnectPeriod=value}),void 0===this.host)throw new Error("Mqtt: Missing @host");void 0===this.clientId&&(this.clientId="xxxxxxxx-xxxx-4xxz-yzzz-zzzzzzzzzzzz".replace(/[xyz4-]/g,function(c){switch(c){case"x":return(Math.floor(100*Math.random())%16).toString(16);case"y":return"8";case"z":return self.$id.charAt(++z);case"-":case"4":return c}}))},destroy:function($cb){this.getChildren().forEach(function(child){child.isAbstract()||(void 0!==child.matchInterface("Sensor")||void 0!==child.matchInterface("Actuator"))&&child.$owner.removeBehaviour(child)}),$cb()},addBehaviour:function(){var doConnect=!1,obj=this.$super.apply(this,arguments);if(void 0!==obj&&!obj.isAbstract()){if(void 0!==obj.matchInterface("Sensor")&&(obj.$subTopic=obj.getName(),void 0!==this.topicRefs[obj.$subTopic]?this.topicRefs[obj.$subTopic]++:(this.topicRefs[obj.$subTopic]=1,this.isConnected?this.doSubscribe(obj.$subTopic):(this.pendingSubs[obj.$subTopic]=!0,void 0!==this.pendingUnsubs[obj.$subTopic]&&delete this.pendingUnsubs[obj.$subTopic],doConnect=!0))),void 0!==obj.matchInterface("Actuator")){var flow=obj.getFlow();obj.$pubTopic=obj.getName(),obj.getFlow=function(){return $thing.arrayAppend(flow,function(message,cb){obj.$owner.doSendMessage(obj.$pubTopic,message),cb()})},this.isConnected||(doConnect=!0,$thing.agent(obj)("pause")()),this.actuatorsTotal++}doConnect&&this.doConnect()}return obj},removeBehaviour:function(){var self=this,objs=this.$super.apply(this,arguments);return objs.forEach(function(obj){void 0!==obj.$subTopic&&--self.topicRefs[obj.$subTopic]<=0&&(delete self.topicRefs[obj.$subTopic],void 0!==self.pendingSubs[obj.$subTopic]&&delete self.pendingSubs[obj.$subTopic],self.isConnected?self.doUnsubscribe(obj.$subTopic):self.pendingUnsubs[obj.$subTopic]=!0),void 0!==obj.$pubTopic&&self.actuatorsTotal--}),this.isActive()||this.doDisconnect(),objs},doConnectWithMqtt:function(){var self=this;this.client=mqtt.connect({host:this.host,port:this.port,clientId:this.clientId,reconnectPeriod:this.reconnectPeriod}),this.client.on("error",function(err){self.onError(err)()}),this.client.on("close",function(){self.onDisconnect(),self.removeBehaviour(self.broker),delete self.broker}),this.client.on("connect",function(){self.broker=self.addBehaviour("@passive",{}),self.onConnect()}),this.client.on("message",function(topic,message){self.onMessageArrived(topic,$thing.createBuffer(message))})},doConnectWithPaho:function(){var self=this;this.client=new Paho.MQTT.Client(this.host,this.port,this.clientId),this.client.onConnectionLost=function(){self.onDisconnect()},this.client.onMessageArrived=function(msg){self.onMessageArrived(msg.destinationName,$thing.createBuffer(msg.payloadBytes))},this.client.onMessageDelivered=function(msg){self.onMessageDelivered(msg.destinationName,$thing.createBuffer(msg.payloadBytes))},this.client.connect({onSuccess:function(){self.onConnect()},onFailure:function(err){self.onError(err)}})},isActive:function(){for(var i in this.pendingSubs)break;for(var j in this.pendingUnsubs)break;for(var k in this.topicRefs)break;return void 0!==i||void 0!==j||void 0!==k||this.actuatorsTotal>0?!0:!1},doConnect:function(){this.isConnecting||(this.isConnecting=!0,this.isConnected=!1,$thing.usePaho?this.doConnectWithPaho():this.doConnectWithMqtt())},doDisconnect:function(){void 0!==this.client&&(this.isConnecting=!1,this.isConnected=!1,$thing.usePaho?this.client.disconnect():this.client.end(),delete this.client)},doReconnect:function(){$thing.usePaho&&this.addBehaviour("@singleton","@period $",this.reconnectPeriod,"extends Waker",{wake:function(cb){this.$super(cb),this.$owner.isConnected?this.$owner.doDisconnect():this.$owner.doConnect()}})},doSubscribe:function(topic){this.client.subscribe(topic)},doUnsubscribe:function(topic){this.client.unsubscribe(topic)},doSendMessage:function(topic,message){var self=this;$thing.usePaho?this.client.send(topic,message,0,!1):this.client.publish(topic,message,{},function(err){err?self.onError(err):self.onMessageDelivered(topic,$thing.createBuffer(message))})},onError:function(err){this.isConnecting=!1,$thing.usePaho&&8===err.errorCode&&this.onDisconnect()},onConnect:function(){this.isConnecting=!1,this.isConnected=!0;for(var i in this.pendingSubs)this.doSubscribe(i);for(var j in this.pendingUnsubs)this.doUnsubscribe(j);this.pendingSubs={},this.pendingUnsubs={};for(var k in this.topicRefs)break;void 0===k&&this.actuatorsTotal<=0?this.doDisconnect():this.getChildren().forEach(function(obj){obj.isAbstract()||void 0===obj.matchInterface("Actuator")||$thing.agent(obj)("resume")()})},onDisconnect:function(){this.isConnecting=!1,this.isConnected=!1,this.actuatorsTotal>0&&this.getChildren().forEach(function(obj){void 0!==obj.matchInterface("Actuator")&&$thing.agent(obj)("pause")()}),this.isActive()&&this.doReconnect()},onMessageArrived:function(topic,message){this.getChildren().forEach(function(obj){obj.isAbstract()||void 0===obj.matchInterface(topic)||(void 0!==obj.matchInterface("Bridge")?$thing.agent("@select $ not owner:$",topic,obj.$owner.$id)("push",message)():void 0!==obj.matchInterface("Sensor")&&$thing.agent(obj)("push",message)())})},onMessageDelivered:function(){}});